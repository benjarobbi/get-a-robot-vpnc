cscope 15 $HOME/mydroid/external/vpnc               0000253232
	@android-hacks.h

	@cisco-decrypt.c

21 
	~"de¸y±-utûs.h
"

23 
	~<°dio.h
>

24 
	~<°dlib.h
>

25 
	~<g¸y±.h
>

26 
	~<î∫o.h
>

28 
	$maö
(
¨gc
, *
¨gv
[])

30 
i
, 
Àn
, 
ªt
 = 0;

31 *
bö
, *
pw
 = 
NULL
;

33 
	`g¸y_check_vîsi⁄
(
NULL
);

35 i‡(
¨gc
 =1 || *
¨gv
[1] == '-') {

36 
	`Ârötf
(
°dîr
,

39 
¨gv
[0]);

40 
	`exô
(1);

43 i‡(*
¨gv
[1] == 'q') {

44 
	`exô
(1);

47 
i
 = 1; i < 
¨gc
; i++) {

48 
ªt
 = 
	`hex2bö
(
¨gv
[
i
], &
bö
, &
Àn
);

49 i‡(
ªt
 != 0) {

50 
	`≥º‹
("decoding input");

53 
ªt
 = 
	`deobfusˇã
(
bö
, 
Àn
, (c⁄° **)&
pw
, 
NULL
);

54 
	`‰ì
(
bö
);

55 i‡(
ªt
 != 0) {

56 
	`≥º‹
("decrypting input");

59 
	`¥ötf
("%s\n", 
pw
);

60 
	`‰ì
(
pw
);

63 
	`exô
(
ªt
 != 0);

64 
	}
}

	@config.c

21 
	#_GNU_SOURCE


	)

23 
	~<öây≥s.h
>

24 
	~<°dio.h
>

25 
	~<°dlib.h
>

26 
	~<uni°d.h
>

27 
	~<°rög.h
>

28 
	~<î∫o.h
>

29 
	~<sys/ut¢ame.h
>

30 
	~<°dio.h
>

32 
	~<g¸y±.h
>

34 
	~"sysdï.h
"

35 
	~"c⁄fig.h
"

36 
	~"v≤c.h
"

37 
	~"suµ.h
"

38 
	~"de¸y±-utûs.h
"

39 
	~"hacks.h
"

41 c⁄° *
	gc⁄fig
[
LAST_CONFIG
];

43 
	g›t_debug
 = 0;

44 
	g›t_nd
;

45 
	g›t_1des
, 
	g›t_no_í¸y±i⁄
, 
	g›t_auth_mode
;

46 
«â_mode_íum
 
	g›t_«â_mode
;

47 
víd‹_íum
 
	g›t_víd‹
;

48 
if_mode_íum
 
	g›t_if_mode
;

49 
uöt16_t
 
	g›t_ud≥nˇµ‹t
;

51 
	$hex_dump
(c⁄° *
°r
, c⁄° *
d©a
, 
ssize_t
 
Àn
, c⁄° 
debug_°rögs
 *
decode
)

53 
size_t
 
i
;

54 c⁄° 
uöt8_t
 *
p
 = 
d©a
;

55 c⁄° *
decodedvÆ
;

57 i‡(
›t_debug
 < 3)

60 
	`¥ötf
(" ");

61 
Àn
) {

62 
DUMP_UINT8
:

63 
decodedvÆ
 = 
	`vÆ_to_°rög
(*(
uöt8_t
 *)
p
, 
decode
);

64 
	`¥ötf
("%s: %02x%s\n", 
°r
, *(
uöt8_t
 *)
p
, 
decodedvÆ
);

66 
DUMP_UINT16
:

67 
decodedvÆ
 = 
	`vÆ_to_°rög
(*(
uöt16_t
 *)
p
, 
decode
);

68 
	`¥ötf
("%s: %04x%s\n", 
°r
, *(
uöt16_t
 *)
p
, 
decodedvÆ
);

70 
DUMP_UINT32
:

71 
decodedvÆ
 = 
	`vÆ_to_°rög
(*(
uöt32_t
 *)
p
, 
decode
);

72 
	`¥ötf
("%s: %08x%s\n", 
°r
, *(
uöt32_t
 *)
p
, 
decodedvÆ
);

76 
	`¥ötf
("%s:%s", 
°r
, (
Àn
 <= 16) ? " " : "\n ");

77 
i
 = 0; i < (
size_t
)
Àn
; i++) {

78 i‡(
i
 && !(i % 32))

79 
	`¥ötf
("\n ");

80 i‡(
i
 && !(i % 4))

81 
	`¥ötf
(" ");

82 
	`¥ötf
("%02x", 
p
[
i
]);

84 
	`¥ötf
("\n");

85 
	}
}

87 
	$c⁄fig_deobfusˇã
(
obfusˇãd
, 
˛ór
)

89 
ªt
, 
Àn
 = 0;

90 *
bö
 = 
NULL
;

92 i‡(
c⁄fig
[
obfusˇãd
] =
NULL
)

95 i‡(
c⁄fig
[
˛ór
] !
NULL
) {

96 
c⁄fig
[
obfusˇãd
] = 
NULL
;

97 
	`îr‹
(0, 0, "warning: ignoring obfuscatedÖassword because cleartextÖassword set");

101 
ªt
 = 
	`hex2bö
(
c⁄fig
[
obfusˇãd
], &
bö
, &
Àn
);

102 i‡(
ªt
 != 0) {

103 
	`îr‹
(1, 0, "error: deobfuscating ofÖassword failed (inputÇotá hex string)");

106 
ªt
 = 
	`deobfusˇã
(
bö
, 
Àn
, 
c⁄fig
+
˛ór
, 
NULL
);

107 
	`‰ì
(
bö
);

108 i‡(
ªt
 != 0) {

109 
	`îr‹
(1, 0, "error: deobfuscating ofÖassword failed");

112 
c⁄fig
[
obfusˇãd
] = 
NULL
;

114 
	}
}

116 c⁄° *
	$c⁄fig_def_ike_dh
()

119 
	}
}

121 c⁄° *
	$c⁄fig_def_pfs
()

124 
	}
}

126 c⁄° *
	$c⁄fig_def_loˇl_addr
()

129 
	}
}

131 c⁄° *
	$c⁄fig_def_loˇl_p‹t
()

134 
	}
}

136 c⁄° *
	$c⁄fig_def_if_mode
()

139 
	}
}

141 c⁄° *
	$c⁄fig_def_«â_mode
()

144 
	}
}

146 c⁄° *
	$c⁄fig_def_udp_p‹t
()

149 
	}
}

151 c⁄° *
	$c⁄fig_def_dpd_idÀ
()

154 
	}
}

156 c⁄° *
	$c⁄fig_ˇ_dú
()

159 
	}
}

161 c⁄° *
	$c⁄fig_def_auth_mode
()

164 
	}
}

166 c⁄° *
	$c⁄fig_def_≠p_vîsi⁄
()

168 
ut¢ame
 
uts
;

169 *
vîsi⁄
;

171 
	`u«me
(&
uts
);

172 
	`a•rötf
(&
vîsi⁄
, "CiscÿSy°em†VPN Clõ¡ %s:%s", 
VERSION
, 
uts
.
sy¢ame
);

173  
vîsi⁄
;

174 
	}
}

176 c⁄° *
	$c⁄fig_def_s¸ùt
()

179 
	}
}

181 c⁄° *
	$c⁄fig_def_pid_fûe
()

184 
	}
}

186 c⁄° *
	$c⁄fig_def_víd‹
()

189 
	}
}

191 c⁄° *
	$c⁄fig_def_èrgë_√tw‹k
()

194 
	}
}

196 c⁄° 
	sc⁄fig_«mes_s
 {

197 
c⁄fig_íum
 
	mnm
;

198 c⁄° 
	m√edsArgumít
;

199 c⁄° 
	ml⁄g_⁄ly
;

200 c⁄° *
	m›ti⁄
;

201 c⁄° *
	m«me
;

202 c⁄° *
	mty≥
;

203 c⁄° *
	mdesc
;

204 c⁄° *(*
	mgë_def
) ();

205 } 
	gc⁄fig_«mes
[] = {

211 
CONFIG_IPSEC_GATEWAY
, 1, 0,

216 
NULL


218 
CONFIG_IPSEC_ID
, 1, 0,

223 
NULL


225 
CONFIG_IPSEC_SECRET
, 1, 0,

226 
NULL
,

230 
NULL


232 
CONFIG_IPSEC_SECRET_OBF
, 1, 1,

233 
NULL
,

237 
NULL


239 
CONFIG_XAUTH_USERNAME
, 1, 0,

244 
NULL


246 
CONFIG_XAUTH_PASSWORD
, 1, 0,

247 
NULL
,

251 
NULL


253 
CONFIG_XAUTH_PASSWORD_OBF
, 1, 1,

254 
NULL
,

258 
NULL


260 
CONFIG_DOMAIN
, 1, 1,

265 
NULL


267 
CONFIG_XAUTH_INTERACTIVE
, 0, 1,

270 
NULL
,

272 
NULL


274 
CONFIG_VENDOR
, 1, 1,

279 
c⁄fig_def_víd‹


281 
CONFIG_NATT_MODE
, 1, 1,

293 
c⁄fig_def_«â_mode


295 
CONFIG_SCRIPT
, 1, 1,

304 
c⁄fig_def_s¸ùt


306 
CONFIG_IKE_DH
, 1, 1,

311 
c⁄fig_def_ike_dh


313 
CONFIG_IPSEC_PFS
, 1, 1,

318 
c⁄fig_def_pfs


320 
CONFIG_ENABLE_1DES
, 0, 1,

323 
NULL
,

325 
NULL


327 
CONFIG_ENABLE_NO_ENCRYPTION
, 0, 1,

330 
NULL
,

332 
NULL


334 
CONFIG_VERSION
, 1, 1,

339 
c⁄fig_def_≠p_vîsi⁄


341 
CONFIG_IF_NAME
, 1, 1,

346 
NULL


348 
CONFIG_IF_MODE
, 1, 1,

355 
c⁄fig_def_if_mode


357 
CONFIG_DEBUG
, 1, 1,

367 
NULL


369 
CONFIG_ND
, 0, 1,

372 
NULL
,

374 
NULL


376 
CONFIG_PID_FILE
, 1, 1,

381 
c⁄fig_def_pid_fûe


383 
CONFIG_LOCAL_ADDR
, 1, 1,

388 
c⁄fig_def_loˇl_addr


390 
CONFIG_LOCAL_PORT
, 1, 1,

395 
c⁄fig_def_loˇl_p‹t


397 
CONFIG_UDP_ENCAP_PORT
, 1, 1,

405 
c⁄fig_def_udp_p‹t


407 
CONFIG_DPD_IDLE
, 1, 1,

413 
c⁄fig_def_dpd_idÀ


415 
CONFIG_NON_INTERACTIVE
, 0, 1,

418 
NULL
,

420 
NULL


422 
CONFIG_AUTH_MODE
, 1, 1,

430 
c⁄fig_def_auth_mode


432 
CONFIG_CA_FILE
, 1, 1,

437 
NULL


439 
CONFIG_CA_DIR
, 1, 1,

444 
c⁄fig_ˇ_dú


446 
CONFIG_IPSEC_TARGET_NETWORK
, 1, 1,

451 
c⁄fig_def_èrgë_√tw‹k


453 0, 0, 0, 
NULL
, NULL, NULL, NULL, NULL

457 *
	$gë_c⁄fig_fûíame
(c⁄° *
«me
, 
add_dŸ_c⁄f
)

459 *
ªÆ«me
;

461 
	`a•rötf
(&
ªÆ«me
, "%s%s%s", 
	`ödex
(
«me
, '/'Ë? "" : "/ëc/v≤c/",Çame, 
add_dŸ_c⁄f
 ? ".conf" : "");

462  
ªÆ«me
;

463 
	}
}

465 
	$ªad_c⁄fig_fûe
(c⁄° *
«me
, c⁄° **
c⁄figs
, 
missögok
)

467 
FILE
 *
f
;

468 *
löe
 = 
NULL
;

469 
size_t
 
löe_Àngth
 = 0;

470 
löíum
 = 0;

471 *
ªÆ«me
;

473 i‡(!
	`°rcmp
(
«me
, "-")) {

474 
f
 = 
°dö
;

475 
ªÆ«me
 = 
	`°rdup
("stdin");

477 
ªÆ«me
 = 
	`gë_c⁄fig_fûíame
(
«me
, 0);

478 
f
 = 
	`f›í
(
ªÆ«me
, "r");

479 i‡(
f
 =
NULL
 && 
î∫o
 =
ENOENT
) {

480 
	`‰ì
(
ªÆ«me
);

481 
ªÆ«me
 = 
	`gë_c⁄fig_fûíame
(
«me
, 1);

482 
f
 = 
	`f›í
(
ªÆ«me
, "r");

484 i‡(
missögok
 && 
f
 =
NULL
 && 
î∫o
 =
ENOENT
) {

485 
	`‰ì
(
ªÆ«me
);

488 i‡(
f
 =
NULL
)

489 
	`îr‹
(1, 
î∫o
, "couldn'à›í `%s'", 
ªÆ«me
);

492 
ssize_t
 
Œí
;

493 
i
;

495 
Œí
 = 
	`gëlöe
(&
löe
, &
löe_Àngth
, 
f
);

496 i‡(
Œí
 =-1 && 
	`„of
(
f
))

498 i‡(
Œí
 == -1)

499 
	`îr‹
(1, 
î∫o
, "ªadög `%s'", 
ªÆ«me
);

500 i‡(
Œí
 > 0 && 
löe
[llen - 1] == '\n')

501 
löe
[--
Œí
] = 0;

502 i‡(
Œí
 > 0 && 
löe
[llen - 1] == '\r')

503 
löe
[--
Œí
] = 0;

504 
löíum
++;

505 
i
 = 0; 
c⁄fig_«mes
[i].
«me
 !
NULL
; i++) {

506 i‡(
	`°∫ˇ£cmp
(
c⁄fig_«mes
[
i
].
«me
, 
löe
,

507 
	`°æí
(
c⁄fig_«mes
[
i
].
«me
)) == 0) {

509 i‡(!
c⁄fig_«mes
[
i
].
√edsArgumít
) {

510 
c⁄figs
[
c⁄fig_«mes
[
i
].
nm
] = c⁄fig_«mes[i].
«me
;

513 i‡(
c⁄figs
[
c⁄fig_«mes
[
i
].
nm
] =
NULL
)

514 
c⁄figs
[
c⁄fig_«mes
[
i
].
nm
] =

515 
	`°rdup
(
löe
 + 
	`°æí
(
c⁄fig_«mes
[
i
].
«me
));

516 i‡(
c⁄figs
[
c⁄fig_«mes
[
i
].
nm
] =
NULL
)

517 
	`îr‹
(1, 
î∫o
, "can'tállocate memory");

521 i‡(
c⁄fig_«mes
[
i
].
«me
 =
NULL
 && 
löe
[0] != '#' &&Üine[0] != 0)

522 
	`îr‹
(0, 0, "warning: unknown configuration directive in %sátÜine %d",

523 
ªÆ«me
, 
löíum
);

525 
	`‰ì
(
löe
);

526 
	`‰ì
(
ªÆ«me
);

527 i‡(
	`°rcmp
(
«me
, "-"))

528 
	`f˛o£
(
f
);

529 
	}
}

531 
	$¥öt_desc
(c⁄° *
¥e
, c⁄° *
ãxt
)

533 c⁄° *
p
, *
q
;

535 
p
 = 
ãxt
, 
q
 = 
	`°rchr
(p, '\n'); q;Ö = q+1, q = strchr(p, '\n'))

536 
	`¥ötf
("%s%.*s\n", 
¥e
, ()(
q
-
p
),Ö);

538 i‡(*
p
 != '\0')

539 
	`¥ötf
("%s%s\n", 
¥e
, 
p
);

540 
	}
}

542 
	$¥öt_ußge
(*
¨gv0
, 
¥öt_Àvñ
)

544 
c
;

546 
	`¥ötf
("Usage: %s [--version] [--print-config] [--help] [--long-help] [options] [config files]\n\n",

547 
¨gv0
);

548 
	`¥ötf
("Options:\n");

549 
c
 = 0; 
c⁄fig_«mes
[c].
«me
 !
NULL
; c++) {

550 i‡(
c⁄fig_«mes
[
c
].
l⁄g_⁄ly
 > 
¥öt_Àvñ
)

553 
	`¥ötf
(" %†%s\n", (
c⁄fig_«mes
[
c
].
›ti⁄
 =
NULL
 ?

554 "(c⁄figfûê⁄ly o±i⁄)" : 
c⁄fig_«mes
[
c
].
›ti⁄
),

555 ((
c⁄fig_«mes
[
c
].
ty≥
 =
NULL
 || c⁄fig_«mes[c].
›ti⁄
 == NULL) ?

556 "" : 
c⁄fig_«mes
[
c
].
ty≥
));

558 
	`¥öt_desc
(" ", 
c⁄fig_«mes
[
c
].
desc
);

560 i‡(
c⁄fig_«mes
[
c
].
gë_def
 !
NULL
)

561 
	`¥ötf
(" DeÁu…: %s\n", 
c⁄fig_«mes
[
c
].
	`gë_def
());

563 
	`¥ötf
(" c⁄f-v¨übÀ: %s%s\n", 
c⁄fig_«mes
[
c
].
«me
,

564 (
c⁄fig_«mes
[
c
].
ty≥
 =
NULL
 ? "" : config_names[c].type));

566 
	`¥ötf
("\n");

569 i‡(!
¥öt_Àvñ
)

570 
	`¥ötf
("Use --long-helpÅo seeáll options\n\n");

572 
	`¥ötf
("Report bugsÅo vpnc@unix-ag.uni-kl.de\n");

573 
	}
}

575 
	$¥öt_vîsi⁄
()

577 
i
;

579 
	`¥ötf
("v≤¯vîsi⁄ " 
VERSION
 "\n");

580 
	`¥ötf
("Copyright (C) 2002-2006 Geoffrey Keating, Maurice Massar, others\n");

581 
	`¥ötf
("vpnc comes with NO WARRANTY,ÅoÅheÉxtentÖermitted byÜaw.\n"

585 #ifde‡
OPENSSL_GPL_VIOLATION


586 
	`¥ötf
("Built with openssl (certificate) support. Beáware ofÅhe\n"

589 
	`¥ötf
("Built without openssl (certificate) support.\n");

591 
	`¥ötf
("\n");

593 
	`¥ötf
("Supported DH-Groups:");

594 
i
 = 0; 
suµ_dh_group
[i].
«me
 !
NULL
; i++)

595 
	`¥ötf
(" %s", 
suµ_dh_group
[
i
].
«me
);

596 
	`¥ötf
("\n");

598 
	`¥ötf
("Supported Hash-Methods:");

599 
i
 = 0; 
suµ_hash
[i].
«me
 !
NULL
; i++)

600 
	`¥ötf
(" %s", 
suµ_hash
[
i
].
«me
);

601 
	`¥ötf
("\n");

603 
	`¥ötf
("Supported Encryptions:");

604 
i
 = 0; 
suµ_¸y±
[i].
«me
 !
NULL
; i++)

605 
	`¥ötf
(" %s", 
suµ_¸y±
[
i
].
«me
);

606 
	`¥ötf
("\n");

608 
	`¥ötf
("Supported Auth-Methods:");

609 
i
 = 0; 
suµ_auth
[i].
«me
 !
NULL
; i++)

610 
	`¥ötf
(" %s", 
suµ_auth
[
i
].
«me
);

611 
	`¥ötf
("\n");

612 
	}
}

614 
	$do_c⁄fig
(
¨gc
, **
¨gv
)

616 *
s
;

617 
i
, 
c
, 
known
;

618 
gŸ_c⁄ffûe
 = 0, 
¥öt_c⁄fig
 = 0;

619 
size_t
 
s_Àn
;

621 
i
 = 1; i < 
¨gc
; i++) {

622 i‡(
¨gv
[
i
][0] && (argv[i][0] != '-' ||árgv[i][1] == '\0')) {

623 
	`ªad_c⁄fig_fûe
(
¨gv
[
i
], 
c⁄fig
, 0);

624 
gŸ_c⁄ffûe
 = 1;

628 
known
 = 0;

630 
c
 = 0; 
c⁄fig_«mes
[c].
«me
 !
NULL
 && !
known
; c++) {

631 i‡(
c⁄fig_«mes
[
c
].
›ti⁄
 =
NULL


632 || 
	`°∫cmp
(
¨gv
[
i
], 
c⁄fig_«mes
[
c
].
›ti⁄
,

633 
	`°æí
(
c⁄fig_«mes
[
c
].
›ti⁄
)) != 0)

636 
s
 = 
NULL
;

638 
known
 = 1;

639 i‡(
¨gv
[
i
][
	`°æí
(
c⁄fig_«mes
[
c
].
›ti⁄
)] == '=')

640 
s
 = 
¨gv
[
i
] + 
	`°æí
(
c⁄fig_«mes
[
c
].
›ti⁄
) + 1;

641 i‡(
¨gv
[
i
][
	`°æí
(
c⁄fig_«mes
[
c
].
›ti⁄
)] == 0) {

642 i‡(
c⁄fig_«mes
[
c
].
√edsArgumít
) {

643 i‡(
i
 + 1 < 
¨gc
)

644 
s
 = 
¨gv
[++
i
];

646 
known
 = 0;

648 
s
 = 
¨gv
[
i
];

650 
known
 = 0;

651 i‡(
known
)

652 
c⁄fig
[
c⁄fig_«mes
[
c
].
nm
] = 
s
;

655 i‡(!
known
 && 
	`°rcmp
(
¨gv
[
i
], "--version") == 0) {

656 
	`¥öt_vîsi⁄
();

657 
	`exô
(0);

659 i‡(!
known
 && 
	`°rcmp
(
¨gv
[
i
], "--print-config") == 0) {

660 
¥öt_c⁄fig
 = 1;

661 
known
 = 1;

663 i‡(!
known
 && 
	`°rcmp
(
¨gv
[
i
], "--help") == 0) {

664 
	`¥öt_ußge
(
¨gv
[0], 0);

665 
	`exô
(0);

667 i‡(!
known
 && 
	`°rcmp
(
¨gv
[
i
], "--long-help") == 0) {

668 
	`¥öt_ußge
(
¨gv
[0], 1);

669 
	`exô
(0);

671 i‡(!
known
) {

672 
	`¥ötf
("%s: unknow¿›ti⁄ %s\n\n", 
¨gv
[0],árgv[
i
]);

674 
	`¥öt_ußge
(
¨gv
[0], 1);

675 
	`exô
(1);

679 i‡(!
gŸ_c⁄ffûe
) {

680 
	`ªad_c⁄fig_fûe
("/ëc/v≤c/deÁu….c⁄f", 
c⁄fig
, 1);

681 
	`ªad_c⁄fig_fûe
("/ëc/v≤c.c⁄f", 
c⁄fig
, 1);

684 i‡(!
¥öt_c⁄fig
) {

685 
i
 = 0; 
c⁄fig_«mes
[i].
«me
 !
NULL
; i++)

686 i‡(!
c⁄fig
[
c⁄fig_«mes
[
i
].
nm
]

687 && 
c⁄fig_«mes
[
i
].
gë_def
 !
NULL
)

688 
c⁄fig
[
c⁄fig_«mes
[
i
].
nm
] = c⁄fig_«mes[i].
	`gë_def
();

690 
›t_debug
 = (
c⁄fig
[
CONFIG_DEBUG
]Ë? 
	`©oi
(config[CONFIG_DEBUG]) : 0;

691 
›t_nd
 = (
c⁄fig
[
CONFIG_ND
]) ? 1 : 0;

692 
›t_1des
 = (
c⁄fig
[
CONFIG_ENABLE_1DES
]) ? 1 : 0;

694 i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_AUTH_MODE
], "psk")) {

695 
›t_auth_mode
 = 
AUTH_MODE_PSK
;

696 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_AUTH_MODE
], "cert")) {

697 
›t_auth_mode
 = 
AUTH_MODE_CERT
;

698 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_AUTH_MODE
], "hybrid")) {

699 
›t_auth_mode
 = 
AUTH_MODE_HYBRID
;

701 
	`¥ötf
("%s: unknow¿authítiˇti⁄ modê%s\nknow¿modes:Ösk cîàhybrid\n", 
¨gv
[0], 
c⁄fig
[
CONFIG_AUTH_MODE
]);

702 
	`exô
(1);

704 #i‚de‡
OPENSSL_GPL_VIOLATION


705 i‡(
›t_auth_mode
 =
AUTH_MODE_HYBRID
 ||

706 
›t_auth_mode
 =
AUTH_MODE_CERT
) {

707 
	`¥ötf
("%†wa†buûàwôhouà›ís¶: C™'àdÿhybrid o∏˚π mode.\n", 
¨gv
[0]);

708 
	`exô
(1);

711 
›t_no_í¸y±i⁄
 = (
c⁄fig
[
CONFIG_ENABLE_NO_ENCRYPTION
]) ? 1 : 0;

712 
›t_ud≥nˇµ‹t
=
	`©oi
(
c⁄fig
[
CONFIG_UDP_ENCAP_PORT
]);

714 i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_NATT_MODE
], "natt")) {

715 
›t_«â_mode
 = 
NATT_NORMAL
;

716 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_NATT_MODE
], "none")) {

717 
›t_«â_mode
 = 
NATT_NONE
;

718 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_NATT_MODE
], "force-natt")) {

719 
›t_«â_mode
 = 
NATT_FORCE
;

720 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_NATT_MODE
], "cisco-udp")) {

721 
›t_«â_mode
 = 
NATT_CISCO_UDP
;

723 
	`¥ötf
("%s: unknow¿«àåavîß»modê%s\nknow¿modes:Ç©àn⁄êf‹˚-«â cisco-udp\n", 
¨gv
[0], 
c⁄fig
[
CONFIG_NATT_MODE
]);

724 
	`exô
(1);

727 i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_IF_MODE
], "tun")) {

728 
›t_if_mode
 = 
IF_MODE_TUN
;

729 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_IF_MODE
], "tap")) {

730 
›t_if_mode
 = 
IF_MODE_TAP
;

732 
	`¥ötf
("%s: unknow¿öãrÁ˚ modê%s\nknow¿modes:Åu¿èp\n", 
¨gv
[0], 
c⁄fig
[
CONFIG_IF_MODE
]);

733 
	`exô
(1);

736 i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_VENDOR
], "cisco")) {

737 
›t_víd‹
 = 
VENDOR_CISCO
;

738 } i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_VENDOR
], "netscreen")) {

739 
›t_víd‹
 = 
VENDOR_NETSCREEN
;

741 
	`¥ötf
("%s: unknow¿víd‹ %s\nknow¿víd‹s: ciscÿ√ts¸ìn\n", 
¨gv
[0], 
c⁄fig
[
CONFIG_VENDOR
]);

742 
	`exô
(1);

746 i‡(
›t_debug
 >= 99) {

747 
	`¥ötf
("WARNING!áctive debugÜevel is >= 99, output includes usernameándÖassword (hexÉncoded)\n");

748 
	`Ârötf
(
°dîr
,

752 
	`c⁄fig_deobfusˇã
(
CONFIG_IPSEC_SECRET_OBF
, 
CONFIG_IPSEC_SECRET
);

753 
	`c⁄fig_deobfusˇã
(
CONFIG_XAUTH_PASSWORD_OBF
, 
CONFIG_XAUTH_PASSWORD
);

755 
i
 = 0; i < 
LAST_CONFIG
; i++) {

756 i‡(
c⁄fig
[
i
] !
NULL
 || c⁄fig[
CONFIG_NON_INTERACTIVE
] != NULL)

758 i‡(
c⁄fig
[
CONFIG_XAUTH_INTERACTIVE
] && 
i
 =
CONFIG_XAUTH_PASSWORD
)

761 
s
 = 
NULL
;

762 
s_Àn
 = 0;

764 
i
) {

765 
CONFIG_IPSEC_GATEWAY
:

766 
	`¥ötf
("Enter IPSec gatewayáddress: ");

768 
CONFIG_IPSEC_ID
:

769 
	`¥ötf
("E¡î IPSe¯ID f‹ %s: ", 
c⁄fig
[
CONFIG_IPSEC_GATEWAY
]);

771 
CONFIG_IPSEC_SECRET
:

772 
	`¥ötf
("Enter IPSec secret for %s@%s: ",

773 
c⁄fig
[
CONFIG_IPSEC_ID
], c⁄fig[
CONFIG_IPSEC_GATEWAY
]);

775 
CONFIG_XAUTH_USERNAME
:

776 
	`¥ötf
("E¡î u£∫amêf‹ %s: ", 
c⁄fig
[
CONFIG_IPSEC_GATEWAY
]);

778 
CONFIG_XAUTH_PASSWORD
:

779 
	`¥ötf
("EnterÖassword for %s@%s: ",

780 
c⁄fig
[
CONFIG_XAUTH_USERNAME
],

781 
c⁄fig
[
CONFIG_IPSEC_GATEWAY
]);

784 
	`fÊush
(
°dout
);

785 
i
) {

786 
CONFIG_IPSEC_SECRET
:

787 
CONFIG_XAUTH_PASSWORD
:

788 
s
 = 
	`°rdup
(
	`gë∑ss
(""));

790 
CONFIG_IPSEC_GATEWAY
:

791 
CONFIG_IPSEC_ID
:

792 
CONFIG_XAUTH_USERNAME
:

793 
	`gëlöe
(&
s
, &
s_Àn
, 
°dö
);

795 i‡(
s
 !
NULL
 && 
	`°æí
(s) > 0 && s[strlen(s) - 1] == '\n')

796 
s
[
	`°æí
(s) - 1] = 0;

797 
c⁄fig
[
i
] = 
s
;

800 i‡(
¥öt_c⁄fig
) {

801 
	`Ârötf
(
°dîr
, "vpnc.conf:\n\n");

802 
i
 = 0; 
c⁄fig_«mes
[i].
«me
 !
NULL
; i++) {

803 i‡(
c⁄fig
[
c⁄fig_«mes
[
i
].
nm
] =
NULL
)

805 
	`¥ötf
("%s%s\n", 
c⁄fig_«mes
[
i
].
«me
,

806 
c⁄fig_«mes
[
i
].
√edsArgumít
 ?

807 
c⁄fig
[
c⁄fig_«mes
[
i
].
nm
] : "");

809 
	`exô
(0);

812 i‡(!
c⁄fig
[
CONFIG_IPSEC_GATEWAY
])

813 
	`îr‹
(1, 0, "missing IPSec gatwayáddress");

814 i‡(!
c⁄fig
[
CONFIG_IPSEC_ID
])

815 
	`îr‹
(1, 0, "missing IPSec ID");

816 i‡(!
c⁄fig
[
CONFIG_IPSEC_SECRET
])

817 
	`îr‹
(1, 0, "missing IPSec secret");

818 i‡(!
c⁄fig
[
CONFIG_XAUTH_USERNAME
])

819 
	`îr‹
(1, 0, "missing Xauth username");

820 i‡(!
c⁄fig
[
CONFIG_XAUTH_PASSWORD
] && !c⁄fig[
CONFIG_XAUTH_INTERACTIVE
])

821 
	`îr‹
(1, 0, "missing XauthÖassword");

822 i‡(
	`gë_dh_group_ike
(Ë=
NULL
)

823 
	`îr‹
(1, 0, "IKE DH Grou∞\"%s\" unsuµ‹ãd\n", 
c⁄fig
[
CONFIG_IKE_DH
]);

824 i‡(
	`gë_dh_group_ù£c
(-1Ë=
NULL
)

825 
	`îr‹
(1, 0, "Perfect Forward Secrecy \"%s\" unsupported\n",

826 
c⁄fig
[
CONFIG_IPSEC_PFS
]);

827 i‡(
	`gë_dh_group_ike
()->
ike_ß_id
 == 0)

828 
	`îr‹
(1, 0, "IKE DH Group mustÇot beÇopfs\n");

831 
	}
}

	@config.h

21 #i‚de‡
__CONFIG_H__


22 
	#__CONFIG_H__


	)

24 
	~<uni°d.h
>

25 
	~<öây≥s.h
>

27 
	~"v≤c-debug.h
"

29 
	ec⁄fig_íum
 {

30 
	mCONFIG_SCRIPT
,

31 
	mCONFIG_DEBUG
,

32 
	mCONFIG_DOMAIN
,

33 
	mCONFIG_ENABLE_1DES
,

34 
	mCONFIG_ENABLE_NO_ENCRYPTION
,

35 
	mCONFIG_ND
,

36 
	mCONFIG_NON_INTERACTIVE
,

37 
	mCONFIG_PID_FILE
,

38 
	mCONFIG_LOCAL_ADDR
,

39 
	mCONFIG_LOCAL_PORT
,

40 
	mCONFIG_VERSION
,

41 
	mCONFIG_IF_NAME
,

42 
	mCONFIG_IF_MODE
,

43 
	mCONFIG_IKE_DH
,

44 
	mCONFIG_IPSEC_PFS
,

45 
	mCONFIG_IPSEC_GATEWAY
,

46 
	mCONFIG_IPSEC_TARGET_NETWORK
,

47 
	mCONFIG_IPSEC_ID
,

48 
	mCONFIG_IPSEC_SECRET
,

49 
	mCONFIG_IPSEC_SECRET_OBF
,

50 
	mCONFIG_XAUTH_USERNAME
,

51 
	mCONFIG_XAUTH_PASSWORD
,

52 
	mCONFIG_XAUTH_PASSWORD_OBF
,

53 
	mCONFIG_XAUTH_INTERACTIVE
,

54 
	mCONFIG_VENDOR
,

55 
	mCONFIG_NATT_MODE
,

56 
	mCONFIG_UDP_ENCAP_PORT
,

57 
	mCONFIG_DPD_IDLE
,

58 
	mCONFIG_AUTH_MODE
,

59 
	mCONFIG_CA_FILE
,

60 
	mCONFIG_CA_DIR
,

61 
	mLAST_CONFIG


64 
	ehex_dump_íum
 {

65 
	mDUMP_UINT8
 = -1,

66 
	mDUMP_UINT16
 = -2,

67 
	mDUMP_UINT32
 = -4

70 
	evíd‹_íum
 {

71 
	mVENDOR_CISCO
,

72 
	mVENDOR_NETSCREEN


75 
	e«â_mode_íum
 {

76 
	mNATT_NONE
,

77 
	mNATT_NORMAL
,

78 
	mNATT_FORCE
,

79 
	mNATT_CISCO_UDP


82 
	eif_mode_íum
 {

83 
	mIF_MODE_TUN
,

84 
	mIF_MODE_TAP


87 
	eauth_mode_íum
 {

88 
	mAUTH_MODE_PSK
,

89 
	mAUTH_MODE_RSA1
,

90 
	mAUTH_MODE_RSA2
,

91 
	mAUTH_MODE_CERT
,

92 
	mAUTH_MODE_HYBRID


95 c⁄° *
c⁄fig
[
LAST_CONFIG
];

97 
víd‹_íum
 
›t_víd‹
;

98 
›t_debug
;

99 
›t_nd
;

100 
›t_1des
, 
›t_no_í¸y±i⁄
, 
›t_auth_mode
;

101 
«â_mode_íum
 
›t_«â_mode
;

102 
if_mode_íum
 
›t_if_mode
;

103 
uöt16_t
 
›t_ud≥nˇµ‹t
;

105 
	#TIMESTAMP
() ({ \

106 
°
[20]; \

107 
time_t
 
t
; \

108 
tm
 *tm; \

109 
t
 = 
	`time
(
NULL
); \

110 
tm
 = 
	`loˇ…ime
(&
t
); \

111 
	`°r·ime
(
°
, (°), "%F %T", 
tm
); \

112 
°
; \

113 })

	)

115 
	#DEBUGTOP
(
LVL
, 
COMMAND
) do { \

116 i‡(
›t_debug
 >(
LVL
)) { \

117 
	`¥ötf
("\n"); \

118 
COMMAND
; \

119 
	`¥ötf
(" [%s]\n", 
	`TIMESTAMP
()); \

121 } 0)

	)

123 
	#DEBUG
(
LVL
, 
COMMAND
) do { \

124 i‡(
›t_debug
 >(
LVL
)) { \

125 i‡(
›t_debug
 > 1) \

126 
	`¥ötf
(" "); \

127 
COMMAND
; \

129 } 0)

	)

131 
hex_dump
(c⁄° *
°r
, c⁄° *
d©a
, 
ssize_t
 
Àn
, c⁄° 
debug_°rögs
 *
decode
);

132 
do_c⁄fig
(
¨gc
, **
¨gv
);

	@decrypt-utils.c

22 
	#_GNU_SOURCE


	)

24 
	~<öây≥s.h
>

25 
	~<°dlib.h
>

26 
	~<°rög.h
>

27 
	~<uni°d.h
>

28 
	~<î∫o.h
>

30 
	~<g¸y±.h
>

32 
	~"de¸y±-utûs.h
"

35 
	$hex2bö_c
(
c
)

37 i‡((
c
 >= '0')&&(c <= '9'))

38  
c
 - '0';

39 i‡((
c
 >= 'A')&&(c <= 'F'))

40  
c
 - 'A' + 10;

41 i‡((
c
 >= 'a')&&(c <= 'f'))

42  
c
 - 'a' + 10;

44 
	}
}

46 
	$hex2bö
(c⁄° *
°r
, **
bö
, *
Àn
)

48 *
p
;

49 
i
, 
l
;

51 i‡(!
bö
)

52  
EINVAL
;

54 
i
 = 0; 
°r
[i] != '\0'; i++)

55 i‡(
	`hex2bö_c
(
°r
[
i
]) == -1)

56  
EINVAL
;

58 
l
 = 
i
;

59 i‡((
l
 & 1) != 0)

60  
EINVAL
;

61 
l
 /= 2;

63 
p
 = 
	`mÆloc
(
l
);

64 i‡(
p
 =
NULL
)

65  
ENOMEM
;

67 
i
 = 0; i < 
l
; i++)

68 
p
[
i
] = 
	`hex2bö_c
(
°r
[i*2]) << 4 | hex2bin_c(str[i*2+1]);

70 *
bö
 = 
p
;

71 i‡(
Àn
)

72 *
Àn
 = 
l
;

75 
	}
}

77 
	$deobfusˇã
(*
˘
, 
Àn
, c⁄° **
ª•
, *
ª¶íp
)

79 c⁄° *
h1
 = 
˘
;

80 c⁄° *
h4
 = 
˘
 + 20;

81 c⁄° *
íc
 = 
˘
 + 40;

83 
ht
[20], 
h2
[20], 
h3
[20], 
key
[24];

84 c⁄° *
iv
 = 
h1
;

85 *
ªs
;

86 
g¸y_cùhî_hd_t
 
˘x
;

87 
ª¶í
;

89 i‡(
Àn
 < 48)

91 
Àn
 -= 40;

93 
	`mem˝y
(
ht
, 
h1
, 20);

95 
ht
[19]++;

96 
	`g¸y_md_hash_buf„r
(
GCRY_MD_SHA1
, 
h2
, 
ht
, 20);

98 
ht
[19] += 2;

99 
	`g¸y_md_hash_buf„r
(
GCRY_MD_SHA1
, 
h3
, 
ht
, 20);

101 
	`mem˝y
(
key
, 
h2
, 20);

102 
	`mem˝y
(
key
+20, 
h3
, 4);

105 
	`g¸y_md_hash_buf„r
(
GCRY_MD_SHA1
, 
ht
, 
íc
, 
Àn
);

107 i‡(
	`memcmp
(
h4
, 
ht
, 20) != 0)

110 
ªs
 = 
	`mÆloc
(
Àn
);

111 i‡(
ªs
 =
NULL
)

114 
	`g¸y_cùhî_›í
(&
˘x
, 
GCRY_CIPHER_3DES
, 
GCRY_CIPHER_MODE_CBC
, 0);

115 
	`g¸y_cùhî_£tkey
(
˘x
, 
key
, 24);

116 
	`g¸y_cùhî_£tiv
(
˘x
, 
iv
, 8);

117 
	`g¸y_cùhî_de¸y±
(
˘x
, (*)
ªs
, 
Àn
, (*)
íc
,Üen);

118 
	`g¸y_cùhî_˛o£
(
˘x
);

120 
ª¶í
 = 
Àn
 - 
ªs
[len-1];

121 
ªs
[
ª¶í
] = '\0';

123 i‡(
ª•
)

124 *
ª•
 = 
ªs
;

125 i‡(
ª¶íp
)

126 *
ª¶íp
 = 
ª¶í
;

128 
	}
}

	@decrypt-utils.h

22 #i‚de‡
__DECRYPT_UTILS_H__


23 
	#__DECRYPT_UTILS_H__


	)

25 
hex2bö
(c⁄° *
°r
, **
bö
, *
Àn
);

26 
deobfusˇã
(*
˘
, 
Àn
, c⁄° **
ª•
, *
ª¶íp
);

	@dh.c

35 
	~"m©h_group.h
"

36 
	~"dh.h
"

42 
	$dh_gëÀn
(
group
 *group)

44  
group
->
	`gëÀn
(group);

45 
	}
}

53 
	$dh_¸óã_exch™ge
(
group
 *group, *
buf
)

55 i‡(
group
->
	`£å™dom
(group, group->
c
))

57 i‡(
group
->
	`›î©i⁄
(group, group->
a
, group->
gí
, group->
c
))

59 
group
->
	`gëøw
(group, group->
a
, 
buf
);

61 
	}
}

68 
	$dh_¸óã_sh¨ed
(
group
 *group, *
£¸ë
, *
exch™ge
)

70 i‡(
group
->
	`£åaw
(group, group->
b
, 
exch™ge
, group->
	`gëÀn
(group)))

72 i‡(
group
->
	`›î©i⁄
(group, group->
a
, group->
b
, group->
c
))

74 
group
->
	`gëøw
(group, group->
a
, 
£¸ë
);

76 
	}
}

	@dh.h

34 #i‚de‡
__DH_H__


35 
	#__DH_H__


	)

37 
	~<sys/ty≥s.h
>

39 
	ggroup
;

41 
dh_gëÀn
(
group
 *);

42 
dh_¸óã_exch™ge
(
group
 *, *);

43 
dh_¸óã_sh¨ed
(
group
 *, *, *);

	@error.h

1 
	#IPPROTO_ENCAP
 98

	)

22 #i‚de‡
_ERROR_H


23 
	#_ERROR_H
 1

	)

25 
	~<„©uªs.h
>

28 
__BEGIN_DECLS


34 
	$îr‹
 (
__°©us
, 
__î∫um
, 
__c⁄°
 *
__f‹m©
, ...)

35 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 3, 4)));

37 
	$îr‹_©_löe
 (
__°©us
, 
__î∫um
, 
__c⁄°
 *
__‚ame
,

38 
__löío
, 
__c⁄°
 *
__f‹m©
, ...)

39 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 5, 6)));

44 (*
îr‹_¥öt_¥og«me
) ();

47 
îr‹_mesßge_cou¡
;

51 
îr‹_⁄e_≥r_löe
;

54 #i‡
deföed
 
__exã∫_Æways_ölöe
 && deföed 
__va_¨g_∑ck


55 
	~<bôs/îr‹.h
>

58 
__END_DECLS


	@hacks.h

1 #i‚de‡
_HACKS_H


2 
	#_HACKS_H
 1

	)

4 
	#IPPROTO_ENCAP
 98

	)

6 
ssize_t


7 
	$gëlöe
(**
outbuf
, 
size_t
 *
outsize
, 
FILE
 *
Â
)

9 *
buf
;

10 
size_t
 
Àn
;

12 
buf
 = 
	`fgë 
(
Â
, &
Àn
);

13 i‡(
buf
 =
NULL
)

17 i‡(*
outbuf
 =
NULL
 || *
outsize
 < 
Àn
 + 1) {

18 *
tmp
 = 
	`ªÆloc
(*
outbuf
, 
Àn
 + 1);

19 i‡(
tmp
 =
NULL
)

21 *
outbuf
 = 
tmp
;

22 *
outsize
 = 
Àn
 + 1;

24 
	`mem˝y
(*
outbuf
, 
buf
, 
Àn
);

25 (*
outbuf
)[
Àn
] = '\0';

26  (
Àn
);

27 
	}
}

	@isakmp-pkt.c

22 
	~<as£π.h
>

23 
	~<°dlib.h
>

24 
	~<°rög.h
>

25 
	~<î∫o.h
>

26 
	~<°dio.h
>

28 
	~"sysdï.h
"

29 
	~"c⁄fig.h
"

30 
	~"ißkmp-pkt.h
"

31 
	~"m©h_group.h
"

32 
	~"v≤c.h
"

34 *
	$xÆlocc
(
size_t
 
x
)

36 *
ªsu…
;

37 
ªsu…
 = 
	`ˇŒoc
(1, 
x
);

38 i‡(
ªsu…
 =
NULL
)

39 
	`îr‹
(1, 
î∫o
, "mÆlo¯o‡%lu byã†Áûed", ()
x
);

40  
ªsu…
;

41 
	}
}

43 
	sÊow
 {

44 
size_t
 
	mÀn
;

45 
uöt8_t
 *
	mba£
;

46 
uöt8_t
 *
	míd
;

49 
uöt8_t
 *
	$Êow_ª£rve_p
(
Êow
 *
f
, 
size_t
 
sz
)

51 
size_t
 
l
 = 
f
->
íd
 - f->
ba£
;

52 i‡(
l
 + 
sz
 > 
f
->
Àn
) {

53 
size_t
 
√w_Àn
 = 
f
->
Àn
 == 0 ? 128 : f->len;

54 
l
 + 
sz
 >
√w_Àn
)

55 
√w_Àn
 *= 2;

57 i‡(
f
->
ba£
 =
NULL
)

58 
f
->
ba£
 = 
	`mÆloc
(
√w_Àn
);

60 
f
->
ba£
 = 
	`ªÆloc
(f->ba£, 
√w_Àn
);

61 i‡(
f
->
ba£
 =
NULL
)

62 
	`îr‹
(1, 
î∫o
, "Ælo¯o‡%lud byã†Áûed", ()
√w_Àn
);

63 
	`mem£t
(
f
->
ba£
 + f->
Àn
, 0, 
√w_Àn
 - f->len);

64 
f
->
íd
 = f->
ba£
 + 
l
;

65 
f
->
Àn
 = 
√w_Àn
;

67 
f
->
íd
 +
sz
;

68  
f
->
íd
 - 
sz
;

69 
	}
}

71 
size_t
 
	$Êow_ª£rve
(
Êow
 *
f
, 
size_t
 
sz
)

73 
uöt8_t
 *
p
 = 
	`Êow_ª£rve_p
(
f
, 
sz
);

74  
p
 - 
f
->
ba£
;

75 
	}
}

77 
	$Êow_x
(
Êow
 *
f
, 
uöt8_t
 * 
d©a
, 
size_t
 
d©a_Àn
)

79 
	`mem˝y
(
	`Êow_ª£rve_p
(
f
, 
d©a_Àn
), 
d©a
, data_len);

80 
	}
}

82 
	$Êow_1
(
Êow
 *
f
, 
uöt8_t
 
d
)

84 
	`Êow_ª£rve_p
(
f
, 1)[0] = 
d
;

85 
	}
}

87 
	$Êow_2
(
Êow
 *
f
, 
uöt16_t
 
d
)

89 
uöt8_t
 
dd
[2];

90 
dd
[0] = 
d
 >> 8;

91 
dd
[1] = 
d
;

92 
	`Êow_x
(
f
, 
dd
, (dd));

93 
	}
}

95 
	$Êow_4
(
Êow
 *
f
, 
uöt32_t
 
d
)

97 
uöt8_t
 
dd
[4];

98 
dd
[0] = 
d
 >> 24;

99 
dd
[1] = 
d
 >> 16;

100 
dd
[2] = 
d
 >> 8;

101 
dd
[3] = 
d
;

102 
	`Êow_x
(
f
, 
dd
, (dd));

103 
	}
}

105 
	$öô_Êow
(
Êow
 *
f
)

107 
	`mem£t
(
f
, 0, (*f));

108 
	}
}

110 
	$Êow_©åibuã
(
Êow
 *
f
, 
ißkmp_©åibuã
 *
p
)

112 ; 
p
;Ö =Ö->
√xt
)

113 
p
->
af
) {

114 
ißkmp_©å_lŸs
:

115 
	`Êow_2
(
f
, 
p
->
ty≥
);

116 
	`Êow_2
(
f
, 
p
->
u
.
lŸs
.
Àngth
);

117 
	`Êow_x
(
f
, 
p
->
u
.
lŸs
.
d©a
,Ö->u.lŸs.
Àngth
);

119 
ißkmp_©å_16
:

120 
	`Êow_2
(
f
, 
p
->
ty≥
 | 0x8000);

121 
	`Êow_2
(
f
, 
p
->
u
.
©å_16
);

123 
ißkmp_©å_2x8
:

124 
	`Êow_2
(
f
, 
p
->
ty≥
 | 0x8000);

125 
	`Êow_x
(
f
, 
p
->
u
.
©å_2x8
, 2);

128 
	`ab‹t
();

130 
	}
}

132 
	$Êow_∑ylﬂd
(
Êow
 *
f
, 
ißkmp_∑ylﬂd
 *
p
)

134 
size_t
 
Õos
;

135 
size_t
 
ba£Àn
;

137 i‡(
p
 =
NULL
)

140 
ba£Àn
 = 
f
->
íd
 - f->
ba£
;

141 i‡(
p
->
√xt
 =
NULL
)

142 
	`Êow_1
(
f
, 0);

144 
	`Êow_1
(
f
, 
p
->
√xt
->
ty≥
);

145 
	`Êow_1
(
f
, 0);

146 
Õos
 = 
	`Êow_ª£rve
(
f
, 2);

147 
p
->
ty≥
) {

148 
ISAKMP_PAYLOAD_SA
:

149 
	`Êow_4
(
f
, 
p
->
u
.
ß
.
doi
);

150 
	`Êow_4
(
f
, 
p
->
u
.
ß
.
sôu©i⁄
);

151 
	`Êow_∑ylﬂd
(
f
, 
p
->
u
.
ß
.
¥›oßls
);

153 
ISAKMP_PAYLOAD_P
:

154 
	`Êow_1
(
f
, 
p
->
u
.p.
numbî
);

155 
	`Êow_1
(
f
, 
p
->
u
.p.
¥Ÿ_id
);

156 
	`Êow_1
(
f
, 
p
->
u
.p.
•i_size
);

158 
uöt8_t
 
num_xf‹m
 = 0;

159 
ißkmp_∑ylﬂd
 *
xf‹m
;

160 
xf‹m
 = 
p
->
u
.p.
å™sf‹ms
; xf‹m; xf‹m = xf‹m->
√xt
)

161 
num_xf‹m
++;

162 
	`Êow_1
(
f
, 
num_xf‹m
);

164 
	`Êow_x
(
f
, 
p
->
u
.p.
•i
,Ö->u.p.
•i_size
);

165 
	`Êow_∑ylﬂd
(
f
, 
p
->
u
.p.
å™sf‹ms
);

167 
ISAKMP_PAYLOAD_T
:

168 
	`Êow_1
(
f
, 
p
->
u
.
t
.
numbî
);

169 
	`Êow_1
(
f
, 
p
->
u
.
t
.
id
);

170 
	`Êow_2
(
f
, 0);

171 
	`Êow_©åibuã
(
f
, 
p
->
u
.
t
.
©åibuãs
);

173 
ISAKMP_PAYLOAD_KE
:

174 
ISAKMP_PAYLOAD_HASH
:

175 
ISAKMP_PAYLOAD_SIG
:

176 
ISAKMP_PAYLOAD_NONCE
:

177 
ISAKMP_PAYLOAD_VID
:

178 
ISAKMP_PAYLOAD_NAT_D
:

179 
ISAKMP_PAYLOAD_NAT_D_OLD
:

180 
	`Êow_x
(
f
, 
p
->
u
.
ke
.
d©a
,Ö->u.ke.
Àngth
);

182 
ISAKMP_PAYLOAD_ID
:

183 
	`Êow_1
(
f
, 
p
->
u
.
id
.
ty≥
);

184 
	`Êow_1
(
f
, 
p
->
u
.
id
.
¥Ÿocﬁ
);

185 
	`Êow_2
(
f
, 
p
->
u
.
id
.
p‹t
);

186 
	`Êow_x
(
f
, 
p
->
u
.
id
.
d©a
,Ö->u.id.
Àngth
);

188 
ISAKMP_PAYLOAD_CERT
:

189 
ISAKMP_PAYLOAD_CR
:

190 
	`Êow_1
(
f
, 
p
->
u
.
˚π
.
ícodög
);

191 
	`Êow_x
(
f
, 
p
->
u
.
˚π
.
d©a
,Ö->u.˚π.
Àngth
);

193 
ISAKMP_PAYLOAD_N
:

194 
	`Êow_4
(
f
, 
p
->
u
.
n
.
doi
);

195 
	`Êow_1
(
f
, 
p
->
u
.
n
.
¥Ÿocﬁ
);

196 
	`Êow_1
(
f
, 
p
->
u
.
n
.
•i_Àngth
);

197 
	`Êow_2
(
f
, 
p
->
u
.
n
.
ty≥
);

198 
	`Êow_x
(
f
, 
p
->
u
.
n
.
•i
,Ö->u.n.
•i_Àngth
);

199 
	`Êow_x
(
f
, 
p
->
u
.
n
.
d©a
,Ö->u.n.
d©a_Àngth
);

201 
ISAKMP_PAYLOAD_D
:

202 
	`Êow_4
(
f
, 
p
->
u
.
d
.
doi
);

203 
	`Êow_1
(
f
, 
p
->
u
.
d
.
¥Ÿocﬁ
);

204 
	`Êow_1
(
f
, 
p
->
u
.
d
.
•i_Àngth
);

205 
	`Êow_2
(
f
, 
p
->
u
.
d
.
num_•i
);

206 i‡(
p
->
u
.
d
.
•i_Àngth
 > 0) {

207 
i
;

208 
i
 = 0; i < 
p
->
u
.
d
.
num_•i
; i++)

209 
	`Êow_x
(
f
, 
p
->
u
.
d
.
•i
[
i
],Ö->u.d.
•i_Àngth
);

212 
ISAKMP_PAYLOAD_MODECFG_ATTR
:

213 
	`Êow_1
(
f
, 
p
->
u
.
modecfg
.
ty≥
);

214 
	`Êow_1
(
f
, 0);

215 
	`Êow_2
(
f
, 
p
->
u
.
modecfg
.
id
);

216 
	`Êow_©åibuã
(
f
, 
p
->
u
.
modecfg
.
©åibuãs
);

219 
	`ab‹t
();

221 
f
->
ba£
[
Õos
] = (f->
íd
 - f->ba£ - 
ba£Àn
) >> 8;

222 
f
->
ba£
[
Õos
 + 1] = (f->
íd
 - f->ba£ - 
ba£Àn
);

223 
	`Êow_∑ylﬂd
(
f
, 
p
->
√xt
);

224 
	}
}

226 
	$Ê©ãn_ißkmp_∑ylﬂds
(
ißkmp_∑ylﬂd
 *
p
, 
uöt8_t
 ** 
ªsu…
, 
size_t
 * 
size
)

228 
Êow
 
f
;

229 
	`öô_Êow
(&
f
);

230 
	`Êow_∑ylﬂd
(&
f
, 
p
);

231 *
ªsu…
 = 
f
.
ba£
;

232 *
size
 = 
f
.
íd
 - f.
ba£
;

233 
	}
}

235 
	$Ê©ãn_ißkmp_∑ylﬂd
(
ißkmp_∑ylﬂd
 *
p
, 
uöt8_t
 ** 
ªsu…
, 
size_t
 * 
size
)

237 
ißkmp_∑ylﬂd
 *
√xt
;

238 
√xt
 = 
p
->next;

239 
p
->
√xt
 = 
NULL
;

240 
	`Ê©ãn_ißkmp_∑ylﬂds
(
p
, 
ªsu…
, 
size
);

241 
p
->
√xt
 =Çext;

242 
	}
}

244 
	$Ê©ãn_ißkmp_∑ckë
(
ißkmp_∑ckë
 *
p
, 
uöt8_t
 ** 
ªsu…
, 
size_t
 * 
size
, size_à
blksz
)

246 
Êow
 
f
;

247 
size_t
 
Õos
, 
sz
, 
∑ddög
;

249 
	`öô_Êow
(&
f
);

250 
	`Êow_x
(&
f
, 
p
->
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

251 
	`Êow_x
(&
f
, 
p
->
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

252 i‡(
p
->
∑ylﬂd
 =
NULL
)

253 
	`Êow_1
(&
f
, 0);

255 
	`Êow_1
(&
f
, 
p
->
∑ylﬂd
->
ty≥
);

256 
	`Êow_1
(&
f
, 
p
->
ißkmp_vîsi⁄
);

257 
	`Êow_1
(&
f
, 
p
->
exch™ge_ty≥
);

258 
	`Êow_1
(&
f
, 
p
->
Êags
);

259 
	`Êow_4
(&
f
, 
p
->
mesßge_id
);

260 
Õos
 = 
	`Êow_ª£rve
(&
f
, 4);

261 
	`Êow_∑ylﬂd
(&
f
, 
p
->
∑ylﬂd
);

262 i‡(
p
->
Êags
 & 
ISAKMP_FLAG_E
) {

263 
	`as£π
(
blksz
 != 0);

264 
sz
 = (
f
.
íd
 - f.
ba£
Ë- 
ISAKMP_PAYLOAD_O
;

265 
∑ddög
 = 
blksz
 - (
sz
 % blksz);

266 i‡(
∑ddög
 =
blksz
)

267 
∑ddög
 = 0;

268 
	`DEBUG
(3, 
	`¥ötf
("size = %ld, blksz = %ld,Öadding = %ld\n",

269 ()
sz
, ()
blksz
, ()
∑ddög
));

270 
	`Êow_ª£rve
(&
f
, 
∑ddög
);

272 
f
.
ba£
[
Õos
] = (f.
íd
 - f.base) >> 24;

273 
f
.
ba£
[
Õos
 + 1] = (f.
íd
 - f.base) >> 16;

274 
f
.
ba£
[
Õos
 + 2] = (f.
íd
 - f.base) >> 8;

275 
f
.
ba£
[
Õos
 + 3] = (f.
íd
 - f.base);

276 *
ªsu…
 = 
f
.
ba£
;

277 *
size
 = 
f
.
íd
 - f.
ba£
;

278  i‡(
›t_debug
 >= 3) {

279 
	`¥ötf
("\n sending: ========================>\n");

280 
	`‰ì_ißkmp_∑ckë
(
	`∑r£_ißkmp_∑ckë
(
f
.
ba£
, f.
íd
 - f.ba£, 
NULL
));

282 
	}
}

284 
ißkmp_©åibuã
 *
	$√w_ißkmp_©åibuã
(
uöt16_t
 
ty≥
, 
ißkmp_©åibuã
 *
√xt
)

286 
ißkmp_©åibuã
 *
r
 = 
	`xÆlocc
((isakmp_attribute));

287 
r
->
ty≥
 =Åype;

288 
r
->
√xt
 =Çext;

289  
r
;

290 
	}
}

292 
ißkmp_©åibuã
 *
	$√w_ißkmp_©åibuã_16
(
uöt16_t
 
ty≥
, uöt16_à
d©a
,

293 
ißkmp_©åibuã
 *
√xt
)

295 
ißkmp_©åibuã
 *
r
 = 
	`xÆlocc
((isakmp_attribute));

296 
r
->
√xt
 =Çext;

297 
r
->
ty≥
 =Åype;

298 
r
->
af
 = 
ißkmp_©å_16
;

299 
r
->
u
.
©å_16
 = 
d©a
;

300  
r
;

301 
	}
}

303 
ißkmp_∑ckë
 *
	$√w_ißkmp_∑ckë
()

305  
	`xÆlocc
((
ißkmp_∑ckë
));

306 
	}
}

308 
ißkmp_∑ylﬂd
 *
	$√w_ißkmp_∑ylﬂd
(
uöt8_t
 
ty≥
)

310 
ißkmp_∑ylﬂd
 *
ªsu…
 = 
	`xÆlocc
((isakmp_payload));

311 
ªsu…
->
ty≥
 =Åype;

312  
ªsu…
;

313 
	}
}

315 
ißkmp_∑ylﬂd
 *
	$√w_ißkmp_d©a_∑ylﬂd
(
uöt8_t
 
ty≥
, c⁄° *
d©a
, 
size_t
 
d©a_Àngth
)

317 
ißkmp_∑ylﬂd
 *
ªsu…
 = 
	`xÆlocc
((isakmp_payload));

319 i‡(
ty≥
 !
ISAKMP_PAYLOAD_KE
 &&Åy≥ !
ISAKMP_PAYLOAD_HASH


320 && 
ty≥
 !
ISAKMP_PAYLOAD_SIG
 &&Åy≥ !
ISAKMP_PAYLOAD_NONCE


321 && 
ty≥
 !
ISAKMP_PAYLOAD_VID
 &&Åy≥ !
ISAKMP_PAYLOAD_NAT_D


322 && 
ty≥
 !
ISAKMP_PAYLOAD_NAT_D_OLD
)

323 
	`ab‹t
();

324 i‡(
d©a_Àngth
 >= 16384)

325 
	`ab‹t
();

327 
ªsu…
->
ty≥
 =Åype;

328 
ªsu…
->
u
.
ke
.
Àngth
 = 
d©a_Àngth
;

329 
ªsu…
->
u
.
ke
.
d©a
 = 
	`xÆlocc
(
d©a_Àngth
);

330 
	`mem˝y
(
ªsu…
->
u
.
ke
.
d©a
, d©a, 
d©a_Àngth
);

331  
ªsu…
;

332 
	}
}

334 
	$‰ì_ißkmp_∑ylﬂd
(
ißkmp_∑ylﬂd
 *
p
)

336 
ißkmp_∑ylﬂd
 *
nxt
;

338 i‡(
p
 =
NULL
)

341 
p
->
ty≥
) {

342 
ISAKMP_PAYLOAD_SA
:

343 
	`‰ì_ißkmp_∑ylﬂd
(
p
->
u
.
ß
.
¥›oßls
);

345 
ISAKMP_PAYLOAD_P
:

346 
	`‰ì
(
p
->
u
.p.
•i
);

347 
	`‰ì_ißkmp_∑ylﬂd
(
p
->
u
.p.
å™sf‹ms
);

349 
ISAKMP_PAYLOAD_T
:

351 
ißkmp_©åibuã
 *
©t
, *
«â
;

352 
©t
 = 
p
->
u
.
t
.
©åibuãs
;áâ;áâ = 
«â
) {

353 
«â
 = 
©t
->
√xt
;

354 i‡(
©t
->
af
 =
ißkmp_©å_lŸs
)

355 
	`‰ì
(
©t
->
u
.
lŸs
.
d©a
);

356 
	`‰ì
(
©t
);

360 
ISAKMP_PAYLOAD_KE
:

361 
ISAKMP_PAYLOAD_HASH
:

362 
ISAKMP_PAYLOAD_SIG
:

363 
ISAKMP_PAYLOAD_NONCE
:

364 
ISAKMP_PAYLOAD_VID
:

365 
ISAKMP_PAYLOAD_NAT_D
:

366 
ISAKMP_PAYLOAD_NAT_D_OLD
:

367 
	`‰ì
(
p
->
u
.
ke
.
d©a
);

369 
ISAKMP_PAYLOAD_ID
:

370 
	`‰ì
(
p
->
u
.
id
.
d©a
);

372 
ISAKMP_PAYLOAD_CERT
:

373 
ISAKMP_PAYLOAD_CR
:

374 
	`‰ì
(
p
->
u
.
˚π
.
d©a
);

376 
ISAKMP_PAYLOAD_N
:

377 
	`‰ì
(
p
->
u
.
n
.
•i
);

378 
	`‰ì
(
p
->
u
.
n
.
d©a
);

380 
ISAKMP_PAYLOAD_D
:

381 i‡(
p
->
u
.
d
.
•i
) {

382 
i
;

383 
i
 = 0; i < 
p
->
u
.
d
.
num_•i
; i++)

384 
	`‰ì
(
p
->
u
.
d
.
•i
[
i
]);

385 
	`‰ì
(
p
->
u
.
d
.
•i
);

388 
ISAKMP_PAYLOAD_MODECFG_ATTR
:

390 
ißkmp_©åibuã
 *
©t
, *
«â
;

391 
©t
 = 
p
->
u
.
modecfg
.
©åibuãs
;áâ;áâ = 
«â
) {

392 
«â
 = 
©t
->
√xt
;

393 i‡(
©t
->
af
 =
ißkmp_©å_lŸs
)

394 
	`‰ì
(
©t
->
u
.
lŸs
.
d©a
);

395 i‡(
©t
->
af
 =
ißkmp_©å_a˛
)

396 
	`‰ì
(
©t
->
u
.
a˛
.
a˛_ít
);

397 
	`‰ì
(
©t
);

402 
	`ab‹t
();

405 
nxt
 = 
p
->
√xt
;

406 
	`‰ì
(
p
);

407 
	`‰ì_ißkmp_∑ylﬂd
(
nxt
);

408 
	}
}

410 
	$‰ì_ißkmp_∑ckë
(
ißkmp_∑ckë
 *
p
)

412 i‡(
p
 =
NULL
)

414 
	`‰ì_ißkmp_∑ylﬂd
(
p
->
∑ylﬂd
);

415 
	`‰ì
(
p
);

416 
	}
}

418 c⁄° 
debug_°rögs
 *
	$å™sf‹m_id_to_debug_°rögs
(
ißkmp_ù£c_¥Ÿo_íum
 
decode_¥Ÿo
)

420 
decode_¥Ÿo
) {

421 
ISAKMP_IPSEC_PROTO_ISAKMP
:

422  
ißkmp_ù£c_key_íum_¨øy
;

423 
ISAKMP_IPSEC_PROTO_IPSEC_AH
:

424  
ißkmp_ù£c_ah_íum_¨øy
;

425 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
:

426  
ißkmp_ù£c_e•_íum_¨øy
;

427 
ISAKMP_IPSEC_PROTO_IPCOMP
:

428  
ißkmp_ù£c_ùcomp_íum_¨øy
;

430  
NULL
;

432 
	}
}

434 c⁄° 
debug_°rögs
 *
	$©å_ty≥_to_debug_°rögs
(
ißkmp_ù£c_¥Ÿo_íum
 
decode_¥Ÿo
)

436 
decode_¥Ÿo
) {

437 
ISAKMP_IPSEC_PROTO_ISAKMP
:

438  
ike_©å_íum_¨øy
;

439 
ISAKMP_IPSEC_PROTO_IPSEC_AH
:

440 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
:

441  
ißkmp_ù£c_©å_íum_¨øy
;

442 
ISAKMP_IPSEC_PROTO_MODECFG
:

443  
ißkmp_modecfg_©åib_íum_¨øy
;

445  
NULL
;

447 
	}
}

449 c⁄° 
debug_°rögs
 *
	$©å_vÆ_to_debug_°rögs
(
ißkmp_ù£c_¥Ÿo_íum
 
decode_¥Ÿo
, 
uöt16_t
 
ty≥
)

451 
decode_¥Ÿo
) {

452 
ISAKMP_IPSEC_PROTO_ISAKMP
:

453 
ty≥
) {

454 
IKE_ATTRIB_ENC
:  
ike_íc_íum_¨øy
;

455 
IKE_ATTRIB_HASH
:  
ike_hash_íum_¨øy
;

456 
IKE_ATTRIB_AUTH_METHOD
:  
ike_auth_íum_¨øy
;

457 
IKE_ATTRIB_GROUP_DESC
:  
ike_group_íum_¨øy
;

458 
IKE_ATTRIB_GROUP_TYPE
:  
ike_group_ty≥_íum_¨øy
;

459 
IKE_ATTRIB_LIFE_TYPE
:  
ike_li„_íum_¨øy
;

460 :  
NULL
;

462 
ISAKMP_IPSEC_PROTO_IPSEC_AH
:

463 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
:

464 
ty≥
) {

465 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
:  
ù£c_li„_íum_¨øy
;

466 
ISAKMP_IPSEC_ATTRIB_ENCAP_MODE
:  
ù£c_íˇp_íum_¨øy
;

467 
ISAKMP_IPSEC_ATTRIB_AUTH_ALG
:  
ù£c_auth_íum_¨øy
;

468 :  
NULL
;

471  
NULL
;

473 
	}
}

475 
	#„tch4
() \

476 (
d©a
 +4, 
d©a_Àn
 -= 4, \

477 (
uöt32_t
)(
d©a
[-4]) << 24 | (uint32_t)(data[-3]) << 16 \

478 | (
uöt32_t
)(
d©a
[-2]Ë<< 8 | d©a[-1])

	)

479 
	#„tch2
() \

480 (
d©a
 +2, 
d©a_Àn
 -= 2, \

481 (
uöt16_t
)(
d©a
[-2]Ë<< 8 | d©a[-1])

	)

482 
	#„tch1
(Ë(
d©a_Àn
--, *
d©a
++)

	)

483 
	#„tchn
(
d
,
n
) \

484 (
	`mem˝y
 ((
d
), 
d©a
, (
n
)), d©®+“), 
d©a_Àn
 -“))

	)

486 
ißkmp_©åibuã
 *
	$∑r£_ißkmp_©åibuãs
(c⁄° 
uöt8_t
 ** 
d©a_p
,

487 
size_t
 
d©a_Àn
, * 
ªje˘
, 
ißkmp_ù£c_¥Ÿo_íum
 
decode_¥Ÿo
)

489 c⁄° 
uöt8_t
 *
d©a
 = *
d©a_p
;

490 
ißkmp_©åibuã
 *
r
;

491 
uöt16_t
 
ty≥
, 
Àngth
;

492 
i
;

494 i‡(
d©a_Àn
 < 4)

495  
NULL
;

497 
r
 = 
	`√w_ißkmp_©åibuã
(0, 
NULL
);

498 
ty≥
 = 
	`„tch2
();

499 
Àngth
 = 
	`„tch2
();

500 i‡(
ty≥
 & 0x8000) {

501 
r
->
ty≥
 =Åype & ~0x8000;

502 
	`hex_dump
("t.©åibuãs.ty≥", &
r
->
ty≥
, 
DUMP_UINT16
, 
	`©å_ty≥_to_debug_°rögs
(
decode_¥Ÿo
));

503 
r
->
af
 = 
ißkmp_©å_16
;

504 
r
->
u
.
©å_16
 = 
Àngth
;

505 i‡((
ISAKMP_XAUTH_06_ATTRIB_TYPE
 <
r
->
ty≥
)

506 && (
r
->
ty≥
 <
ISAKMP_XAUTH_06_ATTRIB_ANSWER
)

507 && (
r
->
ty≥
 !
ISAKMP_XAUTH_06_ATTRIB_STATUS
)

508 && (
Àngth
 > 0)

509 && (
›t_debug
 < 99))

510 
	`DEBUG
(3, 
	`¥ötf
("(not dumping xauth data)\n"));

512 
	`hex_dump
("t.©åibuãs.u.©å_16", &
r
->
u
.
©å_16
, 
DUMP_UINT16
,

513 
	`©å_vÆ_to_debug_°rögs
(
decode_¥Ÿo
, 
r
->
ty≥
));

515 
r
->
ty≥
 =Åype;

516 
	`hex_dump
("t.©åibuãs.ty≥", &
r
->
ty≥
, 
DUMP_UINT16
, 
	`©å_ty≥_to_debug_°rögs
(
decode_¥Ÿo
));

517 
r
->
af
 = 
ißkmp_©å_lŸs
;

518 
r
->
u
.
lŸs
.
Àngth
 =Üength;

519 i‡((
ISAKMP_XAUTH_06_ATTRIB_TYPE
 <
r
->
ty≥
)

520 && (
r
->
ty≥
 <
ISAKMP_XAUTH_06_ATTRIB_ANSWER
)

521 && (
r
->
ty≥
 !
ISAKMP_XAUTH_06_ATTRIB_STATUS
)

522 && (
Àngth
 > 0)

523 && (
›t_debug
 < 99))

524 
	`DEBUG
(3, 
	`¥ötf
("(not dumping xauth dataÜength)\n"));

526 
	`hex_dump
("t.©åibuãs.u.lŸs.Àngth", &
r
->
u
.
lŸs
.
Àngth
, 
DUMP_UINT16
, 
NULL
);

527 i‡(
d©a_Àn
 < 
Àngth
) {

528 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

529  
r
;

531 i‡(
r
->
ty≥
 =
ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_INC
) {

532 
r
->
af
 = 
ißkmp_©å_a˛
;

533 
r
->
u
.
a˛
.
cou¡
 = 
Àngth
 / (4+4+2+2+2);

534 i‡(
r
->
u
.
a˛
.
cou¡
 * (4+4+2+2+2Ë!
Àngth
) {

535 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

536  
r
;

538 
r
->
u
.
a˛
.
a˛_ít
 = 
	`xÆlocc
‘->u.a˛.
cou¡
 * (
a˛_ít_s
));

540 
i
 = 0; i < 
r
->
u
.
a˛
.
cou¡
; i++) {

541 
	`„tchn
(&
r
->
u
.
a˛
.
a˛_ít
[
i
].
addr
.
s_addr
, 4);

542 
	`„tchn
(&
r
->
u
.
a˛
.
a˛_ít
[
i
].
mask
.
s_addr
, 4);

543 
r
->
u
.
a˛
.
a˛_ít
[
i
].
¥Ÿocﬁ
 = 
	`„tch2
();

544 
r
->
u
.
a˛
.
a˛_ít
[
i
].
•‹t
 = 
	`„tch2
();

545 
r
->
u
.
a˛
.
a˛_ít
[
i
].
dp‹t
 = 
	`„tch2
();

546 
	`hex_dump
("t.©åibuãs.u.a˛.addr", &
r
->
u
.
a˛
.
a˛_ít
[
i
].
addr
.
s_addr
, 4, 
NULL
);

547 
	`hex_dump
("t.©åibuãs.u.a˛.mask", &
r
->
u
.
a˛
.
a˛_ít
[
i
].
mask
.
s_addr
, 4, 
NULL
);

548 
	`hex_dump
("t.©åibuãs.u.a˛.¥Ÿocﬁ", &
r
->
u
.
a˛
.
a˛_ít
[
i
].
¥Ÿocﬁ
, 
DUMP_UINT16
, 
NULL
);

549 
	`hex_dump
("t.©åibuãs.u.a˛.•‹t", &
r
->
u
.
a˛
.
a˛_ít
[
i
].
•‹t
, 
DUMP_UINT16
, 
NULL
);

550 
	`hex_dump
("t.©åibuãs.u.a˛.dp‹t", &
r
->
u
.
a˛
.
a˛_ít
[
i
].
dp‹t
, 
DUMP_UINT16
, 
NULL
);

553 
r
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
(
Àngth
);

554 
	`„tchn
(
r
->
u
.
lŸs
.
d©a
, 
Àngth
);

555 i‡((
ISAKMP_XAUTH_06_ATTRIB_TYPE
 <
ty≥
)

556 && (
ty≥
 <
ISAKMP_XAUTH_06_ATTRIB_ANSWER
)

557 && (
r
->
ty≥
 !
ISAKMP_XAUTH_06_ATTRIB_STATUS
)

558 && (
Àngth
 > 0)

559 && (
›t_debug
 < 99))

560 
	`DEBUG
(3, 
	`¥ötf
("(not dumping xauth data)\n"));

562 
	`hex_dump
("t.©åibuãs.u.lŸs.d©a", 
r
->
u
.
lŸs
.
d©a
,Ñ->u.lŸs.
Àngth
, 
NULL
);

565 
r
->
√xt
 = 
	`∑r£_ißkmp_©åibuãs
(&
d©a
, 
d©a_Àn
, 
ªje˘
, 
decode_¥Ÿo
);

566 *
d©a_p
 = 
d©a
;

567  
r
;

568 
	}
}

570 
ißkmp_∑ylﬂd
 *
	$∑r£_ißkmp_∑ylﬂd
(
uöt8_t
 
ty≥
,

571 c⁄° 
uöt8_t
 ** 
d©a_p
, 
size_t
 * 
d©a_Àn_p
, * 
ªje˘
, 
ißkmp_ù£c_¥Ÿo_íum
 
decode_¥Ÿo
)

573 c⁄° 
uöt8_t
 *
d©a
 = *
d©a_p
, *
tmpd©a
;

574 
size_t
 
d©a_Àn
 = *
d©a_Àn_p
;

575 
ißkmp_∑ylﬂd
 *
r
;

576 
uöt8_t
 
√xt_ty≥
;

577 
size_t
 
Àngth
, 
ﬁígth
;

579 c⁄° 
uöt16_t
 
mö_∑ylﬂd_Àn
[
ISAKMP_PAYLOAD_MODECFG_ATTR
 + 1] = {

583 
	`DEBUG
(3, 
	`¥ötf
("\n"));

584 
	`hex_dump
("PARSING PAYLOADÅy≥", &
ty≥
, 
DUMP_UINT8
, 
ißkmp_∑ylﬂd_íum_¨øy
);

585 i‡(
ty≥
 == 0)

586  
NULL
;

587 i‡(
ty≥
 <
ISAKMP_PAYLOAD_MODECFG_ATTR
) {

588 i‡(
d©a_Àn
 < 
mö_∑ylﬂd_Àn
[
ty≥
]) {

589 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

590  
NULL
;

592 } i‡(
d©a_Àn
 < 4) {

593 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

594  
NULL
;

597 
r
 = 
	`√w_ißkmp_∑ylﬂd
(
ty≥
);

598 
√xt_ty≥
 = 
	`„tch1
();

599 
	`hex_dump
("√xt_ty≥", &
√xt_ty≥
, 
DUMP_UINT8
, 
ißkmp_∑ylﬂd_íum_¨øy
);

600 i‡(
	`„tch1
() != 0) {

601 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

602  
r
;

604 
Àngth
 = 
	`„tch2
();

605 
	`hex_dump
("Àngth", &
Àngth
, 
DUMP_UINT16
, 
NULL
);

606 i‡(
Àngth
 > 
d©a_Àn
 + 4

607 || ((
ty≥
 <
ISAKMP_PAYLOAD_MODECFG_ATTR
)&&(
Àngth
 < 
mö_∑ylﬂd_Àn
[type]))

608 || (
Àngth
 < 4)) {

609 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

610  
r
;

612 
ﬁígth
 = 
Àngth
;

613 
ty≥
) {

614 
ISAKMP_PAYLOAD_SA
:

615 
r
->
u
.
ß
.
doi
 = 
	`„tch4
();

616 
	`hex_dump
("ß.doi", &
r
->
u
.
ß
.
doi
, 
DUMP_UINT32
, 
ißkmp_doi_íum_¨øy
);

617 i‡(
r
->
u
.
ß
.
doi
 !
ISAKMP_DOI_IPSEC
) {

618 *
ªje˘
 = 
ISAKMP_N_DOI_NOT_SUPPORTED
;

619  
r
;

621 
r
->
u
.
ß
.
sôu©i⁄
 = 
	`„tch4
();

622 
	`hex_dump
("ß.sôu©i⁄", &
r
->
u
.
ß
.
sôu©i⁄
, 
DUMP_UINT32
, 
ißkmp_ù£c_sô_íum_¨øy
);

623 i‡(
r
->
u
.
ß
.
sôu©i⁄
 !
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
) {

624 *
ªje˘
 = 
ISAKMP_N_SITUATION_NOT_SUPPORTED
;

625  
r
;

627 *
ªje˘
 = 0;

628 
Àngth
 -= 12;

629 
r
->
u
.
ß
.
¥›oßls
 = 
	`∑r£_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_P
, &
d©a
, &
Àngth
, 
ªje˘
, 
decode_¥Ÿo
);

630 i‡(*
ªje˘
 != 0)

631  
r
;

633 
d©a_Àn
 -
ﬁígth
 - 12;

636 
ISAKMP_PAYLOAD_P
:

637 i‡(
√xt_ty≥
 !
ISAKMP_PAYLOAD_P
 &&Çext_type != 0) {

638 *
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

639  
r
;

642 
uöt8_t
 
num_xf‹m
;

643 
ißkmp_∑ylﬂd
 *
xf‹m
;

645 
r
->
u
.
p
.
numbî
 = 
	`„tch1
();

646 
	`hex_dump
("p.numbî", &
r
->
u
.
p
.
numbî
, 
DUMP_UINT8
, 
NULL
);

647 
r
->
u
.
p
.
¥Ÿ_id
 = 
	`„tch1
();

648 
	`hex_dump
("p.¥Ÿ_id", &
r
->
u
.
p
.
¥Ÿ_id
, 
DUMP_UINT8
, 
ißkmp_ù£c_¥Ÿo_íum_¨øy
);

649 
r
->
u
.
p
.
•i_size
 = 
	`„tch1
();

650 
	`hex_dump
("p.•i_size", &
r
->
u
.
p
.
•i_size
, 
DUMP_UINT8
, 
NULL
);

651 
num_xf‹m
 = 
	`„tch1
();

652 
	`hex_dump
("Àngth", &
num_xf‹m
, 
DUMP_UINT8
, 
NULL
);

654 i‡(
d©a_Àn
 < 
r
->
u
.
p
.
•i_size
) {

655 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

656  
r
;

658 
r
->
u
.
p
.
•i
 = 
	`xÆlocc
‘->u.p.
•i_size
);

659 
	`„tchn
(
r
->
u
.
p
.
•i
,Ñ->u.p.
•i_size
);

660 
	`hex_dump
("p.•i", 
r
->
u
.
p
.
•i
,Ñ->u.p.
•i_size
, 
NULL
);

661 
Àngth
 -8 + 
r
->
u
.
p
.
•i_size
;

662 
r
->
u
.
p
.
å™sf‹ms
 = 
	`∑r£_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_T
,

663 &
d©a
, &
Àngth
, 
ªje˘
, 
r
->
u
.
p
.
¥Ÿ_id
);

664 
xf‹m
 = 
r
->
u
.
p
.
å™sf‹ms
; xf‹m; xf‹m = xf‹m->
√xt
)

665 i‡(
num_xf‹m
-- == 0)

667 i‡(
num_xf‹m
 != 0) {

668 *
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

669  
r
;

673 
d©a_Àn
 -
ﬁígth
 - 8 - 
r
->
u
.
p
.
•i_size
;

677 
ISAKMP_PAYLOAD_T
:

678 i‡(
√xt_ty≥
 !
ISAKMP_PAYLOAD_T
 &&Çext_type != 0) {

679 *
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

680  
r
;

682 
r
->
u
.
t
.
numbî
 = 
	`„tch1
();

683 
	`hex_dump
("t.numbî", &
r
->
u
.
t
.
numbî
, 
DUMP_UINT8
, 
NULL
);

684 
r
->
u
.
t
.
id
 = 
	`„tch1
();

685 
	`hex_dump
("t.id", &
r
->
u
.
t
.
id
, 
DUMP_UINT8
, 
	`å™sf‹m_id_to_debug_°rögs
(
decode_¥Ÿo
));

686 i‡(
	`„tch2
() != 0) {

687 *
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

688  
r
;

690 
Àngth
 -= 8;

691 
r
->
u
.
t
.
©åibuãs
 = 
	`∑r£_ißkmp_©åibuãs
(&
d©a
, 
Àngth
, 
ªje˘
, 
decode_¥Ÿo
);

692 
d©a_Àn
 -
ﬁígth
 - 8;

695 
ISAKMP_PAYLOAD_KE
:

696 
ISAKMP_PAYLOAD_HASH
:

697 
ISAKMP_PAYLOAD_SIG
:

698 
ISAKMP_PAYLOAD_NONCE
:

699 
ISAKMP_PAYLOAD_VID
:

700 
ISAKMP_PAYLOAD_NAT_D
:

701 
ISAKMP_PAYLOAD_NAT_D_OLD
:

702 
r
->
u
.
ke
.
Àngth
 =Üength - 4;

703 
r
->
u
.
ke
.
d©a
 = 
	`xÆlocc
‘->u.ke.
Àngth
);

704 
	`„tchn
(
r
->
u
.
ke
.
d©a
,Ñ->u.ke.
Àngth
);

705 
	`hex_dump
("ke.d©a", 
r
->
u
.
ke
.
d©a
,Ñ->u.ke.
Àngth
, 
NULL
);

706 i‡(
ty≥
 =
ISAKMP_PAYLOAD_VID
)

707 
	`¥öt_vid
(
r
->
u
.
ke
.
d©a
,Ñ->u.ke.
Àngth
);

709 
ISAKMP_PAYLOAD_ID
:

710 
r
->
u
.
id
.
ty≥
 = 
	`„tch1
();

711 
	`hex_dump
("id.ty≥", &
r
->
u
.
id
.
ty≥
, 
DUMP_UINT8
, 
ißkmp_ù£c_id_íum_¨øy
);

712 
r
->
u
.
id
.
¥Ÿocﬁ
 = 
	`„tch1
();

713 
	`hex_dump
("id.¥Ÿocﬁ", &
r
->
u
.
id
.
¥Ÿocﬁ
, 
DUMP_UINT8
, 
NULL
);

714 
r
->
u
.
id
.
p‹t
 = 
	`„tch2
();

715 
	`hex_dump
("id.p‹t", &
r
->
u
.
id
.
p‹t
, 
DUMP_UINT16
, 
NULL
);

716 
r
->
u
.
id
.
Àngth
 =Üength - 8;

717 
r
->
u
.
id
.
d©a
 = 
	`xÆlocc
‘->u.id.
Àngth
);

718 
	`„tchn
(
r
->
u
.
id
.
d©a
,Ñ->u.id.
Àngth
);

719 
	`hex_dump
("id.d©a", 
r
->
u
.
id
.
d©a
,Ñ->u.id.
Àngth
, 
NULL
);

721 
ISAKMP_PAYLOAD_CERT
:

722 
ISAKMP_PAYLOAD_CR
:

723 
r
->
u
.
˚π
.
ícodög
 = 
	`„tch1
();

724 
	`hex_dump
("˚π.ícodög", &
r
->
u
.
˚π
.
ícodög
, 
DUMP_UINT8
, 
NULL
);

725 
r
->
u
.
˚π
.
Àngth
 =Üength - 5;

726 
r
->
u
.
˚π
.
d©a
 = 
	`xÆlocc
‘->u.˚π.
Àngth
);

727 
	`„tchn
(
r
->
u
.
˚π
.
d©a
,Ñ->u.˚π.
Àngth
);

728 
	`hex_dump
("˚π.d©a", 
r
->
u
.
˚π
.
d©a
,Ñ->u.˚π.
Àngth
, 
NULL
);

730 
ISAKMP_PAYLOAD_N
:

731 
r
->
u
.
n
.
doi
 = 
	`„tch4
();

732 
	`hex_dump
("n.doi", &
r
->
u
.
n
.
doi
, 
DUMP_UINT32
, 
ißkmp_doi_íum_¨øy
);

733 
r
->
u
.
n
.
¥Ÿocﬁ
 = 
	`„tch1
();

734 
	`hex_dump
("n.¥Ÿocﬁ", &
r
->
u
.
n
.
¥Ÿocﬁ
, 
DUMP_UINT8
, 
ißkmp_ù£c_¥Ÿo_íum_¨øy
);

735 
r
->
u
.
n
.
•i_Àngth
 = 
	`„tch1
();

736 
	`hex_dump
("n.•i_Àngth", &
r
->
u
.
n
.
•i_Àngth
, 
DUMP_UINT8
, 
NULL
);

737 
r
->
u
.
n
.
ty≥
 = 
	`„tch2
();

738 
	`hex_dump
("n.ty≥", &
r
->
u
.
n
.
ty≥
, 
DUMP_UINT16
, 
ißkmp_nŸify_íum_¨øy
);

739 i‡(
r
->
u
.
n
.
•i_Àngth
 + 12u > 
Àngth
) {

740 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

741  
r
;

743 
r
->
u
.
n
.
•i
 = 
	`xÆlocc
‘->u.n.
•i_Àngth
);

744 
	`„tchn
(
r
->
u
.
n
.
•i
,Ñ->u.n.
•i_Àngth
);

745 
	`hex_dump
("n.•i", 
r
->
u
.
n
.
•i
,Ñ->u.n.
•i_Àngth
, 
NULL
);

746 
r
->
u
.
n
.
d©a_Àngth
 = 
Àngth
 - 12 -Ñ->u.n.
•i_Àngth
;

747 
r
->
u
.
n
.
d©a
 = 
	`xÆlocc
‘->u.n.
d©a_Àngth
);

748 
	`„tchn
(
r
->
u
.
n
.
d©a
,Ñ->u.n.
d©a_Àngth
);

749 
	`hex_dump
("n.d©a", 
r
->
u
.
n
.
d©a
,Ñ->u.n.
d©a_Àngth
, 
NULL
);

750 i‡((
r
->
u
.
n
.
doi
 =
ISAKMP_DOI_IPSEC
)&&‘->u.n.
ty≥
 =
ISAKMP_N_IPSEC_RESPONDER_LIFETIME
)) {

751 
tmpd©a
 = 
r
->
u
.
n
.
d©a
;

752 
r
->
u
.
n
.
©åibuãs
 = 
	`∑r£_ißkmp_©åibuãs
(&
tmpd©a
,Ñ->u.n.
d©a_Àngth
, 
ªje˘
,

753 
r
->
u
.
n
.
¥Ÿocﬁ
);

756 
ISAKMP_PAYLOAD_D
:

757 
r
->
u
.
d
.
doi
 = 
	`„tch4
();

758 
	`hex_dump
("d.doi", &
r
->
u
.
d
.
doi
, 
DUMP_UINT32
, 
ißkmp_doi_íum_¨øy
);

759 
r
->
u
.
d
.
¥Ÿocﬁ
 = 
	`„tch1
();

760 
	`hex_dump
("d.¥Ÿocﬁ", &
r
->
u
.
d
.
¥Ÿocﬁ
, 
DUMP_UINT8
, 
ißkmp_ù£c_¥Ÿo_íum_¨øy
);

761 
r
->
u
.
d
.
•i_Àngth
 = 
	`„tch1
();

762 
	`hex_dump
("d.•i_Àngth", &
r
->
u
.
d
.
•i_Àngth
, 
DUMP_UINT8
, 
NULL
);

763 
r
->
u
.
d
.
num_•i
 = 
	`„tch2
();

764 
	`hex_dump
("d.num_•i", &
r
->
u
.
d
.
num_•i
, 
DUMP_UINT16
, 
NULL
);

765 i‡(
r
->
u
.
d
.
num_•i
 *Ñ->u.d.
•i_Àngth
 + 12u !
Àngth
) {

766 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

767  
r
;

769 
r
->
u
.
d
.
•i
 = 
	`xÆlocc
((
uöt8_t
 *Ë*Ñ->u.d.
num_•i
);

771 
i
;

772 
i
 = 0; i < 
r
->
u
.
d
.
num_•i
; i++) {

773 
r
->
u
.
d
.
•i
[
i
] = 
	`xÆlocc
‘->u.d.
•i_Àngth
);

774 
	`„tchn
(
r
->
u
.
d
.
•i
[
i
],Ñ->u.d.
•i_Àngth
);

775 
	`hex_dump
("d.•i", 
r
->
u
.
d
.
•i
[
i
],Ñ->u.d.
•i_Àngth
, 
NULL
);

779 
ISAKMP_PAYLOAD_MODECFG_ATTR
:

780 
r
->
u
.
modecfg
.
ty≥
 = 
	`„tch1
();

781 
	`hex_dump
("modecfg.ty≥", &
r
->
u
.
modecfg
.
ty≥
, 
DUMP_UINT8
, 
ißkmp_modecfg_cfg_íum_¨øy
);

782 i‡(
	`„tch1
() != 0) {

783 *
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

784  
r
;

786 
r
->
u
.
modecfg
.
id
 = 
	`„tch2
();

787 
	`hex_dump
("modecfg.id", &
r
->
u
.
modecfg
.
id
, 
DUMP_UINT16
, 
NULL
);

788 
Àngth
 -= 8;

789 
r
->
u
.
modecfg
.
©åibuãs
 = 
	`∑r£_ißkmp_©åibuãs
(&
d©a
, 
Àngth
, 
ªje˘
,

790 
ISAKMP_IPSEC_PROTO_MODECFG
);

791 
d©a_Àn
 -
ﬁígth
 - 8;

795 
r
->
u
.
ke
.
Àngth
 =Üength - 4;

796 
r
->
u
.
ke
.
d©a
 = 
	`xÆlocc
‘->u.ke.
Àngth
);

797 
	`„tchn
(
r
->
u
.
ke
.
d©a
,Ñ->u.ke.
Àngth
);

798 
	`hex_dump
("UNKNOWN.d©a", 
r
->
u
.
ke
.
d©a
,Ñ->u.ke.
Àngth
, 
NULL
);

801 *
d©a_p
 = 
d©a
;

802 *
d©a_Àn_p
 = 
d©a_Àn
;

803 
	`hex_dump
("DONE PARSING PAYLOADÅy≥", &
ty≥
, 
DUMP_UINT8
, 
ißkmp_∑ylﬂd_íum_¨øy
);

804 
r
->
√xt
 = 
	`∑r£_ißkmp_∑ylﬂd
(
√xt_ty≥
, 
d©a_p
, 
d©a_Àn_p
, 
ªje˘
, 
decode_¥Ÿo
);

805  
r
;

806 
	}
}

808 
ißkmp_∑ckë
 *
	$∑r£_ißkmp_∑ckë
(c⁄° 
uöt8_t
 * 
d©a
, 
size_t
 
d©a_Àn
, * 
ªje˘
)

810 
ªas⁄
 = 0;

811 
uöt8_t
 
∑ylﬂd
;

812 
ißkmp_∑ckë
 *
r
 = 
	`√w_ißkmp_∑ckë
();

813 
size_t
 
o_d©a_Àn
 = 
d©a_Àn
;

814 
size_t
 
ißkmp_d©a_Àn
;

816 i‡(
d©a_Àn
 < 
ISAKMP_PAYLOAD_O
) {

817 
	`DEBUG
(2, 
	`¥ötf
("∑ckëÅÿsh‹t:Üí = %Œd < mö = %Œd\n", (Ë
d©a_Àn
, ()
ISAKMP_PAYLOAD_O
));

818 
ªas⁄
 = 
ISAKMP_N_UNEQUAL_PAYLOAD_LENGTHS
;

819 
îr‹
;

822 
	`DEBUG
(3, 
	`¥ötf
("BEGIN_PARSE\n"));

823 
	`DEBUG
(3, 
	`¥ötf
("Recõved Packë Lí: %d\n", 
d©a_Àn
));

824 
	`„tchn
(
r
->
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

825 
	`hex_dump
("i_cookõ", 
r
->
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
, 
NULL
);

826 
	`„tchn
(
r
->
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

827 
	`hex_dump
("r_cookõ", 
r
->
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
, 
NULL
);

828 
∑ylﬂd
 = 
	`„tch1
();

829 
	`hex_dump
("∑ylﬂd", &
∑ylﬂd
, 
DUMP_UINT8
, 
ißkmp_∑ylﬂd_íum_¨øy
);

831 
r
->
ißkmp_vîsi⁄
 = 
	`„tch1
();

832 
	`hex_dump
("ißkmp_vîsi⁄", &
r
->
ißkmp_vîsi⁄
, 
DUMP_UINT8
, 
NULL
);

833 i‡(
r
->
ißkmp_vîsi⁄
 > 
ISAKMP_VERSION
) {

834 i‡((
r
->
ißkmp_vîsi⁄
 & 0xF0Ë>(
ISAKMP_VERSION
 & 0xF0))

835 
ªas⁄
 = 
ISAKMP_N_INVALID_MAJOR_VERSION
;

837 
ªas⁄
 = 
ISAKMP_N_INVALID_MINOR_VERSION
;

838 
îr‹
;

841 
r
->
exch™ge_ty≥
 = 
	`„tch1
();

842 
	`hex_dump
("exch™ge_ty≥", &
r
->
exch™ge_ty≥
, 
DUMP_UINT8
, 
ißkmp_exch™ge_íum_¨øy
);

843 
r
->
Êags
 = 
	`„tch1
();

844 
	`hex_dump
("Êags", &
r
->
Êags
, 
DUMP_UINT8
, 
NULL
);

845 
r
->
mesßge_id
 = 
	`„tch4
();

846 
	`hex_dump
("mesßge_id", &
r
->
mesßge_id
, ‘->mesßge_id), 
NULL
);

848 
ißkmp_d©a_Àn
 = 
	`„tch4
();

849 
	`hex_dump
("Àn", &
ißkmp_d©a_Àn
, 
DUMP_UINT32
, 
NULL
);

850 i‡(
o_d©a_Àn
 !
ißkmp_d©a_Àn
) {

851 
	`DEBUG
(2, 
	`¥ötf
("isakmpÜength doesÇot matchÖacketÜength: isakmp = %lld != datalen = %lld\n",

852 ()
ißkmp_d©a_Àn
, ()
o_d©a_Àn
));

853 
ªas⁄
 = 
ISAKMP_N_UNEQUAL_PAYLOAD_LENGTHS
;

854 
îr‹
;

857 
r
->
∑ylﬂd
 = 
	`∑r£_ißkmp_∑ylﬂd
’aylﬂd, &
d©a
, &
d©a_Àn
, &
ªas⁄
, 0);

858 i‡(
ªas⁄
 != 0)

859 
îr‹
;

861 
	`DEBUG
(3, 
	`¥ötf
("PARSE_OK\n"));

862  
r
;

864 
îr‹
:

865 
	`‰ì_ißkmp_∑ckë
(
r
);

866 i‡(
ªje˘
)

867 *
ªje˘
 = 
ªas⁄
;

868  
NULL
;

869 
	}
}

871 
	$ã°_∑ck_u≈ack
()

873 c⁄° 
uöt8_t
 
∑ck
[] = {

903 
uöt8_t
 *
u≈ack
;

904 
size_t
 
u≈ack_Àn
;

905 
ißkmp_∑ckë
 *
p
;

906 
ªje˘
;

908 
p
 = 
	`∑r£_ißkmp_∑ckë
(
∑ck
, ’ack), &
ªje˘
);

909 
	`Ê©ãn_ißkmp_∑ckë
(
p
, &
u≈ack
, &
u≈ack_Àn
, 8);

910 i‡(
u≈ack_Àn
 !(
∑ck
)

911 || 
	`memcmp
(
u≈ack
, 
∑ck
, (pack)) != 0)

912 
	`ab‹t
();

913 
	`‰ì
(
u≈ack
);

914 
	`‰ì_ißkmp_∑ckë
(
p
);

915 
	}
}

	@isakmp-pkt.h

22 #i‚de‡
__ISAKMP_PKT_H__


23 
	#__ISAKMP_PKT_H__


	)

24 #i‡
deföed
(
__löux__
)

25 
	~<°döt.h
>

27 
	~<sys/ty≥s.h
>

29 
	~"ißkmp.h
"

31 
	sißkmp_©åibuã
 {

32 
ißkmp_©åibuã
 *
	m√xt
;

33 
uöt16_t
 
	mty≥
;

35 
	mißkmp_©å_lŸs
,

36 
	mißkmp_©å_16
,

37 
	mißkmp_©å_2x8
,

38 
	mißkmp_©å_a˛


39 } 
	maf
;

41 
uöt16_t
 
	m©å_16
;

42 
uöt8_t
 
	m©å_2x8
[2];

44 
uöt16_t
 
	mÀngth
;

45 
uöt8_t
 *
	md©a
;

46 } 
	mlŸs
;

48 
uöt16_t
 
	mcou¡
;

49 
	sa˛_ít_s
 {

50 
ö_addr
 
	maddr
, 
	mmask
;

51 
uöt16_t
 
	m¥Ÿocﬁ
, 
	m•‹t
, 
	mdp‹t
;

52 } *
	ma˛_ít
;

53 } 
	ma˛
;

54 } 
	mu
;

57 
	sißkmp_∑ylﬂd
 {

58 
ißkmp_∑ylﬂd
 *
	m√xt
;

59 
ißkmp_∑ylﬂd_íum
 
	mty≥
;

62 
uöt32_t
 
	mdoi
;

63 
uöt32_t
 
	msôu©i⁄
;

64 
ißkmp_∑ylﬂd
 *
	m¥›oßls
;

65 } 
	mß
;

67 
uöt8_t
 
	mnumbî
;

68 
uöt8_t
 
	m¥Ÿ_id
;

69 
uöt8_t
 
	m•i_size
;

70 
uöt8_t
 *
	m•i
;

71 
ißkmp_∑ylﬂd
 *
	må™sf‹ms
;

72 } 
	mp
;

74 
uöt8_t
 
	mnumbî
;

75 
uöt8_t
 
	mid
;

76 
ißkmp_©åibuã
 *
	m©åibuãs
;

77 } 
	mt
;

79 
uöt16_t
 
	mÀngth
;

80 
uöt8_t
 *
	md©a
;

81 } 
	mke
, 
	mhash
, 
	msig
, 
	mn⁄˚
, 
	mvid
, 
	m«td
;

83 
uöt8_t
 
	mty≥
;

84 
uöt8_t
 
	m¥Ÿocﬁ
;

85 
uöt16_t
 
	mp‹t
;

86 
uöt16_t
 
	mÀngth
;

87 
uöt8_t
 *
	md©a
;

88 } 
	mid
;

90 
uöt8_t
 
	mícodög
;

91 
uöt16_t
 
	mÀngth
;

92 
uöt8_t
 *
	md©a
;

93 } 
	m˚π
, 
	m¸
;

95 
uöt32_t
 
	mdoi
;

96 
uöt8_t
 
	m¥Ÿocﬁ
;

97 
uöt8_t
 
	m•i_Àngth
;

98 
uöt8_t
 *
	m•i
;

99 
uöt16_t
 
	mty≥
;

100 
uöt16_t
 
	md©a_Àngth
;

101 
uöt8_t
 *
	md©a
;

102 
ißkmp_©åibuã
 *
	m©åibuãs
;

103 } 
	mn
;

105 
uöt32_t
 
	mdoi
;

106 
uöt8_t
 
	m¥Ÿocﬁ
;

107 
uöt8_t
 
	m•i_Àngth
;

108 
uöt16_t
 
	mnum_•i
;

109 
uöt8_t
 **
	m•i
;

110 } 
	md
;

112 
uöt8_t
 
	mty≥
;

113 
uöt16_t
 
	mid
;

114 
ißkmp_©åibuã
 *
	m©åibuãs
;

115 } 
	mmodecfg
;

116 } 
	mu
;

119 
	sißkmp_∑ckë
 {

120 
uöt8_t
 
	mi_cookõ
[
ISAKMP_COOKIE_LENGTH
];

121 
uöt8_t
 
	mr_cookõ
[
ISAKMP_COOKIE_LENGTH
];

122 
uöt8_t
 
	mißkmp_vîsi⁄
;

123 
uöt8_t
 
	mexch™ge_ty≥
;

124 
uöt8_t
 
	mÊags
;

125 
uöt32_t
 
	mmesßge_id
;

126 
ißkmp_∑ylﬂd
 *
	m∑ylﬂd
;

129 *
xÆlocc
(
size_t
 
x
);

130 
ißkmp_∑ckë
 *
√w_ißkmp_∑ckë
();

131 
ißkmp_∑ylﬂd
 *
√w_ißkmp_∑ylﬂd
(
uöt8_t
);

132 
ißkmp_∑ylﬂd
 *
√w_ißkmp_d©a_∑ylﬂd
(
uöt8_t
 
ty≥
, c⁄° *
d©a
,

133 
size_t
 
d©a_Àngth
);

134 
ißkmp_©åibuã
 *
√w_ißkmp_©åibuã
(
uöt16_t
, isakmp_attribute *);

135 
ißkmp_©åibuã
 *
√w_ißkmp_©åibuã_16
(
uöt16_t
 
ty≥
, uöt16_à
d©a
,

136 
ißkmp_©åibuã
 *
√xt
);

137 
‰ì_ißkmp_∑ckë
(
ißkmp_∑ckë
 *
p
);

138 
Ê©ãn_ißkmp_∑ylﬂds
(
ißkmp_∑ylﬂd
 *
p
, 
uöt8_t
 ** 
ªsu…
, 
size_t
 * 
size
);

139 
Ê©ãn_ißkmp_∑ylﬂd
(
ißkmp_∑ylﬂd
 *
p
, 
uöt8_t
 ** 
ªsu…
, 
size_t
 * 
size
);

140 
Ê©ãn_ißkmp_∑ckë
(
ißkmp_∑ckë
 *
p
,

141 
uöt8_t
 ** 
ªsu…
, 
size_t
 * 
size
, size_à
blksz
);

142 
ißkmp_∑ckë
 *
∑r£_ißkmp_∑ckë
(c⁄° 
uöt8_t
 * 
d©a
,

143 
size_t
 
d©a_Àn
, * 
ªje˘
);

144 
ã°_∑ck_u≈ack
();

	@isakmp.h

21 #i‚de‡
__ISAKMP_H__


22 
	#__ISAKMP_H__


	)

25 
	#ISAKMP_FLAG_E
 0x1

	)

26 
	#ISAKMP_FLAG_C
 0x2

	)

27 
	#ISAKMP_FLAG_A
 0x4

	)

30 
	eißkmp_∑ylﬂd_íum
 {

31 
	mISAKMP_PAYLOAD_NONE
 = 0,

32 
	mISAKMP_PAYLOAD_SA
,

33 
	mISAKMP_PAYLOAD_P
,

34 
	mISAKMP_PAYLOAD_T
,

35 
	mISAKMP_PAYLOAD_KE
,

36 
	mISAKMP_PAYLOAD_ID
,

37 
	mISAKMP_PAYLOAD_CERT
,

38 
	mISAKMP_PAYLOAD_CR
,

39 
	mISAKMP_PAYLOAD_HASH
,

40 
	mISAKMP_PAYLOAD_SIG
,

41 
	mISAKMP_PAYLOAD_NONCE
,

42 
	mISAKMP_PAYLOAD_N
,

43 
	mISAKMP_PAYLOAD_D
,

44 
	mISAKMP_PAYLOAD_VID
,

45 
	mISAKMP_PAYLOAD_MODECFG_ATTR
,

46 
	mISAKMP_PAYLOAD_SAK
,

47 
	mISAKMP_PAYLOAD_SAT
,

48 
	mISAKMP_PAYLOAD_KD
,

49 
	mISAKMP_PAYLOAD_SEQNO
,

50 
	mISAKMP_PAYLOAD_POP
,

51 
	mISAKMP_PAYLOAD_NAT_D
,

52 
	mISAKMP_PAYLOAD_NAT_OA
,

53 
	mISAKMP_PAYLOAD_NAT_D_OLD
 = 0x82,

54 
	mISAKMP_PAYLOAD_FRAG
 = 0x84

58 
	eißkmp_exch™ge_íum
 {

59 
	mISAKMP_EXCHANGE_NONE
 = 0,

60 
	mISAKMP_EXCHANGE_BASE
,

61 
	mISAKMP_EXCHANGE_IDENTITY
,

62 
	mISAKMP_EXCHANGE_AUTH_ONLY
,

63 
	mISAKMP_EXCHANGE_AGGRESSIVE
,

64 
	mISAKMP_EXCHANGE_INFORMATIONAL
,

65 
	mISAKMP_EXCHANGE_MODECFG_TRANSACTION
,

66 
	mISAKMP_EXCHANGE_IKE_QUICK
 = 32,

67 
	mISAKMP_EXCHANGE_IKE_NEW_GROUP


71 
	eißkmp_doi_íum
 {

72 
	mISAKMP_DOI_GENERIC
 = 0,

73 
	mISAKMP_DOI_IPSEC


77 
	eißkmp_nŸify_íum
 {

78 
	mISAKMP_N_INVALID_PAYLOAD_TYPE
 = 1,

79 
	mISAKMP_N_DOI_NOT_SUPPORTED
,

80 
	mISAKMP_N_SITUATION_NOT_SUPPORTED
,

81 
	mISAKMP_N_INVALID_COOKIE
,

82 
	mISAKMP_N_INVALID_MAJOR_VERSION
,

83 
	mISAKMP_N_INVALID_MINOR_VERSION
,

84 
	mISAKMP_N_INVALID_EXCHANGE_TYPE
,

85 
	mISAKMP_N_INVALID_FLAGS
,

86 
	mISAKMP_N_INVALID_MESSAGE_ID
,

87 
	mISAKMP_N_INVALID_PROTOCOL_ID
,

88 
	mISAKMP_N_INVALID_SPI
,

89 
	mISAKMP_N_INVALID_TRANSFORM_ID
,

90 
	mISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
,

91 
	mISAKMP_N_NO_PROPOSAL_CHOSEN
,

92 
	mISAKMP_N_BAD_PROPOSAL_SYNTAX
,

93 
	mISAKMP_N_PAYLOAD_MALFORMED
,

94 
	mISAKMP_N_INVALID_KEY_INFORMATION
,

95 
	mISAKMP_N_INVALID_ID_INFORMATION
,

96 
	mISAKMP_N_INVALID_CERT_ENCODING
,

97 
	mISAKMP_N_INVALID_CERTIFICATE
,

98 
	mISAKMP_N_CERT_TYPE_UNSUPPORTED
,

99 
	mISAKMP_N_INVALID_CERT_AUTHORITY
,

100 
	mISAKMP_N_INVALID_HASH_INFORMATION
,

101 
	mISAKMP_N_AUTHENTICATION_FAILED
,

102 
	mISAKMP_N_INVALID_SIGNATURE
,

103 
	mISAKMP_N_ADDRESS_NOTIFICATION
,

104 
	mISAKMP_N_NOTIFY_SA_LIFETIME
,

105 
	mISAKMP_N_CERTIFICATE_UNAVAILABLE
,

106 
	mISAKMP_N_UNSUPPORTED_EXCHANGE_TYPE
,

107 
	mISAKMP_N_UNEQUAL_PAYLOAD_LENGTHS
,

108 
	mISAKMP_N_CONNECTED
 = 16384,

109 
	mISAKMP_N_IPSEC_RESPONDER_LIFETIME
 = 24576,

110 
	mISAKMP_N_IPSEC_REPLAY_STATUS
,

111 
	mISAKMP_N_IPSEC_INITIAL_CONTACT
,

112 
	mISAKMP_N_CISCO_HELLO
 = 30000,

113 
	mISAKMP_N_CISCO_WWTEBR
,

114 
	mISAKMP_N_CISCO_SHUT_UP
,

115 
	mISAKMP_N_IOS_KEEP_ALIVE_REQ
 = 32768,

116 
	mISAKMP_N_IOS_KEEP_ALIVE_ACK
,

117 
	mISAKMP_N_R_U_THERE
 = 36136,

118 
	mISAKMP_N_R_U_THERE_ACK
,

119 
	mISAKMP_N_CISCO_LOAD_BALANCE
 = 40501,

120 
	mISAKMP_N_CISCO_PRESHARED_KEY_HASH
 = 40503

125 
	edwr_ike_dñëe
 {

126 
	mIKE_DELETE_SERVER_SHUTDOWN
 = 0,

127 
	mIKE_DELETE_SERVER_REBOOT
,

128 
	mIKE_DELETE_MAX_CONNECT_TIME
,

129 
	mIKE_DELETE_BY_USER_COMMAND
,

130 
	mIKE_DELETE_BY_ERROR
,

131 
	mIKE_DELETE_NO_ERROR
,

132 
	mIKE_DELETE_IDLE_TIMEOUT
,

133 
	mIKE_DELETE_P2_PROPOSAL_MISMATCH
,

134 
	mIKE_DELETE_FIREWALL_MISMATCH
,

135 
	mIKE_DELETE_CERT_EXPIRED
,

136 
	mIKE_DELETE_BY_EXPIRED_LIFETIME
,

137 
	mDEL_REASON_RESET_SADB


141 
	eißkmp_˚πifiˇã_íum
 {

142 
	mISAKMP_CERT_NONE
 = 0,

143 
	mISAKMP_CERT_PKCS7_X509
,

144 
	mISAKMP_CERT_PGP
,

145 
	mISAKMP_CERT_DNS_SIG_KEY
,

146 
	mISAKMP_CERT_X509_SIG
,

147 
	mISAKMP_CERT_X509_KEX_EXCHANGE
,

148 
	mISAKMP_CERT_KERBEROS_TOKENS
,

149 
	mISAKMP_CERT_CRL
,

150 
	mISAKMP_CERT_ARL
,

151 
	mISAKMP_CERT_SPKI
,

152 
	mISAKMP_CERT_X509_ATTRIBUTE


156 
	eike_©å_íum
 {

157 
	mIKE_ATTRIB_ENC
 = 1,

158 
	mIKE_ATTRIB_HASH
,

159 
	mIKE_ATTRIB_AUTH_METHOD
,

160 
	mIKE_ATTRIB_GROUP_DESC
,

161 
	mIKE_ATTRIB_GROUP_TYPE
,

162 
	mIKE_ATTRIB_GROUP_PRIME
,

163 
	mIKE_ATTRIB_GROUP_GEN_1
,

164 
	mIKE_ATTRIB_GROUP_GEN_2
,

165 
	mIKE_ATTRIB_GROUP_CURVE_A
,

166 
	mIKE_ATTRIB_GROUP_CURVE_B
,

167 
	mIKE_ATTRIB_LIFE_TYPE
,

168 
	mIKE_ATTRIB_LIFE_DURATION
,

169 
	mIKE_ATTRIB_PRF
,

170 
	mIKE_ATTRIB_KEY_LENGTH
,

171 
	mIKE_ATTRIB_FIELD_SIZE
,

172 
	mIKE_ATTRIB_GROUP_ORDER
,

173 
	mIKE_ATTRIB_BLOCK_SIZE
,

174 
	mIKE_ATTRIB_NORTEL_UNKNOWN
 = 32767

178 
	eike_íc_íum
 {

179 
	mIKE_ENC_NO_CBC
 = 0,

180 
	mIKE_ENC_DES_CBC
,

181 
	mIKE_ENC_IDEA_CBC
,

182 
	mIKE_ENC_BLOWFISH_CBC
,

183 
	mIKE_ENC_RC5_R16_B16_CBC
,

184 
	mIKE_ENC_3DES_CBC
,

185 
	mIKE_ENC_CAST_CBC
,

186 
	mIKE_ENC_AES_CBC


190 
	eike_hash_íum
 {

191 
	mIKE_HASH_MD5
 = 1,

192 
	mIKE_HASH_SHA
,

193 
	mIKE_HASH_TIGER
,

194 
	mIKE_HASH_SHA2_256
,

195 
	mIKE_HASH_SHA2_384
,

196 
	mIKE_HASH_SHA2_512


200 
	eike_auth_íum
 {

201 
	mIKE_AUTH_PRESHARED
 = 1,

202 
	mIKE_AUTH_DSS
,

203 
	mIKE_AUTH_RSA_SIG
,

204 
	mIKE_AUTH_RSA_ENC
,

205 
	mIKE_AUTH_RSA_ENC_2
,

206 
	mIKE_AUTH_EL_GAMAL_ENC
,

207 
	mIKE_AUTH_EL_GAMAL_ENC_REV
,

208 
	mIKE_AUTH_ECDSA_SIG
,

209 
	mIKE_AUTH_HybridInôRSA
 = 64221,

210 
	mIKE_AUTH_HybridRe•RSA
,

211 
	mIKE_AUTH_HybridInôDSS
,

212 
	mIKE_AUTH_HybridRe•DSS
,

213 
	mIKE_AUTH_XAUTHInôPªSh¨ed
 = 65001,

214 
	mIKE_AUTH_XAUTHRe•PªSh¨ed
,

215 
	mIKE_AUTH_XAUTHInôDSS
,

216 
	mIKE_AUTH_XAUTHRe•DSS
,

217 
	mIKE_AUTH_XAUTHInôRSA
,

218 
	mIKE_AUTH_XAUTHRe•RSA
,

219 
	mIKE_AUTH_XAUTHInôRSAEn¸y±i⁄
,

220 
	mIKE_AUTH_XAUTHRe•RSAEn¸y±i⁄
,

221 
	mIKE_AUTH_XAUTHInôRSARevi£dEn¸y±i⁄
,

222 
	mIKE_AUTH_XAUTHRe•RSARevi£dEn¸y±i⁄


226 
	eike_group_íum
 {

227 
	mIKE_GROUP_MODP_768
 = 1,

228 
	mIKE_GROUP_MODP_1024
,

229 
	mIKE_GROUP_EC2N_155
,

230 
	mIKE_GROUP_EC2N_185
,

231 
	mIKE_GROUP_MODP_1536
,

232 
	mIKE_GROUP_EC2N_163£˘
,

233 
	mIKE_GROUP_EC2N_163K
,

234 
	mIKE_GROUP_EC2N_283£˘
,

235 
	mIKE_GROUP_EC2N_283K
,

236 
	mIKE_GROUP_EC2N_409£˘
,

237 
	mIKE_GROUP_EC2N_409K
,

238 
	mIKE_GROUP_EC2N_571£˘
,

239 
	mIKE_GROUP_EC2N_571K


243 
	eike_group_ty≥_íum
 {

244 
	mIKE_GROUP_TYPE_MODP
 = 1,

245 
	mIKE_GROUP_TYPE_ECP
,

246 
	mIKE_GROUP_TYPE_EC2N


250 
	eike_li„_íum
 {

251 
	mIKE_LIFE_TYPE_SECONDS
 = 1,

252 
	mIKE_LIFE_TYPE_K


256 
	eißkmp_ù£c_sô_íum
 {

257 
	mISAKMP_IPSEC_SIT_IDENTITY_ONLY
 = 0x1,

258 
	mISAKMP_IPSEC_SIT_SECRECY
 = 0x2,

259 
	mISAKMP_IPSEC_SIT_INTEGRITY
 = 0x4

263 
	eißkmp_ù£c_id_íum
 {

264 
	mISAKMP_IPSEC_ID_RESERVED
 = 0,

265 
	mISAKMP_IPSEC_ID_IPV4_ADDR
,

266 
	mISAKMP_IPSEC_ID_FQDN
,

267 
	mISAKMP_IPSEC_ID_USER_FQDN
,

268 
	mISAKMP_IPSEC_ID_IPV4_ADDR_SUBNET
,

269 
	mISAKMP_IPSEC_ID_IPV6_ADDR
,

270 
	mISAKMP_IPSEC_ID_IPV6_ADDR_SUBNET
,

271 
	mISAKMP_IPSEC_ID_IPV4_ADDR_RANGE
,

272 
	mISAKMP_IPSEC_ID_IPV6_ADDR_RANGE
,

273 
	mISAKMP_IPSEC_ID_DER_ASN1_DN
,

274 
	mISAKMP_IPSEC_ID_DER_ASN1_GN
,

275 
	mISAKMP_IPSEC_ID_KEY_ID


279 
	eißkmp_ù£c_¥Ÿo_íum
 {

280 
	mISAKMP_IPSEC_PROTO_RESERVED
 = 0,

281 
	mISAKMP_IPSEC_PROTO_ISAKMP
,

282 
	mISAKMP_IPSEC_PROTO_IPSEC_AH
,

283 
	mISAKMP_IPSEC_PROTO_IPSEC_ESP
,

284 
	mISAKMP_IPSEC_PROTO_IPCOMP
,

285 
	mISAKMP_IPSEC_PROTO_MODECFG
 = 512

289 
	eißkmp_ù£c_key_íum
 {

290 
	mISAKMP_IPSEC_KEY_RESERVED
 = 0,

291 
	mISAKMP_IPSEC_KEY_IKE


295 
	eißkmp_ù£c_ah_íum
 {

296 
	mISAKMP_IPSEC_AH_RESERVED
 = 0,

297 
	mISAKMP_IPSEC_AH_MD5
 = 2,

298 
	mISAKMP_IPSEC_AH_SHA
,

299 
	mISAKMP_IPSEC_AH_DES
,

300 
	mISAKMP_IPSEC_AH_SHA2_256
,

301 
	mISAKMP_IPSEC_AH_SHA2_384
,

302 
	mISAKMP_IPSEC_AH_SHA2_512
,

303 
	mISAKMP_IPSEC_AH_RIPEMD


307 
	eißkmp_ù£c_e•_íum
 {

308 
	mISAKMP_IPSEC_ESP_RESERVED
 = 0,

309 
	mISAKMP_IPSEC_ESP_DES_IV64
,

310 
	mISAKMP_IPSEC_ESP_DES
,

311 
	mISAKMP_IPSEC_ESP_3DES
,

312 
	mISAKMP_IPSEC_ESP_RC5
,

313 
	mISAKMP_IPSEC_ESP_IDEA
,

314 
	mISAKMP_IPSEC_ESP_CAST
,

315 
	mISAKMP_IPSEC_ESP_BLOWFISH
,

316 
	mISAKMP_IPSEC_ESP_3IDEA
,

317 
	mISAKMP_IPSEC_ESP_DES_IV32
,

318 
	mISAKMP_IPSEC_ESP_RC4
,

319 
	mISAKMP_IPSEC_ESP_NULL
,

320 
	mISAKMP_IPSEC_ESP_AES
,

321 
	mISAKMP_IPSEC_ESP_AES_128_CTR
,

322 
	mISAKMP_IPSEC_ESP_AES_MARS
 = 249,

323 
	mISAKMP_IPSEC_ESP_AES_RC6
,

324 
	mISAKMP_IPSEC_ESP_AES_RIJNDAEL
,

325 
	mISAKMP_IPSEC_ESP_AES_SERPENT
,

326 
	mISAKMP_IPSEC_ESP_AES_TWOFISH


330 
	eißkmp_ù£c_©å_íum
 {

331 
	mISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
 = 1,

332 
	mISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
,

333 
	mISAKMP_IPSEC_ATTRIB_GROUP_DESC
,

334 
	mISAKMP_IPSEC_ATTRIB_ENCAP_MODE
,

335 
	mISAKMP_IPSEC_ATTRIB_AUTH_ALG
,

336 
	mISAKMP_IPSEC_ATTRIB_KEY_LENGTH
,

337 
	mISAKMP_IPSEC_ATTRIB_KEY_ROUNDS
,

338 
	mISAKMP_IPSEC_ATTRIB_COMP_DICT_SIZE
,

339 
	mISAKMP_IPSEC_ATTRIB_COMP_PRIVATE_ALG
,

340 
	mISAKMP_IPSEC_ATTRIB_ECN_TUNNEL


344 
	eißkmp_ù£c_ùcomp_íum
 {

345 
	mISAKMP_IPSEC_IPCOMP_RESERVED
 = 0,

346 
	mISAKMP_IPSEC_IPCOMP_OUI
,

347 
	mISAKMP_IPSEC_IPCOMP_DEFLATE
,

348 
	mISAKMP_IPSEC_IPCOMP_LZS
,

349 
	mISAKMP_IPSEC_IPCOMP_V42BIS


353 
	eù£c_li„_íum
 {

354 
	mIPSEC_LIFE_SECONDS
 = 1,

355 
	mIPSEC_LIFE_K


359 
	eù£c_íˇp_íum
 {

360 
	mIPSEC_ENCAP_TUNNEL
 = 1,

361 
	mIPSEC_ENCAP_TRANSPORT
,

362 
	mIPSEC_ENCAP_UDP_TUNNEL
,

363 
	mIPSEC_ENCAP_UDP_TRANSPORT
,

364 
	mIPSEC_ENCAP_UDP_TUNNEL_OLD
 = 61443,

365 
	mIPSEC_ENCAP_UDP_TRANSPORT_OLD


369 
	eù£c_auth_íum
 {

370 
	mIPSEC_AUTH_HMAC_MD5
 = 1,

371 
	mIPSEC_AUTH_HMAC_SHA
,

372 
	mIPSEC_AUTH_DES_MAC
,

373 
	mIPSEC_AUTH_KPDK


377 
	#ISAKMP_COOKIE_LENGTH
 8

	)

378 
	#ISAKMP_VERSION
 0x10

	)

380 
	#ISAKMP_EXCHANGE_TYPE_O
 18

	)

381 
	#ISAKMP_I_COOKIE_O
 0

	)

382 
	#ISAKMP_R_COOKIE_O
 8

	)

383 
	#ISAKMP_MESSAGE_ID_O
 20

	)

384 
	#ISAKMP_PAYLOAD_O
 28

	)

387 c⁄° 
VID_XAUTH
[];

388 c⁄° 
VID_DPD
[];

389 c⁄° 
VID_UNITY
[];

390 c⁄° 
VID_UNKNOWN
[];

391 c⁄° 
VID_NATT_00
[];

392 c⁄° 
VID_NATT_01
[];

393 c⁄° 
VID_NATT_02
[];

394 c⁄° 
VID_NATT_02N
[];

395 c⁄° 
VID_NATT_RFC
[];

398 
	eißkmp_modecfg_cfg_íum
 {

399 
	mISAKMP_MODECFG_CFG_REQUEST
 = 1,

400 
	mISAKMP_MODECFG_CFG_REPLY
,

401 
	mISAKMP_MODECFG_CFG_SET
,

402 
	mISAKMP_MODECFG_CFG_ACK


405 
	eißkmp_modecfg_©åib_íum
 {

406 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_ADDRESS
 = 1,

407 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NETMASK
,

408 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DNS
,

409 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NBNS
,

410 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_ADDRESS_EXPIRY
,

411 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DHCP
,

412 
	mISAKMP_MODECFG_ATTRIB_APPLICATION_VERSION
,

413 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_ADDRESS
,

414 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_NETMASK
,

415 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_DNS
,

416 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_NBNS
,

417 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_DHCP
,

418 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_SUBNET
,

419 
	mISAKMP_MODECFG_ATTRIB_SUPPORTED_ATTRIBUTES
,

420 
	mISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_SUBNET
,

421 
	mISAKMP_XAUTH_06_ATTRIB_TYPE
 = 0x4088,

422 
	mISAKMP_XAUTH_06_ATTRIB_USER_NAME
,

423 
	mISAKMP_XAUTH_06_ATTRIB_USER_PASSWORD
,

424 
	mISAKMP_XAUTH_06_ATTRIB_PASSCODE
,

425 
	mISAKMP_XAUTH_06_ATTRIB_MESSAGE
,

426 
	mISAKMP_XAUTH_06_ATTRIB_CHALLENGE
,

427 
	mISAKMP_XAUTH_06_ATTRIB_DOMAIN
,

428 
	mISAKMP_XAUTH_06_ATTRIB_STATUS
,

429 
	mISAKMP_XAUTH_06_ATTRIB_NEXT_PIN
,

430 
	mISAKMP_XAUTH_06_ATTRIB_ANSWER
,

431 
	mISAKMP_MODECFG_ATTRIB_CISCO_BANNER
 = 0x7000,

432 
	mISAKMP_MODECFG_ATTRIB_CISCO_SAVE_PW
,

433 
	mISAKMP_MODECFG_ATTRIB_CISCO_DEF_DOMAIN
,

434 
	mISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_DNS
,

435 
	mISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_INC
,

436 
	mISAKMP_MODECFG_ATTRIB_CISCO_UDP_ENCAP_PORT
,

437 
	mISAKMP_MODECFG_ATTRIB_CISCO_UNKNOWN
,

438 
	mISAKMP_MODECFG_ATTRIB_CISCO_DO_PFS
,

439 
	mISAKMP_MODECFG_ATTRIB_CISCO_FW_TYPE
,

440 
	mISAKMP_MODECFG_ATTRIB_CISCO_BACKUP_SERVER
,

441 
	mISAKMP_MODECFG_ATTRIB_CISCO_DDNS_HOSTNAME
,

442 
	mISAKMP_XAUTH_ATTRIB_CISCOEXT_VENDOR
 = 0x7d88

	@math_group.c

35 
	~<as£π.h
>

36 
	~<sys/∑øm.h
>

37 
	~<°dlib.h
>

38 
	~<°rög.h
>

39 
	~<√töë/ö.h
>

41 
	~<g¸y±.h
>

43 
	~"m©h_group.h
"

46 
modp_‰ì
(
group
 *);

47 
group
 *
modp_˛⁄e
(group *, group *);

48 
modp_öô
(
group
 *);

50 
modp_gëÀn
(
group
 *);

51 
modp_gëøw
(
group
 *, 
g¸y_mpi_t
, *);

52 
modp_£åaw
(
group
 *, 
g¸y_mpi_t
, *, );

53 
modp_£å™dom
(
group
 *, 
g¸y_mpi_t
);

54 
modp_›î©i⁄
(
group
 *, 
g¸y_mpi_t
, gcry_mpi_t, gcry_mpi_t);

69 c⁄° 
modp_ds¸
 
	gﬂkÀy_modp
[] = {

71 
OAKLEY_GRP_1
, 72,

79 
OAKLEY_GRP_2
, 82,

89 
OAKLEY_GRP_5
, 102,

103 
group
 
	ggroups
[] = {

105 
MODP
, 
OAKLEY_GRP_1
, 0, 
NULL
, &
ﬂkÀy_modp
[0], NULL, NULL, NULL, NULL, NULL,

106 ((*)(
group
 *))
modp_gëÀn
,

107 ((*)(
group
 *, *, *))
modp_gëøw
,

108 ((*)(
group
 *, *, *, ))
modp_£åaw
,

109 ((*)(
group
 *, *))
modp_£å™dom
,

110 ((*)(
group
 *, *, *, *))
modp_›î©i⁄


113 
MODP
, 
OAKLEY_GRP_2
, 0, 
NULL
, &
ﬂkÀy_modp
[1], NULL, NULL, NULL, NULL, NULL,

114 ((*)(
group
 *))
modp_gëÀn
,

115 ((*)(
group
 *, *, *))
modp_gëøw
,

116 ((*)(
group
 *, *, *, ))
modp_£åaw
,

117 ((*)(
group
 *, *))
modp_£å™dom
,

118 ((*)(
group
 *, *, *, *))
modp_›î©i⁄


121 
MODP
, 
OAKLEY_GRP_5
, 0, 
NULL
, &
ﬂkÀy_modp
[2], NULL, NULL, NULL, NULL, NULL,

122 ((*)(
group
 *))
modp_gëÀn
,

123 ((*)(
group
 *, *, *))
modp_gëøw
,

124 ((*)(
group
 *, *, *, ))
modp_£åaw
,

125 ((*)(
group
 *, *))
modp_£å™dom
,

126 ((*)(
group
 *, *, *, *))
modp_›î©i⁄


135 
	$group_öô
()

137 
i
;

139 
i
 = (
groups
) / (groups[0]) - 1; i >= 0; i--) {

140 
	`as£π
(
groups
[
i
].
ty≥
 =
MODP
);

141 
	`modp_öô
(&
groups
[
i
]);

143 
	}
}

145 
group
 *
	$group_gë
(
id
)

147 
group
 *
√w
, *
˛⁄e
;

149 
	`as£π
(
id
 >= 1);

150 
	`as£π
(
id
 <()((
groups
) / (groups[0])));

152 
˛⁄e
 = &
groups
[
id
 - 1];

154 
√w
 = 
	`mÆloc
( *new);

155 
	`as£π
(
√w
);

157 
	`as£π
(
˛⁄e
->
ty≥
 =
MODP
);

158 
√w
 = 
	`modp_˛⁄e
“ew, 
˛⁄e
);

159  
√w
;

160 
	}
}

162 
	$group_‰ì
(
group
 *
gΩ
)

164 
	`as£π
(
gΩ
->
ty≥
 =
MODP
);

165 
	`modp_‰ì
(
gΩ
);

166 
	`‰ì
(
gΩ
);

167 
	}
}

169 
group
 *
	$modp_˛⁄e
(
group
 *
√w
, grou∞*
˛⁄e
)

171 
modp_group
 *
√w_gΩ
, *
˛⁄e_gΩ
 = 
˛⁄e
->
group
;

173 
√w_gΩ
 = 
	`mÆloc
( *new_grp);

174 
	`as£π
(
√w_gΩ
);

176 
	`mem˝y
(
√w
, 
˛⁄e
, (
group
));

178 
√w
->
group
 = 
√w_gΩ
;

179 
√w_gΩ
->
p
 = 
	`g¸y_mpi_c›y
(
˛⁄e_gΩ
->p);

180 
√w_gΩ
->
gí
 = 
	`g¸y_mpi_c›y
(
˛⁄e_gΩ
->gen);

182 
√w_gΩ
->
a
 = 
	`g¸y_mpi_√w
(
˛⁄e
->
bôs
);

183 
√w_gΩ
->
b
 = 
	`g¸y_mpi_√w
(
˛⁄e
->
bôs
);

184 
√w_gΩ
->
c
 = 
	`g¸y_mpi_√w
(
˛⁄e
->
bôs
);

186 
√w
->
gí
 = 
√w_gΩ
->gen;

187 
√w
->
a
 = 
√w_gΩ
->a;

188 
√w
->
b
 = 
√w_gΩ
->b;

189 
√w
->
c
 = 
√w_gΩ
->c;

191  
√w
;

192 
	}
}

194 
	$modp_‰ì
(
group
 *
ﬁd
)

196 
modp_group
 *
gΩ
 = 
ﬁd
->
group
;

198 
	`g¸y_mpi_ªÀa£
(
gΩ
->
p
);

199 
	`g¸y_mpi_ªÀa£
(
gΩ
->
gí
);

200 
	`g¸y_mpi_ªÀa£
(
gΩ
->
a
);

201 
	`g¸y_mpi_ªÀa£
(
gΩ
->
b
);

202 
	`g¸y_mpi_ªÀa£
(
gΩ
->
c
);

204 
	`‰ì
(
gΩ
);

205 
	}
}

207 
	$modp_öô
(
group
 *group)

209 c⁄° 
modp_ds¸
 *
ds¸
 = 
group
->
group_ds¸
;

210 
modp_group
 *
gΩ
;

212 
gΩ
 = 
	`mÆloc
( *grp);

213 
	`as£π
(
gΩ
);

215 
group
->
bôs
 = 
ds¸
->bits;

217 
	`g¸y_mpi_sˇn
(&
gΩ
->
p
, 
GCRYMPI_FMT_HEX
, (c⁄° *)
ds¸
->
¥ime
, 0, 
NULL
);

218 
	`g¸y_mpi_sˇn
(&
gΩ
->
gí
, 
GCRYMPI_FMT_HEX
, (c⁄° *)
ds¸
->gí, 0, 
NULL
);

220 
gΩ
->
a
 = 
	`g¸y_mpi_√w
(
group
->
bôs
);

221 
gΩ
->
b
 = 
	`g¸y_mpi_√w
(
group
->
bôs
);

222 
gΩ
->
c
 = 
	`g¸y_mpi_√w
(
group
->
bôs
);

224 
group
->
gí
 = 
gΩ
->gen;

225 
group
->
a
 = 
gΩ
->a;

226 
group
->
b
 = 
gΩ
->b;

227 
group
->
c
 = 
gΩ
->c;

229 
group
->grou∞
gΩ
;

230 
	}
}

232 
	$modp_gëÀn
(
group
 *group)

234 
modp_group
 *
gΩ
 = (modp_grou∞*)
group
->group;

236  (
	`g¸y_mpi_gë_nbôs
(
gΩ
->
p
) + 7) / 8;

237 
	}
}

239 
	$modp_gëøw
(
group
 *
gΩ
, 
g¸y_mpi_t
 
v
, *
d
)

241 
size_t
 
l
, 
l2
;

242 *
tmp
;

243 
ªt
;

245 
l
 = 
gΩ
->
	`gëÀn
(grp);

246 
ªt
 = 
	`g¸y_mpi_≠röt
(
GCRYMPI_FMT_STD
, &
tmp
, &
l2
, 
v
);

247 
	`mem˝y
(
d
, 
tmp
 + (
l2
 - 
l
),Ü);

248 
	`g¸y_‰ì
(
tmp
);

251 *
p
;

252 
	`g¸y_mpi_≠röt
(
GCRYMPI_FMT_HEX
, (**)&
p
, 
NULL
, 
v
);

253 
	`¥ötf
("exp‹à%d - %d(%d):\n%s\n", 
l
, 
l2
, 
ªt
, 
p
);

254 
	`g¸y_‰ì
(
p
);

257 
	}
}

259 
	$modp_£åaw
(
group
 *
gΩ
, 
g¸y_mpi_t
 
d
, *
s
, 
l
)

261 
i
;

263 
gΩ
 = 
NULL
;

265 
	`g¸y_mpi_£t_ui
(
d
, 0);

266 
i
 = 0; i < 
l
; i++) {

267 
	`g¸y_mpi_mul_2exp
(
d
, d, 8);

268 
	`g¸y_mpi_add_ui
(
d
, d, 
s
[
i
]);

272 *
p
;

273 
	`g¸y_mpi_≠röt
(
GCRYMPI_FMT_HEX
, (**)&
p
, 
NULL
, 
d
);

274 
	`¥ötf
("imp‹à%d:\n%s\n", 
l
, 
p
);

275 
	`g¸y_‰ì
(
p
);

279 
	}
}

281 
	$modp_£å™dom
(
group
 *
gΩ
, 
g¸y_mpi_t
 
d
)

283 
i
, 
l
 = 
gΩ
->
	`gëÀn
(grp);

284 
uöt32_t
 
tmp
 = 0;

286 
	`g¸y_mpi_£t_ui
(
d
, 0);

288 
i
 = 0; i < 
l
; i++) {

289 i‡(
i
 % 4)

290 
	`g¸y_øndomize
((*)&
tmp
, —mp), 
GCRY_STRONG_RANDOM
);

292 
	`g¸y_mpi_mul_2exp
(
d
, d, 8);

293 
	`g¸y_mpi_add_ui
(
d
, d, 
tmp
 & 0xFF);

294 
tmp
 >>= 8;

297 
	}
}

299 
	$modp_›î©i⁄
(
group
 *group, 
g¸y_mpi_t
 
d
, g¸y_mpi_à
a
, g¸y_mpi_à
e
)

301 
modp_group
 *
gΩ
 = (modp_grou∞*)
group
->group;

303 
	`g¸y_mpi_powm
(
d
, 
a
, 
e
, 
gΩ
->
p
);

305 
	}
}

	@math_group.h

35 #i‚de‡
__MATH_GROUP_H__


36 
	#__MATH_GROUP_H__


	)

38 
	~<g¸y±.h
>

40 
	egroups
 {

41 
	mMODP


44 
	#OAKLEY_GRP_1
 1

	)

45 
	#OAKLEY_GRP_2
 2

	)

46 
	#OAKLEY_GRP_5
 3

	)

54 
	smodp_ds¸
 {

55 
	mid
;

56 
	mbôs
;

57 c⁄° *
	m¥ime
;

58 c⁄° *
	mgí
;

61 
	smodp_group
 {

62 
g¸y_mpi_t
 
	mgí
;

63 
g¸y_mpi_t
 
	mp
;

64 
g¸y_mpi_t
 
	ma
, 
	mb
, 
	mc
, 
	md
;

67 
	sgroup
 {

68 
groups
 
	mty≥
;

69 
	mid
;

70 
	mbôs
;

71 
modp_group
 *
	mgroup
;

72 c⁄° 
modp_ds¸
 *
	mgroup_ds¸
;

73 *
	ma
, *
	mb
, *
	mc
, *
	md
;

74 *
	mgí
;

75 (*
	mgëÀn
Ë(
	mgroup
 *);

76 (*
	mgëøw
Ë(
	mgroup
 *, *, *);

77 (*
	m£åaw
Ë(
	mgroup
 *, *, *, );

78 (*
	m£å™dom
Ë(
	mgroup
 *, *);

79 (*
	m›î©i⁄
Ë(
	mgroup
 *, *, *, *);

84 
group_öô
();

85 
group_‰ì
(
group
 *);

86 
group
 *
group_gë
();

	@supp.c

22 
	~"suµ.h
"

23 
	~"m©h_group.h
"

24 
	~"c⁄fig.h
"

25 
	~"ißkmp.h
"

27 
	~<g¸y±.h
>

28 
	~<°dlib.h
>

30 c⁄° 
suµ‹ãd_Ægo_t
 
	gsuµ_dh_group
[] = {

32 {"dh1", 
OAKLEY_GRP_1
, 
IKE_GROUP_MODP_768
, IKE_GROUP_MODP_768, 0},

33 {"dh2", 
OAKLEY_GRP_2
, 
IKE_GROUP_MODP_1024
, IKE_GROUP_MODP_1024, 0},

34 {"dh5", 
OAKLEY_GRP_5
, 
IKE_GROUP_MODP_1536
, IKE_GROUP_MODP_1536, 0},

36 {
NULL
, 0, 0, 0, 0}

39 c⁄° 
suµ‹ãd_Ægo_t
 
	gsuµ_hash
[] = {

40 {"md5", 
GCRY_MD_MD5
, 
IKE_HASH_MD5
, 
IPSEC_AUTH_HMAC_MD5
, 0},

41 {"sha1", 
GCRY_MD_SHA1
, 
IKE_HASH_SHA
, 
IPSEC_AUTH_HMAC_SHA
, 0},

42 {
NULL
, 0, 0, 0, 0}

45 c⁄° 
suµ‹ãd_Ægo_t
 
	gsuµ_¸y±
[] = {

46 {"nuŒ", 
GCRY_CIPHER_NONE
, 
IKE_ENC_NO_CBC
, 
ISAKMP_IPSEC_ESP_NULL
, 0},

47 {"des", 
GCRY_CIPHER_DES
, 
IKE_ENC_DES_CBC
, 
ISAKMP_IPSEC_ESP_DES
, 0},

48 {"3des", 
GCRY_CIPHER_3DES
, 
IKE_ENC_3DES_CBC
, 
ISAKMP_IPSEC_ESP_3DES
, 0},

49 {"´s128", 
GCRY_CIPHER_AES128
, 
IKE_ENC_AES_CBC
, 
ISAKMP_IPSEC_ESP_AES
, 128},

50 {"´s192", 
GCRY_CIPHER_AES192
, 
IKE_ENC_AES_CBC
, 
ISAKMP_IPSEC_ESP_AES
, 192},

51 {"´s256", 
GCRY_CIPHER_AES256
, 
IKE_ENC_AES_CBC
, 
ISAKMP_IPSEC_ESP_AES
, 256},

52 {
NULL
, 0, 0, 0, 0}

55 c⁄° 
suµ‹ãd_Ægo_t
 
	gsuµ_auth
[] = {

56 {"psk", 0, 
IKE_AUTH_PRESHARED
, 0, 0},

57 {"psk+xauth", 0, 
IKE_AUTH_XAUTHInôPªSh¨ed
, 0, 0},

58 #ifde‡
OPENSSL_GPL_VIOLATION


60 {"˚π(dß)", 0, 
IKE_AUTH_RSA_SIG
, 0, 0},

61 {"˚π‘ßsig)", 0, 
IKE_AUTH_DSS
, 0, 0},

62 {"hybrid(dß)", 0, 
IKE_AUTH_DSS
, 0, 0},

64 {"hybrid‘ß)", 0, 
IKE_AUTH_HybridInôRSA
, 0, 0},

66 {
NULL
, 0, 0, 0, 0}

69 c⁄° 
suµ‹ãd_Ægo_t
 *
	$gë_Ægo
(
Ægo_group
 
wh©
, 
suµ_Ægo_key
 
key
, 
id
,

70 c⁄° *
«me
, 
keyÀn
)

72 c⁄° 
suµ‹ãd_Ægo_t
 *
ß
 = 
NULL
;

73 
i
 = 0, 
vÆ
 = 0;

74 c⁄° *
vÆ«me
 = 
NULL
;

76 
wh©
) {

77 
SUPP_ALGO_DH_GROUP
:

78 
ß
 = 
suµ_dh_group
;

80 
SUPP_ALGO_HASH
:

81 
ß
 = 
suµ_hash
;

83 
SUPP_ALGO_CRYPT
:

84 
ß
 = 
suµ_¸y±
;

86 
SUPP_ALGO_AUTH
:

87 
ß
 = 
suµ_auth
;

90 
	`ab‹t
();

93 
i
 = 0; 
ß
[i].
«me
 !
NULL
; i++) {

94 
key
) {

95 
SUPP_ALGO_NAME
:

96 
vÆ«me
 = 
ß
[
i
].
«me
;

98 
SUPP_ALGO_MY_ID
:

99 
vÆ
 = 
ß
[
i
].
my_id
;

101 
SUPP_ALGO_IKE_SA
:

102 
vÆ
 = 
ß
[
i
].
ike_ß_id
;

104 
SUPP_ALGO_IPSEC_SA
:

105 
vÆ
 = 
ß
[
i
].
ù£c_ß_id
;

108 
	`ab‹t
();

110 i‡((
key
 =
SUPP_ALGO_NAME
Ë? !
	`°rˇ£cmp
(
«me
, 
vÆ«me
Ë: (
vÆ
 =
id
))

111 i‡(
keyÀn
 =
ß
[
i
].keylen)

112  
ß
 + 
i
;

115  
NULL
;

116 
	}
}

118 c⁄° 
suµ‹ãd_Ægo_t
 *
	$gë_dh_group_ike
()

120  
	`gë_Ægo
(
SUPP_ALGO_DH_GROUP
, 
SUPP_ALGO_NAME
, 0, 
c⁄fig
[
CONFIG_IKE_DH
], 0);

121 
	}
}

122 c⁄° 
suµ‹ãd_Ægo_t
 *
	$gë_dh_group_ù£c
(
£rvî_£âög
)

124 c⁄° *
pfs_£âög
 = 
c⁄fig
[
CONFIG_IPSEC_PFS
];

126 i‡(!
	`°rcmp
(
c⁄fig
[
CONFIG_IPSEC_PFS
], "server")) {

128 
pfs_£âög
 = (
£rvî_£âög
 == 1) ? "dh2" : "nopfs";

131  
	`gë_Ægo
(
SUPP_ALGO_DH_GROUP
, 
SUPP_ALGO_NAME
, 0, 
pfs_£âög
, 0);

132 
	}
}

	@supp.h

22 #i‚de‡
__SUPP_H__


23 
	#__SUPP_H__


	)

25 
	esuµ_Ægo_key
 {

26 
	mSUPP_ALGO_NAME
,

27 
	mSUPP_ALGO_MY_ID
,

28 
	mSUPP_ALGO_IKE_SA
,

29 
	mSUPP_ALGO_IPSEC_SA


32 
	eÆgo_group
 {

33 
	mSUPP_ALGO_DH_GROUP
,

34 
	mSUPP_ALGO_HASH
,

35 
	mSUPP_ALGO_CRYPT
,

36 
	mSUPP_ALGO_AUTH


40 c⁄° *
	m«me
;

41 
	mmy_id
, 
	mike_ß_id
, 
	mù£c_ß_id
;

42 
	mkeyÀn
;

43 } 
	tsuµ‹ãd_Ægo_t
;

45 c⁄° 
suµ‹ãd_Ægo_t
 
suµ_dh_group
[];

46 c⁄° 
suµ‹ãd_Ægo_t
 
suµ_hash
[];

47 c⁄° 
suµ‹ãd_Ægo_t
 
suµ_¸y±
[];

48 c⁄° 
suµ‹ãd_Ægo_t
 
suµ_auth
[];

50 c⁄° 
suµ‹ãd_Ægo_t
 *
gë_Ægo
(
Ægo_group
 
wh©
, 
suµ_Ægo_key
 
key
, 
id
, c⁄° *
«me
, 
keyÀn
);

51 c⁄° 
suµ‹ãd_Ægo_t
 *
gë_dh_group_ike
();

52 c⁄° 
suµ‹ãd_Ægo_t
 *
gë_dh_group_ù£c
(
£rvî_£âög
);

	@sysdep.c

20 
	~<uni°d.h
>

21 
	~<f˙é.h
>

22 
	~<°dlib.h
>

23 
	~<°dio.h
>

24 
	~<°rög.h
>

25 
	~<sy¶og.h
>

26 
	~<sys/io˘l.h
>

27 
	~<î∫o.h
>

29 
	~<sys/sockë.h
>

30 
	~<√t/if.h
>

32 #ifde‡
__sun__


33 
	~<˘y≥.h
>

34 
	~<sys/time.h
>

35 
	~<sys/waô.h
>

36 
	~<sys/ty≥s.h
>

37 
	~<sys/sockë.h
>

38 
	~<sys/sockio.h
>

39 
	~<sig«l.h
>

40 
	~<°r›ts.h
>

41 
	~<√töë/ö.h
>

42 
	~<√töë/ö_sy°m.h
>

43 
	~<√töë/ù.h
>

44 
	~<√töë/t˝.h
>

47 #i‡
deföed
(
__CYGWIN__
)

48 
	~<io.h
>

49 
	~<w32≠i/wödef.h
>

50 
	~<w32≠i/wöba£.h
>

51 
	~<w32≠i/wö¡.h
>

52 
	~<w32≠i/wöio˘l.h
>

53 
	~<w32≠i/ùhÕ≠i.h
>

54 
	~<w32≠i/ùty≥s.h
>

55 
	~<w32≠i/wöªg.h
>

56 
	~<sys/cygwö.h
>

59 #i‡
deföed
(
__Døg⁄Fly__
)

60 
	~<√t/tun/if_tun.h
>

61 #ñi‡
deföed
(
__löux__
)

62 
	~<löux/if_tun.h
>

63 #ñi‡
deföed
(
__APPLE__
)

65 #ñi‡
deföed
(
__CYGWIN__
)

66 
	~"èp-wö32.h
"

68 
	~<√t/if_tun.h
>

71 
	~"sysdï.h
"

73 #i‡!
deföed
(
HAVE_VASPRINTF
Ë|| !deföed(
HAVE_ASPRINTF
Ë|| !deföed(
HAVE_ERROR
)

74 
	~<°d¨g.h
>

77 #i‡
deföed
(
__sun__
)

78 **
ívú⁄
;

79 
	gù_fd
 = -1, 
	gmuxid
;

82 #i‡
deföed
(
__CYGWIN__
)

86 
OVERLAPPED
 
	govîœp_ªad
, 
	govîœp_wrôe
;

89 
	mSEARCH_IF_GUID_FROM_NAME
,

90 
	mSEARCH_IF_NAME_FROM_GUID


91 } 
	t£¨ch_if_í
;

98 #i‡
deföed
(
__sun__
)

99 
	$tun_›í
(*
dev
, 
if_mode_íum
 
mode
)

101 
tun_fd
, 
if_fd
, 
µa
 = -1;

102 
i‰eq
 
i‰
;

103 *
±r
;

105 i‡(*
dev
) {

106 
±r
 = 
dev
;

107 *
±r
 && !
	`isdigô
(()*ptr))

108 
±r
++;

109 
µa
 = 
	`©oi
(
±r
);

112 i‡((
ù_fd
 = 
	`›í
("/dev/ù", 
O_RDWR
, 0)) < 0) {

113 
	`sy¶og
(
LOG_ERR
, "Can't open /dev/ip");

117 i‡((
tun_fd
 = 
	`›í
(((
mode
 =
IF_MODE_TUN
Ë? "/dev/tun" : "/dev/èp"), 
O_RDWR
, 0)) < 0) {

118 
	`sy¶og
(
LOG_ERR
, "Can't open /dev/tun");

123 i‡((
µa
 = 
	`io˘l
(
tun_fd
, 
TUNNEWPPA
,Öpa)) < 0) {

124 
	`sy¶og
(
LOG_ERR
, "Can'tássignÇew interface");

128 i‡((
if_fd
 = 
	`›í
(((
mode
 =
IF_MODE_TUN
Ë? "/dev/tun" : "/dev/èp"), 
O_RDWR
, 0)) < 0) {

129 
	`sy¶og
(
LOG_ERR
, "Can't open /dev/tun (2)");

132 i‡(
	`io˘l
(
if_fd
, 
I_PUSH
, "ip") < 0) {

133 
	`sy¶og
(
LOG_ERR
, "Can'tÖush IP module");

138 i‡(
	`io˘l
(
if_fd
, 
IF_UNITSEL
, (*)&
µa
Ë< 0 && 
î∫o
 !
EEXIST
) {

139 
	`sy¶og
(
LOG_ERR
, "C™'à£àPPA %d", 
µa
);

142 i‡((
muxid
 = 
	`io˘l
(
ù_fd
, 
I_PLINK
, 
if_fd
)) < 0) {

143 
	`sy¶og
(
LOG_ERR
, "Can'tÜink TUN deviceÅo IP");

146 
	`˛o£
(
if_fd
);

148 
	`¢¥ötf
(
dev
, 
IFNAMSIZ
, "%s%d", ((
mode
 =
IF_MODE_TUN
Ë? "tun" : "èp"), 
µa
);

150 
	`mem£t
(&
i‰
, 0, (ifr));

151 
	`°r˝y
(
i‰
.
i‰_«me
, 
dev
);

152 
i‰
.
i‰_ù_muxid
 = 
muxid
;

154 i‡(
	`io˘l
(
ù_fd
, 
SIOCSIFMUXID
, &
i‰
) < 0) {

155 
	`io˘l
(
ù_fd
, 
I_PUNLINK
, 
muxid
);

156 
	`sy¶og
(
LOG_ERR
, "Can't set multiplexor id");

160  
tun_fd
;

161 
	}
}

162 #ñi‡
deföed
(
__CYGWIN__
)

166 *
	$£¨ch_if
(*
vÆue
, *
key
, 
£¨ch_if_í
 
ty≥
)

168 
i
 = 0;

169 
LONG
 
°©us
;

170 
DWORD
 
Àn
;

171 
HKEY
 
√t_c⁄n_key
;

172 
BOOL
 
found
 = 
FALSE
;

173 
guid
[256];

174 
i‚ame
[256];

175 
c⁄n_°rög
[512];

176 
HKEY
 
c⁄n_key
;

177 
DWORD
 
vÆue_ty≥
;

179 i‡(!
vÆue
 || !
key
) {

180  
NULL
;

183 
°©us
 = 
	`RegO≥nKeyEx
(
HKEY_LOCAL_MACHINE
,

184 
NETWORK_CONNECTIONS_KEY
,

186 
KEY_READ
,

187 &
√t_c⁄n_key
);

189 i‡(
°©us
 !
ERROR_SUCCESS
) {

190 
	`¥ötf
("Eº‹ o≥nögÑegi°ry key: %s\n", 
NETWORK_CONNECTIONS_KEY
);

191  
NULL
;

194 !
found
) {

195 
Àn
 = (
guid
);

196 
°©us
 = 
	`RegEnumKeyEx
(
√t_c⁄n_key
, 
i
++, 
guid
, &
Àn
,

197 
NULL
, NULL, NULL, NULL);

198 i‡(
°©us
 =
ERROR_NO_MORE_ITEMS
) {

200 } i‡(
°©us
 !
ERROR_SUCCESS
) {

203 
	`¢¥ötf
(
c⁄n_°rög
, (conn_string),

205 
NETWORK_CONNECTIONS_KEY
, 
guid
);

206 
°©us
 = 
	`RegO≥nKeyEx
(
HKEY_LOCAL_MACHINE
,

207 
c⁄n_°rög
,

209 
KEY_READ
,

210 &
c⁄n_key
);

211 i‡(
°©us
 !
ERROR_SUCCESS
) {

214 
Àn
 = (
i‚ame
);

215 
°©us
 = 
	`RegQuîyVÆueEx
(
c⁄n_key
, "Name", 
NULL
,

216 &
vÆue_ty≥
, 
i‚ame
, &
Àn
);

217 i‡(
°©us
 !
ERROR_SUCCESS
 || 
vÆue_ty≥
 !
REG_SZ
) {

218 
	`RegClo£Key
(
c⁄n_key
);

222 
ty≥
) {

223 
SEARCH_IF_GUID_FROM_NAME
:

224 i‡(!
	`°rcmp
(
key
, 
i‚ame
)) {

225 
	`°r˝y
(
vÆue
, 
guid
);

226 
found
 = 
TRUE
;

229 
SEARCH_IF_NAME_FROM_GUID
:

230 i‡(!
	`°rcmp
(
key
, 
guid
)) {

231 
	`°r˝y
(
vÆue
, 
i‚ame
);

232 
found
 = 
TRUE
;

238 
	`RegClo£Key
(
c⁄n_key
);

240 
	`RegClo£Key
(
√t_c⁄n_key
);

242 i‡(
found
) {

243  
vÆue
;

246  
NULL
;

247 
	}
}

252 
	$›í_tun_devi˚
 (*
guid
, *
dev
, 
if_mode_íum
 
mode
)

254 
HANDLE
 
h™dÀ
;

255 
ULONG
 
Àn
, 
°©us
, 
öfo
[3];

256 
devi˚_∑th
[512];

258 
	`¥ötf
("Devi˚: %s\n", 
dev
);

260 i‡(
mode
 =
IF_MODE_TUN
) {

261 
	`¥ötf
("TUN mode isÇot supported\n");

268 
	`¢¥ötf
(
devi˚_∑th
, (device_path), "%s%s%s",

269 
USERMODEDEVICEDIR
, 
guid
, 
TAPSUFFIX
);

271 
h™dÀ
 = 
	`Cª©eFûe
(
devi˚_∑th
,

272 
GENERIC_READ
 | 
GENERIC_WRITE
,

276 
OPEN_EXISTING
,

277 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

280 i‡(
h™dÀ
 =
INVALID_HANDLE_VALUE
) {

287 
	`mem£t
(
öfo
, 0, (info));

288 i‡(
	`Devi˚IoC⁄åﬁ
(
h™dÀ
, 
TAP_IOCTL_GET_VERSION
,

289 &
öfo
, (info),

290 &
öfo
, (öfo), &
Àn
, 
NULL
)) {

291 
	`¥ötf
("TAP-Win32 Driver Version %d.%d %s\n",

292 (Ë
öfo
[0],

293 (Ë
öfo
[1],

294 (
öfo
[2] ? "(DEBUG)" : ""));

300 
°©us
 = 
TRUE
;

301 i‡(!
	`Devi˚IoC⁄åﬁ
(
h™dÀ
, 
TAP_IOCTL_SET_MEDIA_STATUS
,

302 &
°©us
, (status),

303 &
°©us
, (°©us), &
Àn
, 
NULL
)) {

304 
	`¥ötf
("WARNING: The TAP-Win32 driverÑejectedá "

311 
ovîœp_ªad
.
hEvít
 = 
	`Cª©eEvít
(
NULL
, 
TRUE
, 
FALSE
, NULL);

312 
ovîœp_wrôe
.
hEvít
 = 
	`Cª©eEvít
(
NULL
, 
TRUE
, 
FALSE
, NULL);

313 i‡(!
ovîœp_ªad
.
hEvít
 || !
ovîœp_wrôe
.hEvent) {

320  
	`cygwö_©èch_h™dÀ_to_fd
(
NULL
, -1, 
h™dÀ
, 1, 
GENERIC_READ
 | 
GENERIC_WRITE
);

321 
	}
}

327 
	$tun_›í
 (*
dev
, 
if_mode_íum
 
mode
)

329 
fd
 = -1;

330 
HKEY
 
unô_key
;

331 
guid
[256];

332 
comp_id
[256];

333 
íum_«me
[256];

334 
unô_°rög
[512];

335 
BOOL
 
found
 = 
FALSE
;

336 
HKEY
 
ad≠ãr_key
;

337 
DWORD
 
vÆue_ty≥
;

338 
LONG
 
°©us
;

339 
DWORD
 
Àn
;

341 i‡(!
dev
) {

348 i‡(*
dev
 != '\0') {

349 i‡(!
	`£¨ch_if
(
guid
, 
dev
, 
SEARCH_IF_GUID_FROM_NAME
)) {

352  
	`›í_tun_devi˚
(
guid
, 
dev
, 
mode
);

358 
i
 = 0;

359 
°©us
 = 
	`RegO≥nKeyEx
(
HKEY_LOCAL_MACHINE
,

360 
ADAPTER_KEY
,

362 
KEY_READ
,

363 &
ad≠ãr_key
);

364 i‡(
°©us
 !
ERROR_SUCCESS
) {

365 
	`¥ötf
("Eº‹ o≥nögÑegi°ry key: %s", 
ADAPTER_KEY
);

369 !
found
) {

370 
Àn
 = (
íum_«me
);

371 
°©us
 = 
	`RegEnumKeyEx
(
ad≠ãr_key
, 
i
++,

372 
íum_«me
, &
Àn
,

373 
NULL
, NULL, NULL, NULL);

374 i‡(
°©us
 =
ERROR_NO_MORE_ITEMS
) {

376 } i‡(
°©us
 !
ERROR_SUCCESS
) {

379 
	`¢¥ötf
(
unô_°rög
, (unit_string), "%s\\%s",

380 
ADAPTER_KEY
, 
íum_«me
);

381 
°©us
 = 
	`RegO≥nKeyEx
(
HKEY_LOCAL_MACHINE
,

382 
unô_°rög
,

384 
KEY_READ
,

385 &
unô_key
);

386 i‡(
°©us
 !
ERROR_SUCCESS
) {

389 
Àn
 = (
comp_id
);

390 
°©us
 = 
	`RegQuîyVÆueEx
(
unô_key
,

391 "Comp⁄ítId", 
NULL
,

392 &
vÆue_ty≥
, 
comp_id
, &
Àn
);

393 i‡(
°©us
 !
ERROR_SUCCESS
 || 
vÆue_ty≥
 !
REG_SZ
) {

394 
	`RegClo£Key
(
unô_key
);

397 
Àn
 = (
guid
);

398 
°©us
 = 
	`RegQuîyVÆueEx
(
unô_key
,

399 "NëCfgIn°™˚Id", 
NULL
,

400 &
vÆue_ty≥
, 
guid
, &
Àn
);

401 i‡(
°©us
 !
ERROR_SUCCESS
 || 
vÆue_ty≥
 !
REG_SZ
) {

402 
	`RegClo£Key
(
unô_key
);

406 
j
 = 0;

407 
TAP_COMPONENT_ID
[
j
]) {

408 i‡(!
	`°rcmp
(
comp_id
, 
TAP_COMPONENT_ID
[
j
])) {

411 
j
++;

413 i‡(!
TAP_COMPONENT_ID
[
j
]) {

414 
	`RegClo£Key
(
unô_key
);

421 
	`£¨ch_if
(
dev
, 
guid
, 
SEARCH_IF_NAME_FROM_GUID
);

422 
fd
 = 
	`›í_tun_devi˚
(
guid
, 
dev
, 
mode
);

423 i‡(
fd
 != -1) {

424 
found
 = 
TRUE
;

427 
	`RegClo£Key
(
unô_key
);

429 
	`RegClo£Key
(
ad≠ãr_key
);

431  
fd
;

432 
	}
}

433 #ñi‡
deföed
(
IFF_TUN
)

434 
	$tun_›í
(*
dev
, 
if_mode_íum
 
mode
)

436 
i‰eq
 
i‰
;

437 
fd
, 
îr
;

439 i‡((
fd
 = 
	`›í
("/dev/√t/tun", 
O_RDWR
)) < 0) {

440 
	`îr‹
(0, 
î∫o
,

445 
	`mem£t
(&
i‰
, 0, (ifr));

446 
i‰
.
i‰_Êags
 = ((
mode
 =
IF_MODE_TUN
Ë? 
IFF_TUN
 : 
IFF_TAP
Ë| 
IFF_NO_PI
;

447 i‡(*
dev
)

448 
	`°∫˝y
(
i‰
.
i‰_«me
, 
dev
, 
IFNAMSIZ
);

450 i‡((
îr
 = 
	`io˘l
(
fd
, 
TUNSETIFF
, (*)&
i‰
)) < 0) {

451 
	`˛o£
(
fd
);

452  
îr
;

454 
	`°r˝y
(
dev
, 
i‰
.
i‰_«me
);

455  
fd
;

456 
	}
}

458 
	$tun_›í
(*
dev
, 
if_mode_íum
 
mode
)

460 
tu¬ame
[14];

461 
i
, 
fd
;

463 i‡(*
dev
) {

464 i‡(
	`°∫cmp
(
dev
, ((
mode
 =
IF_MODE_TUN
) ? "tun" : "tap"), 3))

465 
	`îr‹
(1, 0,

467 
	`¢¥ötf
(
tu¬ame
, —u¬ame), "/dev/%s", 
dev
);

468  
	`›í
(
tu¬ame
, 
O_RDWR
);

471 
i
 = 0; i < 255; i++) {

472 
	`¢¥ötf
(
tu¬ame
, (tunname), "/dev/%s%d",

473 ((
mode
 =
IF_MODE_TUN
Ë? "tun" : "èp"), 
i
);

475 i‡((
fd
 = 
	`›í
(
tu¬ame
, 
O_RDWR
)) > 0) {

476 
	`¢¥ötf
(
dev
, 
IFNAMSIZ
, "%s%d",

477 ((
mode
 =
IF_MODE_TUN
Ë? "tun" : "èp"), 
i
);

478  
fd
;

482 
	}
}

488 #i‡
deföed
(
__sun__
)

489 
	$tun_˛o£
(
fd
, *
dev
)

491 
i‰eq
 
i‰
;

493 
	`mem£t
(&
i‰
, 0, (ifr));

494 
	`°r˝y
(
i‰
.
i‰_«me
, 
dev
);

495 i‡(
	`io˘l
(
ù_fd
, 
SIOCGIFFLAGS
, &
i‰
) < 0) {

496 
	`sy¶og
(
LOG_ERR
, "Can't get iface flags");

500 i‡(
	`io˘l
(
ù_fd
, 
I_PUNLINK
, 
muxid
) < 0) {

501 
	`sy¶og
(
LOG_ERR
, "Can't unlink interface");

505 
	`˛o£
(
ù_fd
);

506 
ù_fd
 = -1;

507 
	`˛o£
(
fd
);

509 
	}
}

510 #ñi‡
deföed
(
__CYGWIN__
)

511 
	$tun_˛o£
(
fd
, *
dev
)

513 
dev
 = 
NULL
;

514  
	`Clo£H™dÀ
((
HANDLE
Ë
	`gë_osfh™dÀ
(
fd
));

515 
	}
}

517 
	$tun_˛o£
(
fd
, *
dev
)

519 
dev
 = 
NULL
;

520  
	`˛o£
(
fd
);

521 
	}
}

525 #i‡
deföed
(
__sun__
)

526 
	$tun_wrôe
(
fd
, *
buf
, 
Àn
)

528 
°rbuf
 
sbuf
;

529 
sbuf
.
Àn
 =Üen;

530 
sbuf
.
buf
 = buf;

531  
	`putmsg
(
fd
, 
NULL
, &
sbuf
, 0Ë>0 ? sbuf.
Àn
 : -1;

532 
	}
}

534 
	$tun_ªad
(
fd
, *
buf
, 
Àn
)

536 
°rbuf
 
sbuf
;

537 
f
 = 0;

539 
sbuf
.
maxÀn
 = 
Àn
;

540 
sbuf
.
buf
 = buf;

541  
	`gëmsg
(
fd
, 
NULL
, &
sbuf
, &
f
Ë>0 ? sbuf.
Àn
 : -1;

542 
	}
}

543 #ñi‡
deföed
(
__CYGWIN__
)

544 
	$tun_ªad
(
fd
, *
buf
, 
Àn
)

546 
DWORD
 
ªad_size
;

548 
	`Re£tEvít
(
ovîœp_ªad
.
hEvít
);

549 i‡(
	`RódFûe
((
HANDLE
Ë
	`gë_osfh™dÀ
(
fd
), 
buf
, 
Àn
, &
ªad_size
, &
ovîœp_ªad
)) {

550  
ªad_size
;

552 
	`GëLa°Eº‹
()) {

553 
ERROR_IO_PENDING
:

554 
	`WaôF‹SögÀObje˘
(
ovîœp_ªad
.
hEvít
, 
INFINITE
);

555 
	`GëOvîœµedResu…
((
HANDLE
Ë
	`gë_osfh™dÀ
(
fd
), &
ovîœp_ªad
, &
ªad_size
, 
FALSE
);

556  
ªad_size
;

563 
	}
}

565 
	$tun_wrôe
(
fd
, *
buf
, 
Àn
)

567 
DWORD
 
wrôe_size
;

569 
	`Re£tEvít
(
ovîœp_wrôe
.
hEvít
);

570 i‡(
	`WrôeFûe
((
HANDLE
Ë
	`gë_osfh™dÀ
(
fd
),

571 
buf
,

572 
Àn
,

573 &
wrôe_size
,

574 &
ovîœp_wrôe
)) {

575  
wrôe_size
;

577 
	`GëLa°Eº‹
()) {

578 
ERROR_IO_PENDING
:

579 
	`WaôF‹SögÀObje˘
(
ovîœp_wrôe
.
hEvít
, 
INFINITE
);

580 
	`GëOvîœµedResu…
((
HANDLE
Ë
	`gë_osfh™dÀ
(
fd
), &
ovîœp_wrôe
,

581 &
wrôe_size
, 
FALSE
);

582  
wrôe_size
;

589 
	}
}

590 #ñi‡
deföed
(
NEW_TUN
)

591 
	#MAX_MRU
 2048

	)

592 
	stun_d©a
 {

594 
uöt32_t
 
	mÁmûy
;

595 
uöt32_t
 
	mtimeout
;

596 } 
	mhódî
;

597 
u_ch¨
 
	md©a
[
MAX_MRU
];

601 
	$tun_wrôe
(
fd
, *
buf
, 
Àn
)

603 *
d©a
;

604 
tun_d©a
 
tun
;

606 i‡(
Àn
 > ()(
tun
.
d©a
))

609 
	`mem˝y
(
tun
.
d©a
, 
buf
, 
Àn
);

610 
tun
.
hódî
.
Ámûy
 = 
	`ht⁄l
(
AF_INET
);

611 
Àn
 +((
tun
Ë- —un.
d©a
));

612 
d©a
 = (*)&
tun
;

614  
	`wrôe
(
fd
, 
d©a
, 
Àn
Ë- ((
tun
) - (tun.data));

615 
	}
}

617 
	$tun_ªad
(
fd
, *
buf
, 
Àn
)

619 
tun_d©a
 
tun
;

620 *
d©a
;

621 
size_t
 
sz
;

622 
∑ck
;

624 
d©a
 = (*)&
tun
;

625 
sz
 = (
tun
);

626 
∑ck
 = 
	`ªad
(
fd
, 
d©a
, 
sz
);

627 i‡(
∑ck
 == -1)

630 
∑ck
 -
sz
 - (
tun
.
d©a
);

631 i‡(
∑ck
 > 
Àn
)

632 
∑ck
 = 
Àn
;

634 
	`mem˝y
(
buf
, 
tun
.
d©a
, 
∑ck
);

636  
∑ck
;

637 
	}
}

641 
	$tun_wrôe
(
fd
, *
buf
, 
Àn
)

643  
	`wrôe
(
fd
, 
buf
, 
Àn
);

644 
	}
}

646 
	$tun_ªad
(
fd
, *
buf
, 
Àn
)

648  
	`ªad
(
fd
, 
buf
, 
Àn
);

649 
	}
}

656 
	$tun_gë_hwaddr
(
fd
, *
dev
, 
uöt8_t
 *
hwaddr
)

658 #i‡
	`deföed
(
__CYGWIN__
)

659 
ULONG
 
Àn
;

661 
dev
 = 
NULL
;

662 i‡(!
	`Devi˚IoC⁄åﬁ
((
HANDLE
Ë
	`gë_osfh™dÀ
(
fd
), 
TAP_IOCTL_GET_MAC
,

663 
hwaddr
, 
ETH_ALEN
, hwaddr, ETH_ALEN, &
Àn
, 
NULL
)) {

664 
	`¥ötf
("Cannot get HWáddress\n");

669 #ñi‡
	`deföed
(
SIOCGIFHWADDR
)

670 
i‰eq
 
i‰
;

673 i‡((
fd
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0) {

677 
	`mem£t
(&
i‰
, 0, (
i‰eq
));

678 
	`°∫˝y
(
i‰
.
i‰_«me
, 
dev
, 
IFNAMSIZ
);

680 i‡(
	`io˘l
(
fd
, 
SIOCGIFHWADDR
, &
i‰
) < 0) {

684 
	`mem˝y
(
hwaddr
, &
i‰
.
i‰_hwaddr
.
ß_d©a
, 
ETH_ALEN
);

689 
fd
 = 0;

690 
dev
 = 0;

691 
hwaddr
 = 0;

692 
î∫o
 = 
ENOSYS
;

695 
	}
}

700 #i‚de‡
HAVE_VASPRINTF


701 
	$va•rötf
(**
°Ω
, c⁄° *
fmt
, 
va_li°
 
≠
)

703 
ªt
;

704 *
°rbuf
;

706 
ªt
 = 
	`v¢¥ötf
(
NULL
, 0, 
fmt
, 
≠
);

707 
°rbuf
 = (*)
	`mÆloc
(
ªt
 + 1);

708 i‡(
°rbuf
 =
NULL
) {

709 
î∫o
 = 
ENOMEM
;

710 
ªt
 = -1;

712 
	`v¢¥ötf
(
°rbuf
, 
ªt
 + 1, 
fmt
, 
≠
);

713 *
°Ω
 = 
°rbuf
;

714  
ªt
;

715 
	}
}

718 #i‚de‡
HAVE_ASPRINTF


719 
	$a•rötf
(**
°Ω
, c⁄° *
fmt
, ...)

721 
ªt
;

722 
va_li°
 
≠
;

724 
	`va_°¨t
(
≠
, 
fmt
);

725 
ªt
 = 
	`va•rötf
(
°Ω
, 
fmt
, 
≠
);

726 
	`va_íd
(
≠
);

728  
ªt
;

729 
	}
}

732 #i‚de‡
HAVE_ERROR


733 
	$îr‹
(
°©us
, 
îr‹num
, c⁄° *
fmt
, ...)

735 *
buf2
;

736 
va_li°
 
≠
;

738 
	`va_°¨t
(
≠
, 
fmt
);

739 
	`va•rötf
(&
buf2
, 
fmt
, 
≠
);

740 
	`va_íd
(
≠
);

741 
	`Ârötf
(
°dîr
, "%s", 
buf2
);

742 i‡(
îr‹num
)

743 
	`Ârötf
(
°dîr
, ": %s\n", 
	`°ªº‹
(
îr‹num
));

745 
	`Ârötf
(
°dîr
, "\n");

746 
	`‰ì
(
buf2
);

748 i‡(
°©us
)

749 
	`exô
(
°©us
);

750 
	}
}

753 #i‚de‡
HAVE_GETLINE


754 
	$gëlöe
(**
löe
, 
size_t
 * 
Àngth
, 
FILE
 * 
°ªam
)

756 
size_t
 
Àn
;

757 #ifde‡
HAVE_FGETLN


758 *
tm∂öe
;

760 
tm∂öe
 = 
	`fgë 
(
°ªam
, &
Àn
);

762 
tm∂öe
[512];

764 
	`fgës
(
tm∂öe
, —m∂öe), 
°ªam
);

765 
Àn
 = 
	`°æí
(
tm∂öe
);

767 i‡(
	`„of
(
°ªam
))

769 i‡(*
löe
 =
NULL
) {

770 *
löe
 = 
	`mÆloc
(
Àn
 + 1);

771 *
Àngth
 = 
Àn
 + 1;

773 i‡(*
Àngth
 < 
Àn
 + 1) {

774 *
löe
 = 
	`ªÆloc
(*löe, 
Àn
 + 1);

775 *
Àngth
 = 
Àn
 + 1;

777 i‡(*
löe
 =
NULL
)

779 
	`mem˝y
(*
löe
, 
tm∂öe
, 
Àn
);

780 (*
löe
)[
Àn
] = '\0';

781  
Àn
;

782 
	}
}

785 #i‚de‡
HAVE_UNSETENV


786 
	$un£ãnv
(c⁄° *
«me
)

788 
i
, 
Àn
;

790 
Àn
 = 
	`°æí
(
«me
);

791 
i
 = 0; 
ívú⁄
[i]; i++)

792 i‡(!
	`°∫cmp
(
«me
, 
ívú⁄
[
i
], 
Àn
))

793 i‡(
ívú⁄
[
i
][
Àn
] == '=')

796 ; 
ívú⁄
[
i
] &&Énviron[i + 1]; i++)

797 
ívú⁄
[
i
] =Énviron[i + 1];

800 
	}
}

803 #i‚de‡
HAVE_SETENV


804 
	$£ãnv
(c⁄° *
«me
, c⁄° *
vÆue
, 
ovîwrôe
)

806 
ªt
;

807 *
√wív
;

809 i‡(
ovîwrôe
 == 0)

810 i‡(
	`gëív
(
«me
Ë!
NULL
)

813 
√wív
 = 
	`mÆloc
(
	`°æí
(
«me
Ë+ 1 + såÀn(
vÆue
) + 1);

814 i‡(
√wív
 =
NULL
)

817 *
√wív
 = '\0';

818 
	`°rˇt
(
√wív
, 
«me
);

819 
	`°rˇt
(
√wív
, "=");

820 
	`°rˇt
(
√wív
, 
vÆue
);

822 
ªt
 = 
	`puãnv
(
√wív
);

823 i‡(
ªt
 == -1)

824 
	`‰ì
(
√wív
);

826  
ªt
;

827 
	}
}

	@sysdep.h

1 #i‚de‡
__SYSDEP_H__


2 
	#__SYSDEP_H__


	)

21 
	~<sys/ty≥s.h
>

22 
	~<sys/sockë.h
>

23 
	~<√töë/ö.h
>

25 #i‡!
deföed
(
__CYGWIN__
)

26 
	~<√t/if.h
>

27 
	~<√t/if_¨p.h
>

28 
	~<√töë/if_ëhî.h
>

31 
	~"c⁄fig.h
"

33 
tun_›í
(*
dev
, 
if_mode_íum
 
mode
);

34 
tun_˛o£
(
fd
, *
dev
);

35 
tun_wrôe
(
fd
, *
buf
, 
Àn
);

36 
tun_ªad
(
fd
, *
buf
, 
Àn
);

37 
tun_gë_hwaddr
(
fd
, *
dev
, 
uöt8_t
 *
hwaddr
);

40 #i‡
deföed
(
__löux__
Ë|| deföed(
__GLIBC__
)

42 
	#HAVE_VASPRINTF
 1

	)

43 
	#HAVE_ASPRINTF
 1

	)

44 
	#HAVE_ERROR
 1

	)

45 
	#HAVE_GETLINE
 1

	)

46 
	#HAVE_UNSETENV
 1

	)

47 
	#HAVE_SETENV
 1

	)

51 #i‡
deföed
(
__NëBSD__
)

52 
	#HAVE_SA_LEN
 1

	)

54 
	#HAVE_VASPRINTF
 1

	)

55 
	#HAVE_ASPRINTF
 1

	)

56 
	#HAVE_FGETLN
 1

	)

57 
	#HAVE_UNSETENV
 1

	)

58 
	#HAVE_SETENV
 1

	)

62 #i‡
deföed
(
__O≥nBSD__
)

63 
	#HAVE_SA_LEN
 1

	)

64 
	#NEED_IPLEN_FIX
 1

	)

65 
	#NEW_TUN
 1

	)

67 
	#HAVE_VASPRINTF
 1

	)

68 
	#HAVE_ASPRINTF
 1

	)

69 
	#HAVE_FGETLN
 1

	)

70 
	#HAVE_UNSETENV
 1

	)

71 
	#HAVE_SETENV
 1

	)

75 #i‡
deföed
(
__FªeBSD_kî√l__
)

76 
	#HAVE_SA_LEN
 1

	)

80 #i‡
deföed
(
__FªeBSD__
)

81 
	#HAVE_SA_LEN
 1

	)

83 
	#HAVE_VASPRINTF
 1

	)

84 
	#HAVE_ASPRINTF
 1

	)

85 
	#HAVE_FGETLN
 1

	)

86 
	#HAVE_UNSETENV
 1

	)

87 
	#HAVE_SETENV
 1

	)

91 #i‡
deföed
(
__Døg⁄Fly__
)

92 
	#HAVE_SA_LEN
 1

	)

94 
	#HAVE_VASPRINTF
 1

	)

95 
	#HAVE_ASPRINTF
 1

	)

96 
	#HAVE_FGETLN
 1

	)

97 
	#HAVE_UNSETENV
 1

	)

98 
	#HAVE_SETENV
 1

	)

102 #i‡
deföed
(
__APPLE__
)

103 
	#HAVE_SA_LEN
 1

	)

104 
	#NEED_IPLEN_FIX
 1

	)

106 
	#HAVE_VASPRINTF
 1

	)

107 
	#HAVE_ASPRINTF
 1

	)

108 
	#HAVE_FGETLN
 1

	)

109 
	#HAVE_UNSETENV
 1

	)

110 
	#HAVE_SETENV
 1

	)

114 #i‡
deföed
(
__sun__
)

115 
	#NEED_IPLEN_FIX
 1

	)

117 #i‚de‡
IPPROTO_ESP


118 
	#IPPROTO_ESP
 50

	)

121 
	#gë∑ss
(
¥om±
Ë
	`gë∑s•hø£
’rom±)

	)

124 
	~<sys/sockë.h
>

125 c⁄° *
öë_¡›
(
af
, c⁄° *
§c
, *
d°
, 
size_t
 
˙t
);

128 #i‡
deföed
 (
__SKYOS__
)

129 
	#HAVE_UNSETENV
 1

	)

131 #i‚de‡
IPPROTO_ENCAP


132 
	#IPPROTO_ENCAP
 4

	)

135 #i‚de‡
IPPROTO_ESP


136 
	#IPPROTO_ESP
 50

	)

140 #i‡
deföed
 (
__CYGWIN__
)

141 
	#HAVE_VASPRINTF
 1

	)

142 
	#HAVE_ASPRINTF
 1

	)

143 
	#HAVE_GETLINE
 1

	)

144 
	#HAVE_FGETLN
 1

	)

145 
	#HAVE_UNSETENV
 1

	)

146 
	#HAVE_SETENV
 1

	)

148 #i‚de‡
IPPROTO_ESP


149 
	#IPPROTO_ESP
 50

	)

152 #i‚de‡
IPPROTO_ENCAP


153 
	#IPPROTO_ENCAP
 4

	)

156 #ifde‡
IFNAMSIZ


157 #unde‡
IFNAMSIZ


159 
	#IFNAMSIZ
 256

	)

167 
	#ETH_ALEN
 6

	)

170 
	sëhî_hódî


172 
	mëhî_dho°
[
ETH_ALEN
];

173 
	mëhî_sho°
[
ETH_ALEN
];

174 
	mëhî_ty≥
;

175 } 
__©åibuã__
 ((
__∑cked__
));

177 
	#ETHERTYPE_IP
 0x0800

	)

178 
	#ETHERTYPE_ARP
 0x0806

	)

181 
	s¨phdr
 {

182 
	m¨_hrd
;

183 
	m¨_¥o
;

184 
	m¨_h 
;

185 
	m¨_∂n
;

186 
	m¨_›
;

190 
	sëhî_¨p
 {

191 
¨phdr
 
	mó_hdr
;

192 
	m¨p_sha
[
ETH_ALEN
];

193 
	m¨p_•a
[4];

194 
	m¨p_tha
[
ETH_ALEN
];

195 
	m¨p_ça
[4];

197 
	#¨p_hrd
 
ó_hdr
.
¨_hrd


	)

198 
	#¨p_¥o
 
ó_hdr
.
¨_¥o


	)

199 
	#¨p_h 
 
ó_hdr
.
¨_h 


	)

200 
	#¨p_∂n
 
ó_hdr
.
¨_∂n


	)

201 
	#¨p_›
 
ó_hdr
.
¨_›


	)

203 
	#ARPHRD_ETHER
 1

	)

205 
	#ARPOP_REQUEST
 1

	)

206 
	#ARPOP_REPLY
 2

	)

212 #i‚de‡
IPDEFTTL


213 
	#IPDEFTTL
 64

	)

216 #i‚de‡
IPPROTO_IPIP


217 
	#IPPROTO_IPIP
 
IPPROTO_ENCAP


	)

220 #i‚de‡
ETH_HLEN


221 
	#ETH_HLEN
 ((
ëhî_hódî
))

	)

224 #i‚de‡
ETH_ALEN


225 
	#ETH_ALEN
 ((
ëhî_addr
))

	)

228 #i‚de‡
HAVE_ERROR


229 
îr‹
(
fd
, 
îr‹no
, c⁄° *
fmt
, ...);

231 #i‚de‡
HAVE_GETLINE


232 
gëlöe
(**
löe
, 
size_t
 * 
Àngth
, 
FILE
 * 
°ªam
);

234 #i‚de‡
HAVE_VASPRINTF


235 
	~<°d¨g.h
>

236 
va•rötf
(**
°Ω
, c⁄° *
fmt
, 
va_li°
 
≠
);

238 #i‚de‡
HAVE_ASPRINTF


239 
a•rötf
(**
°Ω
, c⁄° *
fmt
, ...);

241 #i‚de‡
HAVE_SETENV


242 
£ãnv
(c⁄° *
«me
, c⁄° *
vÆue
, 
ovîwrôe
);

244 #i‚de‡
HAVE_UNSETENV


245 
un£ãnv
(c⁄° *
«me
);

	@tap-win32.h

42 
	#TAP_CONTROL_CODE
(
ªque°
,
mëhod
) \

43 
	`CTL_CODE
 (
FILE_DEVICE_UNKNOWN
, 
ªque°
, 
mëhod
, 
FILE_ANY_ACCESS
)

	)

47 
	#TAP_IOCTL_GET_MAC
 
	`TAP_CONTROL_CODE
 (1, 
METHOD_BUFFERED
)

	)

48 
	#TAP_IOCTL_GET_VERSION
 
	`TAP_CONTROL_CODE
 (2, 
METHOD_BUFFERED
)

	)

49 
	#TAP_IOCTL_GET_MTU
 
	`TAP_CONTROL_CODE
 (3, 
METHOD_BUFFERED
)

	)

50 
	#TAP_IOCTL_GET_INFO
 
	`TAP_CONTROL_CODE
 (4, 
METHOD_BUFFERED
)

	)

51 
	#TAP_IOCTL_CONFIG_POINT_TO_POINT
 
	`TAP_CONTROL_CODE
 (5, 
METHOD_BUFFERED
)

	)

52 
	#TAP_IOCTL_SET_MEDIA_STATUS
 
	`TAP_CONTROL_CODE
 (6, 
METHOD_BUFFERED
)

	)

53 
	#TAP_IOCTL_CONFIG_DHCP_MASQ
 
	`TAP_CONTROL_CODE
 (7, 
METHOD_BUFFERED
)

	)

54 
	#TAP_IOCTL_GET_LOG_LINE
 
	`TAP_CONTROL_CODE
 (8, 
METHOD_BUFFERED
)

	)

55 
	#TAP_IOCTL_CONFIG_DHCP_SET_OPT
 
	`TAP_CONTROL_CODE
 (9, 
METHOD_BUFFERED
)

	)

60 
	#TAP_IOCTL_CONFIG_TUN
 
	`TAP_CONTROL_CODE
 (10, 
METHOD_BUFFERED
)

	)

66 
	#ADAPTER_KEY
 "SYSTEM\\CuºítC⁄åﬁSë\\C⁄åﬁ\\Cœss\\{4D36E972-E325-11CE-BFC1-08002BE10318}"

	)

68 
	#NETWORK_CONNECTIONS_KEY
 "SYSTEM\\CuºítC⁄åﬁSë\\C⁄åﬁ\\Nëw‹k\\{4D36E972-E325-11CE-BFC1-08002BE10318}"

	)

74 
	#USERMODEDEVICEDIR
 "\\\\.\\GlobÆ\\"

	)

75 
	#SYSDEVICEDIR
 "\\Devi˚\\"

	)

76 
	#USERDEVICEDIR
 "\\DosDevi˚s\\GlobÆ\\"

	)

77 
	#TAPSUFFIX
 ".èp"

	)

85 c⁄° * 
	gTAP_COMPONENT_ID
[] = { "èp0901", "èp0801", 
NULL
 };

	@tunip.c

56 
	~<sys/ty≥s.h
>

57 
	~<sys/sockë.h
>

58 
	~<î∫o.h
>

59 
	~<as£π.h
>

60 
	~<uni°d.h
>

61 
	~<f˙é.h
>

62 
	~<°dio.h
>

63 
	~<√töë/ö_sy°m.h
>

64 
	~<√töë/ö.h
>

65 
	~<√töë/ù.h
>

66 #i‚de‡
__SKYOS__


67 
	~<√töë/ù_icmp.h
>

69 
	~<¨∑/öë.h
>

70 
	~<°dlib.h
>

71 
	~<°rög.h
>

72 
	~<°rögs.h
>

73 
	~<sy¶og.h
>

74 
	~<time.h
>

75 
	~<sys/£À˘.h
>

76 
	~<sig«l.h
>

77 
	~"hacks.h
"

79 
	~<√t/if_ëhî.h
>

81 #ifde‡
__CYGWIN__


82 
	~<±hªad.h
>

85 #i‡!
deföed
(
__sun__
Ë&& !deföed(
__SKYOS__
)

86 
	~<îr.h
>

89 
	~<g¸y±.h
>

90 
	~"sysdï.h
"

91 
	~"c⁄fig.h
"

92 
	~"v≤c.h
"

94 
	~"tunù.h
"

96 #i‚de‡
MAX


97 
	#MAX
(
a
,
b
Ë(◊)>(b)?◊):(b))

	)

100 #i‚de‡
FD_COPY


101 
	#FD_COPY
(
f
, 
t
Ë(()
	`mem˝y
(—), (f), (*(f))))

	)

105 
	se•_íˇp_hódî
 {

106 
uöt32_t
 
	m•i
;

107 
uöt32_t
 
	m£q_id
;

111 } 
	t__©åibuã__
((
	t∑cked
)Ë
	te•_íˇp_hódî_t
;

113 
	síˇp_mëhod
 {

114 
	mfixed_hódî_size
;

116 (*
	mªcv
Ë(
ß_block
 *
	ms
, *
	mbuf
, 
	mbufsize
);

117 (*
	m£nd_≥î
Ë(
ß_block
 *
	ms
, *
	mbuf
, 
	mbufsize
);

118 (*
	mªcv_≥î
Ë(
ß_block
 *
	ms
);

123 
	#GLOBAL_MAX_HEADER
 72

	)

124 
	#MAX_PACKET
 4096

	)

125 vﬁ©ûê
	gdo_kûl
;

126 
uöt8_t
 
	gglobÆ_buf„r_rx
[
GLOBAL_MAX_HEADER
 + 
MAX_PACKET
 + 
ETH_HLEN
];

127 
uöt8_t
 
	gglobÆ_buf„r_tx
[
GLOBAL_MAX_HEADER
 + 
MAX_PACKET
 + 
ETH_HLEN
];

133 
u_sh‹t
 
	$ö_cksum
(
u_sh‹t
 *
addr
, 
Àn
)

135 
∆e·
 = 
Àn
;

136 
u_sh‹t
 *
w
 = 
addr
;

137 
sum
 = 0;

138 
u_sh‹t
 
™swî
 = 0;

145 
∆e·
 > 1) {

146 
sum
 +*
w
++;

147 
∆e·
 -= 2;

151 i‡(
∆e·
 == 1) {

152 *(
u_ch¨
 *Ë(&
™swî
Ë*(u_ch¨ *Ë
w
;

153 
sum
 +
™swî
;

157 
sum
 = (sum >> 16) + (sum & 0xffff);

158 
sum
 += (sum >> 16);

159 
™swî
 = ~
sum
;

160  (
™swî
);

161 
	}
}

166 
	$íˇp_øwù_ªcv
(
ß_block
 *
s
, *
buf
, 
bufsize
)

168 
ssize_t
 
r
;

169 
ù
 *
p
 = (ù *)
buf
;

170 
sockaddr_ö
 
‰om
;

171 
sockÀn_t
 
‰omÀn
 = (
‰om
);

173 
r
 = 
	`ªcv‰om
(
s
->
e•_fd
, 
buf
, 
bufsize
, 0, (
sockaddr
 *)&
‰om
, &
‰omÀn
);

174 i‡(
r
 == -1) {

175 
	`sy¶og
(
LOG_ERR
, "recvfrom: %m");

178 i‡(
‰om
.
sö_addr
.
s_addr
 !
s
->
d°
.s_addr) {

179 
	`sy¶og
(
LOG_ALERT
, "∑ckë from unknow¿ho° %s", 
	`öë_¡ﬂ
(
‰om
.
sö_addr
));

182 i‡(
r
 < (
p
->
ù_hl
 << 2Ë+ 
s
->
ù£c
.
em
->
fixed_hódî_size
) {

183 
	`sy¶og
(
LOG_ALERT
, "∑ckëÅoÿsh‹t. gŸ %d,Éx≥˘ed %d", 
r
, (
p
->
ù_hl
 << 2Ë+ 
s
->
ù£c
.
em
->
fixed_hódî_size
);

187 #ifde‡
NEED_IPLEN_FIX


188 
p
->
ù_Àn
 = 
r
;

190 
p
->
ù_Àn
 = 
	`¡ohs
(
r
);

193 
s
->
ù£c
.
rx
.
buf
 = buf;

194 
s
->
ù£c
.
rx
.
buÊí
 = 
r
;

195 
s
->
ù£c
.
rx
.
buÂaylﬂd
 = (
p
->
ù_hl
 << 2);

196 
s
->
ù£c
.
rx
.
bufsize
 = bufsize;

197  
r
;

198 
	}
}

203 
	$íˇp_udp_ªcv
(
ß_block
 *
s
, *
buf
, 
bufsize
)

205 
ssize_t
 
r
;

207 
r
 = 
	`ªcv
(
s
->
e•_fd
, 
buf
, 
bufsize
, 0);

208 i‡(
r
 == -1) {

209 
	`sy¶og
(
LOG_ERR
, "recvfrom: %m");

212 i‡(
s
->
ù£c
.
«â_a˘ive_mode
 =
NATT_ACTIVE_DRAFT_OLD
 && 
r
 > 8) {

213 
r
 -= 8;

214 
	`memmove
(
buf
, bu‡+ 8, 
r
);

216 if–
r
 =1 && *
buf
 == 0xff )

218 
	`DEBUGTOP
(1, 
	`¥ötf
("UDP NAT keepaliveÖacketÑeceived\n"));

221 i‡(
r
 < 
s
->
ù£c
.
em
->
fixed_hódî_size
) {

222 
	`sy¶og
(
LOG_ALERT
, "packetÅoo short from %s. got %d,Éxpected %d",

223 
	`öë_¡ﬂ
(
s
->
d°
), 
r
, s->
ù£c
.
em
->
fixed_hódî_size
);

227 
s
->
ù£c
.
rx
.
buf
 = buf;

228 
s
->
ù£c
.
rx
.
buÊí
 = 
r
;

229 
s
->
ù£c
.
rx
.
buÂaylﬂd
 = 0;

230 
s
->
ù£c
.
rx
.
bufsize
 = bufsize;

231  
r
;

232 
	}
}

237 
	$íˇp_™y_deˇp
(
ß_block
 *
s
)

239 
s
->
ù£c
.
rx
.
buÊí
 -s->ù£c.rx.
buÂaylﬂd
 + s->ù£c.
em
->
fixed_hódî_size
 + s->ù£c.rx.
v¨_hódî_size
;

240 
s
->
ù£c
.
rx
.
buf
 +s->ù£c.rx.
buÂaylﬂd
 + s->ù£c.
em
->
fixed_hódî_size
 + s->ù£c.rx.
v¨_hódî_size
;

241 i‡(
s
->
ù£c
.
rx
.
buÊí
 == 0)

244 
	}
}

249 
	$tun_£nd_ù
(
ß_block
 *
s
)

251 
£¡
, 
Àn
;

252 
uöt8_t
 *
°¨t
;

254 
°¨t
 = 
s
->
ù£c
.
rx
.
buf
;

255 
Àn
 = 
s
->
ù£c
.
rx
.
buÊí
;

257 i‡(
›t_if_mode
 =
IF_MODE_TAP
) {

263 
ëhî_hódî
 *
ëh_hdr
 = (ëhî_hódî *Ë(
s
->
ù£c
.
rx
.
buf
 - 
ETH_HLEN
);

265 
	`mem˝y
(
ëh_hdr
->
ëhî_dho°
, 
s
->
tun_hwaddr
, 
ETH_ALEN
);

266 
	`mem˝y
(
ëh_hdr
->
ëhî_sho°
, 
s
->
tun_hwaddr
, 
ETH_ALEN
);

269 
ëh_hdr
->
ëhî_sho°
[0] ^= 0x80;

270 
ëh_hdr
->
ëhî_ty≥
 = 
	`ht⁄s
(
ETHERTYPE_IP
);

272 
°¨t
 = (
uöt8_t
 *Ë
ëh_hdr
;

273 
Àn
 +
ETH_HLEN
;

277 
£¡
 = 
	`tun_wrôe
(
s
->
tun_fd
, 
°¨t
, 
Àn
);

278 i‡(
£¡
 !
Àn
)

279 
	`sy¶og
(
LOG_ERR
, "åunˇãd in: %d -> %d\n", 
Àn
, 
£¡
);

280 
	`hex_dump
("TxÖkt", 
°¨t
, 
Àn
, 
NULL
);

282 
	}
}

287 
	$hmac_compuã
(
md_Ægo
,

288 c⁄° *
d©a
, 
d©a_size
,

289 *
dige°
, 
do_°‹e
,

290 c⁄° *
£¸ë
, 
£¸ë_size
)

292 
g¸y_md_hd_t
 
md_˘x
;

293 
ªt
;

294 *
hmac_dige°
;

295 
hmac_Àn
;

298 
	`g¸y_md_›í
(&
md_˘x
, 
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

299 
	`as£π
(
md_˘x
 !
NULL
);

300 
ªt
 = 
	`g¸y_md_£tkey
(
md_˘x
, 
£¸ë
, 
£¸ë_size
);

301 
	`as£π
(
ªt
 == 0);

302 
	`g¸y_md_wrôe
(
md_˘x
, 
d©a
, 
d©a_size
);

303 
	`g¸y_md_föÆ
(
md_˘x
);

304 
hmac_dige°
 = 
	`g¸y_md_ªad
(
md_˘x
, 0);

305 
hmac_Àn
 = 12;

307 i‡(
do_°‹e
) {

308 
	`mem˝y
(
dige°
, 
hmac_dige°
, 
hmac_Àn
);

309 
ªt
 = 0;

311 
ªt
 = 
	`memcmp
(
dige°
, 
hmac_dige°
, 
hmac_Àn
);

313 
	`g¸y_md_˛o£
(
md_˘x
);

314  
ªt
;

315 
	}
}

320 
	$íˇp_e•_íˇpsuœã
(
ß_block
 *
s
)

322 
e•_íˇp_hódî_t
 *
eh
;

323 *
iv
, *
˛óπext
;

324 
size_t
 
i
, 
∑ddög
, 
∑d_blksz
;

325 
˛óπexéí
;

334 
∑d_blksz
 = 
s
->
ù£c
.
blk_Àn
;

335 
∑d_blksz
 & 3)

336 
∑d_blksz
 <<= 1;

337 
∑ddög
 = 
∑d_blksz
 - ((
s
->
ù£c
.
tx
.
buÊí
 + 2 - s->ù£c.tx.
v¨_hódî_size
 - s->ù£c.tx.
buÂaylﬂd
) %Öad_blksz);

338 
	`DEBUG
(3, 
	`¥ötf
("£ndögÖackë:Üí = %d,Öaddög = %lu\n", 
s
->
ù£c
.
tx
.
buÊí
, ()
∑ddög
));

339 i‡(
∑ddög
 =
∑d_blksz
)

340 
∑ddög
 = 0;

342 
i
 = 1; i <
∑ddög
; i++) {

343 
s
->
ù£c
.
tx
.
buf
[s->ù£c.tx.
buÊí
] = 
i
;

344 
s
->
ù£c
.
tx
.
buÊí
++;

348 
s
->
ù£c
.
tx
.
buf
[s->ù£c.tx.
buÊí
++] = 
∑ddög
;

349 
s
->
ù£c
.
tx
.
buf
[s->ù£c.tx.
buÊí
++] = 
IPPROTO_IPIP
;

351 
˛óπext
 = 
s
->
ù£c
.
tx
.
buf
 + s->ù£c.tx.
v¨_hódî_size
 + s->ù£c.tx.
buÂaylﬂd
;

352 
˛óπexéí
 = 
s
->
ù£c
.
tx
.
buÊí
 - s->ù£c.tx.
v¨_hódî_size
 - s->ù£c.tx.
buÂaylﬂd
;

354 
eh
 = (
e•_íˇp_hódî_t
 *Ë(
s
->
ù£c
.
tx
.
buf
 + s->ù£c.tx.
buÂaylﬂd
);

355 
eh
->
•i
 = 
s
->
ù£c
.
tx
.spi;

356 
eh
->
£q_id
 = 
	`ht⁄l
(
s
->
ù£c
.
tx
.seq_id++);

359 
iv
 = (*)(
eh
 + 1);

360 
	`g¸y_¸óã_n⁄˚
(
iv
, 
s
->
ù£c
.
iv_Àn
);

361 
	`hex_dump
("iv", 
iv
, 
s
->
ù£c
.
iv_Àn
, 
NULL
);

363 
	`hex_dump
("£ndög ESPÖackë (bef‹ê¸y±)", 
s
->
ù£c
.
tx
.
buf
, s->ù£c.tx.
buÊí
, 
NULL
);

365 i‡(
s
->
ù£c
.
¸y_Ægo
) {

366 
	`g¸y_cùhî_£tiv
(
s
->
ù£c
.
tx
.
¸y_˘x
, 
iv
, s->ù£c.
iv_Àn
);

367 
	`g¸y_cùhî_í¸y±
(
s
->
ù£c
.
tx
.
¸y_˘x
, 
˛óπext
, 
˛óπexéí
, 
NULL
, 0);

370 
	`hex_dump
("£ndög ESPÖackë (a·î cry±)", 
s
->
ù£c
.
tx
.
buf
, s->ù£c.tx.
buÊí
, 
NULL
);

373 i‡(
s
->
ù£c
.
md_Ægo
) {

374 
	`hmac_compuã
(
s
->
ù£c
.
md_Ægo
,

375 
s
->
ù£c
.
tx
.
buf
 + s->ù£c.tx.
buÂaylﬂd
,

376 
s
->
ù£c
.
tx
.
v¨_hódî_size
 + 
˛óπexéí
,

377 
s
->
ù£c
.
tx
.
buf
 + s->ù£c.tx.
buÂaylﬂd


378 + 
s
->
ù£c
.
tx
.
v¨_hódî_size
 + 
˛óπexéí
,

379 1, 
s
->
ù£c
.
tx
.
key_md
, s->ù£c.
md_Àn
);

380 
s
->
ù£c
.
tx
.
buÊí
 += 12;

381 
	`hex_dump
("£ndög ESPÖackë (a·îáh)", 
s
->
ù£c
.
tx
.
buf
, s->ù£c.tx.
buÊí
, 
NULL
);

383 
	}
}

390 
	$íˇp_e•_£nd_≥î
(
ß_block
 *
s
, *
buf
, 
bufsize
)

392 
ssize_t
 
£¡
;

393 
ù
 *
tù
, ip;

394 
sockaddr_ö
 
d°addr
;

396 
buf
 +
GLOBAL_MAX_HEADER
;

399 
tù
 = (
ù
 *)
buf
;

401 
s
->
ù£c
.
tx
.
buf
 = buf;

402 
s
->
ù£c
.
tx
.
buÊí
 = 
bufsize
;

405 
s
->
ù£c
.
tx
.
v¨_hódî_size
 = (s->ù£c.
em
->
fixed_hódî_size
 + s->ù£c.
iv_Àn
);

407 
s
->
ù£c
.
tx
.
buf
 -(
ù
Ë+ s->ù£c.tx.
v¨_hódî_size
;

408 
s
->
ù£c
.
tx
.
buÊí
 +(
ù
Ë+ s->ù£c.tx.
v¨_hódî_size
;

410 
s
->
ù£c
.
tx
.
buÂaylﬂd
 = (
ù
);

413 
ù
.
ù_v
 = 
IPVERSION
;

414 
ù
.
ù_hl
 = 5;

416 
ù
.
ù_id
 = 
	`ht⁄s
(
s
->
ù£c
.ip_id++);

417 
ù
.
ù_p
 = 
IPPROTO_ESP
;

418 
ù
.
ù_§c
 = 
s
->
§c
;

419 
ù
.
ù_d°
 = 
s
->
d°
;

422 
ù
.
ù_tos
 = (
bufsize
 < (ù)Ë? 0 : 
tù
->ip_tos;

423 
ù
.
ù_off
 = 0;

424 
ù
.
ù_âl
 = 
IPDEFTTL
;

425 
ù
.
ù_sum
 = 0;

427 
	`íˇp_e•_íˇpsuœã
(
s
);

429 
ù
.
ù_Àn
 = 
s
->
ù£c
.
tx
.
buÊí
;

430 #ifde‡
NEED_IPLEN_FIX


431 
ù
.
ù_Àn
 = 
	`ht⁄s
(ip.ip_len);

433 
ù
.
ù_sum
 = 
	`ö_cksum
((
u_sh‹t
 *Ë
s
->
ù£c
.
tx
.
buf
, (ip));

435 
	`mem˝y
(
s
->
ù£c
.
tx
.
buf
, &
ù
,  ip);

437 
d°addr
.
sö_Ámûy
 = 
AF_INET
;

438 
d°addr
.
sö_addr
 = 
s
->
d°
;

439 
d°addr
.
sö_p‹t
 = 0;

440 
£¡
 = 
	`£ndto
(
s
->
e•_fd
, s->
ù£c
.
tx
.
buf
, s->ù£c.tx.
buÊí
, 0, (
sockaddr
 *)&
d°addr
, (
sockaddr_ö
));

441 i‡(
£¡
 == -1) {

442 
	`sy¶og
(
LOG_ERR
, "esp sendto: %m");

445 i‡(
£¡
 !
s
->
ù£c
.
tx
.
buÊí
)

446 
	`sy¶og
(
LOG_ALERT
, "e•Årunˇãd ouà(%Œd ouào‡%d)", ()
£¡
, 
s
->
ù£c
.
tx
.
buÊí
);

447 
	}
}

454 
	$íˇp_udp_£nd_≥î
(
ß_block
 *
s
, *
buf
, 
bufsize
)

456 
ssize_t
 
£¡
;

458 
buf
 +
GLOBAL_MAX_HEADER
;

460 
s
->
ù£c
.
tx
.
buf
 = buf;

461 
s
->
ù£c
.
tx
.
buÊí
 = 
bufsize
;

464 
s
->
ù£c
.
tx
.
v¨_hódî_size
 = (s->ù£c.
em
->
fixed_hódî_size
 + s->ù£c.
iv_Àn
);

466 
s
->
ù£c
.
tx
.
buf
 -s->ù£c.tx.
v¨_hódî_size
;

467 
s
->
ù£c
.
tx
.
buÊí
 +s->ù£c.tx.
v¨_hódî_size
;

469 
s
->
ù£c
.
tx
.
buÂaylﬂd
 = 0;

471 
	`íˇp_e•_íˇpsuœã
(
s
);

473 i‡(
s
->
ù£c
.
«â_a˘ive_mode
 =
NATT_ACTIVE_DRAFT_OLD
) {

474 
s
->
ù£c
.
tx
.
buf
 -= 8;

475 
s
->
ù£c
.
tx
.
buÊí
 += 8;

476 
	`mem£t
(
s
->
ù£c
.
tx
.
buf
, 0, 8);

479 
£¡
 = 
	`£nd
(
s
->
e•_fd
, s->
ù£c
.
tx
.
buf
, s->ù£c.tx.
buÊí
, 0);

480 i‡(
£¡
 == -1) {

481 
	`sy¶og
(
LOG_ERR
, "udp sendto: %m");

484 i‡(
£¡
 !
s
->
ù£c
.
tx
.
buÊí
)

485 
	`sy¶og
(
LOG_ALERT
, "udpÅruncated out (%lld out of %d)",

486 ()
£¡
, 
s
->
ù£c
.
tx
.
buÊí
);

487 
	}
}

489 
	$íˇp_e•_ªcv_≥î
(
ß_block
 *
s
)

491 
Àn
, 
i
;

492 
size_t
 
blksz
;

493 
∑dÀn
, 
√xt_hódî
;

494 *
∑d
;

495 *
iv
;

496 
e•_íˇp_hódî
 *
eh
;

498 
eh
 = (
e•_íˇp_hódî
 *)(
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd
);

499 
s
->
ù£c
.
rx
.
v¨_hódî_size
 = s->ù£c.
iv_Àn
;

500 
iv
 = 
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd
 + s->ù£c.
em
->
fixed_hódî_size
;

502 
Àn
 = 
s
->
ù£c
.
rx
.
buÊí
 - s->ù£c.rx.
buÂaylﬂd
 - s->ù£c.
em
->
fixed_hódî_size
 - s->ù£c.rx.
v¨_hódî_size
;

504 i‡(
Àn
 < 0) {

505 
	`sy¶og
(
LOG_ALERT
, "PacketÅoo short");

510 i‡(
s
->
ù£c
.
md_Ægo
) {

511 
Àn
 -= 12;

512 
s
->
ù£c
.
rx
.
buÊí
 -= 12;

513 i‡(
	`hmac_compuã
(
s
->
ù£c
.
md_Ægo
,

514 
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd
,

515 
s
->
ù£c
.
em
->
fixed_hódî_size
 + s->ù£c.
rx
.
v¨_hódî_size
 + 
Àn
,

516 
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd


517 + 
s
->
ù£c
.
em
->
fixed_hódî_size
 + s->ù£c.
rx
.
v¨_hódî_size
 + 
Àn
,

519 
s
->
ù£c
.
rx
.
key_md
,

520 
s
->
ù£c
.
md_Àn
) != 0) {

521 
	`sy¶og
(
LOG_ALERT
, "HMAC mismatch in ESP mode");

526 
blksz
 = 
s
->
ù£c
.
blk_Àn
;

527 i‡((
Àn
 % 
blksz
) != 0) {

528 
	`sy¶og
(
LOG_ALERT
,

529 "∑ylﬂdÜí %dÇŸá mu…ùÀ o‡Æg‹ôhm block sizê%lu", 
Àn
,

530 ()
blksz
);

534 
	`hex_dump
("receiving ESPÖacket (before decrypt)",

535 &
s
->
ù£c
.
rx
.
buf
[s->ù£c.rx.
buÂaylﬂd
 + s->ù£c.
em
->
fixed_hódî_size
 +

536 
s
->
ù£c
.
rx
.
v¨_hódî_size
], 
Àn
, 
NULL
);

538 i‡(
s
->
ù£c
.
¸y_Ægo
) {

539 *
d©a
;

541 
d©a
 = (
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd


542 + 
s
->
ù£c
.
em
->
fixed_hódî_size
 + s->ù£c.
rx
.
v¨_hódî_size
);

543 
	`g¸y_cùhî_£tiv
(
s
->
ù£c
.
rx
.
¸y_˘x
, 
iv
, s->ù£c.
iv_Àn
);

544 
	`g¸y_cùhî_de¸y±
(
s
->
ù£c
.
rx
.
¸y_˘x
, 
d©a
, 
Àn
, 
NULL
, 0);

547 
	`hex_dump
("receiving ESPÖacket (after decrypt)",

548 &
s
->
ù£c
.
rx
.
buf
[s->ù£c.rx.
buÂaylﬂd
 + s->ù£c.
em
->
fixed_hódî_size
 +

549 
s
->
ù£c
.
rx
.
v¨_hódî_size
], 
Àn
, 
NULL
);

551 
∑dÀn
 = 
s
->
ù£c
.
rx
.
buf
[s->ù£c.rx.
buÂaylﬂd


552 + 
s
->
ù£c
.
em
->
fixed_hódî_size
 + s->ù£c.
rx
.
v¨_hódî_size
 + 
Àn
 - 2];

553 
√xt_hódî
 = 
s
->
ù£c
.
rx
.
buf
[s->ù£c.rx.
buÂaylﬂd


554 + 
s
->
ù£c
.
em
->
fixed_hódî_size
 + s->ù£c.
rx
.
v¨_hódî_size
 + 
Àn
 - 1];

556 i‡(
∑dÀn
 + 2 > 
Àn
) {

557 
	`sy¶og
(
LOG_ALERT
, "InconsistentÖadlen");

560 i‡(
√xt_hódî
 !
IPPROTO_IPIP
) {

561 
	`sy¶og
(
LOG_ALERT
, "Inc⁄si°íà√xt_hódî %d", 
√xt_hódî
);

564 
	`DEBUG
(3, 
	`¥ötf
("∑dÜí: %d,Çext_hódî: %d\n", 
∑dÀn
, 
√xt_hódî
));

566 
Àn
 -
∑dÀn
 + 2;

567 
s
->
ù£c
.
rx
.
buÊí
 -
∑dÀn
 + 2;

570 
∑d
 = 
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd


571 + 
s
->
ù£c
.
em
->
fixed_hódî_size
 + s->ù£c.
rx
.
v¨_hódî_size
 + 
Àn
;

572 
i
 = 1; i <
∑dÀn
; i++) {

573 i‡(*
∑d
 !
i
) {

574 
	`sy¶og
(
LOG_ALERT
, "BadÖadding");

577 
∑d
++;

581 
	}
}

583 
	$íˇp_e•_√w
(
íˇp_mëhod
 *
íˇp
)

585 
íˇp
->
ªcv
 = 
íˇp_øwù_ªcv
;

586 
íˇp
->
£nd_≥î
 = 
íˇp_e•_£nd_≥î
;

587 
íˇp
->
ªcv_≥î
 = 
íˇp_e•_ªcv_≥î
;

588 
íˇp
->
fixed_hódî_size
 = (
e•_íˇp_hódî_t
);

589 
	}
}

591 
	$íˇp_udp_√w
(
íˇp_mëhod
 *
íˇp
)

593 
íˇp
->
ªcv
 = 
íˇp_udp_ªcv
;

594 
íˇp
->
£nd_≥î
 = 
íˇp_udp_£nd_≥î
;

595 
íˇp
->
ªcv_≥î
 = 
íˇp_e•_ªcv_≥î
;

596 
íˇp
->
fixed_hódî_size
 = (
e•_íˇp_hódî_t
);

597 
	}
}

603 
	$¥o˚ss_¨p
(
ß_block
 *
s
, 
uöt8_t
 *
‰ame
)

606 
‰ame_size
;

607 
uöt8_t
 
tmp
[4];

608 
ëhî_hódî
 *
ëh
 = (ëhî_hódî *Ë
‰ame
;

609 
ëhî_¨p
 *
¨p
 = (ëhî_¨∞*Ë(
‰ame
 + 
ETH_HLEN
);

611 i‡(
	`¡ohs
(
ëh
->
ëhî_ty≥
Ë!
ETHERTYPE_ARP
) {

615 i‡(
	`¡ohs
(
¨p
->
¨p_hrd
Ë!
ARPHRD_ETHER
 ||

616 
	`¡ohs
(
¨p
->
¨p_¥o
) != 0x800 ||

617 
¨p
->
¨p_h 
 !
ETH_ALEN
 ||

618 
¨p
->
¨p_∂n
 != 4 ||

619 
	`¡ohs
(
¨p
->
¨p_›
Ë!
ARPOP_REQUEST
 ||

620 !
	`memcmp
(
¨p
->
¨p_•a
,áΩ->
¨p_ça
, 4) ||

621 
	`memcmp
(
ëh
->
ëhî_sho°
, 
s
->
tun_hwaddr
, 
ETH_ALEN
) ||

622 !
	`memcmp
(
¨p
->
¨p_ça
, 
s
->
our_addªss
, 4)) {

629 
	`mem˝y
(
ëh
->
ëhî_dho°
, 
s
->
tun_hwaddr
, 
ETH_ALEN
);

630 
ëh
->
ëhî_sho°
[0] ^= 0x80;

632 
	`mem˝y
(
tmp
, 
¨p
->
¨p_•a
, 4);

633 
	`mem˝y
(
¨p
->
¨p_•a
,áΩ->
¨p_ça
, 4);

634 
	`mem˝y
(
¨p
->
¨p_ça
, 
tmp
, 4);

636 
	`mem˝y
(
¨p
->
¨p_tha
, 
s
->
tun_hwaddr
, 
ETH_ALEN
);

637 
¨p
->
¨p_sha
[0] ^= 0x80;

639 
¨p
->
¨p_›
 = 
	`ht⁄s
(
ARPOP_REPLY
);

641 
‰ame_size
 = 
ETH_HLEN
 + (
ëhî_¨p
);

642 
	`tun_wrôe
(
s
->
tun_fd
, 
‰ame
, 
‰ame_size
);

643 
	`hex_dump
("ARPÑïly", 
‰ame
, 
‰ame_size
, 
NULL
);

647 
s
 = 0;

648 
‰ame
 = 0;

651 
	}
}

657 
	$¥o˚ss_n⁄_ù
(
ß_block
 *
s
, 
uöt8_t
 *
‰ame
)

659 
ëhî_hódî
 *
ëh
 = (ëhî_hódî *Ë
‰ame
;

661 
s
 = 
NULL
;

663 i‡(
	`¡ohs
(
ëh
->
ëhî_ty≥
Ë!
ETHERTYPE_IP
) {

669 
	}
}

671 
	$¥o˚ss_tun
(
ß_block
 *
s
)

673 
∑ck
;

674 
size
 = 
MAX_PACKET
;

675 
uöt8_t
 *
°¨t
 = 
globÆ_buf„r_rx
 + 
GLOBAL_MAX_HEADER
;

677 i‡(
›t_if_mode
 =
IF_MODE_TAP
) {

679 
°¨t
 -
ETH_HLEN
;

680 
size
 +
ETH_HLEN
;

684 
∑ck
 = 
	`tun_ªad
(
s
->
tun_fd
, 
°¨t
, 
size
);

686 
	`hex_dump
("RxÖkt", 
°¨t
, 
∑ck
, 
NULL
);

688 i‡(
›t_if_mode
 =
IF_MODE_TAP
) {

689 i‡(
	`¥o˚ss_¨p
(
s
, 
°¨t
)) {

692 i‡(
	`¥o˚ss_n⁄_ù
(
s
, 
°¨t
)) {

695 
∑ck
 -
ETH_HLEN
;

698 i‡(
∑ck
 == -1) {

699 
	`sy¶og
(
LOG_ERR
, "read: %m");

706 i‡(!
	`memcmp
(
globÆ_buf„r_rx
 + 
GLOBAL_MAX_HEADER
 + 12, &
s
->
d°
.
s_addr
, 4)) {

707 
	`sy¶og
(
LOG_ALERT
, "routingÜoopÅo %s",

708 
	`öë_¡ﬂ
(
s
->
d°
));

713 
s
->
ù£c
.
li„
.
tx
 +
∑ck
;

714 
s
->
ù£c
.
em
->
	`£nd_≥î
(s, 
globÆ_buf„r_rx
, 
∑ck
);

715 
	}
}

717 
	$¥o˚ss_sockë
(
ß_block
 *
s
)

720 
∑ck
;

721 
uöt8_t
 *
°¨t
 = 
globÆ_buf„r_tx
;

722 
e•_íˇp_hódî_t
 *
eh
;

724 i‡(
›t_if_mode
 =
IF_MODE_TAP
) {

725 
°¨t
 +
ETH_HLEN
;

728 
∑ck
 = 
s
->
ù£c
.
em
->
	`ªcv
(s, 
°¨t
, 
GLOBAL_MAX_HEADER
 + 
MAX_PACKET
);

729 i‡(
∑ck
 == -1)

732 
eh
 = (
e•_íˇp_hódî_t
 *Ë(
s
->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd
);

733 i‡(
eh
->
•i
 == 0) {

734 
	`¥o˚ss_œã_ike
(
s
, s->
ù£c
.
rx
.
buf
 + s->ù£c.rx.
buÂaylﬂd
 + 4 ,

735 
s
->
ù£c
.
rx
.
buÊí
 - s->ù£c.rx.
buÂaylﬂd
 - 4);

737 } i‡(
eh
->
•i
 !
s
->
ù£c
.
rx
.spi) {

738 
	`sy¶og
(
LOG_NOTICE
, "unknow¿•ò%#08x fromÖìr", 
	`¡ohl
(
eh
->
•i
));

743 i‡(
s
->
ù£c
.
em
->
	`ªcv_≥î
(s) != 0)

746 i‡(
	`íˇp_™y_deˇp
(
s
) == 0) {

747 
	`sy¶og
(
LOG_DEBUG
, "received updateÖrobe fromÖeer");

750 
s
->
ù£c
.
li„
.
rx
 +s->ù£c.rx.
buÊí
;

751 
	`tun_£nd_ù
(
s
);

753 
	}
}

755 #i‡
deföed
(
__CYGWIN__
)

756 *
	$tun_thªad
 (*
¨g
)

758 
ß_block
 *
s
 = (ß_block *Ë
¨g
;

760 !
do_kûl
) {

761 
	`¥o˚ss_tun
(
s
);

763  
NULL
;

764 
	}
}

767 
	$v≤c_maö_lo›
(
ß_block
 *
s
)

769 
fd_£t
 
rfds
, 
ªfds
;

770 
nfds
=0;

771 
íabÀ_kì∑lives
;

772 
timed_mode
;

773 
ssize_t
 
Àn
;

774 
timevÆ
 
£À˘_timeout
;

775 
timevÆ
 
n‹mÆ_timeout
;

776 
time_t
 
√xt_ike_kì∑live
=0;

777 
time_t
 
√xt_ike_dpd
=0;

778 #i‡
	`deföed
(
__CYGWIN__
)

779 
±hªad_t
 
tid
;

783 
uöt8_t
 
kì∑live_v2
[5] = { 0x00, 0x00, 0x00, 0x00, 0xFF };

784 
uöt8_t
 
kì∑live_v1
[1] = { 0xFF };

785 
uöt8_t
 *
kì∑live
;

786 
size_t
 
kì∑live_size
;

788 i‡(
s
->
ù£c
.
«â_a˘ive_mode
 =
NATT_ACTIVE_DRAFT_OLD
) {

789 
kì∑live
 = 
kì∑live_v1
;

790 
kì∑live_size
 = (
kì∑live_v1
);

792 
kì∑live
 = 
kì∑live_v2
;

793 
kì∑live_size
 = (
kì∑live_v2
);

797 
íabÀ_kì∑lives
 = (
s
->
ù£c
.
íˇp_mode
 !
IPSEC_ENCAP_TUNNEL
);

800 
timed_mode
 = ((
íabÀ_kì∑lives
 && 
s
->
ike_fd
 !s->
e•_fd
Ë|| s->
ike
.
do_dpd
);

802 
	`FD_ZERO
(&
rfds
);

804 #i‡!
	`deföed
(
__CYGWIN__
)

805 
	`FD_SET
(
s
->
tun_fd
, &
rfds
);

806 
nfds
 = 
	`MAX
“fds, 
s
->
tun_fd
 +1);

809 
	`FD_SET
(
s
->
e•_fd
, &
rfds
);

810 
nfds
 = 
	`MAX
“fds, 
s
->
e•_fd
 +1);

812 i‡(
s
->
ike_fd
 !s->
e•_fd
) {

813 
	`FD_SET
(
s
->
ike_fd
, &
rfds
);

814 
nfds
 = 
	`MAX
“fds, 
s
->
ike_fd
 +1);

817 #i‡
	`deföed
(
__CYGWIN__
)

818 i‡(
	`±hªad_¸óã
(&
tid
, 
NULL
, 
tun_thªad
, 
s
)) {

819 
	`sy¶og
(
LOG_ERR
, "Cannot createÅunÅhread!\n");

824 
n‹mÆ_timeout
.
tv_£c
 = 86400;

825 
n‹mÆ_timeout
.
tv_u£c
 = 0;

827 i‡(
s
->
ike
.
do_dpd
) {

829 
√xt_ike_dpd
 = 
	`time
(
NULL
Ë+ 
s
->
ike
.
dpd_idÀ
;

830 
	`dpd_ike
(
s
);

831 
n‹mÆ_timeout
.
tv_£c
 = 
s
->
ike
.
dpd_idÀ
;

832 
n‹mÆ_timeout
.
tv_u£c
 = 0;

835 i‡(
íabÀ_kì∑lives
) {

836 
n‹mÆ_timeout
.
tv_£c
 = 9;

837 
n‹mÆ_timeout
.
tv_u£c
 = 500000;

839 i‡(
s
->
ike_fd
 !s->
e•_fd
) {

841 
√xt_ike_kì∑live
 = 
	`time
(
NULL
) + 9;

842 
	`kì∑live_ike
(
s
);

846 
£À˘_timeout
 = 
n‹mÆ_timeout
;

848 !
do_kûl
) {

849 
¥esu…
;

852 
timevÆ
 *
tvp
 = 
NULL
;

853 
	`FD_COPY
(&
rfds
, &
ªfds
);

854 i‡(
s
->
ike
.
do_dpd
 || 
íabÀ_kì∑lives
)

855 
tvp
 = &
£À˘_timeout
;

856 
¥esu…
 = 
	`£À˘
(
nfds
, &
ªfds
, 
NULL
, NULL, 
tvp
);

857 i‡(
¥esu…
 =0 && (
s
->
ike
.
do_dpd
 || 
íabÀ_kì∑lives
)) {

859 
£À˘_timeout
 = 
n‹mÆ_timeout
;

860 i‡(
íabÀ_kì∑lives
) {

861 i‡(
s
->
ike_fd
 !s->
e•_fd
) {

863 
√xt_ike_kì∑live
 = 
	`time
(
NULL
) + 9;

864 
	`kì∑live_ike
(
s
);

867 i‡(
	`£nd
(
s
->
e•_fd
, 
kì∑live
, 
kì∑live_size
, 0) == -1) {

868 
	`sy¶og
(
LOG_ERR
, "keepalive sendto: %m");

871 i‡(
s
->
ike
.
do_dpd
) {

872 
time_t
 
now
 = 
	`time
(
NULL
);

873 i‡(
s
->
ike
.
dpd_£qno
 !s->ike.
dpd_£qno_ack
) {

875 
£À˘_timeout
.
tv_£c
 = 5;

876 
£À˘_timeout
.
tv_u£c
 = 0;

877 
	`dpd_ike
(
s
);

878 
√xt_ike_dpd
 = 
now
 + 
s
->
ike
.
dpd_idÀ
;

880 i‡(
now
 >
√xt_ike_dpd
) {

881 
	`dpd_ike
(
s
);

882 
√xt_ike_dpd
 = 
now
 + 
s
->
ike
.
dpd_idÀ
;

886 
	`DEBUG
(2,
	`¥ötf
("lifetime status: %ld of %u seconds used, %u|%u of %u kbytes used\n",

887 
	`time
(
NULL
Ë- 
s
->
ù£c
.
li„
.
°¨t
,

888 
s
->
ù£c
.
li„
.
£c⁄ds
,

889 
s
->
ù£c
.
li„
.
rx
/1024,

890 
s
->
ù£c
.
li„
.
tx
/1024,

891 
s
->
ù£c
.
li„
.
kbyãs
));

892 } (
¥esu…
 =0 || (¥esu… =-1 && 
î∫o
 =
EINTR
)Ë&& !
do_kûl
);

893 i‡(
¥esu…
 == -1) {

894 
	`sy¶og
(
LOG_ERR
, "select: %m");

898 #i‡!
	`deföed
(
__CYGWIN__
)

899 i‡(
	`FD_ISSET
(
s
->
tun_fd
, &
ªfds
)) {

900 
	`¥o˚ss_tun
(
s
);

904 i‡(
	`FD_ISSET
(
s
->
e•_fd
, &
ªfds
) ) {

905 
	`¥o˚ss_sockë
(
s
);

908 i‡(
s
->
ike_fd
 !s->
e•_fd
 && 
	`FD_ISSET
(s->ike_fd, &
ªfds
) ) {

909 
	`DEBUG
(3,
	`¥ötf
("received something on ike fd..\n"));

910 
Àn
 = 
	`ªcv
(
s
->
ike_fd
, 
globÆ_buf„r_tx
, 
GLOBAL_MAX_HEADER
 + 
MAX_PACKET
, 0);

911 
	`¥o˚ss_œã_ike
(
s
, 
globÆ_buf„r_tx
, 
Àn
);

914 i‡(
timed_mode
) {

915 
time_t
 
now
 = 
	`time
(
NULL
);

916 
time_t
 
√xt_up
 = 
now
 + 86400;

917 i‡(
íabÀ_kì∑lives
) {

919 
√xt_up
 = 
now
 + 9;

920 i‡(
s
->
ike_fd
 !s->
e•_fd
) {

921 i‡(
now
 >
√xt_ike_kì∑live
) {

923 
√xt_ike_kì∑live
 = 
now
 + 9;

924 
	`kì∑live_ike
(
s
);

925 
£À˘_timeout
 = 
n‹mÆ_timeout
;

927 i‡(
√xt_ike_kì∑live
 < 
√xt_up
)

928 
√xt_up
 = 
√xt_ike_kì∑live
;

931 i‡(
s
->
ike
.
do_dpd
) {

932 i‡(
s
->
ike
.
dpd_£qno
 !s->ike.
dpd_£qno_ack
) {

933 
	`dpd_ike
(
s
);

934 
√xt_ike_dpd
 = 
now
 + 
s
->
ike
.
dpd_idÀ
;

935 i‡(
now
 + 5 < 
√xt_up
)

936 
√xt_up
 = 
now
 + 5;

938 i‡(
now
 >
√xt_ike_dpd
) {

939 
	`dpd_ike
(
s
);

940 
√xt_ike_dpd
 = 
now
 + 
s
->
ike
.
dpd_idÀ
;

942 i‡(
√xt_ike_dpd
 < 
√xt_up
)

943 
√xt_up
 = 
√xt_ike_dpd
;

946 
£À˘_timeout
.
tv_£c
 = 
√xt_up
 - 
now
;

947 
£À˘_timeout
.
tv_u£c
 = 0;

952 
do_kûl
) {

954 
	`sy¶og
(
LOG_NOTICE
, "connectionÅerminated by deadÖeer detection");

957 
	`sy¶og
(
LOG_NOTICE
, "connectionÅerminated byÖeer");

960 
	`sy¶og
(
LOG_NOTICE
, "ãrmö©ed by sig«l: %d", 
do_kûl
);

963 
	}
}

965 
	$kûlô
(
signum
)

967 
do_kûl
 = 
signum
;

968 
	}
}

970 
	$wrôe_pidfûe
(c⁄° *
pidfûe
)

972 
FILE
 *
pf
;

974 i‡(
pidfûe
 =
NULL
 ||Öidfile[0] == '\0')

977 
pf
 = 
	`f›í
(
pidfûe
, "w");

978 i‡(
pf
 =
NULL
) {

979 
	`sy¶og
(
LOG_WARNING
, "ˇn'à›íÖidfûê%†f‹ wrôög", 
pidfûe
);

983 
	`Ârötf
(
pf
, "%d\n", ()
	`gëpid
());

984 
	`f˛o£
(
pf
);

985 
	}
}

987 
	$v≤c_doô
(
ß_block
 *
s
)

989 
siga˘i⁄
 
a˘
;

990 
íˇp_mëhod
 
mëh
;

992 c⁄° *
pidfûe
 = 
c⁄fig
[
CONFIG_PID_FILE
];

994 
s
->
ù£c
.
íˇp_mode
) {

995 
IPSEC_ENCAP_TUNNEL
:

996 
	`íˇp_e•_√w
(&
mëh
);

997 
	`g¸y_¸óã_n⁄˚
(&
s
->
ù£c
.
ù_id
, (
uöt16_t
));

999 
IPSEC_ENCAP_UDP_TUNNEL
:

1000 
IPSEC_ENCAP_UDP_TUNNEL_OLD
:

1001 
	`íˇp_udp_√w
(&
mëh
);

1004 
	`ab‹t
();

1006 
s
->
ù£c
.
em
 = &
mëh
;

1008 
s
->
ù£c
.
rx
.
key_¸y
 = s->ù£c.rx.
key
;

1009 
	`hex_dump
("rx.key_¸y", 
s
->
ù£c
.
rx
.
key_¸y
, s->ù£c.
key_Àn
, 
NULL
);

1011 
s
->
ù£c
.
rx
.
key_md
 = s->ù£c.rx.
key
 + s->ù£c.
key_Àn
;

1012 
	`hex_dump
("rx.key_md", 
s
->
ù£c
.
rx
.
key_md
, s->ù£c.
md_Àn
, 
NULL
);

1014 i‡(
s
->
ù£c
.
¸y_Ægo
) {

1015 
	`g¸y_cùhî_›í
(&
s
->
ù£c
.
rx
.
¸y_˘x
, s->ù£c.
¸y_Ægo
, 
GCRY_CIPHER_MODE_CBC
, 0);

1016 
	`g¸y_cùhî_£tkey
(
s
->
ù£c
.
rx
.
¸y_˘x
, s->ù£c.rx.
key_¸y
, s->ù£c.
key_Àn
);

1018 
s
->
ù£c
.
rx
.
¸y_˘x
 = 
NULL
;

1021 
s
->
ù£c
.
tx
.
key_¸y
 = s->ù£c.tx.
key
;

1022 
	`hex_dump
("tx.key_¸y", 
s
->
ù£c
.
tx
.
key_¸y
, s->ù£c.
key_Àn
, 
NULL
);

1024 
s
->
ù£c
.
tx
.
key_md
 = s->ù£c.tx.
key
 + s->ù£c.
key_Àn
;

1025 
	`hex_dump
("tx.key_md", 
s
->
ù£c
.
tx
.
key_md
, s->ù£c.
md_Àn
, 
NULL
);

1027 i‡(
s
->
ù£c
.
¸y_Ægo
) {

1028 
	`g¸y_cùhî_›í
(&
s
->
ù£c
.
tx
.
¸y_˘x
, s->ù£c.
¸y_Ægo
, 
GCRY_CIPHER_MODE_CBC
, 0);

1029 
	`g¸y_cùhî_£tkey
(
s
->
ù£c
.
tx
.
¸y_˘x
, s->ù£c.tx.
key_¸y
, s->ù£c.
key_Àn
);

1031 
s
->
ù£c
.
tx
.
¸y_˘x
 = 
NULL
;

1034 
	`DEBUG
(2, 
	`¥ötf
("ªmŸê->Üoˇ»•i: %#08x\n", 
	`¡ohl
(
s
->
ù£c
.
rx
.
•i
)));

1035 
	`DEBUG
(2, 
	`¥ötf
("loˇ»->ÑemŸê•i: %#08x\n", 
	`¡ohl
(
s
->
ù£c
.
tx
.
•i
)));

1037 
do_kûl
 = 0;

1039 
	`siga˘i⁄
(
SIGHUP
, 
NULL
, &
a˘
);

1040 i‡(
a˘
.
ß_h™dÀr
 =
SIG_DFL
)

1041 
	`sig«l
(
SIGHUP
, 
kûlô
);

1043 
	`sig«l
(
SIGINT
, 
kûlô
);

1044 
	`sig«l
(
SIGTERM
, 
kûlô
);

1046 
	`chdú
("/");

1048 i‡(!
›t_nd
) {

1049 
pid_t
 
pid
;

1050 i‡((
pid
 = 
	`f‹k
()) < 0) {

1051 
	`Ârötf
(
°dîr
, "Warning, couldÇot forkÅhe childÖrocess!\n");

1052 } i‡(
pid
 == 0) {

1053 
	`˛o£
(0); 
	`›í
("/dev/nuŒ", 
O_RDONLY
, 0666);

1054 
	`˛o£
(1); 
	`›í
("/dev/nuŒ", 
O_WRONLY
, 0666);

1055 
	`˛o£
(2); 
	`›í
("/dev/nuŒ", 
O_WRONLY
, 0666);

1056 
	`£tsid
();

1058 
	`¥ötf
("VPNC sèπed i¿background (pid: %d)...\n", ()
pid
);

1059 
	`exô
(0);

1062 
	`¥ötf
("VPNC started in foreground...\n");

1064 
	`›ílog
("v≤c", 
LOG_PID
 | 
LOG_PERROR
, 
LOG_DAEMON
);

1065 
	`wrôe_pidfûe
(
pidfûe
);

1067 
	`v≤c_maö_lo›
(
s
);

1069 i‡(
pidfûe
)

1070 
	`u∆ök
(
pidfûe
);

1071 
	}
}

	@tunip.h

21 #i‚de‡
__TUNIP_H__


22 
	#__TUNIP_H__


	)

24 
	~"ißkmp.h
"

26 
	~<time.h
>

27 
	~<√t/if.h
>

29 
	sli„time
 {

30 
time_t
 
	m°¨t
;

31 
uöt32_t
 
	m£c⁄ds
;

32 
uöt32_t
 
	mkbyãs
;

33 
uöt32_t
 
	mrx
;

34 
uöt32_t
 
	mtx
;

37 
	sike_ß
 {

38 
uöt32_t
 
	m•i
;

39 
uöt32_t
 
	m£q_id
;

41 
uöt8_t
 *
	mkey
;

42 
uöt8_t
 *
	mkey_¸y
;

43 
g¸y_cùhî_hd_t
 
	m¸y_˘x
;

44 
uöt8_t
 *
	mkey_md
;

47 *
	mbuf
;

48 
	mbufsize
, 
	mbuÂaylﬂd
, 
	mv¨_hódî_size
;

49 
	mbuÊí
;

52 
	gíˇp_mëhod
;

54 
	e«â_a˘ive_mode_íum
{

55 
	mNATT_ACTIVE_NONE
,

56 
	mNATT_ACTIVE_CISCO_UDP
,

57 
	mNATT_ACTIVE_DRAFT_OLD
,

58 
	mNATT_ACTIVE_RFC


61 
	sß_block
 {

62 c⁄° *
	mpidfûe
;

64 
	mtun_fd
;

65 
	mtun_«me
[
IFNAMSIZ
];

66 
uöt8_t
 
	mtun_hwaddr
[
ETH_ALEN
];

68 
ö_addr
 
	md°
;

69 
ö_addr
 
	m§c
;

71 
ö_addr
 
	m›t_§c_ù
;

74 
	mike_fd
;

75 
	me•_fd
;

78 
	mtimeout
;

79 
uöt8_t
 *
	mª£nd_hash
;

80 
uöt16_t
 
	m§c_p‹t
, 
	md°_p‹t
;

81 
uöt8_t
 
	mi_cookõ
[
ISAKMP_COOKIE_LENGTH
];

82 
uöt8_t
 
	mr_cookõ
[
ISAKMP_COOKIE_LENGTH
];

83 
uöt8_t
 *
	mkey
;

84 
size_t
 
	mkeyÀn
;

85 
uöt8_t
 *
	möôül_iv
;

86 
uöt8_t
 *
	mskeyid_a
;

87 
uöt8_t
 *
	mskeyid_d
;

88 
	mauth_Ægo
;

89 
	m¸y_Ægo
, 
	mmd_Ægo
;

90 
size_t
 
	mivÀn
, 
	mmd_Àn
;

91 
uöt8_t
 
	mcuºít_iv_msgid
[4];

92 
uöt8_t
 *
	mcuºít_iv
;

93 
li„time
 
	mli„
;

94 
	mdo_dpd
;

95 
	mdpd_idÀ
;

96 
uöt32_t
 
	mdpd_£qno
;

97 
uöt32_t
 
	mdpd_£qno_ack
;

98 
time_t
 
	mdpd_£¡
;

99 
	mdpd_©ãm±s
;

100 } 
	mike
;

101 
uöt8_t
 
	mour_addªss
[4], 
	mour_√tmask
[4];

103 
	mdo_pfs
;

104 
	m¸y_Ægo
, 
	mmd_Ægo
;

105 
size_t
 
	mkey_Àn
, 
	mmd_Àn
;

106 
size_t
 
	mblk_Àn
, 
	miv_Àn
;

107 
uöt16_t
 
	míˇp_mode
;

108 
uöt16_t
 
	m≥î_ud≥nˇp_p‹t
;

109 
«â_a˘ive_mode_íum
 
	m«â_a˘ive_mode
;

110 
li„time
 
	mli„
;

111 
ike_ß
 
	mrx
, 
	mtx
;

112 
íˇp_mëhod
 *
	mem
;

113 
uöt16_t
 
	mù_id
;

114 } 
	mù£c
;

117 vﬁ©ûê
do_kûl
;

118 
v≤c_doô
(
ß_block
 *
s
);

	@vpnc-debug.c

3 
	~<°dio.h
>

5 
	~"v≤c-debug.h
"

6 
	~"ißkmp.h
"

8 c⁄° *
	$vÆ_to_°rög
(
vÆ
, c⁄° 
debug_°rögs
 *
d°rögs
)

10 c⁄° *
unknown
 = " (unknown)";

11 c⁄° *
«
 = "";

12 
i
;

14 i‡(
d°rögs
 =
NULL
)

15  
«
;

17 
i
 = 0; 
d°rögs
[i].
id
 !0 || d°rögs[i].
°rög
 !
NULL
; i++)

18 i‡(
d°rögs
[
i
].
id
 =
vÆ
)

19  
d°rögs
[
i
].
°rög
;

20  
unknown
;

21 
	}
}

23 c⁄° 
debug_°rögs
 
	gißkmp_∑ylﬂd_íum_¨øy
[] = {

24 { 
ISAKMP_PAYLOAD_NONE
, " (ISAKMP_PAYLOAD_NONE)" },

25 { 
ISAKMP_PAYLOAD_SA
, " (ISAKMP_PAYLOAD_SA)" },

26 { 
ISAKMP_PAYLOAD_P
, " (ISAKMP_PAYLOAD_P)" },

27 { 
ISAKMP_PAYLOAD_T
, " (ISAKMP_PAYLOAD_T)" },

28 { 
ISAKMP_PAYLOAD_KE
, " (ISAKMP_PAYLOAD_KE)" },

29 { 
ISAKMP_PAYLOAD_ID
, " (ISAKMP_PAYLOAD_ID)" },

30 { 
ISAKMP_PAYLOAD_CERT
, " (ISAKMP_PAYLOAD_CERT)" },

31 { 
ISAKMP_PAYLOAD_CR
, " (ISAKMP_PAYLOAD_CR)" },

32 { 
ISAKMP_PAYLOAD_HASH
, " (ISAKMP_PAYLOAD_HASH)" },

33 { 
ISAKMP_PAYLOAD_SIG
, " (ISAKMP_PAYLOAD_SIG)" },

34 { 
ISAKMP_PAYLOAD_NONCE
, " (ISAKMP_PAYLOAD_NONCE)" },

35 { 
ISAKMP_PAYLOAD_N
, " (ISAKMP_PAYLOAD_N)" },

36 { 
ISAKMP_PAYLOAD_D
, " (ISAKMP_PAYLOAD_D)" },

37 { 
ISAKMP_PAYLOAD_VID
, " (ISAKMP_PAYLOAD_VID)" },

38 { 
ISAKMP_PAYLOAD_MODECFG_ATTR
, " (ISAKMP_PAYLOAD_MODECFG_ATTR)" },

39 { 
ISAKMP_PAYLOAD_SAK
, " (ISAKMP_PAYLOAD_SAK)" },

40 { 
ISAKMP_PAYLOAD_SAT
, " (ISAKMP_PAYLOAD_SAT)" },

41 { 
ISAKMP_PAYLOAD_KD
, " (ISAKMP_PAYLOAD_KD)" },

42 { 
ISAKMP_PAYLOAD_SEQNO
, " (ISAKMP_PAYLOAD_SEQNO)" },

43 { 
ISAKMP_PAYLOAD_POP
, " (ISAKMP_PAYLOAD_POP)" },

44 { 
ISAKMP_PAYLOAD_NAT_D
, " (ISAKMP_PAYLOAD_NAT_D)" },

45 { 
ISAKMP_PAYLOAD_NAT_OA
, " (ISAKMP_PAYLOAD_NAT_OA)" },

46 { 
ISAKMP_PAYLOAD_NAT_D_OLD
, " (ISAKMP_PAYLOAD_NAT_D_OLD)" },

47 { 
ISAKMP_PAYLOAD_FRAG
, " (ISAKMP_PAYLOAD_FRAG)" },

51 c⁄° 
debug_°rögs
 
	gißkmp_exch™ge_íum_¨øy
[] = {

52 { 
ISAKMP_EXCHANGE_NONE
, " (ISAKMP_EXCHANGE_NONE)" },

53 { 
ISAKMP_EXCHANGE_BASE
, " (ISAKMP_EXCHANGE_BASE)" },

54 { 
ISAKMP_EXCHANGE_IDENTITY
, " (ISAKMP_EXCHANGE_IDENTITY)" },

55 { 
ISAKMP_EXCHANGE_AUTH_ONLY
, " (ISAKMP_EXCHANGE_AUTH_ONLY)" },

56 { 
ISAKMP_EXCHANGE_AGGRESSIVE
, " (ISAKMP_EXCHANGE_AGGRESSIVE)" },

57 { 
ISAKMP_EXCHANGE_INFORMATIONAL
, " (ISAKMP_EXCHANGE_INFORMATIONAL)" },

58 { 
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
, " (ISAKMP_EXCHANGE_MODECFG_TRANSACTION)" },

59 { 
ISAKMP_EXCHANGE_IKE_QUICK
, " (ISAKMP_EXCHANGE_IKE_QUICK)" },

60 { 
ISAKMP_EXCHANGE_IKE_NEW_GROUP
, " (ISAKMP_EXCHANGE_IKE_NEW_GROUP)" },

64 c⁄° 
debug_°rögs
 
	gißkmp_doi_íum_¨øy
[] = {

65 { 
ISAKMP_DOI_GENERIC
, " (ISAKMP_DOI_GENERIC)" },

66 { 
ISAKMP_DOI_IPSEC
, " (ISAKMP_DOI_IPSEC)" },

70 c⁄° 
debug_°rögs
 
	gißkmp_nŸify_íum_¨øy
[] = {

71 { 
ISAKMP_N_INVALID_PAYLOAD_TYPE
, " (ISAKMP_N_INVALID_PAYLOAD_TYPE)" },

72 { 
ISAKMP_N_DOI_NOT_SUPPORTED
, " (ISAKMP_N_DOI_NOT_SUPPORTED)" },

73 { 
ISAKMP_N_SITUATION_NOT_SUPPORTED
, " (ISAKMP_N_SITUATION_NOT_SUPPORTED)" },

74 { 
ISAKMP_N_INVALID_COOKIE
, " (ISAKMP_N_INVALID_COOKIE)" },

75 { 
ISAKMP_N_INVALID_MAJOR_VERSION
, " (ISAKMP_N_INVALID_MAJOR_VERSION)" },

76 { 
ISAKMP_N_INVALID_MINOR_VERSION
, " (ISAKMP_N_INVALID_MINOR_VERSION)" },

77 { 
ISAKMP_N_INVALID_EXCHANGE_TYPE
, " (ISAKMP_N_INVALID_EXCHANGE_TYPE)" },

78 { 
ISAKMP_N_INVALID_FLAGS
, " (ISAKMP_N_INVALID_FLAGS)" },

79 { 
ISAKMP_N_INVALID_MESSAGE_ID
, " (ISAKMP_N_INVALID_MESSAGE_ID)" },

80 { 
ISAKMP_N_INVALID_PROTOCOL_ID
, " (ISAKMP_N_INVALID_PROTOCOL_ID)" },

81 { 
ISAKMP_N_INVALID_SPI
, " (ISAKMP_N_INVALID_SPI)" },

82 { 
ISAKMP_N_INVALID_TRANSFORM_ID
, " (ISAKMP_N_INVALID_TRANSFORM_ID)" },

83 { 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
, " (ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED)" },

84 { 
ISAKMP_N_NO_PROPOSAL_CHOSEN
, " (ISAKMP_N_NO_PROPOSAL_CHOSEN)" },

85 { 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
, " (ISAKMP_N_BAD_PROPOSAL_SYNTAX)" },

86 { 
ISAKMP_N_PAYLOAD_MALFORMED
, " (ISAKMP_N_PAYLOAD_MALFORMED)" },

87 { 
ISAKMP_N_INVALID_KEY_INFORMATION
, " (ISAKMP_N_INVALID_KEY_INFORMATION)" },

88 { 
ISAKMP_N_INVALID_ID_INFORMATION
, " (ISAKMP_N_INVALID_ID_INFORMATION)" },

89 { 
ISAKMP_N_INVALID_CERT_ENCODING
, " (ISAKMP_N_INVALID_CERT_ENCODING)" },

90 { 
ISAKMP_N_INVALID_CERTIFICATE
, " (ISAKMP_N_INVALID_CERTIFICATE)" },

91 { 
ISAKMP_N_CERT_TYPE_UNSUPPORTED
, " (ISAKMP_N_CERT_TYPE_UNSUPPORTED)" },

92 { 
ISAKMP_N_INVALID_CERT_AUTHORITY
, " (ISAKMP_N_INVALID_CERT_AUTHORITY)" },

93 { 
ISAKMP_N_INVALID_HASH_INFORMATION
, " (ISAKMP_N_INVALID_HASH_INFORMATION)" },

94 { 
ISAKMP_N_AUTHENTICATION_FAILED
, " (ISAKMP_N_AUTHENTICATION_FAILED)" },

95 { 
ISAKMP_N_INVALID_SIGNATURE
, " (ISAKMP_N_INVALID_SIGNATURE)" },

96 { 
ISAKMP_N_ADDRESS_NOTIFICATION
, " (ISAKMP_N_ADDRESS_NOTIFICATION)" },

97 { 
ISAKMP_N_NOTIFY_SA_LIFETIME
, " (ISAKMP_N_NOTIFY_SA_LIFETIME)" },

98 { 
ISAKMP_N_CERTIFICATE_UNAVAILABLE
, " (ISAKMP_N_CERTIFICATE_UNAVAILABLE)" },

99 { 
ISAKMP_N_UNSUPPORTED_EXCHANGE_TYPE
, " (ISAKMP_N_UNSUPPORTED_EXCHANGE_TYPE)" },

100 { 
ISAKMP_N_UNEQUAL_PAYLOAD_LENGTHS
, " (ISAKMP_N_UNEQUAL_PAYLOAD_LENGTHS)" },

101 { 
ISAKMP_N_CONNECTED
, " (ISAKMP_N_CONNECTED)" },

102 { 
ISAKMP_N_IPSEC_RESPONDER_LIFETIME
, " (ISAKMP_N_IPSEC_RESPONDER_LIFETIME)" },

103 { 
ISAKMP_N_IPSEC_REPLAY_STATUS
, " (ISAKMP_N_IPSEC_REPLAY_STATUS)" },

104 { 
ISAKMP_N_IPSEC_INITIAL_CONTACT
, " (ISAKMP_N_IPSEC_INITIAL_CONTACT)" },

105 { 
ISAKMP_N_CISCO_HELLO
, " (ISAKMP_N_CISCO_HELLO)" },

106 { 
ISAKMP_N_CISCO_WWTEBR
, " (ISAKMP_N_CISCO_WWTEBR)" },

107 { 
ISAKMP_N_CISCO_SHUT_UP
, " (ISAKMP_N_CISCO_SHUT_UP)" },

108 { 
ISAKMP_N_IOS_KEEP_ALIVE_REQ
, " (ISAKMP_N_IOS_KEEP_ALIVE_REQ)" },

109 { 
ISAKMP_N_IOS_KEEP_ALIVE_ACK
, " (ISAKMP_N_IOS_KEEP_ALIVE_ACK)" },

110 { 
ISAKMP_N_R_U_THERE
, " (ISAKMP_N_R_U_THERE)" },

111 { 
ISAKMP_N_R_U_THERE_ACK
, " (ISAKMP_N_R_U_THERE_ACK)" },

112 { 
ISAKMP_N_CISCO_LOAD_BALANCE
, " (ISAKMP_N_CISCO_LOAD_BALANCE)" },

113 { 
ISAKMP_N_CISCO_PRESHARED_KEY_HASH
, " (ISAKMP_N_CISCO_PRESHARED_KEY_HASH)" },

117 c⁄° 
debug_°rögs
 
	gdwr_ike_dñëe_¨øy
[] = {

118 { 
IKE_DELETE_SERVER_SHUTDOWN
, " (IKE_DELETE_SERVER_SHUTDOWN)" },

119 { 
IKE_DELETE_SERVER_REBOOT
, " (IKE_DELETE_SERVER_REBOOT)" },

120 { 
IKE_DELETE_MAX_CONNECT_TIME
, " (IKE_DELETE_MAX_CONNECT_TIME)" },

121 { 
IKE_DELETE_BY_USER_COMMAND
, " (IKE_DELETE_BY_USER_COMMAND)" },

122 { 
IKE_DELETE_BY_ERROR
, " (IKE_DELETE_BY_ERROR)" },

123 { 
IKE_DELETE_NO_ERROR
, " (IKE_DELETE_NO_ERROR)" },

124 { 
IKE_DELETE_IDLE_TIMEOUT
, " (IKE_DELETE_IDLE_TIMEOUT)" },

125 { 
IKE_DELETE_P2_PROPOSAL_MISMATCH
, " (IKE_DELETE_P2_PROPOSAL_MISMATCH)" },

126 { 
IKE_DELETE_FIREWALL_MISMATCH
, " (IKE_DELETE_FIREWALL_MISMATCH)" },

127 { 
IKE_DELETE_CERT_EXPIRED
, " (IKE_DELETE_CERT_EXPIRED)" },

128 { 
IKE_DELETE_BY_EXPIRED_LIFETIME
, " (IKE_DELETE_BY_EXPIRED_LIFETIME)" },

129 { 
DEL_REASON_RESET_SADB
, " (DEL_REASON_RESET_SADB)" },

133 c⁄° 
debug_°rögs
 
	gißkmp_˚πifiˇã_íum_¨øy
[] = {

134 { 
ISAKMP_CERT_NONE
, " (ISAKMP_CERT_NONE)" },

135 { 
ISAKMP_CERT_PKCS7_X509
, " (ISAKMP_CERT_PKCS7_X509)" },

136 { 
ISAKMP_CERT_PGP
, " (ISAKMP_CERT_PGP)" },

137 { 
ISAKMP_CERT_DNS_SIG_KEY
, " (ISAKMP_CERT_DNS_SIG_KEY)" },

138 { 
ISAKMP_CERT_X509_SIG
, " (ISAKMP_CERT_X509_SIG)" },

139 { 
ISAKMP_CERT_X509_KEX_EXCHANGE
, " (ISAKMP_CERT_X509_KEX_EXCHANGE)" },

140 { 
ISAKMP_CERT_KERBEROS_TOKENS
, " (ISAKMP_CERT_KERBEROS_TOKENS)" },

141 { 
ISAKMP_CERT_CRL
, " (ISAKMP_CERT_CRL)" },

142 { 
ISAKMP_CERT_ARL
, " (ISAKMP_CERT_ARL)" },

143 { 
ISAKMP_CERT_SPKI
, " (ISAKMP_CERT_SPKI)" },

144 { 
ISAKMP_CERT_X509_ATTRIBUTE
, " (ISAKMP_CERT_X509_ATTRIBUTE)" },

148 c⁄° 
debug_°rögs
 
	gike_©å_íum_¨øy
[] = {

149 { 
IKE_ATTRIB_ENC
, " (IKE_ATTRIB_ENC)" },

150 { 
IKE_ATTRIB_HASH
, " (IKE_ATTRIB_HASH)" },

151 { 
IKE_ATTRIB_AUTH_METHOD
, " (IKE_ATTRIB_AUTH_METHOD)" },

152 { 
IKE_ATTRIB_GROUP_DESC
, " (IKE_ATTRIB_GROUP_DESC)" },

153 { 
IKE_ATTRIB_GROUP_TYPE
, " (IKE_ATTRIB_GROUP_TYPE)" },

154 { 
IKE_ATTRIB_GROUP_PRIME
, " (IKE_ATTRIB_GROUP_PRIME)" },

155 { 
IKE_ATTRIB_GROUP_GEN_1
, " (IKE_ATTRIB_GROUP_GEN_1)" },

156 { 
IKE_ATTRIB_GROUP_GEN_2
, " (IKE_ATTRIB_GROUP_GEN_2)" },

157 { 
IKE_ATTRIB_GROUP_CURVE_A
, " (IKE_ATTRIB_GROUP_CURVE_A)" },

158 { 
IKE_ATTRIB_GROUP_CURVE_B
, " (IKE_ATTRIB_GROUP_CURVE_B)" },

159 { 
IKE_ATTRIB_LIFE_TYPE
, " (IKE_ATTRIB_LIFE_TYPE)" },

160 { 
IKE_ATTRIB_LIFE_DURATION
, " (IKE_ATTRIB_LIFE_DURATION)" },

161 { 
IKE_ATTRIB_PRF
, " (IKE_ATTRIB_PRF)" },

162 { 
IKE_ATTRIB_KEY_LENGTH
, " (IKE_ATTRIB_KEY_LENGTH)" },

163 { 
IKE_ATTRIB_FIELD_SIZE
, " (IKE_ATTRIB_FIELD_SIZE)" },

164 { 
IKE_ATTRIB_GROUP_ORDER
, " (IKE_ATTRIB_GROUP_ORDER)" },

165 { 
IKE_ATTRIB_BLOCK_SIZE
, " (IKE_ATTRIB_BLOCK_SIZE)" },

166 { 
IKE_ATTRIB_NORTEL_UNKNOWN
, " (IKE_ATTRIB_NORTEL_UNKNOWN)" },

170 c⁄° 
debug_°rögs
 
	gike_íc_íum_¨øy
[] = {

171 { 
IKE_ENC_NO_CBC
, " (IKE_ENC_NO_CBC)" },

172 { 
IKE_ENC_DES_CBC
, " (IKE_ENC_DES_CBC)" },

173 { 
IKE_ENC_IDEA_CBC
, " (IKE_ENC_IDEA_CBC)" },

174 { 
IKE_ENC_BLOWFISH_CBC
, " (IKE_ENC_BLOWFISH_CBC)" },

175 { 
IKE_ENC_RC5_R16_B16_CBC
, " (IKE_ENC_RC5_R16_B16_CBC)" },

176 { 
IKE_ENC_3DES_CBC
, " (IKE_ENC_3DES_CBC)" },

177 { 
IKE_ENC_CAST_CBC
, " (IKE_ENC_CAST_CBC)" },

178 { 
IKE_ENC_AES_CBC
, " (IKE_ENC_AES_CBC)" },

182 c⁄° 
debug_°rögs
 
	gike_hash_íum_¨øy
[] = {

183 { 
IKE_HASH_MD5
, " (IKE_HASH_MD5)" },

184 { 
IKE_HASH_SHA
, " (IKE_HASH_SHA)" },

185 { 
IKE_HASH_TIGER
, " (IKE_HASH_TIGER)" },

186 { 
IKE_HASH_SHA2_256
, " (IKE_HASH_SHA2_256)" },

187 { 
IKE_HASH_SHA2_384
, " (IKE_HASH_SHA2_384)" },

188 { 
IKE_HASH_SHA2_512
, " (IKE_HASH_SHA2_512)" },

192 c⁄° 
debug_°rögs
 
	gike_auth_íum_¨øy
[] = {

193 { 
IKE_AUTH_PRESHARED
, " (IKE_AUTH_PRESHARED)" },

194 { 
IKE_AUTH_DSS
, " (IKE_AUTH_DSS)" },

195 { 
IKE_AUTH_RSA_SIG
, " (IKE_AUTH_RSA_SIG)" },

196 { 
IKE_AUTH_RSA_ENC
, " (IKE_AUTH_RSA_ENC)" },

197 { 
IKE_AUTH_RSA_ENC_2
, " (IKE_AUTH_RSA_ENC_2)" },

198 { 
IKE_AUTH_EL_GAMAL_ENC
, " (IKE_AUTH_EL_GAMAL_ENC)" },

199 { 
IKE_AUTH_EL_GAMAL_ENC_REV
, " (IKE_AUTH_EL_GAMAL_ENC_REV)" },

200 { 
IKE_AUTH_ECDSA_SIG
, " (IKE_AUTH_ECDSA_SIG)" },

201 { 
IKE_AUTH_HybridInôRSA
, " (IKE_AUTH_HybridInitRSA)" },

202 { 
IKE_AUTH_HybridRe•RSA
, " (IKE_AUTH_HybridRespRSA)" },

203 { 
IKE_AUTH_HybridInôDSS
, " (IKE_AUTH_HybridInitDSS)" },

204 { 
IKE_AUTH_HybridRe•DSS
, " (IKE_AUTH_HybridRespDSS)" },

205 { 
IKE_AUTH_XAUTHInôPªSh¨ed
, " (IKE_AUTH_XAUTHInitPreShared)" },

206 { 
IKE_AUTH_XAUTHRe•PªSh¨ed
, " (IKE_AUTH_XAUTHRespPreShared)" },

207 { 
IKE_AUTH_XAUTHInôDSS
, " (IKE_AUTH_XAUTHInitDSS)" },

208 { 
IKE_AUTH_XAUTHRe•DSS
, " (IKE_AUTH_XAUTHRespDSS)" },

209 { 
IKE_AUTH_XAUTHInôRSA
, " (IKE_AUTH_XAUTHInitRSA)" },

210 { 
IKE_AUTH_XAUTHRe•RSA
, " (IKE_AUTH_XAUTHRespRSA)" },

211 { 
IKE_AUTH_XAUTHInôRSAEn¸y±i⁄
, " (IKE_AUTH_XAUTHInitRSAEncryption)" },

212 { 
IKE_AUTH_XAUTHRe•RSAEn¸y±i⁄
, " (IKE_AUTH_XAUTHRespRSAEncryption)" },

213 { 
IKE_AUTH_XAUTHInôRSARevi£dEn¸y±i⁄
, " (IKE_AUTH_XAUTHInitRSARevisedEncryption)" },

214 { 
IKE_AUTH_XAUTHRe•RSARevi£dEn¸y±i⁄
, " (IKE_AUTH_XAUTHRespRSARevisedEncryption)" },

218 c⁄° 
debug_°rögs
 
	gike_group_íum_¨øy
[] = {

219 { 
IKE_GROUP_MODP_768
, " (IKE_GROUP_MODP_768)" },

220 { 
IKE_GROUP_MODP_1024
, " (IKE_GROUP_MODP_1024)" },

221 { 
IKE_GROUP_EC2N_155
, " (IKE_GROUP_EC2N_155)" },

222 { 
IKE_GROUP_EC2N_185
, " (IKE_GROUP_EC2N_185)" },

223 { 
IKE_GROUP_MODP_1536
, " (IKE_GROUP_MODP_1536)" },

224 { 
IKE_GROUP_EC2N_163£˘
, " (IKE_GROUP_EC2N_163sect)" },

225 { 
IKE_GROUP_EC2N_163K
, " (IKE_GROUP_EC2N_163K)" },

226 { 
IKE_GROUP_EC2N_283£˘
, " (IKE_GROUP_EC2N_283sect)" },

227 { 
IKE_GROUP_EC2N_283K
, " (IKE_GROUP_EC2N_283K)" },

228 { 
IKE_GROUP_EC2N_409£˘
, " (IKE_GROUP_EC2N_409sect)" },

229 { 
IKE_GROUP_EC2N_409K
, " (IKE_GROUP_EC2N_409K)" },

230 { 
IKE_GROUP_EC2N_571£˘
, " (IKE_GROUP_EC2N_571sect)" },

231 { 
IKE_GROUP_EC2N_571K
, " (IKE_GROUP_EC2N_571K)" },

235 c⁄° 
debug_°rögs
 
	gike_group_ty≥_íum_¨øy
[] = {

236 { 
IKE_GROUP_TYPE_MODP
, " (IKE_GROUP_TYPE_MODP)" },

237 { 
IKE_GROUP_TYPE_ECP
, " (IKE_GROUP_TYPE_ECP)" },

238 { 
IKE_GROUP_TYPE_EC2N
, " (IKE_GROUP_TYPE_EC2N)" },

242 c⁄° 
debug_°rögs
 
	gike_li„_íum_¨øy
[] = {

243 { 
IKE_LIFE_TYPE_SECONDS
, " (IKE_LIFE_TYPE_SECONDS)" },

244 { 
IKE_LIFE_TYPE_K
, " (IKE_LIFE_TYPE_K)" },

248 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_sô_íum_¨øy
[] = {

249 { 
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
, " (ISAKMP_IPSEC_SIT_IDENTITY_ONLY)" },

250 { 
ISAKMP_IPSEC_SIT_SECRECY
, " (ISAKMP_IPSEC_SIT_SECRECY)" },

251 { 
ISAKMP_IPSEC_SIT_INTEGRITY
, " (ISAKMP_IPSEC_SIT_INTEGRITY)" },

255 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_id_íum_¨øy
[] = {

256 { 
ISAKMP_IPSEC_ID_RESERVED
, " (ISAKMP_IPSEC_ID_RESERVED)" },

257 { 
ISAKMP_IPSEC_ID_IPV4_ADDR
, " (ISAKMP_IPSEC_ID_IPV4_ADDR)" },

258 { 
ISAKMP_IPSEC_ID_FQDN
, " (ISAKMP_IPSEC_ID_FQDN)" },

259 { 
ISAKMP_IPSEC_ID_USER_FQDN
, " (ISAKMP_IPSEC_ID_USER_FQDN)" },

260 { 
ISAKMP_IPSEC_ID_IPV4_ADDR_SUBNET
, " (ISAKMP_IPSEC_ID_IPV4_ADDR_SUBNET)" },

261 { 
ISAKMP_IPSEC_ID_IPV6_ADDR
, " (ISAKMP_IPSEC_ID_IPV6_ADDR)" },

262 { 
ISAKMP_IPSEC_ID_IPV6_ADDR_SUBNET
, " (ISAKMP_IPSEC_ID_IPV6_ADDR_SUBNET)" },

263 { 
ISAKMP_IPSEC_ID_IPV4_ADDR_RANGE
, " (ISAKMP_IPSEC_ID_IPV4_ADDR_RANGE)" },

264 { 
ISAKMP_IPSEC_ID_IPV6_ADDR_RANGE
, " (ISAKMP_IPSEC_ID_IPV6_ADDR_RANGE)" },

265 { 
ISAKMP_IPSEC_ID_DER_ASN1_DN
, " (ISAKMP_IPSEC_ID_DER_ASN1_DN)" },

266 { 
ISAKMP_IPSEC_ID_DER_ASN1_GN
, " (ISAKMP_IPSEC_ID_DER_ASN1_GN)" },

267 { 
ISAKMP_IPSEC_ID_KEY_ID
, " (ISAKMP_IPSEC_ID_KEY_ID)" },

271 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_¥Ÿo_íum_¨øy
[] = {

272 { 
ISAKMP_IPSEC_PROTO_RESERVED
, " (ISAKMP_IPSEC_PROTO_RESERVED)" },

273 { 
ISAKMP_IPSEC_PROTO_ISAKMP
, " (ISAKMP_IPSEC_PROTO_ISAKMP)" },

274 { 
ISAKMP_IPSEC_PROTO_IPSEC_AH
, " (ISAKMP_IPSEC_PROTO_IPSEC_AH)" },

275 { 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
, " (ISAKMP_IPSEC_PROTO_IPSEC_ESP)" },

276 { 
ISAKMP_IPSEC_PROTO_IPCOMP
, " (ISAKMP_IPSEC_PROTO_IPCOMP)" },

277 { 
ISAKMP_IPSEC_PROTO_MODECFG
, " (ISAKMP_IPSEC_PROTO_MODECFG)" },

281 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_key_íum_¨øy
[] = {

282 { 
ISAKMP_IPSEC_KEY_RESERVED
, " (ISAKMP_IPSEC_KEY_RESERVED)" },

283 { 
ISAKMP_IPSEC_KEY_IKE
, " (ISAKMP_IPSEC_KEY_IKE)" },

287 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_ah_íum_¨øy
[] = {

288 { 
ISAKMP_IPSEC_AH_RESERVED
, " (ISAKMP_IPSEC_AH_RESERVED)" },

289 { 
ISAKMP_IPSEC_AH_MD5
, " (ISAKMP_IPSEC_AH_MD5)" },

290 { 
ISAKMP_IPSEC_AH_SHA
, " (ISAKMP_IPSEC_AH_SHA)" },

291 { 
ISAKMP_IPSEC_AH_DES
, " (ISAKMP_IPSEC_AH_DES)" },

292 { 
ISAKMP_IPSEC_AH_SHA2_256
, " (ISAKMP_IPSEC_AH_SHA2_256)" },

293 { 
ISAKMP_IPSEC_AH_SHA2_384
, " (ISAKMP_IPSEC_AH_SHA2_384)" },

294 { 
ISAKMP_IPSEC_AH_SHA2_512
, " (ISAKMP_IPSEC_AH_SHA2_512)" },

295 { 
ISAKMP_IPSEC_AH_RIPEMD
, " (ISAKMP_IPSEC_AH_RIPEMD)" },

299 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_e•_íum_¨øy
[] = {

300 { 
ISAKMP_IPSEC_ESP_RESERVED
, " (ISAKMP_IPSEC_ESP_RESERVED)" },

301 { 
ISAKMP_IPSEC_ESP_DES_IV64
, " (ISAKMP_IPSEC_ESP_DES_IV64)" },

302 { 
ISAKMP_IPSEC_ESP_DES
, " (ISAKMP_IPSEC_ESP_DES)" },

303 { 
ISAKMP_IPSEC_ESP_3DES
, " (ISAKMP_IPSEC_ESP_3DES)" },

304 { 
ISAKMP_IPSEC_ESP_RC5
, " (ISAKMP_IPSEC_ESP_RC5)" },

305 { 
ISAKMP_IPSEC_ESP_IDEA
, " (ISAKMP_IPSEC_ESP_IDEA)" },

306 { 
ISAKMP_IPSEC_ESP_CAST
, " (ISAKMP_IPSEC_ESP_CAST)" },

307 { 
ISAKMP_IPSEC_ESP_BLOWFISH
, " (ISAKMP_IPSEC_ESP_BLOWFISH)" },

308 { 
ISAKMP_IPSEC_ESP_3IDEA
, " (ISAKMP_IPSEC_ESP_3IDEA)" },

309 { 
ISAKMP_IPSEC_ESP_DES_IV32
, " (ISAKMP_IPSEC_ESP_DES_IV32)" },

310 { 
ISAKMP_IPSEC_ESP_RC4
, " (ISAKMP_IPSEC_ESP_RC4)" },

311 { 
ISAKMP_IPSEC_ESP_NULL
, " (ISAKMP_IPSEC_ESP_NULL)" },

312 { 
ISAKMP_IPSEC_ESP_AES
, " (ISAKMP_IPSEC_ESP_AES)" },

313 { 
ISAKMP_IPSEC_ESP_AES_128_CTR
, " (ISAKMP_IPSEC_ESP_AES_128_CTR)" },

314 { 
ISAKMP_IPSEC_ESP_AES_MARS
, " (ISAKMP_IPSEC_ESP_AES_MARS)" },

315 { 
ISAKMP_IPSEC_ESP_AES_RC6
, " (ISAKMP_IPSEC_ESP_AES_RC6)" },

316 { 
ISAKMP_IPSEC_ESP_AES_RIJNDAEL
, " (ISAKMP_IPSEC_ESP_AES_RIJNDAEL)" },

317 { 
ISAKMP_IPSEC_ESP_AES_SERPENT
, " (ISAKMP_IPSEC_ESP_AES_SERPENT)" },

318 { 
ISAKMP_IPSEC_ESP_AES_TWOFISH
, " (ISAKMP_IPSEC_ESP_AES_TWOFISH)" },

322 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_©å_íum_¨øy
[] = {

323 { 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
, " (ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE)" },

324 { 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
, " (ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION)" },

325 { 
ISAKMP_IPSEC_ATTRIB_GROUP_DESC
, " (ISAKMP_IPSEC_ATTRIB_GROUP_DESC)" },

326 { 
ISAKMP_IPSEC_ATTRIB_ENCAP_MODE
, " (ISAKMP_IPSEC_ATTRIB_ENCAP_MODE)" },

327 { 
ISAKMP_IPSEC_ATTRIB_AUTH_ALG
, " (ISAKMP_IPSEC_ATTRIB_AUTH_ALG)" },

328 { 
ISAKMP_IPSEC_ATTRIB_KEY_LENGTH
, " (ISAKMP_IPSEC_ATTRIB_KEY_LENGTH)" },

329 { 
ISAKMP_IPSEC_ATTRIB_KEY_ROUNDS
, " (ISAKMP_IPSEC_ATTRIB_KEY_ROUNDS)" },

330 { 
ISAKMP_IPSEC_ATTRIB_COMP_DICT_SIZE
, " (ISAKMP_IPSEC_ATTRIB_COMP_DICT_SIZE)" },

331 { 
ISAKMP_IPSEC_ATTRIB_COMP_PRIVATE_ALG
, " (ISAKMP_IPSEC_ATTRIB_COMP_PRIVATE_ALG)" },

332 { 
ISAKMP_IPSEC_ATTRIB_ECN_TUNNEL
, " (ISAKMP_IPSEC_ATTRIB_ECN_TUNNEL)" },

336 c⁄° 
debug_°rögs
 
	gißkmp_ù£c_ùcomp_íum_¨øy
[] = {

337 { 
ISAKMP_IPSEC_IPCOMP_RESERVED
, " (ISAKMP_IPSEC_IPCOMP_RESERVED)" },

338 { 
ISAKMP_IPSEC_IPCOMP_OUI
, " (ISAKMP_IPSEC_IPCOMP_OUI)" },

339 { 
ISAKMP_IPSEC_IPCOMP_DEFLATE
, " (ISAKMP_IPSEC_IPCOMP_DEFLATE)" },

340 { 
ISAKMP_IPSEC_IPCOMP_LZS
, " (ISAKMP_IPSEC_IPCOMP_LZS)" },

341 { 
ISAKMP_IPSEC_IPCOMP_V42BIS
, " (ISAKMP_IPSEC_IPCOMP_V42BIS)" },

345 c⁄° 
debug_°rögs
 
	gù£c_li„_íum_¨øy
[] = {

346 { 
IPSEC_LIFE_SECONDS
, " (IPSEC_LIFE_SECONDS)" },

347 { 
IPSEC_LIFE_K
, " (IPSEC_LIFE_K)" },

351 c⁄° 
debug_°rögs
 
	gù£c_íˇp_íum_¨øy
[] = {

352 { 
IPSEC_ENCAP_TUNNEL
, " (IPSEC_ENCAP_TUNNEL)" },

353 { 
IPSEC_ENCAP_TRANSPORT
, " (IPSEC_ENCAP_TRANSPORT)" },

354 { 
IPSEC_ENCAP_UDP_TUNNEL
, " (IPSEC_ENCAP_UDP_TUNNEL)" },

355 { 
IPSEC_ENCAP_UDP_TRANSPORT
, " (IPSEC_ENCAP_UDP_TRANSPORT)" },

356 { 
IPSEC_ENCAP_UDP_TUNNEL_OLD
, " (IPSEC_ENCAP_UDP_TUNNEL_OLD)" },

357 { 
IPSEC_ENCAP_UDP_TRANSPORT_OLD
, " (IPSEC_ENCAP_UDP_TRANSPORT_OLD)" },

361 c⁄° 
debug_°rögs
 
	gù£c_auth_íum_¨øy
[] = {

362 { 
IPSEC_AUTH_HMAC_MD5
, " (IPSEC_AUTH_HMAC_MD5)" },

363 { 
IPSEC_AUTH_HMAC_SHA
, " (IPSEC_AUTH_HMAC_SHA)" },

364 { 
IPSEC_AUTH_DES_MAC
, " (IPSEC_AUTH_DES_MAC)" },

365 { 
IPSEC_AUTH_KPDK
, " (IPSEC_AUTH_KPDK)" },

369 c⁄° 
debug_°rögs
 
	gißkmp_modecfg_cfg_íum_¨øy
[] = {

370 { 
ISAKMP_MODECFG_CFG_REQUEST
, " (ISAKMP_MODECFG_CFG_REQUEST)" },

371 { 
ISAKMP_MODECFG_CFG_REPLY
, " (ISAKMP_MODECFG_CFG_REPLY)" },

372 { 
ISAKMP_MODECFG_CFG_SET
, " (ISAKMP_MODECFG_CFG_SET)" },

373 { 
ISAKMP_MODECFG_CFG_ACK
, " (ISAKMP_MODECFG_CFG_ACK)" },

377 c⁄° 
debug_°rögs
 
	gißkmp_modecfg_©åib_íum_¨øy
[] = {

378 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_ADDRESS
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_ADDRESS)" },

379 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NETMASK
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NETMASK)" },

380 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DNS
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DNS)" },

381 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NBNS
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NBNS)" },

382 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_ADDRESS_EXPIRY
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_ADDRESS_EXPIRY)" },

383 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DHCP
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DHCP)" },

384 { 
ISAKMP_MODECFG_ATTRIB_APPLICATION_VERSION
, " (ISAKMP_MODECFG_ATTRIB_APPLICATION_VERSION)" },

385 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_ADDRESS
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_ADDRESS)" },

386 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_NETMASK
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_NETMASK)" },

387 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_DNS
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_DNS)" },

388 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_NBNS
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_NBNS)" },

389 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_DHCP
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_DHCP)" },

390 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_SUBNET
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_SUBNET)" },

391 { 
ISAKMP_MODECFG_ATTRIB_SUPPORTED_ATTRIBUTES
, " (ISAKMP_MODECFG_ATTRIB_SUPPORTED_ATTRIBUTES)" },

392 { 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_SUBNET
, " (ISAKMP_MODECFG_ATTRIB_INTERNAL_IP6_SUBNET)" },

393 { 
ISAKMP_XAUTH_06_ATTRIB_TYPE
, " (ISAKMP_XAUTH_06_ATTRIB_TYPE)" },

394 { 
ISAKMP_XAUTH_06_ATTRIB_USER_NAME
, " (ISAKMP_XAUTH_06_ATTRIB_USER_NAME)" },

395 { 
ISAKMP_XAUTH_06_ATTRIB_USER_PASSWORD
, " (ISAKMP_XAUTH_06_ATTRIB_USER_PASSWORD)" },

396 { 
ISAKMP_XAUTH_06_ATTRIB_PASSCODE
, " (ISAKMP_XAUTH_06_ATTRIB_PASSCODE)" },

397 { 
ISAKMP_XAUTH_06_ATTRIB_MESSAGE
, " (ISAKMP_XAUTH_06_ATTRIB_MESSAGE)" },

398 { 
ISAKMP_XAUTH_06_ATTRIB_CHALLENGE
, " (ISAKMP_XAUTH_06_ATTRIB_CHALLENGE)" },

399 { 
ISAKMP_XAUTH_06_ATTRIB_DOMAIN
, " (ISAKMP_XAUTH_06_ATTRIB_DOMAIN)" },

400 { 
ISAKMP_XAUTH_06_ATTRIB_STATUS
, " (ISAKMP_XAUTH_06_ATTRIB_STATUS)" },

401 { 
ISAKMP_XAUTH_06_ATTRIB_NEXT_PIN
, " (ISAKMP_XAUTH_06_ATTRIB_NEXT_PIN)" },

402 { 
ISAKMP_XAUTH_06_ATTRIB_ANSWER
, " (ISAKMP_XAUTH_06_ATTRIB_ANSWER)" },

403 { 
ISAKMP_MODECFG_ATTRIB_CISCO_BANNER
, " (ISAKMP_MODECFG_ATTRIB_CISCO_BANNER)" },

404 { 
ISAKMP_MODECFG_ATTRIB_CISCO_SAVE_PW
, " (ISAKMP_MODECFG_ATTRIB_CISCO_SAVE_PW)" },

405 { 
ISAKMP_MODECFG_ATTRIB_CISCO_DEF_DOMAIN
, " (ISAKMP_MODECFG_ATTRIB_CISCO_DEF_DOMAIN)" },

406 { 
ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_DNS
, " (ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_DNS)" },

407 { 
ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_INC
, " (ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_INC)" },

408 { 
ISAKMP_MODECFG_ATTRIB_CISCO_UDP_ENCAP_PORT
, " (ISAKMP_MODECFG_ATTRIB_CISCO_UDP_ENCAP_PORT)" },

409 { 
ISAKMP_MODECFG_ATTRIB_CISCO_UNKNOWN
, " (ISAKMP_MODECFG_ATTRIB_CISCO_UNKNOWN)" },

410 { 
ISAKMP_MODECFG_ATTRIB_CISCO_DO_PFS
, " (ISAKMP_MODECFG_ATTRIB_CISCO_DO_PFS)" },

411 { 
ISAKMP_MODECFG_ATTRIB_CISCO_FW_TYPE
, " (ISAKMP_MODECFG_ATTRIB_CISCO_FW_TYPE)" },

412 { 
ISAKMP_MODECFG_ATTRIB_CISCO_BACKUP_SERVER
, " (ISAKMP_MODECFG_ATTRIB_CISCO_BACKUP_SERVER)" },

413 { 
ISAKMP_MODECFG_ATTRIB_CISCO_DDNS_HOSTNAME
, " (ISAKMP_MODECFG_ATTRIB_CISCO_DDNS_HOSTNAME)" },

414 { 
ISAKMP_XAUTH_ATTRIB_CISCOEXT_VENDOR
, " (ISAKMP_XAUTH_ATTRIB_CISCOEXT_VENDOR)" },

	@vpnc-debug.h

3 
	sdebug_°rögs
 {

4 
	mid
;

5 c⁄° *
	m°rög
;

8 c⁄° *
vÆ_to_°rög
(, c⁄° 
debug_°rögs
 *);

10 c⁄° 
debug_°rögs
 
ißkmp_∑ylﬂd_íum_¨øy
[];

11 c⁄° 
debug_°rögs
 
ißkmp_exch™ge_íum_¨øy
[];

12 c⁄° 
debug_°rögs
 
ißkmp_doi_íum_¨øy
[];

13 c⁄° 
debug_°rögs
 
ißkmp_nŸify_íum_¨øy
[];

14 c⁄° 
debug_°rögs
 
dwr_ike_dñëe_¨øy
[];

15 c⁄° 
debug_°rögs
 
ißkmp_˚πifiˇã_íum_¨øy
[];

16 c⁄° 
debug_°rögs
 
ike_©å_íum_¨øy
[];

17 c⁄° 
debug_°rögs
 
ike_íc_íum_¨øy
[];

18 c⁄° 
debug_°rögs
 
ike_hash_íum_¨øy
[];

19 c⁄° 
debug_°rögs
 
ike_auth_íum_¨øy
[];

20 c⁄° 
debug_°rögs
 
ike_group_íum_¨øy
[];

21 c⁄° 
debug_°rögs
 
ike_group_ty≥_íum_¨øy
[];

22 c⁄° 
debug_°rögs
 
ike_li„_íum_¨øy
[];

23 c⁄° 
debug_°rögs
 
ißkmp_ù£c_sô_íum_¨øy
[];

24 c⁄° 
debug_°rögs
 
ißkmp_ù£c_id_íum_¨øy
[];

25 c⁄° 
debug_°rögs
 
ißkmp_ù£c_¥Ÿo_íum_¨øy
[];

26 c⁄° 
debug_°rögs
 
ißkmp_ù£c_key_íum_¨øy
[];

27 c⁄° 
debug_°rögs
 
ißkmp_ù£c_ah_íum_¨øy
[];

28 c⁄° 
debug_°rögs
 
ißkmp_ù£c_e•_íum_¨øy
[];

29 c⁄° 
debug_°rögs
 
ißkmp_ù£c_©å_íum_¨øy
[];

30 c⁄° 
debug_°rögs
 
ißkmp_ù£c_ùcomp_íum_¨øy
[];

31 c⁄° 
debug_°rögs
 
ù£c_li„_íum_¨øy
[];

32 c⁄° 
debug_°rögs
 
ù£c_íˇp_íum_¨øy
[];

33 c⁄° 
debug_°rögs
 
ù£c_auth_íum_¨øy
[];

34 c⁄° 
debug_°rögs
 
ißkmp_modecfg_cfg_íum_¨øy
[];

35 c⁄° 
debug_°rögs
 
ißkmp_modecfg_©åib_íum_¨øy
[];

	@vpnc.c

24 
	#_GNU_SOURCE


	)

25 
	~<as£π.h
>

26 
	~<uni°d.h
>

28 
	~<f˙é.h
>

29 
	~<°dio.h
>

30 
	~<î∫o.h
>

31 
	~<°rög.h
>

32 
	~<time.h
>

33 
	~<°dlib.h
>

34 
	~<sys/sockë.h
>

35 
	~<√töë/ö.h
>

36 
	~<√tdb.h
>

37 
	~<¨∑/öë.h
>

38 
	~<pﬁl.h
>

39 
	~<sys/io˘l.h
>

40 
	~<sys/ut¢ame.h
>

42 
	~<g¸y±.h
>

44 #ifde‡
OPENSSL_GPL_VIOLATION


46 
	~<›ís¶/x509.h
>

47 
	~<›ís¶/îr.h
>

50 
	~"sysdï.h
"

51 
	~"c⁄fig.h
"

52 
	~"ißkmp-pkt.h
"

53 
	~"m©h_group.h
"

54 
	~"dh.h
"

55 
	~"v≤c.h
"

56 
	~"tunù.h
"

57 
	~"suµ.h
"

59 #i‡
deföed
(
__CYGWIN__
)

60 
	gGCRY_THREAD_OPTION_PTHREAD_IMPL
;

63 
	#ISAKMP_PORT
 (500)

	)

64 
	#ISAKMP_PORT_NATT
 (4500)

	)

66 c⁄° 
	gVID_XAUTH
[] = {

69 c⁄° 
	gVID_DPD
[] = {

73 c⁄° 
	gVID_UNITY
[] = {

77 c⁄° 
	gVID_UNKNOWN
[] = {

81 c⁄° 
	gVID_NATT_00
[] = {

85 c⁄° 
	gVID_NATT_01
[] = {

89 c⁄° 
	gVID_NATT_02
[] = {

93 c⁄° 
	gVID_NATT_02N
[] = {

97 c⁄° 
	gVID_NATT_RFC
[] = {

101 c⁄° 
	gVID_DWR
[] = {

111 c⁄° 
	gVID_CISCO_FRAG
[] = {

116 c⁄° 
	gVID_NETSCREEN_15
[] = {

122 c⁄° 
	gVID_HEARTBEAT_NOTIFY
[] = {

127 c⁄° 
	gVID_NORTEL_CONT
[] = {

131 c⁄° 
	gFW_UNKNOWN_TYPEINFO
[] = {

136 
	svid_ñemít
 {

137 c⁄° * 
	mvÆuïå
;

138 c⁄° 
uöt16_t
 
	mÀngth
;

139 c⁄° * 
	mdes¸
;

142 c⁄° 
vid_ñemít
 
	gvid_li°
[] = {

143 { 
VID_XAUTH
, (VID_XAUTH), "Xauth" },

144 { 
VID_DPD
, (VID_DPD), "DPD" },

145 { 
VID_UNITY
, (VID_UNITY), "Cisco Unity" },

146 { 
VID_NATT_00
, (VID_NATT_00), "Nat-T 00" },

147 { 
VID_NATT_01
, (VID_NATT_01), "Nat-T 01" },

148 { 
VID_NATT_02
, (VID_NATT_02), "Nat-T 02" },

149 { 
VID_NATT_02N
, (VID_NATT_02N), "Nat-T 02N" },

150 { 
VID_NATT_RFC
, (VID_NATT_RFC), "Nat-T RFC" },

151 { 
VID_DWR
, (VID_DWR), "Delete With Reason" },

152 { 
VID_CISCO_FRAG
, (VID_CISCO_FRAG), "Cisco Fragmentation" },

153 { 
VID_NETSCREEN_15
, (VID_NETSCREEN_15), "Netscreen 15" },

154 { 
VID_NORTEL_CONT
, (VID_NORTEL_CONT), "Nortel Contivity" },

155 { 
VID_HEARTBEAT_NOTIFY
, (VID_HEARTBEAT_NOTIFY), "Heartbeat Notify" },

157 { 
NULL
, 0, NULL }

162 
uöt8_t
 
	gr_∑ckë
[8192];

163 
ssize_t
 
	gr_Àngth
;

165 
	$¥öt_vid
(c⁄° *
vid
, 
uöt16_t
 
Àn
) {

167 
vid_ödex
 = 0;

169 i‡(
›t_debug
 < 2)

172 
vid_li°
[
vid_ödex
].
Àngth
) {

173 i‡(
Àn
 =
vid_li°
[
vid_ödex
].
Àngth
 &&

174 
	`memcmp
(
vid_li°
[
vid_ödex
].
vÆuïå
, 
vid
, 
Àn
) == 0) {

175 
	`¥ötf
(" (%s)\n", 
vid_li°
[
vid_ödex
].
des¸
);

178 
vid_ödex
++;

180 
	`¥ötf
(" (unknown)\n");

181 
	}
}

183 
__ölöe__
 
	$mö
(
a
, 
b
)

185  (
a
 < 
b
) ?á : b;

186 
	}
}

188 
	$addív
(c⁄° *
«me
, c⁄° *
vÆue
)

190 *
°rbuf
 = 
NULL
, *
ﬁdvÆ
;

192 
ﬁdvÆ
 = 
	`gëív
(
«me
);

193 i‡(
ﬁdvÆ
 !
NULL
) {

194 
°rbuf
 = 
	`xÆlocc
(
	`°æí
(
ﬁdvÆ
Ë+ 1 + såÀn(
vÆue
) + 1);

195 
	`°rˇt
(
°rbuf
, 
ﬁdvÆ
);

196 
	`°rˇt
(
°rbuf
, " ");

197 
	`°rˇt
(
°rbuf
, 
vÆue
);

200 
	`£ãnv
(
«me
, 
°rbuf
 ? såbu‡: 
vÆue
, 1);

202 
	`‰ì
(
°rbuf
);

203 
	}
}

205 
	$addív_ùv4
(c⁄° *
«me
, 
uöt8_t
 * 
d©a
)

207 
	`addív
(
«me
, 
	`öë_¡ﬂ
(*((
ö_addr
 *)
d©a
)));

208 
	}
}

210 
	$make_sockë
(
ß_block
 *
s
, 
uöt16_t
 
§c_p‹t
, uöt16_à
d°_p‹t
)

212 
sock
;

213 
sockaddr_ö
 
«me
;

214 
sockÀn_t
 
Àn
 = (
«me
);

217 
sock
 = 
	`sockë
(
PF_INET
, 
SOCK_DGRAM
, 0);

218 i‡(
sock
 < 0)

219 
	`îr‹
(1, 
î∫o
, "making socket");

221 #ifde‡
FD_CLOEXEC


223 
	`f˙é
(
sock
, 
F_SETFD
, 
FD_CLOEXEC
);

227 
«me
.
sö_Ámûy
 = 
AF_INET
;

228 
«me
.
sö_addr
 = 
s
->
›t_§c_ù
;

229 
«me
.
sö_p‹t
 = 
	`ht⁄s
(
§c_p‹t
);

230 i‡(
	`böd
(
sock
, (
sockaddr
 *)&
«me
, (name)) < 0)

231 
	`îr‹
(1, 
î∫o
, "Eº‹ bödögÅÿsour˚Ö‹t. Try '--loˇl-p‹à0'\nFaûedÅÿbödÅÿ%s:%d", 
	`öë_¡ﬂ
(
s
->
›t_§c_ù
), 
§c_p‹t
);

234 
«me
.
sö_Ámûy
 = 
AF_INET
;

235 
«me
.
sö_addr
 = 
s
->
d°
;

236 
«me
.
sö_p‹t
 = 
	`ht⁄s
(
d°_p‹t
);

237 i‡(
	`c⁄√˘
(
sock
, (
sockaddr
 *)&
«me
, (name)) < 0)

238 
	`îr‹
(1, 
î∫o
, "c⁄√˘ögÅÿp‹à%d", 
	`¡ohs
(
d°_p‹t
));

241 i‡(
	`gësock«me
(
sock
, (
sockaddr
 *)&
«me
, &
Àn
) < 0)

242 
	`îr‹
(1, 
î∫o
, "ªadögÜoˇ»addªs†‰om sockë %d", 
sock
);

243 
s
->
§c
 = 
«me
.
sö_addr
;

245  
sock
;

246 
	}
}

248 
	$˛ónup
(
ß_block
 *
s
) {

249 i‡(
s
->
ike_fd
 != 0) {

250 
	`˛o£
(
s
->
ike_fd
);

251 
s
->
ike_fd
 = 0;

253 i‡(
s
->
e•_fd
 != 0) {

254 
	`˛o£
(
s
->
e•_fd
);

255 
s
->
e•_fd
 = 0;

257 i‡(
s
->
ike
.
ª£nd_hash
) {

258 
	`‰ì
(
s
->
ike
.
ª£nd_hash
);

259 
s
->
ike
.
ª£nd_hash
 = 
NULL
;

261 i‡(
s
->
ike
.
skeyid_d
) {

262 
	`‰ì
(
s
->
ike
.
skeyid_d
);

263 
s
->
ike
.
skeyid_d
 = 
NULL
;

265 i‡(
s
->
ike
.
skeyid_a
) {

266 
	`‰ì
(
s
->
ike
.
skeyid_a
);

267 
s
->
ike
.
skeyid_a
 = 
NULL
;

269 i‡(
s
->
ike
.
öôül_iv
) {

270 
	`‰ì
(
s
->
ike
.
öôül_iv
);

271 
s
->
ike
.
öôül_iv
 = 
NULL
;

273 i‡(
s
->
ike
.
cuºít_iv
) {

274 
	`‰ì
(
s
->
ike
.
cuºít_iv
);

275 
s
->
ike
.
cuºít_iv
 = 
NULL
;

277 i‡(
s
->
ike
.
key
) {

278 
	`‰ì
(
s
->
ike
.
key
);

279 
s
->
ike
.
key
 = 
NULL
;

281 i‡(
s
->
ù£c
.
rx
.
key
) {

282 
	`‰ì
(
s
->
ù£c
.
rx
.
key
);

283 
s
->
ù£c
.
rx
.
key
 = 
NULL
;

285 i‡(
s
->
ù£c
.
tx
.
key
) {

286 
	`‰ì
(
s
->
ù£c
.
tx
.
key
);

287 
s
->
ù£c
.
tx
.
key
 = 
NULL
;

289 i‡(
s
->
ù£c
.
rx
.
¸y_˘x
) {

290 
	`g¸y_cùhî_˛o£
(
s
->
ù£c
.
rx
.
¸y_˘x
);

291 
s
->
ù£c
.
rx
.
¸y_˘x
 = 
NULL
;

293 i‡(
s
->
ù£c
.
tx
.
¸y_˘x
) {

294 
	`g¸y_cùhî_˛o£
(
s
->
ù£c
.
tx
.
¸y_˘x
);

295 
s
->
ù£c
.
tx
.
¸y_˘x
 = 
NULL
;

297 
	}
}

299 
	$öô_sockaddr
(
ö_addr
 *
d°
, c⁄° *
ho°«me
)

301 
ho°ít
 *
ho°öfo
;

303 i‡(
	`öë_©⁄
(
ho°«me
, 
d°
) == 0) {

304 
ho°öfo
 = 
	`gëho°by«me
(
ho°«me
);

305 i‡(
ho°öfo
 =
NULL
)

306 
	`îr‹
(1, 0, "unknow¿ho° `%s'\n", 
ho°«me
);

307 *
d°
 = *(
ö_addr
 *)
ho°öfo
->
h_addr
;

309 
	}
}

311 
	$öô_√èddr
(
ö_addr
 *
√t
, c⁄° *
°rög
)

313 *
p
;

315 i‡((
p
 = 
	`°rchr
(
°rög
, '/')Ë!
NULL
) {

316 *
ho°
 = 
	`xÆlocc
(
p
 - 
°rög
 + 1);

317 
	`mem˝y
(
ho°
, 
°rög
, 
p
 - string + 1);

318 
ho°
[
p
 - 
°rög
] = '\0';

319 
	`öô_sockaddr
((
ö_addr
 *)
√t
, 
ho°
);

320 
	`‰ì
(
ho°
);

321 i‡(
	`°rchr
(
p
 + 1, '.'Ë!
NULL
)

322 
	`öô_sockaddr
(
√t
 + 1, 
p
 + 1);

324 
bôs
 = 
	`©oi
(
p
 + 1);

325 
mask
 = (1 << 
bôs
) - 1;

326 
	`mem˝y
((*)(
√t
 + 1), (*)&
mask
, 4);

329 
	`mem£t
((*)
√t
, 0, 8);

331 
	}
}

333 
	$£tup_tu¬ñ
(
ß_block
 *
s
)

335 
	`£ãnv
("reason", "pre-init", 1);

336 
	`sy°em
(
c⁄fig
[
CONFIG_SCRIPT
]);

338 i‡(
c⁄fig
[
CONFIG_IF_NAME
])

339 
	`mem˝y
(
s
->
tun_«me
, 
c⁄fig
[
CONFIG_IF_NAME
], 
	`°æí
(config[CONFIG_IF_NAME]));

341 
s
->
tun_fd
 = 
	`tun_›í
(s->
tun_«me
, 
›t_if_mode
);

342 
	`DEBUG
(2, 
	`¥ötf
("usög i¡îÁ˚ %s\n", 
s
->
tun_«me
));

343 
	`£ãnv
("TUNDEV", 
s
->
tun_«me
, 1);

345 i‡(
s
->
tun_fd
 == -1)

346 
	`îr‹
(1, 
î∫o
, "can't initialiseÅunnel interface");

347 #ifde‡
FD_CLOEXEC


349 
	`f˙é
(
s
->
tun_fd
, 
F_SETFD
, 
FD_CLOEXEC
);

352 i‡(
›t_if_mode
 =
IF_MODE_TAP
) {

353 i‡(
	`tun_gë_hwaddr
(
s
->
tun_fd
, s->
tun_«me
, s->
tun_hwaddr
) < 0) {

354 
	`îr‹
(1, 
î∫o
, "can't getÅunnel HWáddress");

356 
	`hex_dump
("öãrÁ˚ HWáddr", 
s
->
tun_hwaddr
, 
ETH_ALEN
, 
NULL
);

358 
	}
}

360 
	$c⁄fig_tu¬ñ
(
ß_block
 *
s
)

362 
	`£ãnv
("VPNGATEWAY", 
	`öë_¡ﬂ
(
s
->
d°
), 1);

363 
	`£ãnv
("reason", "connect", 1);

364 
	`sy°em
(
c⁄fig
[
CONFIG_SCRIPT
]);

365 
	}
}

367 
	$˛o£_tu¬ñ
(
ß_block
 *
s
)

369 
	`£ãnv
("reason", "disconnect", 1);

370 
	`sy°em
(
c⁄fig
[
CONFIG_SCRIPT
]);

371 
	`tun_˛o£
(
s
->
tun_fd
, s->
tun_«me
);

372 
	}
}

374 
	$ªcv_ign‹e_dup
(
ß_block
 *
s
, *
ªcvbuf
, 
size_t
 
ªcvbufsize
)

376 
uöt8_t
 *
ª£nd_check_hash
;

377 
ªcvsize
, 
hash_Àn
;

379 
ªcvsize
 = 
	`ªcv
(
s
->
ike_fd
, 
ªcvbuf
, 
ªcvbufsize
, 0);

380 i‡(
ªcvsize
 < 0)

381 
	`îr‹
(1, 
î∫o
, "receivingÖacket");

382 i‡(()
ªcvsize
 > 
ªcvbufsize
)

383 
	`îr‹
(1, 
î∫o
, "receivedÖacketÅooÜarge for buffer");

387 (
ªcvsize
 =1Ë&& (*((
u_ch¨
 *)(
ªcvbuf
)) == 0xff))

389 i‡((
s
->
ù£c
.
«â_a˘ive_mode
 !
NATT_ACTIVE_DRAFT_OLD
))

391 
	`DEBUG
(2, 
	`¥ötf
("Re˚ived UDP NAT-Kì∑livêbugÇ©á˘ivêmodêöc‹ª˘: %d\n", 
s
->
ù£c
.
«â_a˘ive_mode
));

396 
hash_Àn
 = 
	`g¸y_md_gë_Ægo_dÀn
(
GCRY_MD_SHA1
);

397 
ª£nd_check_hash
 = 
	`mÆloc
(
hash_Àn
);

398 
	`g¸y_md_hash_buf„r
(
GCRY_MD_SHA1
, 
ª£nd_check_hash
, 
ªcvbuf
, 
ªcvsize
);

399 i‡(
s
->
ike
.
ª£nd_hash
 && 
	`memcmp
(s->ike.ª£nd_hash, 
ª£nd_check_hash
, 
hash_Àn
) == 0) {

400 
	`‰ì
(
ª£nd_check_hash
);

403 i‡(!
s
->
ike
.
ª£nd_hash
) {

404 
s
->
ike
.
ª£nd_hash
 = 
ª£nd_check_hash
;

406 
	`mem˝y
(
s
->
ike
.
ª£nd_hash
, 
ª£nd_check_hash
, 
hash_Àn
);

407 
	`‰ì
(
ª£nd_check_hash
);

410  
ªcvsize
;

411 
	}
}

418 
ssize_t
 
	$£ndªcv
(
ß_block
 *
s
, *
ªcvbuf
, 
size_t
 
ªcvbufsize
, *
to£nd
, size_à
£ndsize
, 
£nd⁄ly
)

420 
pﬁlfd
 
pfd
;

421 
åõs
 = 0;

422 
ªcvsize
 = -1;

423 
time_t
 
°¨t
 = 
	`time
(
NULL
);

424 
time_t
 
íd
 = 0;

425 *
ªÆto£nd
;

427 
pfd
.
fd
 = 
s
->
ike_fd
;

428 
pfd
.
evíts
 = 
POLLIN
;

429 
åõs
 = 0;

431 i‡((
s
->
ù£c
.
«â_a˘ive_mode
 =
NATT_ACTIVE_RFC
Ë&& (
to£nd
 !
NULL
)) {

432 
	`DEBUG
(2, 
	`¥ötf
("NAT-T mode,áddingÇon-esp marker\n"));

433 
ªÆto£nd
 = 
	`xÆlocc
(
£ndsize
+4);

434 
	`memmove
((*)
ªÆto£nd
+4, 
to£nd
, 
£ndsize
);

435 
£ndsize
 += 4;

437 
ªÆto£nd
 = 
to£nd
;

441 
pﬁÃesu…
;

443 i‡(
ªÆto£nd
 !
NULL
)

444 i‡(
	`wrôe
(
s
->
ike_fd
, 
ªÆto£nd
, 
£ndsize
) != ()sendsize)

445 
	`îr‹
(1, 
î∫o
, "can't sendÖacket");

446 i‡(
£nd⁄ly
)

450 
pﬁÃesu…
 = 
	`pﬁl
(&
pfd
, 1, 
s
->
ike
.
timeout
 << 
åõs
);

451 } 
pﬁÃesu…
 =-1 && 
î∫o
 =
EINTR
);

453 i‡(
pﬁÃesu…
 == -1)

454 
	`îr‹
(1, 
î∫o
, "can'tÖoll socket");

455 i‡(
pﬁÃesu…
 != 0) {

456 
ªcvsize
 = 
	`ªcv_ign‹e_dup
(
s
, 
ªcvbuf
, 
ªcvbufsize
);

457 
íd
 = 
	`time
(
NULL
);

458 i‡(
ªcvsize
 != -1)

463 i‡(
åõs
 > 2)

464 
	`îr‹
(1, 0, "noÑesponse fromÅarget");

465 
åõs
++;

468 i‡(
ªÆto£nd
 !
to£nd
)

469 
	`‰ì
(
ªÆto£nd
);

471 i‡(
£nd⁄ly
)

474 i‡((
s
->
ù£c
.
«â_a˘ive_mode
 =
NATT_ACTIVE_RFC
)&&(
ªcvsize
 > 4)) {

475 
ªcvsize
 -= 4;

476 
	`memmove
(
ªcvbuf
, (*Ïecvbuf+4, 
ªcvsize
);

479 
	`DEBUGTOP
(3, 
	`¥ötf
("\nÑeceiving: <========================\n"));

483 i‡(
°¨t
 >
íd
)

484 
s
->
ike
.
timeout
 = 2000;

486 
s
->
ike
.
timeout
 = 4000 * (
íd
 - 
°¨t
);

488  
ªcvsize
;

489 
	}
}

491 
	$ißkmp_¸y±
(
ß_block
 *
s
, 
uöt8_t
 * 
block
, 
size_t
 
blockÀn
, 
íc
)

493 *
√w_iv
, *
iv
 = 
NULL
;

494 
öfo_ex
;

495 
g¸y_cùhî_hd_t
 
¸y_˘x
;

497 i‡(
blockÀn
 < 
ISAKMP_PAYLOAD_O
 || ((blockÀ¿- ISAKMP_PAYLOAD_OË% 
s
->
ike
.
ivÀn
 != 0))

498 
	`ab‹t
();

500 i‡(!
íc
 && (
	`memcmp
(
block
 + 
ISAKMP_I_COOKIE_O
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
) != 0

501 || 
	`memcmp
(
block
 + 
ISAKMP_R_COOKIE_O
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
) != 0)) {

502 
	`DEBUG
(2, 
	`¥ötf
("gotÖaket with wrong cookies\n"));

503  
ISAKMP_N_INVALID_COOKIE
;

506 
öfo_ex
 = 
block
[
ISAKMP_EXCHANGE_TYPE_O
] =
ISAKMP_EXCHANGE_INFORMATIONAL
;

508 i‡(
	`memcmp
(
block
 + 
ISAKMP_MESSAGE_ID_O
, 
s
->
ike
.
cuºít_iv_msgid
, 4) != 0) {

509 
g¸y_md_hd_t
 
md_˘x
;

511 
	`g¸y_md_›í
(&
md_˘x
, 
s
->
ike
.
md_Ægo
, 0);

512 
	`g¸y_md_wrôe
(
md_˘x
, 
s
->
ike
.
öôül_iv
, s->ike.
ivÀn
);

513 
	`g¸y_md_wrôe
(
md_˘x
, 
block
 + 
ISAKMP_MESSAGE_ID_O
, 4);

514 
	`g¸y_md_föÆ
(
md_˘x
);

515 i‡(
öfo_ex
) {

516 
iv
 = 
	`xÆlocc
(
s
->
ike
.
ivÀn
);

517 
	`mem˝y
(
iv
, 
	`g¸y_md_ªad
(
md_˘x
, 0), 
s
->
ike
.
ivÀn
);

519 
	`mem˝y
(
s
->
ike
.
cuºít_iv
, 
	`g¸y_md_ªad
(
md_˘x
, 0), s->ike.
ivÀn
);

520 
	`mem˝y
(
s
->
ike
.
cuºít_iv_msgid
, 
block
 + 
ISAKMP_MESSAGE_ID_O
, 4);

522 
	`g¸y_md_˛o£
(
md_˘x
);

523 } i‡(
öfo_ex
) {

524 
	`ab‹t
();

527 i‡(!
öfo_ex
) {

528 
iv
 = 
s
->
ike
.
cuºít_iv
;

531 
√w_iv
 = 
	`xÆlocc
(
s
->
ike
.
ivÀn
);

532 
	`g¸y_cùhî_›í
(&
¸y_˘x
, 
s
->
ike
.
¸y_Ægo
, 
GCRY_CIPHER_MODE_CBC
, 0);

533 
	`g¸y_cùhî_£tkey
(
¸y_˘x
, 
s
->
ike
.
key
, s->ike.
keyÀn
);

534 
	`g¸y_cùhî_£tiv
(
¸y_˘x
, 
iv
, 
s
->
ike
.
ivÀn
);

535 i‡(!
íc
) {

536 
	`mem˝y
(
√w_iv
, 
block
 + 
blockÀn
 - 
s
->
ike
.
ivÀn
, s->ike.ivlen);

537 
	`g¸y_cùhî_de¸y±
(
¸y_˘x
, 
block
 + 
ISAKMP_PAYLOAD_O
, 
blockÀn
 - ISAKMP_PAYLOAD_O,

538 
NULL
, 0);

539 i‡(!
öfo_ex
)

540 
	`mem˝y
(
s
->
ike
.
cuºít_iv
, 
√w_iv
, s->ike.
ivÀn
);

542 
	`g¸y_cùhî_í¸y±
(
¸y_˘x
, 
block
 + 
ISAKMP_PAYLOAD_O
, 
blockÀn
 - ISAKMP_PAYLOAD_O,

543 
NULL
, 0);

544 i‡(!
öfo_ex
)

545 
	`mem˝y
(
s
->
ike
.
cuºít_iv
, 
block
 + 
blockÀn
 - s->ike.
ivÀn
, s->ike.ivlen);

547 
	`g¸y_cùhî_˛o£
(
¸y_˘x
);

549 
	`‰ì
(
√w_iv
);

550 i‡(
öfo_ex
)

551 
	`‰ì
(
iv
);

554 
	}
}

556 
uöt16_t
 
	$u≈ack_vîify_pha£2
(
ß_block
 *
s
, 
uöt8_t
 * 
r_∑ckë
,

557 
size_t
 
r_Àngth
, 
ißkmp_∑ckë
 **
r_p
, c⁄° 
uöt8_t
 * 
n⁄˚
, size_à
n⁄˚_size
)

559 
ißkmp_∑ckë
 *
r
;

560 
ªje˘
 = 0;

562 *
r_p
 = 
NULL
;

567 i‡(
r_Àngth
 < 
ISAKMP_PAYLOAD_O
 ||

568 ((
r_Àngth
 - 
ISAKMP_PAYLOAD_O
Ë% 
s
->
ike
.
ivÀn
 != 0)) {

569 
	`DEBUG
(2, 
	`¥ötf
("payloadÅoo short orÇotÖadded:Üen=%lld, min=%d (ivlen=%lld)\n",

570 ()
r_Àngth
, 
ISAKMP_PAYLOAD_O
, ()
s
->
ike
.
ivÀn
));

571 
	`hex_dump
("Paylﬂd", 
r_∑ckë
, 
r_Àngth
, 
NULL
);

572 i‡(
r_Àngth
 < 
ISAKMP_PAYLOAD_O
 ) {

573  
ISAKMP_N_UNEQUAL_PAYLOAD_LENGTHS
;

575 
r_Àngth
 -‘_Àngth - 
ISAKMP_PAYLOAD_O
Ë% 
s
->
ike
.
ivÀn
;

578 
ªje˘
 = 
	`ißkmp_¸y±
(
s
, 
r_∑ckë
, 
r_Àngth
, 0);

579 i‡(
ªje˘
 != 0)

580  
ªje˘
;

582 
s
->
ike
.
li„
.
rx
 +
r_Àngth
;

585 
r
 = 
	`∑r£_ißkmp_∑ckë
(
r_∑ckë
, 
r_Àngth
, &
ªje˘
);

586 i‡(
ªje˘
 != 0) {

587 i‡(
r
Ë
	`‰ì_ißkmp_∑ckë
(r);

588  
ªje˘
;

593 i‡(
r
->
Êags
 !
ISAKMP_FLAG_E
) {

594 
	`‰ì_ißkmp_∑ckë
(
r
);

595  
ISAKMP_N_INVALID_FLAGS
;

599 
size_t
 
sz
, 
•os
;

600 
g¸y_md_hd_t
 
hm
;

601 *
ex≥˘ed_hash
;

602 
ißkmp_∑ylﬂd
 *
h
 = 
r
->
∑ylﬂd
;

604 i‡(
h
 =
NULL
 || h->
ty≥
 !
ISAKMP_PAYLOAD_HASH
 || h->
u
.
hash
.
Àngth
 !
s
->
ike
.
md_Àn
) {

605 
	`‰ì_ißkmp_∑ckë
(
r
);

606  
ISAKMP_N_INVALID_HASH_INFORMATION
;

609 
•os
 = (
ISAKMP_PAYLOAD_O
 + (
r_∑ckë
[ISAKMP_PAYLOAD_O + 2] << 8)

610 + 
r_∑ckë
[
ISAKMP_PAYLOAD_O
 + 3]);

613 
sz
 = 
•os
; 
r_∑ckë
[sz] != 0; sz +=Ñ_packet[sz + 2] << 8 |Ñ_packet[sz + 3]) ;

614 
sz
 +
r_∑ckë
[sz + 2] << 8 |Ñ_packet[sz + 3];

616 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

617 
	`g¸y_md_£tkey
(
hm
, 
s
->
ike
.
skeyid_a
, s->ike.
md_Àn
);

618 
	`g¸y_md_wrôe
(
hm
, 
r_∑ckë
 + 
ISAKMP_MESSAGE_ID_O
, 4);

619 i‡(
n⁄˚
)

620 
	`g¸y_md_wrôe
(
hm
, 
n⁄˚
, 
n⁄˚_size
);

621 
	`g¸y_md_wrôe
(
hm
, 
r_∑ckë
 + 
•os
, 
sz
 - spos);

622 
	`g¸y_md_föÆ
(
hm
);

623 
ex≥˘ed_hash
 = 
	`g¸y_md_ªad
(
hm
, 0);

625 
	`DEBUG
(3,
	`¥ötf
("hashÀn: %lu\n", ()
s
->
ike
.
md_Àn
));

626 
	`DEBUG
(3,
	`¥ötf
("u.hash.Àngth: %d\n", 
h
->
u
.
hash
.
Àngth
));

627 
	`hex_dump
("ex≥˘ed_hash", 
ex≥˘ed_hash
, 
s
->
ike
.
md_Àn
, 
NULL
);

628 
	`hex_dump
("h->u.hash.d©a", 
h
->
u
.
hash
.
d©a
, 
s
->
ike
.
md_Àn
, 
NULL
);

630 
ªje˘
 = 0;

631 i‡(
	`memcmp
(
h
->
u
.
hash
.
d©a
, 
ex≥˘ed_hash
, 
s
->
ike
.
md_Àn
) != 0)

632 
ªje˘
 = 
ISAKMP_N_AUTHENTICATION_FAILED
;

633 
	`g¸y_md_˛o£
(
hm
);

635 i‡(
ªje˘
 != 0) {

636 
	`‰ì_ißkmp_∑ckë
(
r
);

637  
ªje˘
;

641 *
r_p
 = 
r
;

643 
	}
}

646 
	$pha£2_auth∑ckë
(
ß_block
 *
s
, 
ißkmp_∑ylﬂd
 *
∂
,

647 
uöt8_t
 
exch™ge_ty≥
, 
uöt32_t
 
msgid
,

648 
uöt8_t
 ** 
p_Ê©
, 
size_t
 * 
p_size
,

649 
uöt8_t
 * 
n⁄˚_i
, 
ni_Àn
, uöt8_à* 
n⁄˚_r
, 
ƒ_Àn
)

651 
ißkmp_∑ckë
 *
p
;

652 
uöt8_t
 *
∂_Ê©
;

653 
size_t
 
∂_size
;

654 
g¸y_md_hd_t
 
hm
;

655 
uöt8_t
 
msgid_£¡
[4];

658 
p
 = 
	`√w_ißkmp_∑ckë
();

659 
	`mem˝y
(
p
->
i_cookõ
, 
s
->
ike
.i_cookõ, 
ISAKMP_COOKIE_LENGTH
);

660 
	`mem˝y
(
p
->
r_cookõ
, 
s
->
ike
.r_cookõ, 
ISAKMP_COOKIE_LENGTH
);

661 
p
->
Êags
 = 
ISAKMP_FLAG_E
;

662 
p
->
ißkmp_vîsi⁄
 = 
ISAKMP_VERSION
;

663 
p
->
exch™ge_ty≥
 =Éxchange_type;

664 
p
->
mesßge_id
 = 
msgid
;

665 
p
->
∑ylﬂd
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_HASH
);

666 
p
->
∑ylﬂd
->
√xt
 = 
∂
;

667 
p
->
∑ylﬂd
->
u
.
hash
.
Àngth
 = 
s
->
ike
.
md_Àn
;

668 
p
->
∑ylﬂd
->
u
.
hash
.
d©a
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

671 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

672 
	`g¸y_md_£tkey
(
hm
, 
s
->
ike
.
skeyid_a
, s->ike.
md_Àn
);

674 i‡(
∂
 =
NULL
) {

675 
	`DEBUG
(3, 
	`¥ötf
("authing NULLÖackage!\n"));

676 
	`g¸y_md_wrôe
(
hm
, "" , 1);

679 
msgid_£¡
[0] = 
msgid
 >> 24;

680 
msgid_£¡
[1] = 
msgid
 >> 16;

681 
msgid_£¡
[2] = 
msgid
 >> 8;

682 
msgid_£¡
[3] = 
msgid
;

683 
	`g¸y_md_wrôe
(
hm
, 
msgid_£¡
, (msgid_sent));

685 i‡(
n⁄˚_i
 !
NULL
)

686 
	`g¸y_md_wrôe
(
hm
, 
n⁄˚_i
, 
ni_Àn
);

688 i‡(
n⁄˚_r
 !
NULL
)

689 
	`g¸y_md_wrôe
(
hm
, 
n⁄˚_r
, 
ƒ_Àn
);

691 i‡(
∂
 !
NULL
) {

692 
	`Ê©ãn_ißkmp_∑ylﬂds
(
∂
, &
∂_Ê©
, &
∂_size
);

693 
	`g¸y_md_wrôe
(
hm
, 
∂_Ê©
, 
∂_size
);

694 
	`mem£t
(
∂_Ê©
, 0, 
∂_size
);

695 
	`‰ì
(
∂_Ê©
);

698 
	`g¸y_md_föÆ
(
hm
);

699 
	`mem˝y
(
p
->
∑ylﬂd
->
u
.
hash
.
d©a
, 
	`g¸y_md_ªad
(
hm
, 0), 
s
->
ike
.
md_Àn
);

700 
	`g¸y_md_˛o£
(
hm
);

702 
	`Ê©ãn_ißkmp_∑ckë
(
p
, 
p_Ê©
, 
p_size
, 
s
->
ike
.
ivÀn
);

703 
	`‰ì_ißkmp_∑ckë
(
p
);

704 
	}
}

706 
	$£ndªcv_pha£2
(
ß_block
 *
s
, 
ißkmp_∑ylﬂd
 *
∂
,

707 
uöt8_t
 
exch™ge_ty≥
, 
uöt32_t
 
msgid
, 
£nd⁄ly
,

708 
uöt8_t
 ** 
ßve_p_Ê©
, 
size_t
 * 
ßve_p_size
,

709 
uöt8_t
 * 
n⁄˚_i
, 
ni_Àn
, uöt8_à* 
n⁄˚_r
, 
ƒ_Àn
)

711 
uöt8_t
 *
p_Ê©
;

712 
size_t
 
p_size
;

713 
ssize_t
 
ªcvÀn
;

715 i‡((
ßve_p_Ê©
 =
NULL
) || (*save_p_flat == NULL)) {

716 
	`pha£2_auth∑ckë
(
s
, 
∂
, 
exch™ge_ty≥
, 
msgid
, &
p_Ê©
, &
p_size
,

717 
n⁄˚_i
, 
ni_Àn
, 
n⁄˚_r
, 
ƒ_Àn
);

718 
	`ißkmp_¸y±
(
s
, 
p_Ê©
, 
p_size
, 1);

720 
p_Ê©
 = *
ßve_p_Ê©
;

721 
p_size
 = *
ßve_p_size
;

724 
s
->
ike
.
li„
.
tx
 +
p_size
;

726 
ªcvÀn
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
p_Ê©
, 
p_size
, 
£nd⁄ly
);

727 i‡(
£nd⁄ly
 == 0)

728 
r_Àngth
 = 
ªcvÀn
;

730 i‡(
ßve_p_Ê©
 =
NULL
) {

731 
	`‰ì
(
p_Ê©
);

733 *
ßve_p_Ê©
 = 
p_Ê©
;

734 *
ßve_p_size
 = 
p_size
;

736 
	}
}

738 
	$£nd_pha£2_œã
(
ß_block
 *
s
, 
ißkmp_∑ylﬂd
 *
∂
,

739 
uöt8_t
 
exch™ge_ty≥
, 
uöt32_t
 
msgid
)

741 
ißkmp_∑ckë
 *
p
;

742 
uöt8_t
 *
p_Ê©
;

743 
size_t
 
p_size
;

744 
ssize_t
 
ªcvÀn
;

747 
p
 = 
	`√w_ißkmp_∑ckë
();

748 
	`mem˝y
(
p
->
i_cookõ
, 
s
->
ike
.i_cookõ, 
ISAKMP_COOKIE_LENGTH
);

749 
	`mem˝y
(
p
->
r_cookõ
, 
s
->
ike
.r_cookõ, 
ISAKMP_COOKIE_LENGTH
);

750 
p
->
Êags
 = 
ISAKMP_FLAG_E
;

751 
p
->
ißkmp_vîsi⁄
 = 
ISAKMP_VERSION
;

752 
p
->
exch™ge_ty≥
 =Éxchange_type;

753 
p
->
mesßge_id
 = 
msgid
;

754 
p
->
∑ylﬂd
 = 
∂
;

756 
	`Ê©ãn_ißkmp_∑ckë
(
p
, &
p_Ê©
, &
p_size
, 
s
->
ike
.
ivÀn
);

757 
	`‰ì_ißkmp_∑ckë
(
p
);

758 
	`ißkmp_¸y±
(
s
, 
p_Ê©
, 
p_size
, 1);

760 
s
->
ike
.
li„
.
tx
 +
p_size
;

762 
ªcvÀn
 = 
	`£ndªcv
(
s
, 
NULL
, 0, 
p_Ê©
, 
p_size
, 1);

763 
	`‰ì
(
p_Ê©
);

764 
	}
}

766 
	$kì∑live_ike
(
ß_block
 *
s
)

768 
uöt32_t
 
msgid
;

770 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
msgid
, (msgid));

771 
	`£nd_pha£2_œã
(
s
, 
NULL
, 
ISAKMP_EXCHANGE_INFORMATIONAL
, 
msgid
);

772 
	}
}

774 
	$£nd_dpd
(
ß_block
 *
s
, 
ißck
, 
uöt32_t
 
£qno
)

776 
ißkmp_∑ylﬂd
 *
∂
;

777 
uöt32_t
 
msgid
;

779 
∂
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_N
);

780 
∂
->
u
.
n
.
doi
 = 
ISAKMP_DOI_IPSEC
;

781 
∂
->
u
.
n
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

782 
∂
->
u
.
n
.
ty≥
 = 
ißck
 ? 
ISAKMP_N_R_U_THERE_ACK
 : 
ISAKMP_N_R_U_THERE
;

783 
∂
->
u
.
n
.
•i_Àngth
 = 2 * 
ISAKMP_COOKIE_LENGTH
;

784 
∂
->
u
.
n
.
•i
 = 
	`xÆlocc
(2 * 
ISAKMP_COOKIE_LENGTH
);

785 
	`mem˝y
(
∂
->
u
.
n
.
•i
 + 
ISAKMP_COOKIE_LENGTH
 * 0, 
s
->
ike
.
i_cookõ
, ISAKMP_COOKIE_LENGTH);

786 
	`mem˝y
(
∂
->
u
.
n
.
•i
 + 
ISAKMP_COOKIE_LENGTH
 * 1, 
s
->
ike
.
r_cookõ
, ISAKMP_COOKIE_LENGTH);

787 
∂
->
u
.
n
.
d©a_Àngth
 = 4;

788 
∂
->
u
.
n
.
d©a
 = 
	`xÆlocc
(4);

789 
	`mem˝y
(
∂
->
u
.
n
.
d©a
, &
£qno
, 4);

790 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
msgid
, (msgid));

792 
	`£ndªcv_pha£2
(
s
, 
∂
, 
ISAKMP_EXCHANGE_INFORMATIONAL
, 
msgid
,

793 1 , 
NULL
, NULL, NULL, 0, NULL, 0);

794 
	}
}

796 
	$dpd_ike
(
ß_block
 *
s
)

798 i‡(!
s
->
ike
.
do_dpd
)

801 i‡(
s
->
ike
.
dpd_£qno
 =s->ike.
dpd_£qno_ack
) {

805 
s
->
ike
.
dpd_©ãm±s
 = 6;

806 
s
->
ike
.
dpd_£¡
 = 
	`time
(
NULL
);

807 ++
s
->
ike
.
dpd_£qno
;

808 
	`£nd_dpd
(
s
, 0, s->
ike
.
dpd_£qno
);

816 
time_t
 
now
 = 
	`time
(
NULL
);

817 i‡(
now
 < 
s
->
ike
.
dpd_£¡
 + 5)

819 i‡(--
s
->
ike
.
dpd_©ãm±s
 == 0) {

820 
	`DEBUG
(2, 
	`¥ötf
("deadÖeer detected,Åerminating\n"));

821 
do_kûl
 = -2;

824 
s
->
ike
.
dpd_£¡
 = 
now
;

825 
	`£nd_dpd
(
s
, 0, s->
ike
.
dpd_£qno
);

827 
	}
}

829 
	$pha£2_Áèl
(
ß_block
 *
s
, c⁄° *
msg
, 
id
)

831 
ißkmp_∑ylﬂd
 *
∂
;

832 
uöt32_t
 
msgid
;

834 
	`DEBUG
(1, 
	`¥ötf
("\n\n---!!!!!!!!!ÉnteringÖhase2_fatal !!!!!!!!!---\n\n\n"));

835 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
msgid
, (msgid));

836 
∂
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_N
);

837 
∂
->
u
.
n
.
doi
 = 
ISAKMP_DOI_IPSEC
;

838 
∂
->
u
.
n
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

839 
∂
->
u
.
n
.
ty≥
 = 
id
;

840 
	`£ndªcv_pha£2
(
s
, 
∂
, 
ISAKMP_EXCHANGE_INFORMATIONAL
, 
msgid
, 1, 0, 0, 0, 0, 0, 0);

842 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
msgid
, (msgid));

843 
∂
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_D
);

844 
∂
->
u
.
d
.
doi
 = 
ISAKMP_DOI_IPSEC
;

845 
∂
->
u
.
d
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

846 
∂
->
u
.
d
.
•i_Àngth
 = 2 * 
ISAKMP_COOKIE_LENGTH
;

847 
∂
->
u
.
d
.
num_•i
 = 1;

848 
∂
->
u
.
d
.
•i
 = 
	`xÆlocc
(1 * (
uöt8_t
 *));

849 
∂
->
u
.
d
.
•i
[0] = 
	`xÆlocc
(2 * 
ISAKMP_COOKIE_LENGTH
);

850 
	`mem˝y
(
∂
->
u
.
d
.
•i
[0] + 
ISAKMP_COOKIE_LENGTH
 * 0, 
s
->
ike
.
i_cookõ
, ISAKMP_COOKIE_LENGTH);

851 
	`mem˝y
(
∂
->
u
.
d
.
•i
[0] + 
ISAKMP_COOKIE_LENGTH
 * 1, 
s
->
ike
.
r_cookõ
, ISAKMP_COOKIE_LENGTH);

852 
	`£ndªcv_pha£2
(
s
, 
∂
, 
ISAKMP_EXCHANGE_INFORMATIONAL
, 
msgid
, 1, 0, 0, 0, 0, 0, 0);

854 
	`îr‹
(1, 0, 
msg
, 
	`vÆ_to_°rög
(
id
, 
ißkmp_nŸify_íum_¨øy
), id);

855 
	}
}

857 
uöt8_t
 *
	$gí_keym©
(
ß_block
 *
s
,

858 
uöt8_t
 
¥Ÿocﬁ
, 
uöt32_t
 
•i
,

859 c⁄° 
uöt8_t
 * 
dh_sh¨ed
, 
size_t
 
dh_size
,

860 c⁄° 
uöt8_t
 * 
ni_d©a
, 
size_t
 
ni_size
, c⁄° uöt8_à* 
ƒ_d©a
, size_à
ƒ_size
)

862 
g¸y_md_hd_t
 
hm
;

863 
uöt8_t
 *
block
;

864 
i
;

865 
blksz
;

866 
˙t
;

868 
blksz
 = 
s
->
ù£c
.
md_Àn
 + s->ù£c.
key_Àn
;

869 
˙t
 = (
blksz
 + 
s
->
ike
.
md_Àn
 - 1) / s->ike.md_len;

870 
block
 = 
	`xÆlocc
(
˙t
 * 
s
->
ike
.
md_Àn
);

871 
	`DEBUG
(3, 
	`¥ötf
("gíî©ög %d byã†keym© (˙t=%d)\n", 
blksz
, 
˙t
));

872 i‡(
˙t
 < 1)

873 
	`ab‹t
();

875 
i
 = 0; i < 
˙t
; i++) {

876 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

877 
	`g¸y_md_£tkey
(
hm
, 
s
->
ike
.
skeyid_d
, s->ike.
md_Àn
);

878 i‡(
i
 != 0)

879 
	`g¸y_md_wrôe
(
hm
, 
block
 + (
i
 - 1Ë* 
s
->
ike
.
md_Àn
, s->ike.md_len);

880 i‡(
dh_sh¨ed
 !
NULL
)

881 
	`g¸y_md_wrôe
(
hm
, 
dh_sh¨ed
, 
dh_size
);

882 
	`g¸y_md_wrôe
(
hm
, &
¥Ÿocﬁ
, 1);

883 
	`g¸y_md_wrôe
(
hm
, (
uöt8_t
 *Ë& 
•i
, (spi));

884 
	`g¸y_md_wrôe
(
hm
, 
ni_d©a
, 
ni_size
);

885 
	`g¸y_md_wrôe
(
hm
, 
ƒ_d©a
, 
ƒ_size
);

886 
	`g¸y_md_föÆ
(
hm
);

887 
	`mem˝y
(
block
 + 
i
 * 
s
->
ike
.
md_Àn
, 
	`g¸y_md_ªad
(
hm
, 0), s->ike.md_len);

888 
	`g¸y_md_˛o£
(
hm
);

890  
block
;

891 
	}
}

893 
	$mask_to_maskÀn
(
ö_addr
 
mask
)

895 
Àn
;

896 
uöt32_t
 
addr
;

898 
addr
 = 
	`¡ohl
(
mask
.
s_addr
);

899 
Àn
 = 0; 
addr
;áddr <<= 1,Üen++)

901  
Àn
;

902 
	}
}

904 
	$do_c⁄fig_to_ív
(
ß_block
 *
s
, 
ißkmp_©åibuã
 *
a
)

906 
i
;

907 
ªje˘
 = 0;

908 
£í_addªss
 = 0;

909 *
°rbuf
, *
°rbuf2
;

911 
	`un£ãnv
("CISCO_BANNER");

912 
	`un£ãnv
("CISCO_DEF_DOMAIN");

913 
	`un£ãnv
("CISCO_SPLIT_INC");

914 
	`un£ãnv
("INTERNAL_IP4_NBNS");

915 
	`un£ãnv
("INTERNAL_IP4_DNS");

916 
	`un£ãnv
("INTERNAL_IP4_NETMASK");

917 
	`un£ãnv
("INTERNAL_IP4_ADDRESS");

919 ; 
a
 && 
ªje˘
 =0;á =á->
√xt
)

920 
a
->
ty≥
) {

921 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_ADDRESS
:

922 i‡(
a
->
af
 !
ißkmp_©å_lŸs
 ||á->
u
.
lŸs
.
Àngth
 != 4)

923 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

925 
	`addív_ùv4
("INTERNAL_IP4_ADDRESS", 
a
->
u
.
lŸs
.
d©a
);

926 
	`mem˝y
(
s
->
our_addªss
, 
a
->
u
.
lŸs
.
d©a
, 4);

928 
£í_addªss
 = 1;

931 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NETMASK
:

932 i‡(
a
->
af
 =
ißkmp_©å_lŸs
 &&á->
u
.
lŸs
.
Àngth
 == 0) {

933 
	`DEBUG
(2, 
	`¥ötf
("ignoring zeroÜengthÇetmask\n"));

936 i‡(
a
->
af
 !
ißkmp_©å_lŸs
 ||á->
u
.
lŸs
.
Àngth
 != 4)

937 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

939 
uöt32_t
 
√èddr
 = ((
ö_addr
 *)(
s
->
our_addªss
))->
s_addr
 & ((ö_add∏*)(
a
->
u
.
lŸs
.
d©a
))->s_addr;

940 
	`addív_ùv4
("INTERNAL_IP4_NETMASK", 
a
->
u
.
lŸs
.
d©a
);

941 
	`a•rötf
(&
°rbuf
, "%d", 
	`mask_to_maskÀn
(*((
ö_addr
 *)
a
->
u
.
lŸs
.
d©a
)));

942 
	`£ãnv
("INTERNAL_IP4_NETMASKLEN", 
°rbuf
, 1);

943 
	`‰ì
(
°rbuf
);

944 
	`addív_ùv4
("INTERNAL_IP4_NETADDR", (
uöt8_t
 *)&
√èddr
);

948 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DNS
:

949 i‡(
a
->
af
 !
ißkmp_©å_lŸs
 ||á->
u
.
lŸs
.
Àngth
 != 4)

950 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

952 
	`addív_ùv4
("INTERNAL_IP4_DNS", 
a
->
u
.
lŸs
.
d©a
);

955 
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NBNS
:

956 i‡(
a
->
af
 !
ißkmp_©å_lŸs
 ||á->
u
.
lŸs
.
Àngth
 != 4)

957 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

959 
	`addív_ùv4
("INTERNAL_IP4_NBNS", 
a
->
u
.
lŸs
.
d©a
);

962 
ISAKMP_MODECFG_ATTRIB_CISCO_DEF_DOMAIN
:

963 i‡(
a
->
af
 !
ißkmp_©å_lŸs
) {

964 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

967 
°rbuf
 = 
	`xÆlocc
(
a
->
u
.
lŸs
.
Àngth
 + 1);

968 
	`mem˝y
(
°rbuf
, 
a
->
u
.
lŸs
.
d©a
,á->u.lŸs.
Àngth
);

969 
	`addív
("CISCO_DEF_DOMAIN", 
°rbuf
);

970 
	`‰ì
(
°rbuf
);

973 
ISAKMP_MODECFG_ATTRIB_CISCO_BANNER
:

974 i‡(
a
->
af
 !
ißkmp_©å_lŸs
) {

975 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

978 
°rbuf
 = 
	`xÆlocc
(
a
->
u
.
lŸs
.
Àngth
 + 1);

979 
	`mem˝y
(
°rbuf
, 
a
->
u
.
lŸs
.
d©a
,á->u.lŸs.
Àngth
);

980 
	`addív
("CISCO_BANNER", 
°rbuf
);

981 
	`‰ì
(
°rbuf
);

982 
	`DEBUG
(1, 
	`¥ötf
("Banner: "));

983 
	`DEBUG
(1, 
	`fwrôe
(
a
->
u
.
lŸs
.
d©a
,á->u.lŸs.
Àngth
, 1, 
°dout
));

984 
	`DEBUG
(1, 
	`¥ötf
("\n"));

987 
ISAKMP_MODECFG_ATTRIB_APPLICATION_VERSION
:

988 
	`DEBUG
(2, 
	`¥ötf
("Remote Application Version: "));

989 
	`DEBUG
(2, 
	`fwrôe
(
a
->
u
.
lŸs
.
d©a
,á->u.lŸs.
Àngth
, 1, 
°dout
));

990 
	`DEBUG
(2, 
	`¥ötf
("\n"));

993 
ISAKMP_MODECFG_ATTRIB_CISCO_DO_PFS
:

994 i‡(
a
->
af
 !
ißkmp_©å_16
)

995 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

997 
s
->
ù£c
.
do_pfs
 = 
a
->
u
.
©å_16
;

998 
	`DEBUG
(2, 
	`¥ötf
("gŸÖf†£âög: %d\n", 
s
->
ù£c
.
do_pfs
));

1002 
ISAKMP_MODECFG_ATTRIB_CISCO_UDP_ENCAP_PORT
:

1003 i‡(
a
->
af
 !
ißkmp_©å_16
)

1004 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

1006 
s
->
ù£c
.
≥î_ud≥nˇp_p‹t
 = 
a
->
u
.
©å_16
;

1007 
	`DEBUG
(2, 
	`¥ötf
("gŸÖì∏ud∞íˇpsuœti⁄Ö‹t: %hu\n", 
s
->
ù£c
.
≥î_ud≥nˇp_p‹t
));

1011 
ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_INC
:

1012 i‡(
a
->
af
 !
ißkmp_©å_a˛
) {

1013 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

1017 
	`DEBUG
(2, 
	`¥ötf
("gŸ %dá˛†f‹ s∂ô in˛ude\n", 
a
->
u
.
a˛
.
cou¡
));

1018 
	`a•rötf
(&
°rbuf
, "%d", 
a
->
u
.
a˛
.
cou¡
);

1019 
	`£ãnv
("CISCO_SPLIT_INC", 
°rbuf
, 1);

1020 
	`‰ì
(
°rbuf
);

1022 
i
 = 0; i < 
a
->
u
.
a˛
.
cou¡
; i++) {

1023 
	`DEBUG
(2, 
	`¥ötf
("a˛ %d: ", 
i
));

1026 
	`a•rötf
(&
°rbuf
, "CISCO_SPLIT_INC_%d_ADDR", 
i
);

1027 
	`a•rötf
(&
°rbuf2
, "%s", 
	`öë_¡ﬂ
(
a
->
u
.
a˛
.
a˛_ít
[
i
].
addr
));

1028 
	`DEBUG
(2, 
	`¥ötf
("addr: %s/", 
°rbuf2
));

1029 
	`£ãnv
(
°rbuf
, 
°rbuf2
, 1);

1030 
	`‰ì
(
°rbuf
); fªe(
°rbuf2
);

1032 
	`a•rötf
(&
°rbuf
, "CISCO_SPLIT_INC_%d_MASK", 
i
);

1033 
	`a•rötf
(&
°rbuf2
, "%s", 
	`öë_¡ﬂ
(
a
->
u
.
a˛
.
a˛_ít
[
i
].
mask
));

1034 
	`DEBUG
(2, 
	`¥ötf
("%†", 
°rbuf2
));

1035 
	`£ãnv
(
°rbuf
, 
°rbuf2
, 1);

1036 
	`‰ì
(
°rbuf
); fªe(
°rbuf2
);

1039 
	`a•rötf
(&
°rbuf
, "CISCO_SPLIT_INC_%d_MASKLEN", 
i
);

1040 
	`a•rötf
(&
°rbuf2
, "%d", 
	`mask_to_maskÀn
(
a
->
u
.
a˛
.
a˛_ít
[
i
].
mask
));

1041 
	`DEBUG
(2, 
	`¥ötf
("(%s), ", 
°rbuf2
));

1042 
	`£ãnv
(
°rbuf
, 
°rbuf2
, 1);

1043 
	`‰ì
(
°rbuf
); fªe(
°rbuf2
);

1045 
	`a•rötf
(&
°rbuf
, "CISCO_SPLIT_INC_%d_PROTOCOL", 
i
);

1046 
	`a•rötf
(&
°rbuf2
, "%hu", 
a
->
u
.
a˛
.
a˛_ít
[
i
].
¥Ÿocﬁ
);

1047 
	`DEBUG
(2, 
	`¥ötf
("¥Ÿocﬁ: %s, ", 
°rbuf2
));

1048 
	`£ãnv
(
°rbuf
, 
°rbuf2
, 1);

1049 
	`‰ì
(
°rbuf
); fªe(
°rbuf2
);

1051 
	`a•rötf
(&
°rbuf
, "CISCO_SPLIT_INC_%d_SPORT", 
i
);

1052 
	`a•rötf
(&
°rbuf2
, "%hu", 
a
->
u
.
a˛
.
a˛_ít
[
i
].
•‹t
);

1053 
	`DEBUG
(2, 
	`¥ötf
("•‹t: %s, ", 
°rbuf2
));

1054 
	`£ãnv
(
°rbuf
, 
°rbuf2
, 1);

1055 
	`‰ì
(
°rbuf
); fªe(
°rbuf2
);

1057 
	`a•rötf
(&
°rbuf
, "CISCO_SPLIT_INC_%d_DPORT", 
i
);

1058 
	`a•rötf
(&
°rbuf2
, "%hu", 
a
->
u
.
a˛
.
a˛_ít
[
i
].
dp‹t
);

1059 
	`DEBUG
(2, 
	`¥ötf
("dp‹t: %s\n", 
°rbuf2
));

1060 
	`£ãnv
(
°rbuf
, 
°rbuf2
, 1);

1061 
	`‰ì
(
°rbuf
); fªe(
°rbuf2
);

1065 
ISAKMP_MODECFG_ATTRIB_CISCO_SAVE_PW
:

1066 
	`DEBUG
(2, 
	`¥ötf
("gŸ savê∑ssw‹d sëtög: %d\n", 
a
->
u
.
©å_16
));

1070 
	`DEBUG
(2, 
	`¥ötf
("unknow¿©åibuã %d / 0x%X\n", 
a
->
ty≥
,á->type));

1074 i‡(
ªje˘
 =0 && !
£í_addªss
)

1075 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

1077  
ªje˘
;

1078 
	}
}

1082 
ißkmp_©åibuã
 *
	$make_å™sf‹m_ike
(
dh_group
, 
¸y±
, 
hash
, 
keyÀn
, 
auth
)

1084 
ißkmp_©åibuã
 *
a
 = 
NULL
;

1086 
a
 = 
	`√w_ißkmp_©åibuã
(
IKE_ATTRIB_LIFE_DURATION
,á);

1087 
a
->
af
 = 
ißkmp_©å_lŸs
;

1088 
a
->
u
.
lŸs
.
Àngth
 = 4;

1089 
a
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
◊->u.lŸs.
Àngth
);

1090 *((
uöt32_t
 *Ë
a
->
u
.
lŸs
.
d©a
Ë
	`ht⁄l
(2147483);

1091 
a
 = 
	`√w_ißkmp_©åibuã_16
(
IKE_ATTRIB_LIFE_TYPE
, 
IKE_LIFE_TYPE_SECONDS
,á);

1092 
a
 = 
	`√w_ißkmp_©åibuã_16
(
IKE_ATTRIB_AUTH_METHOD
, 
auth
,á);

1093 
a
 = 
	`√w_ißkmp_©åibuã_16
(
IKE_ATTRIB_GROUP_DESC
, 
dh_group
,á);

1094 
a
 = 
	`√w_ißkmp_©åibuã_16
(
IKE_ATTRIB_HASH
, 
hash
,á);

1095 
a
 = 
	`√w_ißkmp_©åibuã_16
(
IKE_ATTRIB_ENC
, 
¸y±
,á);

1096 i‡(
keyÀn
 != 0)

1097 
a
 = 
	`√w_ißkmp_©åibuã_16
(
IKE_ATTRIB_KEY_LENGTH
, 
keyÀn
,á);

1098  
a
;

1099 
	}
}

1101 
ißkmp_∑ylﬂd
 *
	$make_our_ß_ike
()

1103 
ißkmp_∑ylﬂd
 *
r
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_SA
);

1104 
ißkmp_∑ylﬂd
 *
t
 = 
NULL
, *
ä
;

1105 
ißkmp_©åibuã
 *
a
;

1106 
dh_gΩ
 = 
	`gë_dh_group_ike
()->
ike_ß_id
;

1107 
auth
, 
¸y±
, 
hash
, 
keyÀn
;

1108 
i
;

1110 
r
->
u
.
ß
.
doi
 = 
ISAKMP_DOI_IPSEC
;

1111 
r
->
u
.
ß
.
sôu©i⁄
 = 
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
;

1112 
r
->
u
.
ß
.
¥›oßls
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_P
);

1113 
r
->
u
.
ß
.
¥›oßls
->u.
p
.
¥Ÿ_id
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

1114 
auth
 = 0; 
suµ_auth
[auth].
«me
 !
NULL
;áuth++) {

1115 i‡(
›t_auth_mode
 =
AUTH_MODE_CERT
) {

1116 i‡((
suµ_auth
[
auth
].
ike_ß_id
 !
IKE_AUTH_RSA_SIG
) &&

1117 (
suµ_auth
[
auth
].
ike_ß_id
 !
IKE_AUTH_DSS
))

1119 } i‡(
›t_auth_mode
 =
AUTH_MODE_HYBRID
) {

1120 i‡((
suµ_auth
[
auth
].
ike_ß_id
 !
IKE_AUTH_HybridInôRSA
) &&

1121 (
suµ_auth
[
auth
].
ike_ß_id
 !
IKE_AUTH_HybridInôDSS
))

1124 i‡(
suµ_auth
[
auth
].
ike_ß_id
 =
IKE_AUTH_HybridInôRSA
 ||

1125 
suµ_auth
[
auth
].
ike_ß_id
 =
IKE_AUTH_HybridInôDSS
 ||

1126 
suµ_auth
[
auth
].
ike_ß_id
 =
IKE_AUTH_RSA_SIG
 ||

1127 
suµ_auth
[
auth
].
ike_ß_id
 =
IKE_AUTH_DSS
)

1130 
¸y±
 = 0; 
suµ_¸y±
[¸y±].
«me
 !
NULL
; crypt++) {

1131 
keyÀn
 = 
suµ_¸y±
[
¸y±
].keylen;

1132 
hash
 = 0; 
suµ_hash
[hash].
«me
 !
NULL
; hash++) {

1133 
ä
 = 
t
;

1134 
t
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_T
);

1135 
t
->
u
.t.
id
 = 
ISAKMP_IPSEC_KEY_IKE
;

1136 
a
 = 
	`make_å™sf‹m_ike
(
dh_gΩ
, 
suµ_¸y±
[
¸y±
].
ike_ß_id
,

1137 
suµ_hash
[
hash
].
ike_ß_id
, 
keyÀn
, 
suµ_auth
[
auth
].ike_sa_id);

1138 
t
->
u
.t.
©åibuãs
 = 
a
;

1139 
t
->
√xt
 = 
ä
;

1143 
i
 = 0, 
ä
 = 
t
;Ån;Å¿ä->
√xt
)

1144 
ä
->
u
.
t
.
numbî
 = 
i
++;

1145 
r
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
 = 
t
;

1146  
r
;

1147 
	}
}

1149 
	$li„time_ike_¥o˚ss
(
ß_block
 *
s
, 
ißkmp_©åibuã
 *
a
)

1151 
uöt32_t
 
vÆue
;

1153 
	`as£π
(
a
 !
NULL
);

1154 
	`as£π
(
a
->
ty≥
 =
IKE_ATTRIB_LIFE_TYPE
);

1155 
	`as£π
(
a
->
af
 =
ißkmp_©å_16
);

1156 
	`as£π
(
a
->
u
.
©å_16
 =
IKE_LIFE_TYPE_SECONDS
 ||á->u.©å_16 =
IKE_LIFE_TYPE_K
);

1157 
	`as£π
(
a
->
√xt
 !
NULL
);

1158 
	`as£π
(
a
->
√xt
->
ty≥
 =
IKE_ATTRIB_LIFE_DURATION
);

1160 i‡(
a
->
√xt
->
af
 =
ißkmp_©å_16
)

1161 
vÆue
 = 
a
->
√xt
->
u
.
©å_16
;

1162 i‡(
a
->
√xt
->
af
 =
ißkmp_©å_lŸs
 &&á->√xt->
u
.
lŸs
.
Àngth
 == 4)

1163 
vÆue
 = 
	`¡ohl
(*((
uöt32_t
 *Ë
a
->
√xt
->
u
.
lŸs
.
d©a
));

1165 
	`as£π
(0);

1167 
	`DEBUG
(2, 
	`¥ötf
("gŸ ikêli„timê©åibuãs: %d %s\n", 
vÆue
,

1168 (
a
->
u
.
©å_16
 =
IKE_LIFE_TYPE_SECONDS
) ? "seconds" : "kilobyte"));

1170 i‡(
a
->
u
.
©å_16
 =
IKE_LIFE_TYPE_SECONDS
)

1171 
s
->
ike
.
li„
.
£c⁄ds
 = 
vÆue
;

1173 
s
->
ike
.
li„
.
kbyãs
 = 
vÆue
;

1174 
	}
}

1176 
	$li„time_ù£c_¥o˚ss
(
ß_block
 *
s
, 
ißkmp_©åibuã
 *
a
)

1178 
uöt32_t
 
vÆue
;

1180 
	`as£π
(
a
 !
NULL
);

1181 
	`as£π
(
a
->
ty≥
 =
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
);

1182 
	`as£π
(
a
->
af
 =
ißkmp_©å_16
);

1183 
	`as£π
(
a
->
u
.
©å_16
 =
IPSEC_LIFE_SECONDS
 ||á->u.©å_16 =
IPSEC_LIFE_K
);

1184 
	`as£π
(
a
->
√xt
 !
NULL
);

1185 
	`as£π
(
a
->
√xt
->
ty≥
 =
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
);

1187 i‡(
a
->
√xt
->
af
 =
ißkmp_©å_16
)

1188 
vÆue
 = 
a
->
√xt
->
u
.
©å_16
;

1189 i‡(
a
->
√xt
->
af
 =
ißkmp_©å_lŸs
 &&á->√xt->
u
.
lŸs
.
Àngth
 == 4)

1190 
vÆue
 = 
	`¡ohl
(*((
uöt32_t
 *Ë
a
->
√xt
->
u
.
lŸs
.
d©a
));

1192 
	`as£π
(0);

1194 
	`DEBUG
(2, 
	`¥ötf
("gŸ ip£¯li„timê©åibuãs: %d %s\n", 
vÆue
,

1195 (
a
->
u
.
©å_16
 =
IPSEC_LIFE_SECONDS
) ? "seconds" : "kilobyte"));

1197 i‡(
a
->
u
.
©å_16
 =
IPSEC_LIFE_SECONDS
)

1198 
s
->
ù£c
.
li„
.
£c⁄ds
 = 
vÆue
;

1200 
s
->
ù£c
.
li„
.
kbyãs
 = 
vÆue
;

1204 i‡(
a
->
√xt
->√xà!
NULL
 &&á->√xt->√xt->
ty≥
 =
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
)

1205 
	`li„time_ù£c_¥o˚ss
(
s
, 
a
->
√xt
->next);

1206 
	}
}

1208 
	$do_pha£1_am
(c⁄° *
key_id
, c⁄° *
sh¨ed_key
, 
ß_block
 *
s
)

1210 
i_n⁄˚
[20];

1211 
group
 *
dh_gΩ
;

1212 *
dh_public
;

1213 *
ªtu∫ed_hash
;

1214 *
psk_hash
;

1216 
ißkmp_∑ckë
 *
p1
;

1217 
ißkmp_∑ckë
 *
r
;

1218 
£í_«â_vid
 = 0, 
£í_«td
 = 0, 
£í_«td_them
 = 0, 
£í_«td_us
 = 0, 
«td_ty≥
 = 0;

1219 *
«td_us
 = 
NULL
, *
«td_them
 = NULL;

1220 
«â_dø·
 = -1;

1221 *
dh_sh¨ed_£¸ë
;

1223 
	`DEBUGTOP
(2, 
	`¥ötf
("S4.1 create_nonce\n"));

1224 
	`g¸y_¸óã_n⁄˚
(
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1225 
s
->
ike
.
li„
.
°¨t
 = 
	`time
(
NULL
);

1226 
s
->
ù£c
.
do_pfs
 = -1;

1227 i‡(
s
->
ike
.
i_cookõ
[0] == 0)

1228 
s
->
ike
.
i_cookõ
[0] = 1;

1229 
	`hex_dump
("i_cookõ", 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
, 
NULL
);

1230 
	`g¸y_¸óã_n⁄˚
(
i_n⁄˚
, (i_nonce));

1231 
	`hex_dump
("i_n⁄˚", 
i_n⁄˚
, (i_n⁄˚), 
NULL
);

1232 
	`DEBUGTOP
(2, 
	`¥ötf
("S4.2 dh setup\n"));

1235 
dh_gΩ
 = 
	`group_gë
(
	`gë_dh_group_ike
()->
my_id
);

1236 
dh_public
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

1237 
	`dh_¸óã_exch™ge
(
dh_gΩ
, 
dh_public
);

1238 
	`hex_dump
("dh_public", 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

1241 
	`DEBUGTOP
(2, 
	`¥ötf
("S4.3 AMÖacket_1\n"));

1244 
ißkmp_∑ylﬂd
 *
l
;

1245 
uöt8_t
 *
pkt
;

1246 
size_t
 
pkt_Àn
;

1248 
p1
 = 
	`√w_ißkmp_∑ckë
();

1249 
	`mem˝y
(
p1
->
i_cookõ
, 
s
->
ike
.i_cookõ, 
ISAKMP_COOKIE_LENGTH
);

1250 
p1
->
ißkmp_vîsi⁄
 = 
ISAKMP_VERSION
;

1251 
p1
->
exch™ge_ty≥
 = 
ISAKMP_EXCHANGE_AGGRESSIVE
;

1252 
p1
->
∑ylﬂd
 = 
l
 = 
	`make_our_ß_ike
();

1253 
l
->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_KE
, 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
));

1254 
l
->
√xt
->√xà
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_NONCE
,

1255 
i_n⁄˚
, (i_nonce));

1256 
l
 =Ü->
√xt
->next;

1257 
l
->
√xt
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_ID
);

1258 
l
 =Ü->
√xt
;

1259 i‡(
›t_víd‹
 =
VENDOR_CISCO
)

1260 
l
->
u
.
id
.
ty≥
 = 
ISAKMP_IPSEC_ID_KEY_ID
;

1262 
l
->
u
.
id
.
ty≥
 = 
ISAKMP_IPSEC_ID_USER_FQDN
;

1263 
l
->
u
.
id
.
¥Ÿocﬁ
 = 
IPPROTO_UDP
;

1264 
l
->
u
.
id
.
p‹t
 = 
ISAKMP_PORT
;

1265 
l
->
u
.
id
.
Àngth
 = 
	`°æí
(
key_id
);

1266 
l
->
u
.
id
.
d©a
 = 
	`xÆlocc
÷->u.id.
Àngth
);

1267 
	`mem˝y
(
l
->
u
.
id
.
d©a
, 
key_id
, 
	`°æí
(key_id));

1268 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1269 
VID_XAUTH
, (VID_XAUTH));

1270 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1271 
VID_UNITY
, (VID_UNITY));

1272 i‡((
›t_«â_mode
 =
NATT_NORMAL
Ë|| (›t_«â_modê=
NATT_FORCE
)) {

1273 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1274 
VID_NATT_RFC
, (VID_NATT_RFC));

1275 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1276 
VID_NATT_02N
, (VID_NATT_02N));

1277 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1278 
VID_NATT_02
, (VID_NATT_02));

1279 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1280 
VID_NATT_01
, (VID_NATT_01));

1281 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1282 
VID_NATT_00
, (VID_NATT_00));

1284 
s
->
ike
.
dpd_idÀ
 = 
	`©oi
(
c⁄fig
[
CONFIG_DPD_IDLE
]);

1285 i‡(
s
->
ike
.
dpd_idÀ
 != 0) {

1286 i‡(
s
->
ike
.
dpd_idÀ
 < 10)

1287 
s
->
ike
.
dpd_idÀ
 = 10;

1288 i‡(
s
->
ike
.
dpd_idÀ
 > 86400)

1289 
s
->
ike
.
dpd_idÀ
 = 86400;

1290 
l
 =Ü->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

1291 
VID_DPD
, (VID_DPD));

1293 
	`Ê©ãn_ißkmp_∑ckë
(
p1
, &
pkt
, &
pkt_Àn
, 0);

1296 
r_Àngth
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
pkt
, 
pkt_Àn
, 0);

1297 
	`‰ì
(
pkt
);

1299 
	`DEBUGTOP
(2, 
	`¥ötf
("S4.4 AM_packet2\n"));

1302 
ªje˘
;

1303 
ißkmp_∑ylﬂd
 *
Ω
;

1304 
ißkmp_∑ylﬂd
 *
n⁄˚
 = 
NULL
;

1305 
ißkmp_∑ylﬂd
 *
ke
 = 
NULL
;

1306 
ißkmp_∑ylﬂd
 *
hash
 = 
NULL
;

1307 
ißkmp_∑ylﬂd
 *
œ°_˚π
 = 
NULL
;

1308 
ißkmp_∑ylﬂd
 *
sig
 = 
NULL
;

1309 
ißkmp_∑ylﬂd
 *
idp
 = 
NULL
;

1310 
£í_ß
 = 0, 
£í_xauth_vid
 = 0;

1311 *
psk_skeyid
;

1312 *
skeyid
;

1313 
g¸y_md_hd_t
 
skeyid_˘x
;

1315 #ifde‡
OPENSSL_GPL_VIOLATION


1316 
X509
 *
cuºít_˚π
;

1318 
	`STACK_OF
(
X509
Ë*
˚π_°ack
 = 
	`sk_X509_√w_nuŒ
();

1321 
ªje˘
 = 0;

1322 
r
 = 
	`∑r£_ißkmp_∑ckë
(
r_∑ckë
, 
r_Àngth
, &
ªje˘
);

1325 i‡(
ªje˘
 =0 && 
	`memcmp
(
r
->
i_cookõ
, 
s
->
ike
.i_cookõ, 
ISAKMP_COOKIE_LENGTH
) != 0)

1326 
ªje˘
 = 
ISAKMP_N_INVALID_COOKIE
;

1327 i‡(
ªje˘
 == 0)

1328 
	`mem˝y
(
s
->
ike
.
r_cookõ
, 
r
->r_cookõ, 
ISAKMP_COOKIE_LENGTH
);

1329 i‡(
ªje˘
 =0 && 
r
->
exch™ge_ty≥
 !
ISAKMP_EXCHANGE_AGGRESSIVE
)

1330 
ªje˘
 = 
ISAKMP_N_INVALID_EXCHANGE_TYPE
;

1331 i‡(
ªje˘
 =0 && 
r
->
Êags
 != 0)

1332 
ªje˘
 = 
ISAKMP_N_INVALID_FLAGS
;

1333 i‡(
ªje˘
 =0 && 
r
->
mesßge_id
 != 0)

1334 
ªje˘
 = 
ISAKMP_N_INVALID_MESSAGE_ID
;

1335 i‡(
ªje˘
 != 0)

1336 
	`îr‹
(1, 0, "ª•⁄£ wa†övÆid [1]: %s(%d)", 
	`vÆ_to_°rög
(
ªje˘
, 
ißkmp_nŸify_íum_¨øy
),Ñeject);

1337 
Ω
 = 
r
->
∑ylﬂd
;Ñ∞&& 
ªje˘
 =0;Ñ∞Ω->
√xt
)

1338 
Ω
->
ty≥
) {

1339 
ISAKMP_PAYLOAD_SA
:

1340 i‡(
ªje˘
 =0 && 
Ω
->
u
.
ß
.
doi
 !
ISAKMP_DOI_IPSEC
)

1341 
ªje˘
 = 
ISAKMP_N_DOI_NOT_SUPPORTED
;

1342 i‡(
ªje˘
 == 0 &&

1343 
Ω
->
u
.
ß
.
sôu©i⁄
 !
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
)

1344 
ªje˘
 = 
ISAKMP_N_SITUATION_NOT_SUPPORTED
;

1345 i‡(
ªje˘
 == 0 &&

1346 (
Ω
->
u
.
ß
.
¥›oßls
 =
NULL


1347 || 
Ω
->
u
.
ß
.
¥›oßls
->
√xt
 !
NULL
))

1348 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1349 i‡(
ªje˘
 == 0 &&

1350 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
¥Ÿ_id
 !=

1351 
ISAKMP_IPSEC_PROTO_ISAKMP
)

1352 
ªje˘
 = 
ISAKMP_N_INVALID_PROTOCOL_ID
;

1353 i‡(
ªje˘
 =0 && 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
•i_size
 != 0)

1354 
ªje˘
 = 
ISAKMP_N_INVALID_SPI
;

1355 i‡(
ªje˘
 == 0 &&

1356 (
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
 =
NULL


1357 || 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->
√xt
 !=

1358 
NULL
))

1359 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1360 i‡(
ªje˘
 == 0 &&

1361 (
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->u.
t
.
id


1362 !
ISAKMP_IPSEC_KEY_IKE
))

1363 
ªje˘
 = 
ISAKMP_N_INVALID_TRANSFORM_ID
;

1364 i‡(
ªje˘
 == 0) {

1365 
ißkmp_©åibuã
 *
a


1367 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->u.
t
.
©åibuãs
;

1368 
£í_íc
 = 0, 
£í_hash
 = 0, 
£í_auth
 = 0;

1369 
£í_group
 = 0, 
£í_keyÀn
 = 0;

1370 ; 
a
 && 
ªje˘
 =0;á =á->
√xt
)

1371 
a
->
ty≥
) {

1372 
IKE_ATTRIB_GROUP_DESC
:

1373 i‡(
a
->
af
 =
ißkmp_©å_16
 &&

1374 
a
->
u
.
©å_16
 ==

1375 
	`gë_dh_group_ike
()->
ike_ß_id
)

1376 
£í_group
 = 1;

1378 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1380 
IKE_ATTRIB_AUTH_METHOD
:

1381 i‡(
a
->
af
 =
ißkmp_©å_16
)

1382 
£í_auth
 = 
a
->
u
.
©å_16
;

1384 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1386 
IKE_ATTRIB_HASH
:

1387 i‡(
a
->
af
 =
ißkmp_©å_16
)

1388 
£í_hash
 = 
a
->
u
.
©å_16
;

1390 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1392 
IKE_ATTRIB_ENC
:

1393 i‡(
a
->
af
 =
ißkmp_©å_16
)

1394 
£í_íc
 = 
a
->
u
.
©å_16
;

1396 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1398 
IKE_ATTRIB_KEY_LENGTH
:

1399 i‡(
a
->
af
 =
ißkmp_©å_16
)

1400 
£í_keyÀn
 = 
a
->
u
.
©å_16
;

1402 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1404 
IKE_ATTRIB_LIFE_TYPE
:

1406 i‡(
a
->
√xt
->
ty≥
 =
IKE_ATTRIB_LIFE_DURATION
) {

1407 
	`li„time_ike_¥o˚ss
(
s
, 
a
);

1409 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1411 
IKE_ATTRIB_LIFE_DURATION
:

1415 
	`DEBUG
(1, 
¥ötf


1417 
a
->
ty≥
));

1418 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

1421 i‡(!
£í_group
 || !
£í_auth
 || !
£í_hash
 || !
£í_íc
)

1422 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

1424 i‡(
	`gë_Ægo
(
SUPP_ALGO_AUTH
, 
SUPP_ALGO_IKE_SA
, 
£í_auth
,

1425 
NULL
, 0) == NULL)

1426 
ªje˘
 = 
ISAKMP_N_NO_PROPOSAL_CHOSEN
;

1427 i‡(
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IKE_SA
, 
£í_hash
,

1428 
NULL
, 0) == NULL)

1429 
ªje˘
 = 
ISAKMP_N_NO_PROPOSAL_CHOSEN
;

1430 i‡(
	`gë_Ægo
(
SUPP_ALGO_CRYPT
, 
SUPP_ALGO_IKE_SA
, 
£í_íc
,

1431 
NULL
, 
£í_keyÀn
) == NULL)

1432 
ªje˘
 = 
ISAKMP_N_NO_PROPOSAL_CHOSEN
;

1434 i‡(
ªje˘
 == 0) {

1435 
£í_ß
 = 1;

1436 
s
->
ike
.
auth_Ægo
 = 
£í_auth
;

1437 
s
->
ike
.
¸y_Ægo
 =

1438 
	`gë_Ægo
(
SUPP_ALGO_CRYPT
, 
SUPP_ALGO_IKE_SA
,

1439 
£í_íc
, 
NULL
, 
£í_keyÀn
)->
my_id
;

1440 
s
->
ike
.
md_Ægo
 =

1441 
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IKE_SA
,

1442 
£í_hash
, 
NULL
, 0)->
my_id
;

1443 
s
->
ike
.
md_Àn
 = 
	`g¸y_md_gë_Ægo_dÀn
(s->ike.
md_Ægo
);

1444 
	`DEBUG
(1, 
	`¥ötf
("IKE SA selected %s-%s-%s\n",

1445 
	`gë_Ægo
(
SUPP_ALGO_AUTH
,

1446 
SUPP_ALGO_IKE_SA
, 
£í_auth
,

1447 
NULL
, 0)->
«me
,

1448 
	`gë_Ægo
(
SUPP_ALGO_CRYPT
,

1449 
SUPP_ALGO_IKE_SA
, 
£í_íc
,

1450 
NULL
, 
£í_keyÀn
)->
«me
,

1451 
	`gë_Ægo
(
SUPP_ALGO_HASH
,

1452 
SUPP_ALGO_IKE_SA
, 
£í_hash
,

1453 
NULL
, 0)->
«me
));

1454 i‡(
s
->
ike
.
¸y_Ægo
 =
GCRY_CIPHER_DES
 && !
›t_1des
) {

1455 
	`îr‹
(1, 0, "peer selected (single) DESás \"encryption\" method.\n"

1464 
ISAKMP_PAYLOAD_ID
:

1465 
idp
 = 
Ω
;

1467 
ISAKMP_PAYLOAD_KE
:

1468 
ke
 = 
Ω
;

1470 
ISAKMP_PAYLOAD_NONCE
:

1471 
n⁄˚
 = 
Ω
;

1473 
ISAKMP_PAYLOAD_HASH
:

1474 
hash
 = 
Ω
;

1476 
ISAKMP_PAYLOAD_CERT
:

1477 
œ°_˚π
 = 
Ω
;

1478 i‡(
œ°_˚π
->
u
.
˚π
.
ícodög
 =
ISAKMP_CERT_X509_SIG
) {

1479 #ifde‡
OPENSSL_GPL_VIOLATION


1481 
cuºít_˚π
 = 
	`d2i_X509
(
NULL
, (c⁄° **)&
œ°_˚π
->
u
.
˚π
.
d©a
,Üa°_˚π->u.˚π.
Àngth
);

1482 
	`sk_X509_push
(
˚π_°ack
, 
cuºít_˚π
);

1483 
œ°_˚π
->
u
.
˚π
.
d©a
 -œ°_˚π->u.˚π.
Àngth
;

1487 
ISAKMP_PAYLOAD_SIG
:

1488 
sig
 = 
Ω
;

1490 
ISAKMP_PAYLOAD_VID
:

1491 i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_XAUTH
)

1492 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_XAUTH
,

1493 (
VID_XAUTH
)) == 0) {

1494 
£í_xauth_vid
 = 1;

1495 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_NATT_RFC
)

1496 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_NATT_RFC
,

1497 (
VID_NATT_RFC
)) == 0) {

1498 
£í_«â_vid
 = 1;

1499 i‡(
«â_dø·
 < 1)Çatt_draft = 2;

1500 
	`DEBUG
(2, 
	`¥ötf
("peer is NAT-T capable (RFC 3947)\n"));

1501 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_NATT_02N
)

1502 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_NATT_02N
,

1503 (
VID_NATT_02N
)) == 0) {

1504 
£í_«â_vid
 = 1;

1505 i‡(
«â_dø·
 < 1)Çatt_draft = 2;

1506 
	`DEBUG
(2, 
	`¥ötf
("peer is NAT-T capable (draft-02)\\n\n"));

1507 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_NATT_02
)

1508 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_NATT_02
,

1509 (
VID_NATT_02
)) == 0) {

1510 
£í_«â_vid
 = 1;

1511 i‡(
«â_dø·
 < 1)Çatt_draft = 2;

1512 
	`DEBUG
(2, 
	`¥ötf
("peer is NAT-T capable (draft-02)\n"));

1513 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_NATT_01
)

1514 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_NATT_01
,

1515 (
VID_NATT_01
)) == 0) {

1516 
£í_«â_vid
 = 1;

1517 i‡(
«â_dø·
 < 1)Çatt_draft = 1;

1518 
	`DEBUG
(2, 
	`¥ötf
("peer is NAT-T capable (draft-01)\n"));

1519 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_NATT_00
)

1520 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_NATT_00
,

1521 (
VID_NATT_00
)) == 0) {

1522 
£í_«â_vid
 = 1;

1523 i‡(
«â_dø·
 < 0)Çatt_draft = 0;

1524 
	`DEBUG
(2, 
	`¥ötf
("peer is NAT-T capable (draft-00)\n"));

1525 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_DPD
)

1526 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_DPD
,

1527 (
VID_DPD
)) == 0) {

1528 i‡(
s
->
ike
.
dpd_idÀ
 != 0) {

1529 
	`g¸y_¸óã_n⁄˚
(&
s
->
ike
.
dpd_£qno
, (s->ike.dpd_seqno));

1530 
s
->
ike
.
dpd_£qno
 &= 0x7FFFFFFF;

1531 
s
->
ike
.
dpd_£qno_ack
 = s->ike.
dpd_£qno
;

1532 
s
->
ike
.
do_dpd
 = 1;

1533 
	`DEBUG
(2, 
	`¥ötf
("peer is DPD capable (RFC3706)\n"));

1535 
	`DEBUG
(2, 
	`¥ötf
("ignoringÅhatÖeer is DPD capable (RFC3706)\n"));

1537 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_NETSCREEN_15
)

1538 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_NETSCREEN_15
,

1539 (
VID_NETSCREEN_15
)) == 0) {

1540 
	`DEBUG
(2, 
	`¥ötf
("peer is using ScreenOS 5.3, 5.4 or 6.0\n"));

1541 } i‡(
Ω
->
u
.
vid
.
Àngth
 =(
VID_HEARTBEAT_NOTIFY
)

1542 && 
	`memcmp
(
Ω
->
u
.
vid
.
d©a
, 
VID_HEARTBEAT_NOTIFY
,

1543 (
VID_HEARTBEAT_NOTIFY
)) == 0) {

1544 
	`DEBUG
(2, 
	`¥ötf
("peer sent Heartbeat NotifyÖayload\n"));

1546 
	`hex_dump
("unknown ISAKMP_PAYLOAD_VID",

1547 
Ω
->
u
.
vid
.
d©a
,Ñp->u.vid.
Àngth
, 
NULL
);

1550 
ISAKMP_PAYLOAD_NAT_D_OLD
:

1551 
ISAKMP_PAYLOAD_NAT_D
:

1552 
«td_ty≥
 = 
Ω
->
ty≥
;

1553 
	`DEBUG
(2, 
	`¥ötf
("peer is usingÅype %d%s for NAT-DiscoveryÖayloads\n",

1554 
«td_ty≥
, 
	`vÆ_to_°rög
“©d_ty≥, 
ißkmp_∑ylﬂd_íum_¨øy
)));

1555 i‡(!
£í_ß
 ) {

1556 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

1557 } i‡(
›t_«â_mode
 =
NATT_NONE
) {

1559 } i‡(
Ω
->
u
.
«td
.
Àngth
 !
s
->
ike
.
md_Àn
) {

1560 
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

1561 } i‡(
£í_«td
 == 0) {

1562 
g¸y_md_hd_t
 
hm
;

1563 
uöt16_t
 
n_d°_p‹t
 = 
	`ht⁄s
(
s
->
ike
.
d°_p‹t
);

1565 
«td_us
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1566 
«td_them
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1567 
	`mem˝y
(
«td_us
, 
Ω
->
u
.
«td
.
d©a
, 
s
->
ike
.
md_Àn
);

1568 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 0);

1569 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1570 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1571 
	`g¸y_md_wrôe
(
hm
, &
s
->
d°
, (
ö_addr
));

1572 
	`g¸y_md_wrôe
(
hm
, &
n_d°_p‹t
, (
uöt16_t
));

1573 
	`g¸y_md_föÆ
(
hm
);

1574 
	`mem˝y
(
«td_them
, 
	`g¸y_md_ªad
(
hm
, 0), 
s
->
ike
.
md_Àn
);

1575 
	`g¸y_md_˛o£
(
hm
);

1576 
£í_«td
 = 1;

1578 i‡(
	`memcmp
(
«td_them
, 
Ω
->
u
.
«td
.
d©a
, 
s
->
ike
.
md_Àn
) == 0)

1579 
£í_«td_them
 = 1;

1583 
	`DEBUG
(1, 
	`¥ötf
("ªje˘ög invÆidÖaylﬂdÅy≥ %d\n", 
Ω
->
ty≥
));

1584 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

1588 i‡(
ªje˘
 == 0) {

1589 
	`g¸y_cùhî_Ægo_öfo
(
s
->
ike
.
¸y_Ægo
, 
GCRYCTL_GET_BLKLEN
, 
NULL
, &(s->ike.
ivÀn
));

1590 
	`g¸y_cùhî_Ægo_öfo
(
s
->
ike
.
¸y_Ægo
, 
GCRYCTL_GET_KEYLEN
, 
NULL
, &(s->ike.
keyÀn
));

1593 i‡(
ªje˘
 =0 && (
ke
 =
NULL
 || ke->
u
.ke.
Àngth
 !
	`dh_gëÀn
(
dh_gΩ
)))

1594 
ªje˘
 = 
ISAKMP_N_INVALID_KEY_INFORMATION
;

1595 i‡(
ªje˘
 =0 && 
n⁄˚
 =
NULL
)

1596 
ªje˘
 = 
ISAKMP_N_INVALID_HASH_INFORMATION
;

1597 i‡(
ªje˘
 != 0)

1598 
	`îr‹
(1, 0, "ª•⁄£ wa†övÆid [2]: %s(%d)", 
	`vÆ_to_°rög
(
ªje˘
, 
ißkmp_nŸify_íum_¨øy
),Ñeject);

1599 i‡(
ªje˘
 =0 && 
idp
 =
NULL
)

1600 
ªje˘
 = 
ISAKMP_N_INVALID_ID_INFORMATION
;

1603 i‡(
ªje˘
 =0 && 
›t_auth_mode
 =
AUTH_MODE_PSK
 && (
hash
 =
NULL
 || hash->
u
.hash.
Àngth
 !
s
->
ike
.
md_Àn
))

1604 
ªje˘
 = 
ISAKMP_N_INVALID_HASH_INFORMATION
;

1605 i‡(
ªje˘
 =0 && 
sig
 =
NULL
 &&

1606 (
›t_auth_mode
 =
AUTH_MODE_CERT
 ||

1607 
›t_auth_mode
 =
AUTH_MODE_HYBRID
))

1608 
ªje˘
 = 
ISAKMP_N_INVALID_SIGNATURE
;

1609 i‡(
ªje˘
 != 0)

1610 
	`îr‹
(1, 0, "ª•⁄£ wa†övÆid [3]: %s(%d)", 
	`vÆ_to_°rög
(
ªje˘
, 
ißkmp_nŸify_íum_¨øy
),Ñeject);

1613 
dh_sh¨ed_£¸ë
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

1614 
	`dh_¸óã_sh¨ed
(
dh_gΩ
, 
dh_sh¨ed_£¸ë
, 
ke
->
u
.ke.
d©a
);

1615 
	`hex_dump
("dh_sh¨ed_£¸ë", 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

1618 
	`g¸y_md_›í
(&
skeyid_˘x
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1619 
	`g¸y_md_£tkey
(
skeyid_˘x
, 
sh¨ed_key
, 
	`°æí
(shared_key));

1620 
	`g¸y_md_wrôe
(
skeyid_˘x
, 
i_n⁄˚
, (i_nonce));

1621 
	`g¸y_md_wrôe
(
skeyid_˘x
, 
n⁄˚
->
u
.n⁄˚.
d©a
,Ç⁄˚->u.n⁄˚.
Àngth
);

1622 
	`g¸y_md_föÆ
(
skeyid_˘x
);

1623 
psk_skeyid
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1624 
	`mem˝y
(
psk_skeyid
, 
	`g¸y_md_ªad
(
skeyid_˘x
, 0), 
s
->
ike
.
md_Àn
);

1625 i‡(
›t_debug
 < 99)

1626 
	`DEBUG
(3, 
	`¥ötf
("(not dumpingÖsk hash)\n"));

1628 
	`hex_dump
("psk_skeyid", 
psk_skeyid
, 
s
->
ike
.
md_Àn
, 
NULL
);

1629 
	`‰ì
(
psk_skeyid
);

1630 
	`g¸y_md_˛o£
(
skeyid_˘x
);

1631 
	`DEBUG
(99, 
	`¥ötf
("sh¨ed-key: %s\n",
sh¨ed_key
));

1634 i‡(
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_PRESHARED
 ||

1635 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_XAUTHInôPªSh¨ed
 ||

1636 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_XAUTHRe•PªSh¨ed
) {

1637 
	`g¸y_md_›í
(&
skeyid_˘x
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1638 
	`g¸y_md_£tkey
(
skeyid_˘x
, 
sh¨ed_key
, 
	`°æí
(shared_key));

1639 
	`g¸y_md_wrôe
(
skeyid_˘x
, 
i_n⁄˚
, (i_nonce));

1640 
	`g¸y_md_wrôe
(
skeyid_˘x
, 
n⁄˚
->
u
.n⁄˚.
d©a
,Ç⁄˚->u.n⁄˚.
Àngth
);

1641 
	`g¸y_md_föÆ
(
skeyid_˘x
);

1642 } i‡(
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_DSS
 ||

1643 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_RSA_SIG
 ||

1644 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_ECDSA_SIG
 ||

1645 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_HybridInôRSA
 ||

1646 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_HybridRe•RSA
 ||

1647 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_HybridInôDSS
 ||

1648 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_HybridRe•DSS
 ||

1649 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_XAUTHInôDSS
 ||

1650 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_XAUTHRe•DSS
 ||

1651 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_XAUTHInôRSA
 ||

1652 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_XAUTHRe•RSA
) {

1653 *
key
;

1654 
key_Àn
;

1655 
key_Àn
 = (
i_n⁄˚
Ë+ 
n⁄˚
->
u
.n⁄˚.
Àngth
;

1656 
key
 = 
	`xÆlocc
(
key_Àn
);

1657 
	`mem˝y
(
key
, 
i_n⁄˚
, (i_nonce));

1658 
	`mem˝y
(
key
 + (
i_n⁄˚
), 
n⁄˚
->
u
.n⁄˚.
d©a
,Ç⁄˚->u.n⁄˚.
Àngth
);

1659 
	`g¸y_md_›í
(&
skeyid_˘x
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1660 
	`g¸y_md_£tkey
(
skeyid_˘x
, 
key
, 
key_Àn
);

1661 
	`g¸y_md_wrôe
(
skeyid_˘x
, 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
));

1662 
	`g¸y_md_föÆ
(
skeyid_˘x
);

1664 
	`îr‹
(1, 0, "SKEYID couldÇot be computed: %s", "the selectedáuthentication method isÇot supported");

1665 
skeyid
 = 
	`g¸y_md_ªad
(
skeyid_˘x
, 0);

1666 
	`hex_dump
("skeyid", 
skeyid
, 
s
->
ike
.
md_Àn
, 
NULL
);

1671 
g¸y_md_hd_t
 
hm
;

1672 *
ex≥˘ed_hash
;

1673 
uöt8_t
 *
ß_f
, *
idi_f
, *
idp_f
;

1674 
size_t
 
ß_size
, 
idi_size
, 
idp_size
;

1675 
ißkmp_∑ylﬂd
 *
ß
, *
idi
;

1677 
ß
 = 
p1
->
∑ylﬂd
;

1678 
idi
 = 
ß
; idi->
ty≥
 !
ISAKMP_PAYLOAD_ID
; idòidi->
√xt
) ;

1679 
	`Ê©ãn_ißkmp_∑ylﬂd
(
ß
, &
ß_f
, &
ß_size
);

1680 
	`Ê©ãn_ißkmp_∑ylﬂd
(
idi
, &
idi_f
, &
idi_size
);

1681 
	`Ê©ãn_ißkmp_∑ylﬂd
(
idp
, &
idp_f
, &
idp_size
);

1683 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1684 
	`g¸y_md_£tkey
(
hm
, 
skeyid
, 
s
->
ike
.
md_Àn
);

1685 
	`g¸y_md_wrôe
(
hm
, 
ke
->
u
.ke.
d©a
, ke->u.ke.
Àngth
);

1686 
	`g¸y_md_wrôe
(
hm
, 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
));

1687 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1688 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1689 
	`g¸y_md_wrôe
(
hm
, 
ß_f
 + 4, 
ß_size
 - 4);

1690 
	`g¸y_md_wrôe
(
hm
, 
idp_f
 + 4, 
idp_size
 - 4);

1691 
	`g¸y_md_föÆ
(
hm
);

1692 
ex≥˘ed_hash
 = 
	`g¸y_md_ªad
(
hm
, 0);

1693 
	`hex_dump
("ex≥˘ed hash", 
ex≥˘ed_hash
, 
s
->
ike
.
md_Àn
, 
NULL
);

1695 i‡(
›t_auth_mode
 =
AUTH_MODE_PSK
) {

1696 i‡(
	`memcmp
(
ex≥˘ed_hash
, 
hash
->
u
.hash.
d©a
, 
s
->
ike
.
md_Àn
) != 0)

1697 
	`îr‹
(2, 0, "hash comparison failed: %s(%d)\ncheck groupÖassword!",

1698 
	`vÆ_to_°rög
(
ISAKMP_N_AUTHENTICATION_FAILED
, 
ißkmp_nŸify_íum_¨øy
),

1699 
ISAKMP_N_AUTHENTICATION_FAILED
);

1700 
	`hex_dump
("ª˚ived hash", 
hash
->
u
.hash.
d©a
, hash->u.hash.
Àngth
, 
NULL
);

1701 } i‡(
›t_auth_mode
 =
AUTH_MODE_CERT
 ||

1702 
›t_auth_mode
 =
AUTH_MODE_HYBRID
) {

1703 #ifde‡
OPENSSL_GPL_VIOLATION


1707 
X509
 *
x509
;

1708 
EVP_PKEY
 *
pkey
;

1709 
RSA
 *
rß
;

1710 
X509_STORE
 *
°‹e
;

1712 
X509_STORE_CTX
 *
vîify_˘x
;

1713 *
ªc_hash
;

1714 
de¸_size
;

1716 
	`hex_dump
("ª˚ived sig«tuª", 
sig
->
u
.sig.
d©a
, sig->u.sig.
Àngth
, 
NULL
);

1717 
	`O≥nSSL_add_Æl_cùhîs
();

1718 
	`O≥nSSL_add_Æl_dige°s
();

1719 
	`O≥nSSL_add_Æl_Æg‹ôhms
();

1721 
	`ERR_lﬂd_¸y±o_°rögs
();

1723 
	`hex_dump
("œ° cît", 
œ°_˚π
->
u
.
˚π
.
d©a
,Üa°_˚π->u.˚π.
Àngth
, 
NULL
);

1724 
x509
 = 
	`d2i_X509
(
NULL
, (c⁄° **)&
œ°_˚π
->
u
.
˚π
.
d©a
,Üa°_˚π->u.˚π.
Àngth
);

1725 i‡(
x509
 =
NULL
) {

1726 
	`ERR_¥öt_îr‹s_Â
 (
°dîr
);

1727 
	`îr‹
(1, 0, "x509Érror\n");

1729 
	`DEBUG
(3, 
	`¥ötf
("Subje˘Çamêhash: %08lx\n",
	`X509_subje˘_«me_hash
(
x509
)));

1733 i‡(!(
°‹e
 = 
	`X509_STORE_√w
())) {

1734 
	`îr‹
(1, 0, "Error creating X509_STORE object\n");

1737 i‡(
	`X509_STORE_lﬂd_loˇti⁄s
 (
°‹e
, 
c⁄fig
[
CONFIG_CA_FILE
], c⁄fig[
CONFIG_CA_DIR
]) != 1) {

1738 
	`îr‹
(1, 0, "ErrorÜoadingÅhe CA file or directory\n");

1740 i‡(
	`X509_STORE_£t_deÁu…_∑ths
 (
°‹e
) != 1) {

1741 
	`îr‹
(1, 0, "ErrorÜoadingÅhe system-wide CA certificates\n");

1747 
	#CRL_FILE
 "roŸ-ˇ-¸l.¸l.≥m"

	)

1749 i‡(!(
lookup
 = 
	`X509_STORE_add_lookup
(
°‹e
, 
	`X509_LOOKUP_fûe
()))) {

1750 
	`îr‹
(1, 0, "Error creating X509Üookup object.\n");

1752 i‡(
	`X509_lﬂd_¸l_fûe
(
lookup
, 
CRL_FILE
, 
X509_FILETYPE_PEM
) != 1) {

1753 
	`ERR_¥öt_îr‹s_Â
(
°dîr
);

1754 
	`îr‹
(1, 0, "ErrorÑeading CRL file\n");

1756 
	`X509_STORE_£t_Êags
(
°‹e
, 
X509_V_FLAG_CRL_CHECK
 | 
X509_V_FLAG_CRL_CHECK_ALL
);

1759 i‡(!(
vîify_˘x
 = 
	`X509_STORE_CTX_√w
 ())) {

1760 
	`îr‹
(1, 0, "Error creating X509_STORE_CTX object\n");

1764 i‡(
	`X509_STORE_CTX_öô
 (
vîify_˘x
, 
°‹e
, 
x509
, 
˚π_°ack
) != 1)

1765 
	`¥ötf
("Error intializing verification context\n");

1768 i‡(
	`X509_vîify_˚π
(
vîify_˘x
) != 1) {

1769 
	`ERR_¥öt_îr‹s_Â
(
°dîr
);

1770 
	`îr‹
(2, 0, "Error verifyingÅhe certificate-chain\n");

1772 
	`DEBUG
(3, 
	`¥ötf
("Certificate-chain verified correctly!\n"));

1778 
pkey
 = 
	`X509_gë_pubkey
(
x509
);

1779 i‡(
pkey
 =
NULL
) {

1780 
	`ERR_¥öt_îr‹s_Â
 (
°dîr
);

1781 
	`exô
 (1);

1784 
rß
 = 
	`EVP_PKEY_gë1_RSA
(
pkey
);

1785 i‡(
rß
 =
NULL
) {

1786 
	`ERR_¥öt_îr‹s_Â
 (
°dîr
);

1787 
	`exô
 (1);

1789 
ªc_hash
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1790 
de¸_size
 = 
	`RSA_public_de¸y±
(
sig
->
u
.sig.
Àngth
, sig->u.sig.
d©a
, 
ªc_hash
, 
rß
, 
RSA_PKCS1_PADDING
);

1792 i‡(
de¸_size
 !(Ë
s
->
ike
.
md_Àn
) {

1793 
	`¥ötf
("De¸y±ed-Size: %d\n",
de¸_size
);

1794 
	`hex_dump
(" de¸_hash", 
ªc_hash
, 
de¸_size
, 
NULL
);

1795 
	`hex_dump
("ex≥˘ed hash", 
ex≥˘ed_hash
, 
s
->
ike
.
md_Àn
, 
NULL
);

1797 
	`îr‹
(2, 0, "The hash-value, which was decrypted fromÅheÑeceived signature,ándÅheÉxpected hash-value differ in size.\n");

1799 i‡(
	`memcmp
(
ªc_hash
, 
ex≥˘ed_hash
, 
de¸_size
) != 0) {

1800 
	`¥ötf
("De¸y±ed-Size: %d\n",
de¸_size
);

1801 
	`hex_dump
(" de¸_hash", 
ªc_hash
, 
de¸_size
, 
NULL
);

1802 
	`hex_dump
("ex≥˘ed hash", 
ex≥˘ed_hash
, 
s
->
ike
.
md_Àn
, 
NULL
);

1804 
	`îr‹
(2, 0, "The hash-value, which was decrypted fromÅheÑeceived signature,ándÅheÉxpected hash-value differ.\n");

1806 
	`DEBUG
(3, 
	`¥ötf
("Signature MATCH!!\n"));

1811 
	`EVP_PKEY_‰ì
(
pkey
);

1812 
	`‰ì
(
ªc_hash
);

1818 
	`g¸y_md_˛o£
(
hm
);

1820 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1821 
	`g¸y_md_£tkey
(
hm
, 
skeyid
, 
s
->
ike
.
md_Àn
);

1822 
	`g¸y_md_wrôe
(
hm
, 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
));

1823 
	`g¸y_md_wrôe
(
hm
, 
ke
->
u
.ke.
d©a
, ke->u.ke.
Àngth
);

1824 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1825 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1826 
	`g¸y_md_wrôe
(
hm
, 
ß_f
 + 4, 
ß_size
 - 4);

1827 
	`g¸y_md_wrôe
(
hm
, 
idi_f
 + 4, 
idi_size
 - 4);

1828 
	`g¸y_md_föÆ
(
hm
);

1829 
ªtu∫ed_hash
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1830 
	`mem˝y
(
ªtu∫ed_hash
, 
	`g¸y_md_ªad
(
hm
, 0), 
s
->
ike
.
md_Àn
);

1831 
	`g¸y_md_˛o£
(
hm
);

1832 
	`hex_dump
("ªtu∫ed_hash", 
ªtu∫ed_hash
, 
s
->
ike
.
md_Àn
, 
NULL
);

1835 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1836 
	`g¸y_md_£tkey
(
hm
, 
skeyid
, 
s
->
ike
.
md_Àn
);

1837 
	`g¸y_md_wrôe
(
hm
, 
sh¨ed_key
, 
	`°æí
(shared_key));

1838 
	`g¸y_md_föÆ
(
hm
);

1839 
psk_hash
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1840 
	`mem˝y
(
psk_hash
, 
	`g¸y_md_ªad
(
hm
, 0), 
s
->
ike
.
md_Àn
);

1841 
	`g¸y_md_˛o£
(
hm
);

1842 
	`hex_dump
("psk_hash", 
psk_hash
, 
s
->
ike
.
md_Àn
, 
NULL
);

1845 
	`‰ì
(
ß_f
);

1846 
	`‰ì
(
idi_f
);

1847 
	`‰ì
(
idp_f
);

1852 
g¸y_md_hd_t
 
hm
;

1853 
i
;

1854 c⁄° 
c012
[3] = { 0, 1, 2 };

1855 *
skeyid_e
;

1856 *
dh_sh¨ed_£¸ë
;

1859 
dh_sh¨ed_£¸ë
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

1860 
	`dh_¸óã_sh¨ed
(
dh_gΩ
, 
dh_sh¨ed_£¸ë
, 
ke
->
u
.ke.
d©a
);

1861 
	`hex_dump
("dh_sh¨ed_£¸ë", 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

1863 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1864 
	`g¸y_md_£tkey
(
hm
, 
skeyid
, 
s
->
ike
.
md_Àn
);

1865 
	`g¸y_md_wrôe
(
hm
, 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
));

1866 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1867 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1868 
	`g¸y_md_wrôe
(
hm
, 
c012
 + 0, 1);

1869 
	`g¸y_md_föÆ
(
hm
);

1870 i‡(
s
->
ike
.
skeyid_d
Ë
	`‰ì
(s->ike.skeyid_d);

1871 
s
->
ike
.
skeyid_d
 = 
	`xÆlocc
(s->ike.
md_Àn
);

1872 
	`mem˝y
(
s
->
ike
.
skeyid_d
, 
	`g¸y_md_ªad
(
hm
, 0), s->ike.
md_Àn
);

1873 
	`g¸y_md_˛o£
(
hm
);

1874 
	`hex_dump
("skeyid_d", 
s
->
ike
.
skeyid_d
, s->ike.
md_Àn
, 
NULL
);

1876 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1877 
	`g¸y_md_£tkey
(
hm
, 
skeyid
, 
s
->
ike
.
md_Àn
);

1878 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
skeyid_d
, s->ike.
md_Àn
);

1879 
	`g¸y_md_wrôe
(
hm
, 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
));

1880 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1881 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1882 
	`g¸y_md_wrôe
(
hm
, 
c012
 + 1, 1);

1883 
	`g¸y_md_föÆ
(
hm
);

1884 i‡(
s
->
ike
.
skeyid_a
Ë
	`‰ì
(s->ike.skeyid_a);

1885 
s
->
ike
.
skeyid_a
 = 
	`xÆlocc
(s->ike.
md_Àn
);

1886 
	`mem˝y
(
s
->
ike
.
skeyid_a
, 
	`g¸y_md_ªad
(
hm
, 0), s->ike.
md_Àn
);

1887 
	`g¸y_md_˛o£
(
hm
);

1888 
	`hex_dump
("skeyid_a", 
s
->
ike
.
skeyid_a
, s->ike.
md_Àn
, 
NULL
);

1890 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1891 
	`g¸y_md_£tkey
(
hm
, 
skeyid
, 
s
->
ike
.
md_Àn
);

1892 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
skeyid_a
, s->ike.
md_Àn
);

1893 
	`g¸y_md_wrôe
(
hm
, 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
));

1894 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1895 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

1896 
	`g¸y_md_wrôe
(
hm
, 
c012
 + 2, 1);

1897 
	`g¸y_md_föÆ
(
hm
);

1898 
skeyid_e
 = 
	`xÆlocc
(
s
->
ike
.
md_Àn
);

1899 
	`mem˝y
(
skeyid_e
, 
	`g¸y_md_ªad
(
hm
, 0), 
s
->
ike
.
md_Àn
);

1900 
	`g¸y_md_˛o£
(
hm
);

1901 
	`hex_dump
("skeyid_e", 
skeyid_e
, 
s
->
ike
.
md_Àn
, 
NULL
);

1903 
	`mem£t
(
dh_sh¨ed_£¸ë
, 0, (dh_shared_secret));

1904 
	`‰ì
(
dh_sh¨ed_£¸ë
);

1907 i‡(
s
->
ike
.
key
Ë
	`‰ì
(s->ike.key);

1908 
s
->
ike
.
key
 = 
	`xÆlocc
(s->ike.
keyÀn
);

1910 i‡(
s
->
ike
.
keyÀn
 > s->ike.
md_Àn
) {

1911 
i
 = 0; i * 
s
->
ike
.
md_Àn
 < s->ike.
keyÀn
; i++) {

1912 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 
GCRY_MD_FLAG_HMAC
);

1913 
	`g¸y_md_£tkey
(
hm
, 
skeyid_e
, 
s
->
ike
.
md_Àn
);

1914 i‡(
i
 == 0)

1915 
	`g¸y_md_wrôe
(
hm
, "" , 1);

1917 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
key
 + (
i
 - 1Ë* s->ike.
md_Àn
,

1918 
s
->
ike
.
md_Àn
);

1919 
	`g¸y_md_föÆ
(
hm
);

1920 
	`mem˝y
(
s
->
ike
.
key
 + 
i
 * s->ike.
md_Àn
, 
	`g¸y_md_ªad
(
hm
, 0),

1921 
	`mö
(
s
->
ike
.
md_Àn
, s->ike.
keyÀn
 - 
i
 * s->ike.md_len));

1922 
	`g¸y_md_˛o£
(
hm
);

1925 
	`mem˝y
(
s
->
ike
.
key
, 
skeyid_e
, s->ike.
keyÀn
);

1927 
	`hex_dump
("íc-key", 
s
->
ike
.
key
, s->ike.
keyÀn
, 
NULL
);

1929 
	`mem£t
(
skeyid_e
, 0, 
s
->
ike
.
md_Àn
);

1930 
	`‰ì
(
skeyid_e
);

1935 
g¸y_md_hd_t
 
hm
;

1937 
	`as£π
(
s
->
ike
.
ivÀn
 <s->ike.
md_Àn
);

1938 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 0);

1939 
	`g¸y_md_wrôe
(
hm
, 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
));

1940 
	`g¸y_md_wrôe
(
hm
, 
ke
->
u
.ke.
d©a
, ke->u.ke.
Àngth
);

1941 
	`g¸y_md_föÆ
(
hm
);

1942 i‡(
s
->
ike
.
cuºít_iv
Ë
	`‰ì
(s->ike.current_iv);

1943 
s
->
ike
.
cuºít_iv
 = 
	`xÆlocc
(s->ike.
ivÀn
);

1944 
	`mem˝y
(
s
->
ike
.
cuºít_iv
, 
	`g¸y_md_ªad
(
hm
, 0), s->ike.
ivÀn
);

1945 
	`g¸y_md_˛o£
(
hm
);

1946 
	`hex_dump
("cuºít_iv", 
s
->
ike
.
cuºít_iv
, s->ike.
ivÀn
, 
NULL
);

1947 
	`mem£t
(
s
->
ike
.
cuºít_iv_msgid
, 0, 4);

1950 
	`g¸y_md_˛o£
(
skeyid_˘x
);

1953 
	`DEBUGTOP
(2, 
	`¥ötf
("S4.5 AM_packet3\n"));

1956 
ißkmp_∑ckë
 *
p2
;

1957 
uöt8_t
 *
p2kt
;

1958 
size_t
 
p2kt_Àn
;

1959 
ißkmp_∑ylﬂd
 *
∂
;

1961 #ifde‡
OPENSSL_GPL_VIOLATION


1962 
ißkmp_∑ylﬂd
 *
œ°_˚π
 = 
NULL
;

1963 
ißkmp_∑ylﬂd
 *
sig
 = 
NULL
;

1966 
X509
 *
cuºít_˚π
;

1968 
	`STACK_OF
(
X509
Ë*
˚π_°ack
 = 
	`sk_X509_√w_nuŒ
();

1972 
p2
 = 
	`√w_ißkmp_∑ckë
();

1973 
	`mem˝y
(
p2
->
i_cookõ
, 
s
->
ike
.i_cookõ, 
ISAKMP_COOKIE_LENGTH
);

1974 
	`mem˝y
(
p2
->
r_cookõ
, 
s
->
ike
.r_cookõ, 
ISAKMP_COOKIE_LENGTH
);

1975 
p2
->
Êags
 = 
ISAKMP_FLAG_E
;

1976 
p2
->
ißkmp_vîsi⁄
 = 
ISAKMP_VERSION
;

1977 
p2
->
exch™ge_ty≥
 = 
ISAKMP_EXCHANGE_AGGRESSIVE
;

1979 
p2
->
∑ylﬂd
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_HASH
,

1980 
ªtu∫ed_hash
, 
s
->
ike
.
md_Àn
);

1981 
p2
->
∑ylﬂd
->
√xt
 = 
∂
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_N
);

1982 
∂
->
u
.
n
.
doi
 = 
ISAKMP_DOI_IPSEC
;

1983 
∂
->
u
.
n
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

1984 
∂
->
u
.
n
.
ty≥
 = 
ISAKMP_N_IPSEC_INITIAL_CONTACT
;

1985 
∂
->
u
.
n
.
•i_Àngth
 = 2 * 
ISAKMP_COOKIE_LENGTH
;

1986 
∂
->
u
.
n
.
•i
 = 
	`xÆlocc
(2 * 
ISAKMP_COOKIE_LENGTH
);

1987 
	`mem˝y
(
∂
->
u
.
n
.
•i
 + 
ISAKMP_COOKIE_LENGTH
 * 0, 
s
->
ike
.
i_cookõ
, ISAKMP_COOKIE_LENGTH);

1988 
	`mem˝y
(
∂
->
u
.
n
.
•i
 + 
ISAKMP_COOKIE_LENGTH
 * 1, 
s
->
ike
.
r_cookõ
, ISAKMP_COOKIE_LENGTH);

1991 i‡(
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_HybridInôRSA
 ||

1992 
s
->
ike
.
auth_Ægo
 =
IKE_AUTH_HybridInôDSS
) {

1994 
∂
 =Öl->
√xt
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_N
);

1995 
∂
->
u
.
n
.
doi
 = 
ISAKMP_DOI_IPSEC
;

1996 
∂
->
u
.
n
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

1998 
∂
->
u
.
n
.
ty≥
 = 
ISAKMP_N_CISCO_PRESHARED_KEY_HASH
;

1999 
∂
->
u
.
n
.
•i_Àngth
 = 2 * 
ISAKMP_COOKIE_LENGTH
;

2000 
∂
->
u
.
n
.
•i
 = 
	`xÆlocc
(2 * 
ISAKMP_COOKIE_LENGTH
);

2001 
	`mem˝y
(
∂
->
u
.
n
.
•i
 + 
ISAKMP_COOKIE_LENGTH
 * 0,

2002 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

2003 
	`mem˝y
(
∂
->
u
.
n
.
•i
 + 
ISAKMP_COOKIE_LENGTH
 * 1,

2004 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

2005 
∂
->
u
.
n
.
d©a_Àngth
 = 
s
->
ike
.
md_Àn
;

2006 
∂
->
u
.
n
.
d©a
 = 
	`xÆlocc
’l->u.n.
d©a_Àngth
);

2007 
	`mem˝y
(
∂
->
u
.
n
.
d©a
, 
psk_hash
,Öl->u.n.
d©a_Àngth
);

2010 
∂
 =Öl->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

2011 
VID_UNKNOWN
, (VID_UNKNOWN));

2012 
∂
 =Öl->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_VID
,

2013 
VID_UNITY
, (VID_UNITY));

2016 i‡(
£í_«â_vid
) {

2017 
	`as£π
(
«td_ty≥
 != 0);

2018 
∂
 =Öl->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
«td_ty≥
,

2019 
«td_them
, 
s
->
ike
.
md_Àn
);

2022 
g¸y_md_hd_t
 
hm
;

2023 
uöt16_t
 
n_§c_p‹t
 = 
	`ht⁄s
(
s
->
ike
.
§c_p‹t
);

2025 
	`g¸y_md_›í
(&
hm
, 
s
->
ike
.
md_Ægo
, 0);

2026 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
i_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

2027 
	`g¸y_md_wrôe
(
hm
, 
s
->
ike
.
r_cookõ
, 
ISAKMP_COOKIE_LENGTH
);

2028 
	`g¸y_md_wrôe
(
hm
, &
s
->
§c
, (
ö_addr
));

2029 
	`g¸y_md_wrôe
(
hm
, &
n_§c_p‹t
, (
uöt16_t
));

2030 
	`g¸y_md_föÆ
(
hm
);

2031 
∂
 =Öl->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
«td_ty≥
,

2032 
	`g¸y_md_ªad
(
hm
, 0), 
s
->
ike
.
md_Àn
);

2033 i‡(
›t_«â_mode
 =
NATT_FORCE
)

2034 
∂
->
u
.
ke
.
d©a
[0] ^= 1;

2035 i‡(
£í_«td
 && 
	`memcmp
(
«td_us
, 
∂
->
u
.
ke
.
d©a
, 
s
->
ike
.
md_Àn
) == 0)

2036 
£í_«td_us
 = 1;

2037 
	`g¸y_md_˛o£
(
hm
);

2039 i‡(
£í_«td
) {

2040 
	`‰ì
(
«td_us
);

2041 
	`‰ì
(
«td_them
);

2044 i‡(!
£í_«td_us
 || !
£í_«td_them
) {

2045 
	`DEBUG
(1, 
	`¥ötf
("NAT status:ÅhisÉnd behind NAT? %s --ÑemoteÉnd behind NAT? %s\n",

2046 
£í_«td_us
 ? "no" : "YES", 
£í_«td_them
 ? "no" : "YES"));

2047 
«td_ty≥
) {

2048 
ISAKMP_PAYLOAD_NAT_D
:

2049 
s
->
ù£c
.
íˇp_mode
 = 
IPSEC_ENCAP_UDP_TUNNEL
;

2051 
ISAKMP_PAYLOAD_NAT_D_OLD
:

2052 
s
->
ù£c
.
íˇp_mode
 = 
IPSEC_ENCAP_UDP_TUNNEL_OLD
;

2055 
	`ab‹t
();

2057 i‡(
«â_dø·
 >= 2) {

2058 
s
->
ù£c
.
«â_a˘ive_mode
 = 
NATT_ACTIVE_RFC
;

2059 
	`˛o£
(
s
->
ike_fd
);

2060 i‡(
s
->
ike
.
§c_p‹t
 =
ISAKMP_PORT
)

2061 
s
->
ike
.
§c_p‹t
 = 
ISAKMP_PORT_NATT
;

2062 
s
->
ike_fd
 = 
	`make_sockë
(s, s->
ike
.
§c_p‹t
, s->ike.
d°_p‹t
 = 
ISAKMP_PORT_NATT
);

2064 
s
->
ù£c
.
«â_a˘ive_mode
 = 
NATT_ACTIVE_DRAFT_OLD
;

2067 
	`DEBUG
(1, 
	`¥ötf
("NAT status: NAT-T VID seen,Ço NAT device detected\n"));

2070 
	`DEBUG
(1, 
	`¥ötf
("NAT status:Ço NAT-T VID seen\n"));

2074 
	`Ê©ãn_ißkmp_∑ckë
(
p2
, &
p2kt
, &
p2kt_Àn
, 
s
->
ike
.
ivÀn
);

2075 
	`‰ì_ißkmp_∑ckë
(
p2
);

2076 
	`ißkmp_¸y±
(
s
, 
p2kt
, 
p2kt_Àn
, 1);

2078 i‡(
s
->
ike
.
öôül_iv
Ë
	`‰ì
(s->ike.initial_iv);

2079 
s
->
ike
.
öôül_iv
 = 
	`xÆlocc
(s->ike.
ivÀn
);

2080 
	`mem˝y
(
s
->
ike
.
öôül_iv
, s->ike.
cuºít_iv
, s->ike.
ivÀn
);

2081 
	`hex_dump
("öôül_iv", 
s
->
ike
.
öôül_iv
, s->ike.
ivÀn
, 
NULL
);

2084 
r_Àngth
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
p2kt
, 
p2kt_Àn
, 0);

2085 
	`‰ì
(
p2kt
);

2087 
	`DEBUGTOP
(2, 
	`¥ötf
("S4.6 cleanup\n"));

2089 
	`‰ì_ißkmp_∑ckë
(
p1
);

2095 
	`‰ì_ißkmp_∑ckë
(
r
);

2097 
	`‰ì
(
ªtu∫ed_hash
);

2098 
	`‰ì
(
dh_public
);

2099 
	`‰ì
(
dh_sh¨ed_£¸ë
);

2100 
	`‰ì
(
psk_hash
);

2101 
	`group_‰ì
(
dh_gΩ
);

2102 
	}
}

2104 
	$do_pha£2_nŸi˚_check
(
ß_block
 *
s
, 
ißkmp_∑ckë
 **
r_p
)

2106 
ªje˘
 = 0;

2107 
ißkmp_∑ckë
 *
r
;

2110 
ªje˘
 = 
	`u≈ack_vîify_pha£2
(
s
, 
r_∑ckë
, 
r_Àngth
, 
r_p
, 
NULL
, 0);

2111 i‡(
ªje˘
 =
ISAKMP_N_INVALID_COOKIE
) {

2112 
r_Àngth
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
NULL
, 0, 0);

2115 i‡(*
r_p
 =
NULL
) {

2116 
	`as£π
(
ªje˘
 != 0);

2117  
ªje˘
;

2119 
r
 = *
r_p
;

2122 i‡(
r
->
exch™ge_ty≥
 =
ISAKMP_EXCHANGE_INFORMATIONAL
 &&

2123 
r
->
∑ylﬂd
->
√xt
 !
NULL
) {

2124 i‡(
r
->
∑ylﬂd
->
√xt
->
ty≥
 =
ISAKMP_PAYLOAD_N
) {

2125 i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
ty≥
 =
ISAKMP_N_CISCO_LOAD_BALANCE
) {

2127 i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
d©a_Àngth
 != 4)

2128 
	`îr‹
(1, 0, "malformedÜoadbalanceÅarget");

2129 
s
->
d°
 = *(
ö_addr
 *)
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
d©a
;

2130 
s
->
ike
.
d°_p‹t
 = 
ISAKMP_PORT
;

2131 
s
->
ù£c
.
íˇp_mode
 = 
IPSEC_ENCAP_TUNNEL
;

2132 
s
->
ù£c
.
«â_a˘ive_mode
 = 
NATT_ACTIVE_NONE
;

2133 i‡(
s
->
ike
.
§c_p‹t
 =
ISAKMP_PORT_NATT
)

2134 
s
->
ike
.
§c_p‹t
 = 
ISAKMP_PORT
;

2135 
	`˛o£
(
s
->
ike_fd
);

2136 
s
->
ike_fd
 = 
	`make_sockë
(s, s->
ike
.
§c_p‹t
, s->ike.
d°_p‹t
);

2137 
	`DEBUG
(2, 
	`¥ötf
("got ciscoÜoadbalancingÇotice, divertingÅo %s\n",

2138 
	`öë_¡ﬂ
(
s
->
d°
)));

2140 } i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
ty≥
 =
ISAKMP_N_IPSEC_RESPONDER_LIFETIME
) {

2141 i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_ISAKMP
)

2142 
	`li„time_ike_¥o˚ss
(
s
, 
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
©åibuãs
);

2143 i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_IPSEC_ESP
)

2144 
	`li„time_ù£c_¥o˚ss
(
s
, 
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
©åibuãs
);

2146 
	`DEBUG
(2, 
	`¥ötf
("got unknownÜifetimeÇotice, ignoring..\n"));

2147 
r_Àngth
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
NULL
, 0, 0);

2149 } i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
ty≥
 =
ISAKMP_N_IPSEC_INITIAL_CONTACT
) {

2151 
	`DEBUG
(2, 
	`¥ötf
("got initial contactÇotice, ignoring..\n"));

2152 
r_Àngth
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
NULL
, 0, 0);

2156 
	`¥ötf
("receivedÇotice ofÅype %s(%d), giving up\n",

2157 
	`vÆ_to_°rög
(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
ty≥
, 
ißkmp_nŸify_íum_¨øy
),

2158 
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
ty≥
);

2159  
ªje˘
;

2162 i‡(
r
->
∑ylﬂd
->
√xt
->
ty≥
 =
ISAKMP_PAYLOAD_D
) {

2164 
	`DEBUG
(2, 
	`¥ötf
("got delete for old connection, ignoring..\n"));

2165 
r_Àngth
 = 
	`£ndªcv
(
s
, 
r_∑ckë
, ‘_∑ckë), 
NULL
, 0, 0);

2172  
ªje˘
;

2173 
	}
}

2175 
	$do_pha£2_xauth
(
ß_block
 *
s
)

2177 
ißkmp_∑ckë
 *
r
 = 
NULL
;

2178 
lo›cou¡
;

2179 
ªje˘
;

2180 
∑sswd_u£d
 = 0;

2182 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.1 xauth_start\n"));

2184 
lo›cou¡
 = 0;;Üoopcount++) {

2185 
ißkmp_∑ylﬂd
 *
Ω
;

2186 
ißkmp_©åibuã
 *
a
, *
≠
, *
ª∂y_©å
;

2187 
¡›_buf
[32];

2188 
£í_™swî
 = 0;

2190 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.2Çotice_check\n"));

2193 i‡(
r
Ë
	`‰ì_ißkmp_∑ckë
(r);

2194 
r
 = 
NULL
;

2195 
ªje˘
 = 
	`do_pha£2_nŸi˚_check
(
s
, &
r
);

2196 i‡(
ªje˘
 == -1) {

2197 i‡(
r
Ë
	`‰ì_ißkmp_∑ckë
(r);

2201 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.3Åype-is-xauth check\n"));

2203 i‡(
ªje˘
 =0 && 
r
->
exch™ge_ty≥
 !
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
)

2204 
ªje˘
 = 
ISAKMP_N_INVALID_EXCHANGE_TYPE
;

2207 i‡(
ªje˘
 == 0

2208 && (
r
->
∑ylﬂd
->
√xt
 =
NULL


2209 || 
r
->
∑ylﬂd
->
√xt
->√xà!
NULL


2210 || 
r
->
∑ylﬂd
->
√xt
->
ty≥
 !
ISAKMP_PAYLOAD_MODECFG_ATTR
))

2211 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

2213 i‡(
ªje˘
 =0 && 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
ty≥
 =
ISAKMP_MODECFG_CFG_SET
)

2215 i‡(
ªje˘
 =0 && 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
ty≥
 !
ISAKMP_MODECFG_CFG_REQUEST
)

2216 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

2218 i‡(
ªje˘
 != 0)

2219 
	`pha£2_Áèl
(
s
, "ex≥˘ed xauthÖackë;Ñeje˘ed: %s(%d)", 
ªje˘
);

2221 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.4 xauthÅype check\n"));

2222 
a
 = 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
©åibuãs
;

2228 
≠
 = 
a
;á∞&& 
£í_™swî
 =0;á∞≠->
√xt
)

2229 i‡(
≠
->
ty≥
 =
ISAKMP_XAUTH_06_ATTRIB_ANSWER


2230 || 
≠
->
ty≥
 =
ISAKMP_XAUTH_06_ATTRIB_NEXT_PIN


2232 
£í_™swî
 = 1;

2234 
≠
 = 
a
;á∞&& 
ªje˘
 =0;á∞≠->
√xt
)

2235 
≠
->
ty≥
) {

2236 
ISAKMP_XAUTH_06_ATTRIB_TYPE
:

2237 i‡(
≠
->
af
 !
ißkmp_©å_16
 ||áp->
u
.
©å_16
 != 0)

2238 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

2240 
ISAKMP_XAUTH_06_ATTRIB_USER_NAME
:

2241 
ISAKMP_XAUTH_06_ATTRIB_USER_PASSWORD
:

2242 
ISAKMP_XAUTH_06_ATTRIB_PASSCODE
:

2243 
ISAKMP_XAUTH_06_ATTRIB_DOMAIN
:

2244 
ISAKMP_XAUTH_06_ATTRIB_ANSWER
:

2245 
ISAKMP_XAUTH_06_ATTRIB_NEXT_PIN
:

2246 
ISAKMP_XAUTH_ATTRIB_CISCOEXT_VENDOR
:

2248 
ISAKMP_XAUTH_06_ATTRIB_MESSAGE
:

2249 i‡(
›t_debug
 || 
£í_™swî
 || 
c⁄fig
[
CONFIG_XAUTH_INTERACTIVE
]) {

2250 i‡(
≠
->
af
 =
ißkmp_©å_16
)

2251 
	`¥ötf
("%c%c\n", 
≠
->
u
.
©å_16
 >> 8,áp->u.attr_16);

2253 
	`¥ötf
("%.*s%s", 
≠
->
u
.
lŸs
.
Àngth
,áp->u.lŸs.
d©a
,

2254 ((
≠
->
u
.
lŸs
.
d©a


2255 && 
≠
->
u
.
lŸs
.
d©a
[ap->u.

2256 
lŸs
.
Àngth
 - 1] !=

2262 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

2264 i‡(
ªje˘
 != 0)

2265 
	`pha£2_Áèl
(
s
, "xauthÖackë unsuµ‹ãd: %s(%d)", 
ªje˘
);

2267 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.5 do xautháuthentication\n"));

2268 
	`öë_¡›
(
AF_INET
, &
s
->
d°
, 
¡›_buf
, (ntop_buf));

2271 
ª∂y_©å
 = 
NULL
;

2272 
≠
 = 
a
;á∞&& 
ªje˘
 =0;á∞≠->
√xt
)

2273 
≠
->
ty≥
) {

2274 
ISAKMP_XAUTH_06_ATTRIB_DOMAIN
:

2276 
ißkmp_©åibuã
 *
«
;

2277 
«
 = 
	`√w_ißkmp_©åibuã
(
≠
->
ty≥
, 
ª∂y_©å
);

2278 
ª∂y_©å
 = 
«
;

2279 i‡(!
c⁄fig
[
CONFIG_DOMAIN
])

2280 
	`îr‹
(1, 0,

2282 
«
->
u
.
lŸs
.
Àngth
 = 
	`°æí
(
c⁄fig
[
CONFIG_DOMAIN
]);

2283 
«
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
“a->u.lŸs.
Àngth
);

2284 
	`mem˝y
(
«
->
u
.
lŸs
.
d©a
, 
c⁄fig
[
CONFIG_DOMAIN
],

2285 
«
->
u
.
lŸs
.
Àngth
);

2288 
ISAKMP_XAUTH_06_ATTRIB_USER_NAME
:

2290 
ißkmp_©åibuã
 *
«
;

2291 
«
 = 
	`√w_ißkmp_©åibuã
(
≠
->
ty≥
, 
ª∂y_©å
);

2292 
ª∂y_©å
 = 
«
;

2293 
«
->
u
.
lŸs
.
Àngth
 = 
	`°æí
(
c⁄fig
[
CONFIG_XAUTH_USERNAME
]);

2294 
«
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
“a->u.lŸs.
Àngth
);

2295 
	`mem˝y
(
«
->
u
.
lŸs
.
d©a
, 
c⁄fig
[
CONFIG_XAUTH_USERNAME
],

2296 
«
->
u
.
lŸs
.
Àngth
);

2299 
ISAKMP_XAUTH_06_ATTRIB_ANSWER
:

2300 
ISAKMP_XAUTH_06_ATTRIB_USER_PASSWORD
:

2301 
ISAKMP_XAUTH_06_ATTRIB_PASSCODE
:

2302 
ISAKMP_XAUTH_06_ATTRIB_NEXT_PIN
:

2303 i‡(
∑sswd_u£d
 && 
c⁄fig
[
CONFIG_NON_INTERACTIVE
]) {

2304 
ªje˘
 = 
ISAKMP_N_AUTHENTICATION_FAILED
;

2305 
	`pha£2_Áèl
(
s
, "n⁄öãø˘ivêˇn'àªu£Öassw‹d", 
ªje˘
);

2306 
	`îr‹
(2, 0, "authentication unsuccessful");

2307 } i‡(
£í_™swî
 || 
∑sswd_u£d
 || 
c⁄fig
[
CONFIG_XAUTH_INTERACTIVE
]) {

2308 *
∑ss
, *
¥om±
 = 
NULL
;

2309 
ißkmp_©åibuã
 *
«
;

2311 
	`a•rötf
(&
¥om±
, "%s for VPN %s@%s: ",

2312 (
≠
->
ty≥
 =
ISAKMP_XAUTH_06_ATTRIB_ANSWER
) ?

2314 (
≠
->
ty≥
 =
ISAKMP_XAUTH_06_ATTRIB_USER_PASSWORD
) ?

2316 
c⁄fig
[
CONFIG_XAUTH_USERNAME
], 
¡›_buf
);

2317 
∑ss
 = 
	`gë∑ss
(
¥om±
);

2318 
	`‰ì
(
¥om±
);

2320 
«
 = 
	`√w_ißkmp_©åibuã
(
≠
->
ty≥
, 
ª∂y_©å
);

2321 
ª∂y_©å
 = 
«
;

2322 
«
->
u
.
lŸs
.
Àngth
 = 
	`°æí
(
∑ss
);

2323 
«
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
“a->u.lŸs.
Àngth
);

2324 
	`mem˝y
(
«
->
u
.
lŸs
.
d©a
, 
∑ss
,Ça->u.lŸs.
Àngth
);

2325 
	`mem£t
(
∑ss
, 0, 
«
->
u
.
lŸs
.
Àngth
);

2327 
ißkmp_©åibuã
 *
«
;

2328 
«
 = 
	`√w_ißkmp_©åibuã
(
≠
->
ty≥
, 
ª∂y_©å
);

2329 
ª∂y_©å
 = 
«
;

2330 
«
->
u
.
lŸs
.
Àngth
 = 
	`°æí
(
c⁄fig
[
CONFIG_XAUTH_PASSWORD
]);

2331 
«
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
“a->u.lŸs.
Àngth
);

2332 
	`mem˝y
(
«
->
u
.
lŸs
.
d©a
, 
c⁄fig
[
CONFIG_XAUTH_PASSWORD
],

2333 
«
->
u
.
lŸs
.
Àngth
);

2334 
∑sswd_u£d
 = 1;

2342 
Ω
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_MODECFG_ATTR
);

2343 
Ω
->
u
.
modecfg
.
ty≥
 = 
ISAKMP_MODECFG_CFG_REPLY
;

2344 
Ω
->
u
.
modecfg
.
id
 = 
r
->
∑ylﬂd
->
√xt
->u.modecfg.id;

2345 
Ω
->
u
.
modecfg
.
©åibuãs
 = 
ª∂y_©å
;

2346 
	`£ndªcv_pha£2
(
s
, 
Ω
, 
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
,

2347 
r
->
mesßge_id
, 0, 0, 0, 0, 0, 0, 0);

2351 i‡((
›t_víd‹
 =
VENDOR_NETSCREEN
) &&

2352 (
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
ty≥
 =
ISAKMP_MODECFG_CFG_SET
)) {

2353 
ißkmp_©åibuã
 *
a
 = 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
©åibuãs
;

2355 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.5.1 doÇetscreen modecfgÉxtra\n"));

2357 
	`do_c⁄fig_to_ív
(
s
, 
a
);

2359 ; 
a
;á =á->
√xt
)

2360 if(
a
->
af
 =
ißkmp_©å_lŸs
)

2361 
a
->
u
.
lŸs
.
Àngth
 = 0;

2363 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
ty≥
 = 
ISAKMP_MODECFG_CFG_ACK
;

2364 
	`£ndªcv_pha£2
(
s
, 
r
->
∑ylﬂd
->
√xt
,

2365 
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
,

2366 
r
->
mesßge_id
, 0, 0, 0, 0, 0, 0, 0);

2368 
ªje˘
 = 
	`do_pha£2_nŸi˚_check
(
s
, &
r
);

2369 i‡(
ªje˘
 == -1) {

2370 
	`‰ì_ißkmp_∑ckë
(
r
);

2375 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.6Örocess xauthÑesponse\n"));

2378 
ißkmp_©åibuã
 *
a
 = 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
©åibuãs
;

2379 
uöt16_t
 
£t_ªsu…
 = 1;

2381 i‡(
a
 =
NULL


2382 || 
a
->
ty≥
 !
ISAKMP_XAUTH_06_ATTRIB_STATUS


2383 || 
a
->
af
 !
ißkmp_©å_16
 ||á->
√xt
 !
NULL
) {

2384 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

2385 
	`pha£2_Áèl
(
s
, "xauth SETÑe•⁄£Ñeje˘ed: %s(%d)", 
ªje˘
);

2387 
£t_ªsu…
 = 
a
->
u
.
©å_16
;

2391 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
ty≥
 = 
ISAKMP_MODECFG_CFG_ACK
;

2392 
	`£ndªcv_pha£2
(
s
, 
r
->
∑ylﬂd
->
√xt
, 
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
,

2393 
r
->
mesßge_id
, 1, 0, 0, 0, 0, 0, 0);

2394 
r
->
∑ylﬂd
->
√xt
 = 
NULL
;

2395 
	`‰ì_ißkmp_∑ckë
(
r
);

2397 i‡(
£t_ªsu…
 == 0)

2398 
	`îr‹
(2, 0, "authentication unsuccessful");

2400 
	`DEBUGTOP
(2, 
	`¥ötf
("S5.7 xauth done\n"));

2402 
	}
}

2404 
	$do_pha£2_c⁄fig
(
ß_block
 *
s
)

2406 
ißkmp_∑ylﬂd
 *
Ω
;

2407 
ißkmp_©åibuã
 *
a
;

2408 
ißkmp_∑ckë
 *
r
;

2409 
ut¢ame
 
uts
;

2410 
uöt32_t
 
msgid
;

2411 
ªje˘
;

2413 
	`u«me
(&
uts
);

2415 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
msgid
, (msgid));

2416 i‡(
msgid
 == 0)

2417 
msgid
 = 1;

2419 
Ω
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_MODECFG_ATTR
);

2420 
Ω
->
u
.
modecfg
.
ty≥
 = 
ISAKMP_MODECFG_CFG_REQUEST
;

2421 
Ω
->
u
.
modecfg
.
id
 = 20;

2422 
a
 = 
NULL
;

2424 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_APPLICATION_VERSION
,á);

2425 
a
->
u
.
lŸs
.
Àngth
 = 
	`°æí
(
c⁄fig
[
CONFIG_VERSION
]);

2426 
a
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
◊->u.lŸs.
Àngth
);

2427 
	`mem˝y
(
a
->
u
.
lŸs
.
d©a
, 
c⁄fig
[
CONFIG_VERSION
],á->u.lŸs.
Àngth
);

2429 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_DDNS_HOSTNAME
,á);

2430 
a
->
u
.
lŸs
.
Àngth
 = 
	`°æí
(
uts
.
nodíame
);

2431 
a
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
◊->u.lŸs.
Àngth
);

2432 
	`mem˝y
(
a
->
u
.
lŸs
.
d©a
, 
uts
.
nodíame
,á->u.lŸs.
Àngth
);

2434 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_SPLIT_INC
,á);

2435 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_SAVE_PW
,á);

2437 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_BANNER
,á);

2438 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_DO_PFS
,á);

2439 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_FW_TYPE
,á);

2440 
a
->
u
.
lŸs
.
Àngth
 = (
FW_UNKNOWN_TYPEINFO
);

2441 
a
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
◊->u.lŸs.
Àngth
);

2442 
	`mem˝y
(
a
->
u
.
lŸs
.
d©a
, 
FW_UNKNOWN_TYPEINFO
,á->u.lŸs.
Àngth
);

2443 i‡(
›t_«â_mode
 =
NATT_CISCO_UDP
)

2444 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_UDP_ENCAP_PORT
,á);

2445 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_CISCO_DEF_DOMAIN
,á);

2446 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NBNS
,á);

2447 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_DNS
,á);

2448 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_NETMASK
,á);

2449 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_MODECFG_ATTRIB_INTERNAL_IP4_ADDRESS
,á);

2451 
Ω
->
u
.
modecfg
.
©åibuãs
 = 
a
;

2452 
	`DEBUGTOP
(2, 
	`¥ötf
("S6.1Öhase2_config send modecfg\n"));

2453 
	`£ndªcv_pha£2
(
s
, 
Ω
, 
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
, 
msgid
, 0, 0, 0, 0, 0, 0, 0);

2455 
	`DEBUGTOP
(2, 
	`¥ötf
("S6.2Öhase2_configÑeceive modecfg\n"));

2457 
ªje˘
 = 
	`do_pha£2_nŸi˚_check
(
s
, &
r
);

2458 i‡(
ªje˘
 == -1) {

2459 i‡(
r
Ë
	`‰ì_ißkmp_∑ckë
(r);

2464 i‡(
ªje˘
 =0 && 
r
->
mesßge_id
 !
msgid
)

2465 
ªje˘
 = 
ISAKMP_N_INVALID_MESSAGE_ID
;

2466 i‡(
ªje˘
 =0 && 
r
->
exch™ge_ty≥
 !
ISAKMP_EXCHANGE_MODECFG_TRANSACTION
)

2467 
ªje˘
 = 
ISAKMP_N_INVALID_EXCHANGE_TYPE
;

2470 i‡(
ªje˘
 == 0

2471 && (
r
->
∑ylﬂd
->
√xt
 =
NULL


2472 || 
r
->
∑ylﬂd
->
√xt
->√xà!
NULL


2473 || 
r
->
∑ylﬂd
->
√xt
->
ty≥
 !
ISAKMP_PAYLOAD_MODECFG_ATTR


2475 || 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
id
 != 20

2477 || 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
ty≥
 !
ISAKMP_MODECFG_CFG_REPLY
))

2478 
ªje˘
 = 
ISAKMP_N_PAYLOAD_MALFORMED
;

2480 i‡(
ªje˘
 != 0)

2481 
	`pha£2_Áèl
(
s
, "c⁄figuøti⁄Ñe•⁄£Ñeje˘ed: %s(%d)", 
ªje˘
);

2483 i‡(
ªje˘
 == 0)

2484 
ªje˘
 = 
	`do_c⁄fig_to_ív
(
s
, 
r
->
∑ylﬂd
->
√xt
->
u
.
modecfg
.
©åibuãs
);

2486 i‡(
ªje˘
 != 0)

2487 
	`pha£2_Áèl
(
s
, "c⁄figuøti⁄Ñe•⁄£Ñeje˘ed: %s(%d)", 
ªje˘
);

2489 
	`DEBUG
(1, 
	`¥ötf
("gŸáddªs†%s\n", 
	`gëív
("INTERNAL_IP4_ADDRESS")));

2490 
	`‰ì_ißkmp_∑ckë
(
r
);

2492 
	}
}

2494 
ißkmp_©åibuã
 *
	$make_å™sf‹m_ù£c
(
ß_block
 *
s
, 
dh_group
, 
hash
, 
keyÀn
)

2496 
ißkmp_©åibuã
 *
a
 = 
NULL
;

2498 
a
 = 
	`√w_ißkmp_©åibuã
(
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
,á);

2499 
a
->
af
 = 
ißkmp_©å_lŸs
;

2500 
a
->
u
.
lŸs
.
Àngth
 = 4;

2501 
a
->
u
.
lŸs
.
d©a
 = 
	`xÆlocc
◊->u.lŸs.
Àngth
);

2502 *((
uöt32_t
 *Ë
a
->
u
.
lŸs
.
d©a
Ë
	`ht⁄l
(2147483);

2503 
a
 = 
	`√w_ißkmp_©åibuã_16
(
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
, 
IPSEC_LIFE_SECONDS
,á);

2505 i‡(
dh_group
)

2506 
a
 = 
	`√w_ißkmp_©åibuã_16
(
ISAKMP_IPSEC_ATTRIB_GROUP_DESC
, 
dh_group
,á);

2507 
a
 = 
	`√w_ißkmp_©åibuã_16
(
ISAKMP_IPSEC_ATTRIB_AUTH_ALG
, 
hash
,á);

2508 
a
 = 
	`√w_ißkmp_©åibuã_16
(
ISAKMP_IPSEC_ATTRIB_ENCAP_MODE
, 
s
->
ù£c
.
íˇp_mode
,á);

2509 i‡(
keyÀn
 != 0)

2510 
a
 = 
	`√w_ißkmp_©åibuã_16
(
ISAKMP_IPSEC_ATTRIB_KEY_LENGTH
, 
keyÀn
,á);

2512  
a
;

2513 
	}
}

2515 
ißkmp_∑ylﬂd
 *
	$make_our_ß_ù£c
(
ß_block
 *
s
)

2517 
ißkmp_∑ylﬂd
 *
r
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_SA
);

2518 
ißkmp_∑ylﬂd
 *
p
 = 
NULL
, *
≤
;

2519 
ißkmp_©åibuã
 *
a
;

2520 
dh_gΩ
 = 
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
ù£c_ß_id
;

2521 
¸y±
, 
hash
, 
keyÀn
;

2522 
i
;

2524 
r
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_SA
);

2525 
r
->
u
.
ß
.
doi
 = 
ISAKMP_DOI_IPSEC
;

2526 
r
->
u
.
ß
.
sôu©i⁄
 = 
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
;

2527 
r
->
u
.
ß
.
¥›oßls
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_P
);

2528 
r
->
u
.
ß
.
¥›oßls
->u.
p
.
•i_size
 = 4;

2529 
r
->
u
.
ß
.
¥›oßls
->u.
p
.
•i
 = 
	`xÆlocc
(4);

2531 
	`mem˝y
(
r
->
u
.
ß
.
¥›oßls
->u.
p
.
•i
, &
s
->
ù£c
.
rx
.spi, 4);

2532 
r
->
u
.
ß
.
¥›oßls
->u.
p
.
¥Ÿ_id
 = 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
;

2533 
¸y±
 = 0; 
suµ_¸y±
[¸y±].
«me
 !
NULL
; crypt++) {

2534 
keyÀn
 = 
suµ_¸y±
[
¸y±
].keylen;

2535 
hash
 = 0; 
suµ_hash
[hash].
«me
 !
NULL
; hash++) {

2536 
≤
 = 
p
;

2537 
p
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_P
);

2538 
p
->
u
.p.
•i_size
 = 4;

2539 
p
->
u
.p.
•i
 = 
	`xÆlocc
(4);

2541 
	`mem˝y
(
p
->
u
.p.
•i
, &
s
->
ù£c
.
rx
.spi, 4);

2542 
p
->
u
.p.
¥Ÿ_id
 = 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
;

2543 
p
->
u
.p.
å™sf‹ms
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_T
);

2544 
p
->
u
.p.
å™sf‹ms
->u.
t
.
id
 = 
suµ_¸y±
[
¸y±
].
ù£c_ß_id
;

2545 
a
 = 
	`make_å™sf‹m_ù£c
(
s
, 
dh_gΩ
, 
suµ_hash
[
hash
].
ù£c_ß_id
, 
keyÀn
);

2546 
p
->
u
.p.
å™sf‹ms
->u.
t
.
©åibuãs
 = 
a
;

2547 
p
->
√xt
 = 
≤
;

2550 
i
 = 0, 
≤
 = 
p
;Ön;Ö¿≤->
√xt
)

2551 
≤
->
u
.
p
.
numbî
 = 
i
++;

2552 
r
->
u
.
ß
.
¥›oßls
 = 
p
;

2553  
r
;

2554 
	}
}

2556 
	$do_pha£2_qm
(
ß_block
 *
s
)

2558 
ißkmp_∑ylﬂd
 *
Ω
, *
us
, *
ke
 = 
NULL
, *
them
, *
n⁄˚_r
 = NULL;

2559 
ißkmp_∑ckë
 *
r
;

2560 
group
 *
dh_gΩ
 = 
NULL
;

2561 
uöt32_t
 
msgid
;

2562 
ªje˘
;

2563 
uöt8_t
 *
p_Ê©
 = 
NULL
, *
ªÆiv
 = NULL, 
ªÆiv_msgid
[4];

2564 
size_t
 
p_size
 = 0;

2565 
uöt8_t
 
n⁄˚_i
[20], *
dh_public
 = 
NULL
;

2566 
i
;

2568 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.1 QM_packet1\n"));

2570 i‡(
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
my_id
) {

2571 
dh_gΩ
 = 
	`group_gë
(
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
my_id
);

2572 
	`DEBUG
(3, 
	`¥ötf
("À¿%d\n", 
	`dh_gëÀn
(
dh_gΩ
)));

2573 
dh_public
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

2574 
	`dh_¸óã_exch™ge
(
dh_gΩ
, 
dh_public
);

2575 
	`hex_dump
("dh_public", 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

2578 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
s
->
ù£c
.
rx
.
•i
, (s->ipsec.rx.spi));

2579 
Ω
 = 
	`make_our_ß_ù£c
(
s
);

2580 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë
n⁄˚_i
, (nonce_i));

2581 
Ω
->
√xt
 = 
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_NONCE
, 
n⁄˚_i
, (nonce_i));

2583 
us
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_ID
);

2584 
us
->
u
.
id
.
ty≥
 = 
ISAKMP_IPSEC_ID_IPV4_ADDR
;

2585 
us
->
u
.
id
.
Àngth
 = 4;

2586 
us
->
u
.
id
.
d©a
 = 
	`xÆlocc
(4);

2587 
	`mem˝y
(
us
->
u
.
id
.
d©a
, 
s
->
our_addªss
, (
ö_addr
));

2588 
them
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_ID
);

2589 
them
->
u
.
id
.
ty≥
 = 
ISAKMP_IPSEC_ID_IPV4_ADDR_SUBNET
;

2590 
them
->
u
.
id
.
Àngth
 = 8;

2591 
them
->
u
.
id
.
d©a
 = 
	`xÆlocc
(8);

2592 
	`öô_√èddr
((
ö_addr
 *)
them
->
u
.
id
.
d©a
,

2593 
c⁄fig
[
CONFIG_IPSEC_TARGET_NETWORK
]);

2594 
us
->
√xt
 = 
them
;

2595 
s
->
ù£c
.
li„
.
°¨t
 = 
	`time
(
NULL
);

2597 i‡(!
dh_gΩ
) {

2598 
Ω
->
√xt
->√xà
us
;

2600 
Ω
->
√xt
->√xà
	`√w_ißkmp_d©a_∑ylﬂd
(
ISAKMP_PAYLOAD_KE
,

2601 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
));

2602 
Ω
->
√xt
->√xt->√xà
us
;

2605 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
msgid
, (msgid));

2606 i‡(
msgid
 == 0)

2607 
msgid
 = 1;

2609 
i
 = 0; i < 4; i++) {

2610 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.2 QM_packet2 send_receive\n"));

2611 
	`£ndªcv_pha£2
(
s
, 
Ω
, 
ISAKMP_EXCHANGE_IKE_QUICK
,

2612 
msgid
, 0, &
p_Ê©
, &
p_size
, 0, 0, 0, 0);

2614 i‡(
ªÆiv
 =
NULL
) {

2615 
ªÆiv
 = 
	`xÆlocc
(
s
->
ike
.
ivÀn
);

2616 
	`mem˝y
(
ªÆiv
, 
s
->
ike
.
cuºít_iv
, s->ike.
ivÀn
);

2617 
	`mem˝y
(
ªÆiv_msgid
, 
s
->
ike
.
cuºít_iv_msgid
, 4);

2620 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.3 QM_packet2 validateÅype\n"));

2621 
ªje˘
 = 
	`u≈ack_vîify_pha£2
(
s
, 
r_∑ckë
, 
r_Àngth
, &
r
, 
n⁄˚_i
, (nonce_i));

2623 i‡(((
ªje˘
 =0Ë|| (ªje˘ =
ISAKMP_N_AUTHENTICATION_FAILED
))

2624 && 
r
->
exch™ge_ty≥
 =
ISAKMP_EXCHANGE_INFORMATIONAL
) {

2625 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.4Örocessánd skipÜifetimeÇotice\n"));

2628 i‡(
ªje˘
 =0 && 
r
->
∑ylﬂd
->
√xt
->
ty≥
 !
ISAKMP_PAYLOAD_N
)

2629 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

2631 i‡(
ªje˘
 == 0

2632 && 
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
ty≥
 =
ISAKMP_N_IPSEC_RESPONDER_LIFETIME
) {

2633 i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_ISAKMP
)

2634 
	`li„time_ike_¥o˚ss
(
s
, 
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
©åibuãs
);

2635 i‡(
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_IPSEC_ESP
)

2636 
	`li„time_ù£c_¥o˚ss
(
s
, 
r
->
∑ylﬂd
->
√xt
->
u
.
n
.
©åibuãs
);

2638 
	`DEBUG
(2, 
	`¥ötf
("got unknownÜifetimeÇotice, ignoring..\n"));

2639 
	`mem˝y
(
s
->
ike
.
cuºít_iv
, 
ªÆiv
, s->ike.
ivÀn
);

2640 
	`mem˝y
(
s
->
ike
.
cuºít_iv_msgid
, 
ªÆiv_msgid
, 4);

2646 i‡(
ªje˘
 =0 && 
r
->
mesßge_id
 !
msgid
)

2647 
ªje˘
 = 
ISAKMP_N_INVALID_MESSAGE_ID
;

2649 i‡(
ªje˘
 =0 && 
r
->
exch™ge_ty≥
 !
ISAKMP_EXCHANGE_IKE_QUICK
)

2650 
ªje˘
 = 
ISAKMP_N_INVALID_EXCHANGE_TYPE
;

2653 i‡(
ªje˘
 =0 && 
r
->
∑ylﬂd
->
√xt
->
ty≥
 !
ISAKMP_PAYLOAD_SA
)

2654 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

2656 
	`‰ì
(
p_Ê©
);

2657 
	`‰ì
(
ªÆiv
);

2662 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.5 QM_packet2 checkÑeject offer\n"));

2663 i‡(
ªje˘
 != 0)

2664 
	`pha£2_Áèl
(
s
, "quick modeÑesponseÑejected: %s(%d)\n"

2675 
ªje˘
);

2677 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.6 QM_packet2 checkándÖrocessÖroposal\n"));

2678 
Ω
 = 
r
->
∑ylﬂd
->
√xt
;Ñ∞&& 
ªje˘
 == 0;Ñp =Ñp->next)

2679 
Ω
->
ty≥
) {

2680 
ISAKMP_PAYLOAD_SA
:

2681 i‡(
ªje˘
 =0 && 
Ω
->
u
.
ß
.
doi
 !
ISAKMP_DOI_IPSEC
)

2682 
ªje˘
 = 
ISAKMP_N_DOI_NOT_SUPPORTED
;

2683 i‡(
ªje˘
 =0 && 
Ω
->
u
.
ß
.
sôu©i⁄
 !
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
)

2684 
ªje˘
 = 
ISAKMP_N_SITUATION_NOT_SUPPORTED
;

2685 i‡(
ªje˘
 == 0 &&

2686 (
Ω
->
u
.
ß
.
¥›oßls
 =
NULL
 ||Ñp->u.ß.¥›oßls->
√xt
 != NULL))

2687 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2688 i‡(
ªje˘
 == 0 &&

2689 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
¥Ÿ_id
 !
ISAKMP_IPSEC_PROTO_IPSEC_ESP
)

2690 
ªje˘
 = 
ISAKMP_N_INVALID_PROTOCOL_ID
;

2691 i‡(
ªje˘
 =0 && 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
•i_size
 != 4)

2692 
ªje˘
 = 
ISAKMP_N_INVALID_SPI
;

2693 i‡(
ªje˘
 == 0 &&

2694 (
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
 =
NULL


2695 || 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->
√xt
 !
NULL
))

2696 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2697 i‡(
ªje˘
 == 0) {

2698 
ißkmp_©åibuã
 *
a


2699 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->u.
t
.
©åibuãs
;

2700 
£í_íc
 = 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->u.
t
.
id
;

2701 
£í_auth
 = 0, 
£í_íˇp
 = 0, 
£í_group
 = 0, 
£í_keyÀn
 = 0;

2703 
	`mem˝y
(&
s
->
ù£c
.
tx
.
•i
, 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.spi, 4);

2705 ; 
a
 && 
ªje˘
 =0;á =á->
√xt
)

2706 
a
->
ty≥
) {

2707 
ISAKMP_IPSEC_ATTRIB_AUTH_ALG
:

2708 i‡(
a
->
af
 =
ißkmp_©å_16
)

2709 
£í_auth
 = 
a
->
u
.
©å_16
;

2711 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2713 
ISAKMP_IPSEC_ATTRIB_ENCAP_MODE
:

2714 i‡(
a
->
af
 =
ißkmp_©å_16
 &&

2715 
a
->
u
.
©å_16
 =
s
->
ù£c
.
íˇp_mode
)

2716 
£í_íˇp
 = 1;

2718 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2720 
ISAKMP_IPSEC_ATTRIB_GROUP_DESC
:

2721 i‡(
dh_gΩ
 &&

2722 
a
->
af
 =
ißkmp_©å_16
 &&

2723 
a
->
u
.
©å_16
 ==

2724 
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
ù£c_ß_id
)

2725 
£í_group
 = 1;

2727 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2729 
ISAKMP_IPSEC_ATTRIB_KEY_LENGTH
:

2730 i‡(
a
->
af
 =
ißkmp_©å_16
)

2731 
£í_keyÀn
 = 
a
->
u
.
©å_16
;

2733 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2735 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
:

2737 i‡(
a
->
√xt
->
ty≥
 =
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
) {

2738 
	`li„time_ù£c_¥o˚ss
(
s
, 
a
);

2740 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2742 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
:

2746 
ªje˘
 = 
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

2749 i‡(
ªje˘
 =0 && (!
£í_auth
 || !
£í_íˇp
 ||

2750 (
dh_gΩ
 && !
£í_group
)))

2751 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2753 i‡(
ªje˘
 == 0

2754 && 
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IPSEC_SA
, 
£í_auth
,

2755 
NULL
, 0) == NULL)

2756 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2757 i‡(
ªje˘
 == 0

2758 && 
	`gë_Ægo
(
SUPP_ALGO_CRYPT
, 
SUPP_ALGO_IPSEC_SA
, 
£í_íc
,

2759 
NULL
, 
£í_keyÀn
) == NULL)

2760 
ªje˘
 = 
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2762 i‡(
ªje˘
 == 0) {

2763 
s
->
ù£c
.
¸y_Ægo
 =

2764 
	`gë_Ægo
(
SUPP_ALGO_CRYPT
, 
SUPP_ALGO_IPSEC_SA
,

2765 
£í_íc
, 
NULL
, 
£í_keyÀn
)->
my_id
;

2766 
s
->
ù£c
.
md_Ægo
 =

2767 
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IPSEC_SA
,

2768 
£í_auth
, 
NULL
, 0)->
my_id
;

2769 i‡(
s
->
ù£c
.
¸y_Ægo
) {

2770 
	`g¸y_cùhî_Ægo_öfo
(
s
->
ù£c
.
¸y_Ægo
, 
GCRYCTL_GET_KEYLEN
, 
NULL
, &(s->ù£c.
key_Àn
));

2771 
	`g¸y_cùhî_Ægo_öfo
(
s
->
ù£c
.
¸y_Ægo
, 
GCRYCTL_GET_BLKLEN
, 
NULL
, &(s->ù£c.
blk_Àn
));

2772 
s
->
ù£c
.
iv_Àn
 = s->ù£c.
blk_Àn
;

2774 
s
->
ù£c
.
key_Àn
 = 0;

2775 
s
->
ù£c
.
iv_Àn
 = 0;

2776 
s
->
ù£c
.
blk_Àn
 = 8;

2778 
s
->
ù£c
.
md_Àn
 = 
	`g¸y_md_gë_Ægo_dÀn
(s->ù£c.
md_Ægo
);

2779 
	`DEBUG
(1, 
	`¥ötf
("IPSEC SA selected %s-%s\n",

2780 
	`gë_Ægo
(
SUPP_ALGO_CRYPT
,

2781 
SUPP_ALGO_IPSEC_SA
, 
£í_íc
, 
NULL
,

2782 
£í_keyÀn
)->
«me
,

2783 
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IPSEC_SA
,

2784 
£í_auth
, 
NULL
, 0)->
«me
));

2785 i‡(
s
->
ù£c
.
¸y_Ægo
 =
GCRY_CIPHER_DES
 && !
›t_1des
) {

2786 
	`îr‹
(1, 0, "peer selected (single) DESás \"encrytion\" method.\n"

2790 } i‡(
s
->
ù£c
.
¸y_Ægo
 =
GCRY_CIPHER_NONE
 && !
›t_no_í¸y±i⁄
) {

2791 
	`îr‹
(1, 0, "peer selected NULLás \"encrytion\" method.\n"

2796 
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IPSEC_SA
, 
£í_auth
, 
NULL
, 0)->
«me
);

2802 
ISAKMP_PAYLOAD_N
:

2803 i‡(
ªje˘
 =0 && 
Ω
->
u
.
n
.
ty≥
 =
ISAKMP_N_IPSEC_RESPONDER_LIFETIME
) {

2804 i‡(
Ω
->
u
.
n
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_ISAKMP
)

2805 
	`li„time_ike_¥o˚ss
(
s
, 
Ω
->
u
.
n
.
©åibuãs
);

2806 i‡(
Ω
->
u
.
n
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_IPSEC_ESP
)

2807 
	`li„time_ù£c_¥o˚ss
(
s
, 
Ω
->
u
.
n
.
©åibuãs
);

2809 
	`DEBUG
(2, 
	`¥ötf
("got unknownÜifetimeÇotice, ignoring..\n"));

2812 
ISAKMP_PAYLOAD_ID
:

2815 
ISAKMP_PAYLOAD_KE
:

2816 
ke
 = 
Ω
;

2818 
ISAKMP_PAYLOAD_NONCE
:

2819 
n⁄˚_r
 = 
Ω
;

2823 
ªje˘
 = 
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

2827 i‡(
ªje˘
 =0 && 
n⁄˚_r
 =
NULL
)

2828 
ªje˘
 = 
ISAKMP_N_INVALID_HASH_INFORMATION
;

2829 i‡(
ªje˘
 =0 && 
dh_gΩ
 && (
ke
 =
NULL
 || ke->
u
.ke.
Àngth
 !
	`dh_gëÀn
(dh_grp)))

2830 
ªje˘
 = 
ISAKMP_N_INVALID_KEY_INFORMATION
;

2831 i‡(
ªje˘
 != 0)

2832 
	`pha£2_Áèl
(
s
, "quick modêª•⁄£Ñeje˘ed [2]: %s(%d)", 
ªje˘
);

2835 
	`£ndªcv_pha£2
(
s
, 
NULL
, 
ISAKMP_EXCHANGE_IKE_QUICK
,

2836 
msgid
, 1, 0, 0, 
n⁄˚_i
, (nonce_i),

2837 
n⁄˚_r
->
u
.
n⁄˚
.
d©a
,Ç⁄˚_r->u.n⁄˚.
Àngth
);

2839 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.7 QM_packet3 sent\n"));

2841 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.8 setup ipsecÅunnel\n"));

2843 *
dh_sh¨ed_£¸ë
 = 
NULL
;

2845 i‡(
dh_gΩ
) {

2847 
dh_sh¨ed_£¸ë
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

2848 
	`dh_¸óã_sh¨ed
(
dh_gΩ
, 
dh_sh¨ed_£¸ë
, 
ke
->
u
.ke.
d©a
);

2849 
	`hex_dump
("dh_sh¨ed_£¸ë", 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

2852 
s
->
ù£c
.
rx
.
key
 = 
	`gí_keym©
(s, 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
, s->ù£c.rx.
•i
,

2853 
dh_sh¨ed_£¸ë
, 
dh_gΩ
 ? 
	`dh_gëÀn
(dh_grp) : 0,

2854 
n⁄˚_i
, “⁄˚_i), 
n⁄˚_r
->
u
.
n⁄˚
.
d©a
,Ç⁄˚_r->u.n⁄˚.
Àngth
);

2856 
s
->
ù£c
.
tx
.
key
 = 
	`gí_keym©
(s, 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
, s->ù£c.tx.
•i
,

2857 
dh_sh¨ed_£¸ë
, 
dh_gΩ
 ? 
	`dh_gëÀn
(dh_grp) : 0,

2858 
n⁄˚_i
, “⁄˚_i), 
n⁄˚_r
->
u
.
n⁄˚
.
d©a
,Ç⁄˚_r->u.n⁄˚.
Àngth
);

2860 i‡(
dh_gΩ
)

2861 
	`group_‰ì
(
dh_gΩ
);

2862 
	`‰ì
(
dh_sh¨ed_£¸ë
);

2863 
	`‰ì_ißkmp_∑ckë
(
r
);

2865 i‡((
›t_«â_mode
 =
NATT_CISCO_UDP
Ë&& 
s
->
ù£c
.
≥î_ud≥nˇp_p‹t
) {

2866 
s
->
e•_fd
 = 
	`make_sockë
(s, 
›t_ud≥nˇµ‹t
, s->
ù£c
.
≥î_ud≥nˇp_p‹t
);

2867 
s
->
ù£c
.
íˇp_mode
 = 
IPSEC_ENCAP_UDP_TUNNEL
;

2868 
s
->
ù£c
.
«â_a˘ive_mode
 = 
NATT_ACTIVE_CISCO_UDP
;

2869 } i‡(
s
->
ù£c
.
íˇp_mode
 !
IPSEC_ENCAP_TUNNEL
) {

2870 
s
->
e•_fd
 = s->
ike_fd
;

2872 #ifde‡
IP_HDRINCL


2873 
hö˛
 = 1;

2876 
s
->
e•_fd
 = 
	`sockë
(
PF_INET
, 
SOCK_RAW
, 
IPPROTO_ESP
);

2877 i‡(
s
->
e•_fd
 == -1) {

2878 
	`˛o£_tu¬ñ
(
s
);

2879 
	`îr‹
(1, 
î∫o
, "Couldn't open socket of ESP. Maybe somethingÑegistered ESPálready.\nPleaseÅry '--natt-mode force-natt' or disable whatever is using ESP.\nsocket(PF_INET, SOCK_RAW, IPPROTO_ESP)");

2881 #ifde‡
IP_HDRINCL


2882 i‡(
	`£tsock›t
(
s
->
e•_fd
, 
IPPROTO_IP
, 
IP_HDRINCL
, &
hö˛
, (hincl)) == -1) {

2883 
	`˛o£_tu¬ñ
(
s
);

2884 
	`îr‹
(1, 
î∫o
, "setsockopt(esp_fd, IPPROTO_IP, IP_HDRINCL, 1)");

2889 
s
->
ù£c
.
rx
.
£q_id
 = s->ù£c.
tx
.seq_id = 1;

2891 
	`‰ì
(
dh_public
);

2892 
	}
}

2894 
	$£nd_dñëe_ù£c
(
ß_block
 *
s
)

2898 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.10 send ipsecÅermination message\n"));

2900 
ißkmp_∑ylﬂd
 *
d_ù£c
;

2901 
uöt8_t
 
dñ_msgid
;

2903 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
dñ_msgid
, (del_msgid));

2904 
d_ù£c
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_D
);

2905 
d_ù£c
->
u
.
d
.
doi
 = 
ISAKMP_DOI_IPSEC
;

2906 
d_ù£c
->
u
.
d
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
;

2907 
d_ù£c
->
u
.
d
.
•i_Àngth
 = 4;

2908 
d_ù£c
->
u
.
d
.
num_•i
 = 2;

2909 
d_ù£c
->
u
.
d
.
•i
 = 
	`xÆlocc
(2 * (
uöt8_t
 *));

2910 
d_ù£c
->
u
.
d
.
•i
[0] = 
	`xÆlocc
(d_ù£c->u.d.
•i_Àngth
);

2911 
	`mem˝y
(
d_ù£c
->
u
.
d
.
•i
[0], &
s
->
ù£c
.
rx
.spi, 4);

2912 
d_ù£c
->
u
.
d
.
•i
[1] = 
	`xÆlocc
(d_ù£c->u.d.
•i_Àngth
);

2913 
	`mem˝y
(
d_ù£c
->
u
.
d
.
•i
[1], &
s
->
ù£c
.
tx
.spi, 4);

2914 
	`£ndªcv_pha£2
(
s
, 
d_ù£c
, 
ISAKMP_EXCHANGE_INFORMATIONAL
,

2915 
dñ_msgid
, 1, 
NULL
, NULL,

2916 
NULL
, 0, NULL, 0);

2918 
	}
}

2920 
	$£nd_dñëe_ißkmp
(
ß_block
 *
s
)

2922 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.11 send isakmpÅermination message\n"));

2924 
ißkmp_∑ylﬂd
 *
d_ißkmp
;

2925 
uöt8_t
 
dñ_msgid
;

2927 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
dñ_msgid
, (del_msgid));

2928 
d_ißkmp
 = 
	`√w_ißkmp_∑ylﬂd
(
ISAKMP_PAYLOAD_D
);

2929 
d_ißkmp
->
u
.
d
.
doi
 = 
ISAKMP_DOI_IPSEC
;

2930 
d_ißkmp
->
u
.
d
.
¥Ÿocﬁ
 = 
ISAKMP_IPSEC_PROTO_ISAKMP
;

2931 
d_ißkmp
->
u
.
d
.
•i_Àngth
 = 2 * 
ISAKMP_COOKIE_LENGTH
;

2932 
d_ißkmp
->
u
.
d
.
num_•i
 = 1;

2933 
d_ißkmp
->
u
.
d
.
•i
 = 
	`xÆlocc
(1 * (
uöt8_t
 *));

2934 
d_ißkmp
->
u
.
d
.
•i
[0] = 
	`xÆlocc
(2 * 
ISAKMP_COOKIE_LENGTH
);

2935 
	`mem˝y
(
d_ißkmp
->
u
.
d
.
•i
[0] + 
ISAKMP_COOKIE_LENGTH
 * 0, 
s
->
ike
.
i_cookõ
,

2936 
ISAKMP_COOKIE_LENGTH
);

2937 
	`mem˝y
(
d_ißkmp
->
u
.
d
.
•i
[0] + 
ISAKMP_COOKIE_LENGTH
 * 1, 
s
->
ike
.
r_cookõ
,

2938 
ISAKMP_COOKIE_LENGTH
);

2939 
	`£ndªcv_pha£2
(
s
, 
d_ißkmp
, 
ISAKMP_EXCHANGE_INFORMATIONAL
,

2940 
dñ_msgid
, 1, 
NULL
, NULL,

2941 
NULL
, 0, NULL, 0);

2943 
	}
}

2945 
	$do_ªkey
(
ß_block
 *
s
, 
ißkmp_∑ckë
 *
r
)

2947 
ißkmp_∑ylﬂd
 *
Ω
, *
ke
 = 
NULL
, *
n⁄˚_i
 = NULL;

2948 
ißkmp_©åibuã
 *
a
;

2949 
£í_íc
;

2950 
£í_auth
 = 0, 
£í_íˇp
 = 0, 
£í_group
 = 0, 
£í_keyÀn
 = 0;

2951 
n⁄˚_i_c›y_Àn
;

2952 
group
 *
dh_gΩ
 = 
NULL
;

2953 
uöt8_t
 
n⁄˚_r
[20], *
dh_public
 = 
NULL
, *
n⁄˚_i_c›y
 = NULL;

2954 *
dh_sh¨ed_£¸ë
 = 
NULL
;

2956 i‡(
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
my_id
) {

2957 
dh_gΩ
 = 
	`group_gë
(
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
my_id
);

2958 
	`DEBUG
(3, 
	`¥ötf
("À¿%d\n", 
	`dh_gëÀn
(
dh_gΩ
)));

2959 
dh_public
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

2960 
	`dh_¸óã_exch™ge
(
dh_gΩ
, 
dh_public
);

2961 
	`hex_dump
("dh_public", 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

2964 
Ω
 = 
r
->
∑ylﬂd
->
√xt
;

2967 i‡(
Ω
->
u
.
ß
.
doi
 !
ISAKMP_DOI_IPSEC
)

2968  
ISAKMP_N_DOI_NOT_SUPPORTED
;

2969 i‡(
Ω
->
u
.
ß
.
sôu©i⁄
 !
ISAKMP_IPSEC_SIT_IDENTITY_ONLY
)

2970  
ISAKMP_N_SITUATION_NOT_SUPPORTED
;

2971 i‡(
Ω
->
u
.
ß
.
¥›oßls
 =
NULL
)

2972  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2973 i‡(
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
¥Ÿ_id
 !
ISAKMP_IPSEC_PROTO_IPSEC_ESP
)

2974  
ISAKMP_N_INVALID_PROTOCOL_ID
;

2975 i‡(
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
•i_size
 != 4)

2976  
ISAKMP_N_INVALID_SPI
;

2977 i‡(
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
 =
NULL
 ||Ñp->u.ß.¥›oßls->u.p.å™sf‹ms->
√xt
 != NULL)

2978  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2980 
£í_íc
 = 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->u.
t
.
id
;

2982 
	`mem˝y
(&
s
->
ù£c
.
tx
.
•i
, 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.spi, 4);

2984 
a
 = 
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
å™sf‹ms
->u.
t
.
©åibuãs
;á;á =á->
√xt
)

2985 
a
->
ty≥
) {

2986 
ISAKMP_IPSEC_ATTRIB_AUTH_ALG
:

2987 i‡(
a
->
af
 =
ißkmp_©å_16
)

2988 
£í_auth
 = 
a
->
u
.
©å_16
;

2990  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

2992 
ISAKMP_IPSEC_ATTRIB_ENCAP_MODE
:

2993 i‡(
a
->
af
 =
ißkmp_©å_16
 &&

2994 
a
->
u
.
©å_16
 == (

2995 (
s
->
ù£c
.
«â_a˘ive_mode
 !
NATT_ACTIVE_CISCO_UDP
) ?

2996 
s
->
ù£c
.
íˇp_mode
 :

2997 
IPSEC_ENCAP_TUNNEL


2999 
£í_íˇp
 = 1;

3001  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3003 
ISAKMP_IPSEC_ATTRIB_GROUP_DESC
:

3004 i‡(
dh_gΩ
 && 
a
->
af
 =
ißkmp_©å_16
 &&

3005 
a
->
u
.
©å_16
 =
	`gë_dh_group_ù£c
(
s
->
ù£c
.
do_pfs
)->
ù£c_ß_id
)

3006 
£í_group
 = 1;

3008  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3010 
ISAKMP_IPSEC_ATTRIB_KEY_LENGTH
:

3011 i‡(
a
->
af
 =
ißkmp_©å_16
)

3012 
£í_keyÀn
 = 
a
->
u
.
©å_16
;

3014  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3016 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_TYPE
:

3018 i‡(
a
->
√xt
->
ty≥
 =
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
) {

3019 
	`li„time_ù£c_¥o˚ss
(
s
, 
a
);

3021  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3023 
ISAKMP_IPSEC_ATTRIB_SA_LIFE_DURATION
:

3027  
ISAKMP_N_ATTRIBUTES_NOT_SUPPORTED
;

3030 i‡(!
£í_auth
 || !
£í_íˇp
 || (
dh_gΩ
 && !
£í_group
))

3031  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3036 i‡((
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IPSEC_SA
, 
£í_auth
, 
NULL
, 0) == NULL) ||

3037 (
	`gë_Ægo
(
SUPP_ALGO_CRYPT
, 
SUPP_ALGO_IPSEC_SA
, 
£í_íc
, 
NULL
, 
£í_keyÀn
) == NULL)) {

3038 
	`¥ötf
("\nFIXME: vpnc doesn't support change ofálgorightms duringÑekeying\n");

3039  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3043 i‡(
s
->
ù£c
.
¸y_Ægo
 !
	`gë_Ægo
(
SUPP_ALGO_CRYPT
, 
SUPP_ALGO_IPSEC_SA
, 
£í_íc
, 
NULL
, 
£í_keyÀn
)->
my_id
)

3044  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3045 i‡(
s
->
ù£c
.
md_Ægo
 !
	`gë_Ægo
(
SUPP_ALGO_HASH
, 
SUPP_ALGO_IPSEC_SA
, 
£í_auth
, 
NULL
, 0)->
my_id
)

3046  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3048 
Ω
 =Ñp->
√xt
;Ñp;Ñp =Ñp->next)

3049 
Ω
->
ty≥
) {

3050 
ISAKMP_PAYLOAD_ID
:

3053 
ISAKMP_PAYLOAD_KE
:

3054 
ke
 = 
Ω
;

3056 
ISAKMP_PAYLOAD_NONCE
:

3057 
n⁄˚_i
 = 
Ω
;

3060  
ISAKMP_N_INVALID_PAYLOAD_TYPE
;

3064 i‡((
dh_gΩ
 && 
ke
 =
NULL
Ë|| 
n⁄˚_i
 == NULL)

3065  
ISAKMP_N_BAD_PROPOSAL_SYNTAX
;

3067 
	`DEBUG
(3, 
	`¥ötf
("everything fine so far...\n"));

3068 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë
n⁄˚_r
, (nonce_r));

3069 
	`g¸y_¸óã_n⁄˚
((
uöt8_t
 *Ë& 
s
->
ù£c
.
rx
.
•i
, (s->ipsec.rx.spi));

3071 i‡(
dh_gΩ
) {

3073 
dh_sh¨ed_£¸ë
 = 
	`xÆlocc
(
	`dh_gëÀn
(
dh_gΩ
));

3074 
	`dh_¸óã_sh¨ed
(
dh_gΩ
, 
dh_sh¨ed_£¸ë
, 
ke
->
u
.ke.
d©a
);

3075 
	`hex_dump
("dh_sh¨ed_£¸ë", 
dh_sh¨ed_£¸ë
, 
	`dh_gëÀn
(
dh_gΩ
), 
NULL
);

3078 
	`‰ì
(
s
->
ù£c
.
rx
.
key
);

3079 
	`‰ì
(
s
->
ù£c
.
tx
.
key
);

3081 
s
->
ù£c
.
rx
.
key
 = 
	`gí_keym©
(s, 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
, s->ù£c.rx.
•i
,

3082 
dh_sh¨ed_£¸ë
, 
dh_gΩ
 ? 
	`dh_gëÀn
(dh_grp) : 0,

3083 
n⁄˚_i
->
u
.
n⁄˚
.
d©a
,Ç⁄˚_i->u.n⁄˚.
Àngth
, 
n⁄˚_r
, (nonce_r));

3085 
s
->
ù£c
.
tx
.
key
 = 
	`gí_keym©
(s, 
ISAKMP_IPSEC_PROTO_IPSEC_ESP
, s->ù£c.tx.
•i
,

3086 
dh_sh¨ed_£¸ë
, 
dh_gΩ
 ? 
	`dh_gëÀn
(dh_grp) : 0,

3087 
n⁄˚_i
->
u
.
n⁄˚
.
d©a
,Ç⁄˚_i->u.n⁄˚.
Àngth
, 
n⁄˚_r
, (nonce_r));

3089 
s
->
ù£c
.
rx
.
key_¸y
 = s->ù£c.rx.
key
;

3090 
s
->
ù£c
.
rx
.
key_md
 = s->ù£c.rx.
key
 + s->ù£c.
key_Àn
;

3091 
s
->
ù£c
.
tx
.
key_¸y
 = s->ù£c.tx.
key
;

3092 
s
->
ù£c
.
tx
.
key_md
 = s->ù£c.tx.
key
 + s->ù£c.
key_Àn
;

3094 
n⁄˚_i_c›y_Àn
 = 
n⁄˚_i
->
u
.
n⁄˚
.
Àngth
;

3095 
n⁄˚_i_c›y
 = 
	`xÆlocc
(
n⁄˚_i_c›y_Àn
);

3096 
	`mem˝y
(
n⁄˚_i_c›y
, 
n⁄˚_i
->
u
.
n⁄˚
.
d©a
, 
n⁄˚_i_c›y_Àn
);

3098 
s
->
ù£c
.
rx
.
£q_id
 = s->ù£c.
tx
.seq_id = 1;

3099 
s
->
ù£c
.
li„
.
°¨t
 = 
	`time
(
NULL
);

3100 
s
->
ù£c
.
li„
.
tx
 = 0;

3101 
s
->
ù£c
.
li„
.
rx
 = 0;

3103 i‡(
s
->
ù£c
.
¸y_Ægo
) {

3104 
	`g¸y_cùhî_£tkey
(
s
->
ù£c
.
rx
.
¸y_˘x
, s->ù£c.rx.
key_¸y
, s->ù£c.
key_Àn
);

3105 
	`g¸y_cùhî_£tkey
(
s
->
ù£c
.
tx
.
¸y_˘x
, s->ù£c.tx.
key_¸y
, s->ù£c.
key_Àn
);

3110 
Ω
 = 
r
->
∑ylﬂd
->
√xt
;

3112 
	`mem˝y
(
Ω
->
u
.
ß
.
¥›oßls
->u.
p
.
•i
, &
s
->
ù£c
.
rx
.spi, 4);

3114 
Ω
 =Ñp->
√xt
;Ñp;Ñp =Ñp->next)

3115 
Ω
->
ty≥
) {

3116 
ISAKMP_PAYLOAD_ID
:

3118 
ISAKMP_PAYLOAD_KE
:

3119 
	`mem˝y
(
Ω
->
u
.
ke
.
d©a
, 
dh_public
, 
	`dh_gëÀn
(
dh_gΩ
));

3121 
ISAKMP_PAYLOAD_NONCE
:

3122 
	`mem˝y
(
Ω
->
u
.
n⁄˚
.
d©a
, 
n⁄˚_r
, (nonce_r));

3125 
	`as£π
(0);

3129 
	`£ndªcv_pha£2
(
s
, 
r
->
∑ylﬂd
->
√xt
, 
ISAKMP_EXCHANGE_IKE_QUICK
,

3130 
r
->
mesßge_id
, 0, 0, 0, 
n⁄˚_i_c›y
, 
n⁄˚_i_c›y_Àn
, 0,0);

3131 
	`u≈ack_vîify_pha£2
(
s
, 
r_∑ckë
, 
r_Àngth
, &
r
, 
NULL
, 0);

3132 
	`‰ì
(
n⁄˚_i_c›y
);

3136 
	}
}

3138 
	$¥o˚ss_œã_ike
(
ß_block
 *
s
, 
uöt8_t
 *
r_∑ckë
, 
ssize_t
 
r_Àngth
)

3140 
ªje˘
;

3141 
ißkmp_∑ckë
 *
r
;

3142 
ißkmp_∑ylﬂd
 *
Ω
;

3144 
	`DEBUG
(2,
	`¥ötf
("gŸÜ©êikê∑kë: %zd byãs\n", 
r_Àngth
));

3147 
ªje˘
 = 
	`u≈ack_vîify_pha£2
(
s
, 
r_∑ckë
, 
r_Àngth
, &
r
, 
NULL
, 0);

3150 i‡(
ªje˘
 != 0) {

3151 i‡(
r
Ë
	`‰ì_ißkmp_∑ckë
(r);

3156 i‡(
r
->
∑ylﬂd
 =
NULL
 ||Ñ->∑ylﬂd->
ty≥
 !
ISAKMP_PAYLOAD_HASH
) {

3157 
	`‰ì_ißkmp_∑ckë
(
r
);

3162 i‡(
r
->
∑ylﬂd
->
√xt
 =
NULL
) {

3163 
	`‰ì_ißkmp_∑ckë
(
r
);

3168 i‡(
r
->
exch™ge_ty≥
 =
ISAKMP_EXCHANGE_IKE_QUICK
 &&

3169 
r
->
∑ylﬂd
->
√xt
->
ty≥
 =
ISAKMP_PAYLOAD_SA
) {

3170 
ªje˘
 = 
	`do_ªkey
(
s
, 
r
);

3171 
	`DEBUG
(3, 
	`¥ötf
("do_ªkeyÑëu∫ed: %d\n", 
ªje˘
));

3177 i‡(
r
->
exch™ge_ty≥
 =
ISAKMP_EXCHANGE_INFORMATIONAL
) {

3179 
Ω
 = 
r
->
∑ylﬂd
->
√xt
;Ñp;Ñp =Ñp->next) {

3180 i‡(
Ω
->
ty≥
 !
ISAKMP_PAYLOAD_N
)

3183 i‡(
Ω
->
u
.
n
.
¥Ÿocﬁ
 !
ISAKMP_IPSEC_PROTO_ISAKMP
) {

3184 
	`DEBUG
(2, 
	`¥ötf
("gotÇon isakmp-notify, ignoring...\n"));

3187 i‡(
Ω
->
u
.
n
.
ty≥
 =
ISAKMP_N_R_U_THERE
) {

3188 
uöt32_t
 
£q
;

3189 i‡(
Ω
->
u
.
n
.
d©a_Àngth
 != 4) {

3190 
	`DEBUG
(2, 
	`¥ötf
("ignoring bad dataÜength R-U-THEREÑequest\n"));

3193 
	`mem˝y
(&
£q
, 
Ω
->
u
.
n
.
d©a
, 4);

3194 
	`£nd_dpd
(
s
, 1, 
£q
);

3195 
	`DEBUG
(2, 
	`¥ötf
("gotÑ-u-thereÑequest sentáck\n"));

3197 } i‡(
Ω
->
u
.
n
.
ty≥
 =
ISAKMP_N_R_U_THERE_ACK
) {

3198 
uöt32_t
 
£qack
;

3199 i‡(
Ω
->
u
.
n
.
d©a_Àngth
 != 4) {

3200 
	`DEBUG
(2, 
	`¥ötf
("ignoring bad dataÜength R-U-THERE-ACK\n"));

3203 
	`mem˝y
(&
£qack
, 
Ω
->
u
.
n
.
d©a
, 4);

3204 i‡(
£qack
 =
s
->
ike
.
dpd_£qno
) {

3205 
s
->
ike
.
dpd_£qno_ack
 = 
£qack
;

3207 
	`DEBUG
(2, 
	`¥ötf
("ign‹ögÑ-u-thîêack %u (ex≥˘ög %u)\n", 
£qack
, 
s
->
ike
.
dpd_£qno
));

3210 
	`DEBUG
(2, 
	`¥ötf
("gotÑ-u-thereáck\n"));

3216 
Ω
 = 
r
->
∑ylﬂd
->
√xt
;Ñp;Ñp =Ñp->next) {

3218 i‡(
Ω
->
ty≥
 !
ISAKMP_PAYLOAD_D
)

3220 i‡(
Ω
->
u
.
d
.
¥Ÿocﬁ
 =
ISAKMP_IPSEC_PROTO_IPSEC_ESP
) {

3228 
	`‰ì_ißkmp_∑ckë
(
r
);

3229 
	`do_pha£2_qm
(
s
);

3233 i‡(
Ω
->
u
.
d
.
¥Ÿocﬁ
 !
ISAKMP_IPSEC_PROTO_ISAKMP
) {

3234 
	`DEBUG
(2, 
	`¥ötf
("gotÇon isakmp-delete, ignoring...\n"));

3245 
do_kûl
 = -1;

3246 
	`DEBUG
(2, 
	`¥ötf
("got isakmp-delete,Åerminating...\n"));

3247 
	`‰ì_ißkmp_∑ckë
(
r
);

3251 
	`‰ì_ißkmp_∑ckë
(
r
);

3253 
	}
}

3255 
	$maö
(
¨gc
, **
¨gv
)

3257 
do_lﬂd_bÆ™˚
;

3258 c⁄° 
uöt8_t
 
hex_ã°
[] = { 0, 1, 2, 3 };

3259 
ß_block
 
ourß
[1];

3260 
ß_block
 *
s
 = 
ourß
;

3262 
	`ã°_∑ck_u≈ack
();

3263 #i‡
	`deföed
(
__CYGWIN__
)

3264 
	`g¸y_c⁄åﬁ
(
GCRYCTL_SET_THREAD_CBS
, &
g¸y_thªads_±hªad
);

3266 
	`g¸y_check_vîsi⁄
("1.1.90");

3267 
	`g¸y_c⁄åﬁ
(
GCRYCTL_INIT_SECMEM
, 16384, 0);

3268 
	`group_öô
();

3270 
	`mem£t
(
s
, 0, (*s));

3271 
s
->
ù£c
.
íˇp_mode
 = 
IPSEC_ENCAP_TUNNEL
;

3272 
s
->
ike
.
timeout
 = 1000;

3274 
	`do_c⁄fig
(
¨gc
, 
¨gv
);

3276 
	`DEBUG
(1, 
	`¥ötf
("\nv≤¯vîsi⁄ " 
VERSION
 "\n"));

3277 
	`hex_dump
("hex_ã°", 
hex_ã°
, (hex_ã°), 
NULL
);

3279 
	`DEBUGTOP
(2, 
	`¥ötf
("S1 init_sockaddr\n"));

3280 
	`öô_sockaddr
(&
s
->
d°
, 
c⁄fig
[
CONFIG_IPSEC_GATEWAY
]);

3281 
	`öô_sockaddr
(&
s
->
›t_§c_ù
, 
c⁄fig
[
CONFIG_LOCAL_ADDR
]);

3282 
	`DEBUGTOP
(2, 
	`¥ötf
("S2 make_socket\n"));

3283 
s
->
ike
.
§c_p‹t
 = 
	`©oi
(
c⁄fig
[
CONFIG_LOCAL_PORT
]);

3284 
s
->
ike
.
d°_p‹t
 = 
ISAKMP_PORT
;

3285 
s
->
ike_fd
 = 
	`make_sockë
(s, s->
ike
.
§c_p‹t
, s->ike.
d°_p‹t
);

3286 
	`DEBUGTOP
(2, 
	`¥ötf
("S3 setup_tunnel\n"));

3287 
	`£tup_tu¬ñ
(
s
);

3289 
do_lﬂd_bÆ™˚
 = 0;

3291 
	`DEBUGTOP
(2, 
	`¥ötf
("S4 do_phase1_am\n"));

3292 
	`do_pha£1_am
(
c⁄fig
[
CONFIG_IPSEC_ID
], c⁄fig[
CONFIG_IPSEC_SECRET
], 
s
);

3293 
	`DEBUGTOP
(2, 
	`¥ötf
("S5 do_phase2_xauth\n"));

3295 i‡(
s
->
ike
.
auth_Ægo
 >
IKE_AUTH_HybridInôRSA
)

3296 
do_lﬂd_bÆ™˚
 = 
	`do_pha£2_xauth
(
s
);

3297 
	`DEBUGTOP
(2, 
	`¥ötf
("S6 do_phase2_config\n"));

3298 i‡((
›t_víd‹
 =
VENDOR_CISCO
Ë&& (
do_lﬂd_bÆ™˚
 == 0))

3299 
do_lﬂd_bÆ™˚
 = 
	`do_pha£2_c⁄fig
(
s
);

3300 } 
do_lﬂd_bÆ™˚
);

3301 
	`DEBUGTOP
(2, 
	`¥ötf
("S7 setup_link (phase 2 + main_loop)\n"));

3302 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.0Ñun interface setup script\n"));

3303 
	`c⁄fig_tu¬ñ
(
s
);

3304 
	`do_pha£2_qm
(
s
);

3305 
	`DEBUGTOP
(2, 
	`¥ötf
("S7.9 mainÜoop (receiveándÅransmit ipsecÖackets)\n"));

3306 
	`v≤c_doô
(
s
);

3309 
	`£nd_dñëe_ù£c
(
s
);

3310 
	`£nd_dñëe_ißkmp
(
s
);

3313 
	`DEBUGTOP
(2, 
	`¥ötf
("S8 close_tunnel\n"));

3314 
	`˛o£_tu¬ñ
(
s
);

3317 
	`DEBUGTOP
(2, 
	`¥ötf
("S9 cleanup\n"));

3318 
	`˛ónup
(
s
);

3321 
	}
}

	@vpnc.h

21 #i‚de‡
__VPNC_H__


22 
	#__VPNC_H__


	)

24 
	~"tunù.h
"

26 
¥o˚ss_œã_ike
(
ß_block
 *
s
, 
uöt8_t
 *
r_∑ckë
, 
ssize_t
 
r_Àngth
);

27 
kì∑live_ike
(
ß_block
 *
s
);

28 
dpd_ike
(
ß_block
 *
s
);

29 
¥öt_vid
(c⁄° *
vid
, 
uöt16_t
 
Àn
);

	@
1
.
1
/usr/include
26
269
android-hacks.h
cisco-decrypt.c
config.c
config.h
decrypt-utils.c
decrypt-utils.h
dh.c
dh.h
error.h
hacks.h
isakmp-pkt.c
isakmp-pkt.h
isakmp.h
math_group.c
math_group.h
supp.c
supp.h
sysdep.c
sysdep.h
tap-win32.h
tunip.c
tunip.h
vpnc-debug.c
vpnc-debug.h
vpnc.c
vpnc.h
